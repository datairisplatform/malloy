
> malloy@0.0.1 test
> jest --runInBand expr

  console.log
    BRIAN fianl status check: {
      '$metadata': {
        httpStatusCode: 200,
        requestId: '2a9da100-cfae-467c-9eb5-8ad908991851',
        extendedRequestId: undefined,
        cfId: undefined,
        attempts: 1,
        totalRetryDelay: 0
      },
      CreatedAt: 2025-02-27T01:30:24.113Z,
      Database: 'dev',
      Duration: 139725769,
      HasResultSet: true,
      Id: '0b3c0bb2-cf7d-4a3d-83bb-e7db9714900d',
      RedshiftPid: 1073881189,
      RedshiftQueryId: 0,
      ResultFormat: 'json',
      ResultRows: -1,
      ResultSize: -1,
      SecretArn: 'arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg',
      Status: 'FINISHED',
      SubStatements: [
        {
          CreatedAt: 2025-02-27T01:30:24.237Z,
          Duration: 45530141,
          HasResultSet: false,
          Id: '0b3c0bb2-cf7d-4a3d-83bb-e7db9714900d:1',
          QueryString: 'SET search_path TO malloytest;',
          RedshiftQueryId: 0,
          ResultRows: 0,
          ResultSize: 0,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:24.590Z
        },
        {
          CreatedAt: 2025-02-27T01:30:24.241Z,
          Duration: 94195628,
          HasResultSet: true,
          Id: '0b3c0bb2-cf7d-4a3d-83bb-e7db9714900d:2',
          QueryString: 'SELECT type as "data_type", "column" as "col_name"\n' +
            '      FROM pg_table_def\n' +
            "      WHERE tablename = 'aircraft_models';",
          RedshiftQueryId: 0,
          ResultRows: 11,
          ResultSize: 239,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:24.809Z
        }
      ],
      UpdatedAt: 2025-02-27T01:30:24.869Z,
      WorkgroupName: 'default-workgroup'
    }

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:336:17)

  console.log
    BRIAN table schema rows: [
      {
        data_type: 'character varying(256)',
        col_name: 'aircraft_model_code'
      },
      { data_type: 'character varying(256)', col_name: 'manufacturer' },
      { data_type: 'character varying(256)', col_name: 'model' },
      { data_type: 'bigint', col_name: 'aircraft_type_id' },
      { data_type: 'bigint', col_name: 'aircraft_engine_type_id' },
      { data_type: 'bigint', col_name: 'aircraft_category_id' },
      { data_type: 'bigint', col_name: 'amateur' },
      { data_type: 'bigint', col_name: 'engines' },
      { data_type: 'bigint', col_name: 'seats' },
      { data_type: 'bigint', col_name: 'weight' },
      { data_type: 'bigint', col_name: 'speed' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:233:13)

  console.log
    BRIAN fianl status check: {
      '$metadata': {
        httpStatusCode: 200,
        requestId: 'b380b3f0-b840-43c8-a16d-a98d70fd5e8f',
        extendedRequestId: undefined,
        cfId: undefined,
        attempts: 1,
        totalRetryDelay: 0
      },
      CreatedAt: 2025-02-27T01:30:25.728Z,
      Database: 'dev',
      Duration: 134473734,
      HasResultSet: true,
      Id: '62ef5021-7b37-4db3-900a-21684a92f45a',
      RedshiftPid: 1073889398,
      RedshiftQueryId: 0,
      ResultFormat: 'json',
      ResultRows: -1,
      ResultSize: -1,
      SecretArn: 'arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg',
      Status: 'FINISHED',
      SubStatements: [
        {
          CreatedAt: 2025-02-27T01:30:25.816Z,
          Duration: 44152674,
          HasResultSet: false,
          Id: '62ef5021-7b37-4db3-900a-21684a92f45a:1',
          QueryString: 'SET search_path TO malloytest;',
          RedshiftQueryId: 0,
          ResultRows: 0,
          ResultSize: 0,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:26.156Z
        },
        {
          CreatedAt: 2025-02-27T01:30:25.820Z,
          Duration: 90321060,
          HasResultSet: true,
          Id: '62ef5021-7b37-4db3-900a-21684a92f45a:2',
          QueryString: 'SELECT type as "data_type", "column" as "col_name"\n' +
            '      FROM pg_table_def\n' +
            "      WHERE tablename = 'aircraft';",
          RedshiftQueryId: 0,
          ResultRows: 25,
          ResultSize: 689,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:26.387Z
        }
      ],
      UpdatedAt: 2025-02-27T01:30:26.446Z,
      WorkgroupName: 'default-workgroup'
    }

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:336:17)

  console.log
    BRIAN table schema rows: [
      { data_type: 'bigint', col_name: 'id' },
      { data_type: 'character varying(256)', col_name: 'tail_num' },
      { data_type: 'character varying(256)', col_name: 'aircraft_serial' },
      {
        data_type: 'character varying(256)',
        col_name: 'aircraft_model_code'
      },
      {
        data_type: 'character varying(256)',
        col_name: 'aircraft_engine_code'
      },
      { data_type: 'bigint', col_name: 'year_built' },
      { data_type: 'bigint', col_name: 'aircraft_type_id' },
      { data_type: 'bigint', col_name: 'aircraft_engine_type_id' },
      { data_type: 'bigint', col_name: 'registrant_type_id' },
      { data_type: 'character varying(256)', col_name: 'name' },
      { data_type: 'character varying(256)', col_name: 'address1' },
      { data_type: 'character varying(256)', col_name: 'address2' },
      { data_type: 'character varying(256)', col_name: 'city' },
      { data_type: 'character varying(256)', col_name: 'state' },
      { data_type: 'character varying(256)', col_name: 'zip' },
      { data_type: 'character varying(256)', col_name: 'region' },
      { data_type: 'character varying(256)', col_name: 'county' },
      { data_type: 'character varying(256)', col_name: 'country' },
      { data_type: 'character varying(256)', col_name: 'certification' },
      { data_type: 'character varying(256)', col_name: 'status_code' },
      { data_type: 'character varying(256)', col_name: 'mode_s_code' },
      { data_type: 'character varying(256)', col_name: 'fract_owner' },
      { data_type: 'date', col_name: 'last_action_date' },
      { data_type: 'date', col_name: 'cert_issue_date' },
      { data_type: 'date', col_name: 'air_worth_date' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:233:13)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:350:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:351:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp96b96cbbad4b4c02b222f4f19336d72a;\n' +
        '      create temp table tmp96b96cbbad4b4c02b222f4f19336d72a as SELECT * FROM (\n' +
        '        SELECT 10 as ten\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp96b96cbbad4b4c02b222f4f19336d72a';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:15)

  console.log
    Error in SQL:

          drop table if exists tmp96b96cbbad4b4c02b222f4f19336d72a;
          create temp table tmp96b96cbbad4b4c02b222f4f19336d72a as SELECT * FROM (
            SELECT 10 as ten
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp96b96cbbad4b4c02b222f4f19336d72a';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    BRIAN fianl status check: {
      '$metadata': {
        httpStatusCode: 200,
        requestId: '7aaae3ae-2139-4189-99c4-f3d63f152a37',
        extendedRequestId: undefined,
        cfId: undefined,
        attempts: 1,
        totalRetryDelay: 0
      },
      CreatedAt: 2025-02-27T01:30:28.920Z,
      Database: 'dev',
      Duration: 100643029,
      HasResultSet: true,
      Id: 'fe052a2b-f812-40d8-beb3-bf8a86aa7ea3',
      RedshiftPid: 1073791090,
      RedshiftQueryId: 0,
      ResultFormat: 'json',
      ResultRows: -1,
      ResultSize: -1,
      SecretArn: 'arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg',
      Status: 'FINISHED',
      SubStatements: [
        {
          CreatedAt: 2025-02-27T01:30:29.050Z,
          Duration: 51783663,
          HasResultSet: false,
          Id: 'fe052a2b-f812-40d8-beb3-bf8a86aa7ea3:1',
          QueryString: 'SET search_path TO malloytest;',
          RedshiftQueryId: 0,
          ResultRows: 0,
          ResultSize: 0,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:29.379Z
        },
        {
          CreatedAt: 2025-02-27T01:30:29.054Z,
          Duration: 48859366,
          HasResultSet: true,
          Id: 'fe052a2b-f812-40d8-beb3-bf8a86aa7ea3:2',
          QueryString: 'SELECT type as "data_type", "column" as "col_name"\n' +
            '      FROM pg_table_def\n' +
            "      WHERE tablename = 'alltypes';",
          RedshiftQueryId: 0,
          ResultRows: 9,
          ResultSize: 164,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:29.590Z
        }
      ],
      UpdatedAt: 2025-02-27T01:30:29.648Z,
      WorkgroupName: 'default-workgroup'
    }

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:336:17)

  console.log
    BRIAN table schema rows: [
      { data_type: 'bigint', col_name: 't_int64' },
      { data_type: 'double precision', col_name: 't_float64' },
      { data_type: 'character varying(256)', col_name: 'string' },
      { data_type: 'boolean', col_name: 't_bool_true' },
      { data_type: 'boolean', col_name: 't_bool_false' },
      { data_type: 'integer', col_name: 't_bool_null' },
      { data_type: 'date', col_name: 't_date' },
      { data_type: 'bigint', col_name: 't_datetime' },
      { data_type: 'bigint', col_name: 't_timestamp' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:233:13)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:350:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:351:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp0c616cbe3ff8430881efe0572353d809;\n' +
        '      create temp table tmp0c616cbe3ff8430881efe0572353d809 as SELECT * FROM (\n' +
        '        SELECT 1 as one\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp0c616cbe3ff8430881efe0572353d809';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:15)

  console.log
    Error in SQL:

          drop table if exists tmp0c616cbe3ff8430881efe0572353d809;
          create temp table tmp0c616cbe3ff8430881efe0572353d809 as SELECT * FROM (
            SELECT 1 as one
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp0c616cbe3ff8430881efe0572353d809';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    BRIAN fianl status check: {
      '$metadata': {
        httpStatusCode: 200,
        requestId: '2c293aa8-61f5-4643-9014-f078de0253c4',
        extendedRequestId: undefined,
        cfId: undefined,
        attempts: 1,
        totalRetryDelay: 0
      },
      CreatedAt: 2025-02-27T01:30:32.135Z,
      Database: 'dev',
      Duration: 90864790,
      HasResultSet: true,
      Id: 'd44f2201-0289-425b-a414-9883d5f4cd77',
      RedshiftPid: 1073832049,
      RedshiftQueryId: 0,
      ResultFormat: 'json',
      ResultRows: -1,
      ResultSize: -1,
      SecretArn: 'arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg',
      Status: 'FINISHED',
      SubStatements: [
        {
          CreatedAt: 2025-02-27T01:30:32.251Z,
          Duration: 42349493,
          HasResultSet: false,
          Id: 'd44f2201-0289-425b-a414-9883d5f4cd77:1',
          QueryString: 'SET search_path TO malloytest;',
          RedshiftQueryId: 0,
          ResultRows: 0,
          ResultSize: 0,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:32.572Z
        },
        {
          CreatedAt: 2025-02-27T01:30:32.254Z,
          Duration: 48515297,
          HasResultSet: true,
          Id: 'd44f2201-0289-425b-a414-9883d5f4cd77:2',
          QueryString: 'SELECT type as "data_type", "column" as "col_name"\n' +
            '      FROM pg_table_def\n' +
            "      WHERE tablename = 'state_facts';",
          RedshiftQueryId: 0,
          ResultRows: 5,
          ResultSize: 112,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:32.783Z
        }
      ],
      UpdatedAt: 2025-02-27T01:30:32.841Z,
      WorkgroupName: 'default-workgroup'
    }

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:336:17)

  console.log
    BRIAN table schema rows: [
      { data_type: 'character varying(256)', col_name: 'state' },
      { data_type: 'bigint', col_name: 'aircraft_count' },
      { data_type: 'bigint', col_name: 'airport_count' },
      { data_type: 'bigint', col_name: 'births' },
      { data_type: 'character varying(256)', col_name: 'popular_name' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:233:13)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:350:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:351:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpb3263db999f14294b891f5097fc20198;\n' +
        '      create temp table tmpb3263db999f14294b891f5097fc20198 as SELECT * FROM (\n' +
        '        \n' +
        `          SELECT '' as "null_value", '' as "string_value"\n` +
        "          UNION ALL SELECT null, 'correct'\n" +
        '      \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpb3263db999f14294b891f5097fc20198';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:15)

  console.log
    Error in SQL:

          drop table if exists tmpb3263db999f14294b891f5097fc20198;
          create temp table tmpb3263db999f14294b891f5097fc20198 as SELECT * FROM (

              SELECT '' as "null_value", '' as "string_value"
              UNION ALL SELECT null, 'correct'

          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpb3263db999f14294b891f5097fc20198';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:350:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:351:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpf96925abc93a4234869c2c5bf561d38d;\n' +
        '      create temp table tmpf96925abc93a4234869c2c5bf561d38d as SELECT * FROM (\n' +
        '        \n' +
        '      SELECT\n' +
        '        0 as "n",\n' +
        '        1 as "x", 2 as "y",\n' +
        `        'a' as "a", 'b' as "b",\n` +
        '        (1 = 1) as "tf"\n' +
        '      UNION ALL SELECT\n' +
        '        5,\n' +
        '        null, null, null, null, null\n' +
        '    \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpf96925abc93a4234869c2c5bf561d38d';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:15)

  console.log
    Error in SQL:

          drop table if exists tmpf96925abc93a4234869c2c5bf561d38d;
          create temp table tmpf96925abc93a4234869c2c5bf561d38d as SELECT * FROM (

          SELECT
            0 as "n",
            1 as "x", 2 as "y",
            'a' as "a", 'b' as "b",
            (1 = 1) as "tf"
          UNION ALL SELECT
            5,
            null, null, null, null, null

          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpf96925abc93a4234869c2c5bf561d38d';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/expr.spec.ts (25.019 s)
  redshift
    ✕ basic calculations (3678 ms)
    ✕ join dependencies tracked from annotated references
    ✕ Floor() -or any function bustage with aggregates
    ✕ computes mod correctly (1539 ms)
    ✕ model: expression fixups.
    ✕ simple turtle (1 ms)
    ✕ double turtle
    ✕ double turtle - pipeline (1 ms)
    ✕ model: turtle
    ✕ model: filtered turtle
    ✕ model: simple having
    ✕ model: having in a nest
    ✕ model: turtle having on main
    ✕ model: having float group by partition (47 ms)
    ✕ model: aggregate functions distinct min max
    ✕ model: dates named (1673 ms)
    ✕ named query metadata undefined
    ✕ named query metadata named (1 ms)
    ✕ named query metadata named head of pipeline
    ✕ filtered explores basic
    ✕ sql cast
    ✕ case expressions
    ✕ sql safe cast (1517 ms)
    ✕ many_field.sum() has correct locality (30 ms)
    ✕ query with aliasname used twice
    ✕ joined filtered sources
    ✕ joined filtered explores with NO dependencies (1552 ms)
    ✕ nullish ?? operator (1343 ms)
    ✕ dimension expressions expanded with parens properly (14 ms)
    ○ skipped joined filtered explores with dependencies
    sql expr functions
      ✕ sql_string
      ✕ sql_number
      ✕ sql_number can be sum()med (1 ms)
      ✕ sql_boolean
      ✕ sql_date
      ✕ sql_timestamp
      ✕ with ${TABLE}.field
      ✕ with ${field}
      [not yet supported]
        ✕ ${view_name.dimension_name} - one path (10 ms)
        ✕ ${view_name.dimension_name} - multiple paths (1 ms)
        ✕ ${view_name.SQL_TABLE_NAME} (1 ms)
    alternations with not-eq
      ○ skipped x not-eq y or z : x eq y
      ○ skipped x not-eq y or z : x eq z
      ○ skipped x not-eq y or z : else
      ○ skipped x not-eq y and not-eq z : x eq y
      ○ skipped x not-eq y and not-eq z : x eq z
      ○ skipped x not-eq y and not-eq z : else
    string literal quoting
      ✕ quote single character (55 ms)
      ✕ quote single quote (11 ms)
      ✕ quote double quote (6 ms)
      ✕ quote backslash (12 ms)
    null safe booleans
      ✕ select boolean (1506 ms)
      ✕ not boolean (25 ms)
      ✕ numeric != non-null to null (13 ms)
      ✕ string !~ non-null to null (11 ms)
      ✕ regex !~ non-null to null (10 ms)
      ✕ numeric != null-to-null (9 ms)
      ✕ string !~ null-to-null (9 ms)

  ● redshift › basic calculations

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      76 |           percent_boeing_floor,
      77 |       }
    > 78 |     `).malloyResultMatches(expressionModel, {
         |        ^
      79 |       total_seats: 452415,
      80 |       total_seats2: 452415,
      81 |       boeing_seats: 252771,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:78:8)

  ● redshift › join dependencies tracked from annotated references

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      92 |           group_by: aircraft_models.seats
      93 |         }
    > 94 |     `).malloyResultMatches(expressionModel, {
         |        ^
      95 |       seats: 0,
      96 |     });
      97 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:94:8)

  ● redshift › Floor() -or any function bustage with aggregates

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      105 |           percent_boeing_floor2 is floor(boeing_seats / total_seats * 100)
      106 |       }
    > 107 |     `).malloyResultMatches(expressionModel, {
          |        ^
      108 |       percent_boeing_floor: 55,
      109 |       percent_boeing_floor2: 55,
      110 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:107:8)

  ● redshift › computes mod correctly

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/8492fb55-e4fb-5805-adc6-f3d175aaafa9: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("SELECT 10 as ten") -> {select: mod is 10 % 3}
      |            ^

      114 |     await expect(`
      115 |       run: ${databaseName}.sql("SELECT 10 as ten") -> {select: mod is 10 % 3}
    > 116 |     `).malloyResultMatches(runtime, {mod: 1});
          |        ^
      117 |   });
      118 |
      119 |   // Model based version of sums.

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:116:8)

  ● redshift › model: expression fixups.

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      125 |           aircraft_models.boeing_seats
      126 |       }
    > 127 |     `).malloyResultMatches(expressionModel, {
          |        ^
      128 |       total_seats: 18294,
      129 |       boeing_seats: 6244,
      130 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:127:8)

  ● redshift › simple turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      145 |         limit: 3
      146 |       }
    > 147 |     `).malloyResultMatches(expressionModel, {
          |        ^
      148 |       'by_state.state': 'TX',
      149 |       'by_state.airport_count': 1845,
      150 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:147:8)

  ● redshift › double turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      169 |         }
      170 |       }
    > 171 |     `).malloyResultMatches(expressionModel, {
          |        ^
      172 |       'o.by_state.state': 'TX',
      173 |       'o.by_state.airport_count': 1845,
      174 |       'o.airport_count': 11146,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:171:8)

  ● redshift › double turtle - pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      195 |         aggregate: o.by_state.airport_count.sum()
      196 |       }
    > 197 |     `).malloyResultMatches(expressionModel, {
          |        ^
      198 |       'airport_count': 5023,
      199 |     });
      200 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:197:8)

  ● redshift › model: turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      202 |   // turtle expressions
      203 |   it('model: turtle', async () => {
    > 204 |     await expect('run: aircraft->by_manufacturer').malloyResultMatches(
          |                                                    ^
      205 |       expressionModel,
      206 |       {manufacturer: 'CESSNA'}
      207 |     );

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:204:52)

  ● redshift › model: filtered turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      214 |         nest: b is by_manufacturer + { where: aircraft_models.manufacturer ?~'B%'}
      215 |       }
    > 216 |     `).malloyResultMatches(expressionModel, {'b.manufacturer': 'BEECH'});
          |        ^
      217 |   });
      218 |
      219 |   // having.

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:216:8)

  ● redshift › model: simple having

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      227 |         limit: 2
      228 |       }
    > 229 |     `).malloyResultMatches(expressionModel, {aircraft_count: 91});
          |        ^
      230 |   });
      231 |
      232 |   test.when(runtime.supportsNesting)('model: having in a nest', async () => {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:229:8)

  ● redshift › model: having in a nest

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      245 |         }
      246 |       }
    > 247 |     `).malloyResultMatches(expressionModel, {'by_state.state': 'VA'});
          |        ^
      248 |   });
      249 |
      250 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:247:8)

  ● redshift › model: turtle having on main

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      270 |         }
      271 |       }
    > 272 |     `).malloyResultMatches(expressionModel, {
          |        ^
      273 |         'by_state.by_city.city': 'ALBUQUERQUE',
      274 |       });
      275 |     }

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:272:8)

  ● redshift › model: having float group by partition

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^
    line 31: 'engines' is not defined
      |             group_by: engines
      |                       ^

      291 |             aggregate: aircraft_model_count
      292 |           }
    > 293 |       }`).malloyResultMatches(runtime, {aircraft_model_count: 448});
          |           ^
      294 |     }
      295 |   );
      296 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:293:11)

  ● redshift › model: aggregate functions distinct min max

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      310 |           boeing_max_model is max(model) { where: manufacturer ? 'BOEING'},
      311 |       }
    > 312 |     `).malloyResultMatches(expressionModel, {
          |        ^
      313 |       distinct_seats: 187,
      314 |       boeing_distinct_seats: 85,
      315 |       min_seats: 0,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:312:8)

  ● redshift › model: dates named

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 't_date' is not defined
      |           t_date,
      |           ^
    line 5: 't_date' is not defined
      |           t_date_month is t_date.month,
      |                           ^
    line 6: 't_date' is not defined
      |           t_date_year is t_date.year,
      |                          ^
    line 7: 't_timestamp' is not defined
      |           t_timestamp,
      |           ^
    line 8: 't_timestamp' is not defined
      |           t_timestamp_date is t_timestamp.day,
      |                               ^
    line 9: 't_timestamp' is not defined
      |           t_timestamp_hour is t_timestamp.hour,
      |                               ^
    line 10: 't_timestamp' is not defined
      |           t_timestamp_minute is t_timestamp.minute,
      |                                 ^
    line 11: 't_timestamp' is not defined
      |           t_timestamp_second is t_timestamp.second,
      |                                 ^
    line 12: 't_timestamp' is not defined
      |           t_timestamp_month is t_timestamp.month,
      |                                ^
    line 13: 't_timestamp' is not defined
      |           t_timestamp_year is t_timestamp.year,
      |                               ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'date',
          name: 't_date_month',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 10 },
              end: { line: 4, character: 38 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_date.month'
        },
        {
          type: 'date',
          name: 't_date_year',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 10 },
              end: { line: 5, character: 36 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_date.year'
        },
        {
          type: 'date',
          name: 't_timestamp_date',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.day'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_hour',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 8, character: 10 },
              end: { line: 8, character: 46 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.hour'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_minute',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 10 },
              end: { line: 9, character: 50 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.minute'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_second',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 10, character: 10 },
              end: { line: 10, character: 50 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.second'
        },
        {
          type: 'date',
          name: 't_timestamp_month',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 10 },
              end: { line: 11, character: 48 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.month'
        },
        {
          type: 'date',
          name: 't_timestamp_year',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 12, character: 10 },
              end: { line: 12, character: 46 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.year'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 't_date_month', dir: 'desc' } ]
    }
      |       run: redshift.table('malloytest.alltypes')->{
      |            ^

      343 |           t_timestamp_year is t_timestamp.year,
      344 |       }
    > 345 |     `).malloyResultMatches(runtime, {
          |        ^
      346 |         t_date: new Date('2020-03-02'),
      347 |         t_date_month: new Date('2020-03-01'),
      348 |         t_date_year: new Date('2020-01-01'),

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:345:8)

  ● redshift › named query metadata undefined

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › named query metadata named

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › named query metadata named head of pipeline

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › filtered explores basic

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      399 |       run: aircraft extend { where: aircraft_models.manufacturer ? ~'B%' }
      400 |         -> {aggregate: m_count is count(aircraft_models.manufacturer) }
    > 401 |     `).malloyResultMatches(expressionModel, {m_count: 63});
          |        ^
      402 |   });
      403 |
      404 |   const nativeInt = databaseName === 'mysql' ? 'signed' : 'integer';

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:401:8)

  ● redshift › sql cast

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      408 |         group_by: a is "312"::"${nativeInt}"
      409 |       }
    > 410 |     `).malloyResultMatches(expressionModel, {a: 312});
          |        ^
      411 |   });
      412 |
      413 |   it('case expressions', async () => {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:410:8)

  ● redshift › case expressions

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      422 |           valuey is case manufacturer when 'BOEING' then 'BOEING' else 'NOT BOEING' end
      423 |       }
    > 424 |     `).malloyResultMatches(expressionModel, [
          |        ^
      425 |       {other: 'BOEING', nully: 'BOEING', valuey: 'BOEING'},
      426 |       {other: 'OTHER', nully: null, valuey: 'NOT BOEING'},
      427 |     ]);

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:424:8)

  ● redshift › sql safe cast

    Expected events - Expected
    + Received

      Array [
        Object {
          "data": Object {
    -       "code": "dialect-cast-unsafe-only",
    +       "code": "invalid-sql-source",
    +       "data": null,
    +       "message": "Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED",
          },
          "id": "translation-error",
        },
      ]

      443 |       });
      444 |     } else {
    > 445 |       await expect(safeCast).toEmitDuringTranslation(runtime, {
          |                              ^
      446 |         id: 'translation-error',
      447 |         data: {code: 'dialect-cast-unsafe-only'},
      448 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:445:30)

  ● redshift › many_field.sum() has correct locality

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'year_built' is not defined
      |         dimension: a_year_built is a.year_built
      |                                    ^
    line 4: 'aircraft_model_code' is not defined
      |         join_many: a on a.aircraft_model_code = a.aircraft_model_code
      |                         ^
    line 4: 'aircraft_model_code' is not defined
      |         join_many: a on a.aircraft_model_code = a.aircraft_model_code
      |                                                 ^

      462 |         aggregate: avg_a_year_built2 is floor(a.avg(a_year_built))
      463 |       }
    > 464 |     `).malloyResultMatches(runtime, {
          |        ^
      465 |       avg_a_year_built1: 1969,
      466 |       avg_a_year_built2: 1969,
      467 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:464:8)

  ● redshift › sql expr functions › sql_string

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      477 |           group_by: string_1 is sql_string("UPPER(\${manufacturer})")
      478 |         }
    > 479 |       `).malloyResultMatches(expressionModel, {
          |          ^
      480 |         string_1: 'AHRENS AIRCRAFT CORP.',
      481 |       });
      482 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:479:10)

  ● redshift › sql expr functions › sql_number

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      491 |           group_by: number_1 is sql_number("\${seats} * 2")
      492 |         }
    > 493 |   `).malloyResultMatches(expressionModel, {
          |      ^
      494 |         seats: 29,
      495 |         number_1: 58,
      496 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:493:6)

  ● redshift › sql expr functions › sql_number can be sum()med

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      508 |           aggregate: s is number_1.sum()
      509 |         }
    > 510 |       `).malloyResultMatches(expressionModel, {
          |          ^
      511 |         s: 58,
      512 |       });
      513 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:510:10)

  ● redshift › sql expr functions › sql_boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      522 |           group_by: boolean_2 is sql_boolean("\${engines} = 2")
      523 |         }
    > 524 |   `).malloyResultMatches(expressionModel, {
          |      ^
      525 |         boolean_1: booleanResult(true, databaseName),
      526 |         boolean_2: booleanResult(false, databaseName),
      527 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:524:6)

  ● redshift › sql expr functions › sql_date

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      536 |           group_by: date_1 is sql_date("\${last_action_date}")
      537 |         }
    > 538 |   `).malloyResultMatches(expressionModel, {
          |      ^
      539 |         date_1: new Date('2000-01-04T00:00:00.000Z'),
      540 |       });
      541 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:538:6)

  ● redshift › sql expr functions › sql_timestamp

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      549 |         group_by: timestamp_1 is sql_timestamp("\${last_action_date}")
      550 |         }
    > 551 |   `).malloyResultMatches(expressionModel, {
          |      ^
      552 |         timestamp_1: new Date('2000-01-04T00:00:00.000Z'),
      553 |       });
      554 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:551:6)

  ● redshift › sql expr functions › with ${TABLE}.field

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      562 |           group_by: string_1 is sql_string('UPPER(\${TABLE}.${q`manufacturer`})')
      563 |         }
    > 564 |       `).malloyResultMatches(expressionModel, {
          |          ^
      565 |         string_1: 'AHRENS AIRCRAFT CORP.',
      566 |       });
      567 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:564:10)

  ● redshift › sql expr functions › with ${field}

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      575 |           group_by: string_1 is sql_string("UPPER(\${manufacturer})")
      576 |         }
    > 577 |       `).malloyResultMatches(expressionModel, {
          |          ^
      578 |         string_1: 'AHRENS AIRCRAFT CORP.',
      579 |       });
      580 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:577:10)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.dimension_name} - one path

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found ${a.manufacturer}"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:596:43)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.dimension_name} - multiple paths

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found (${a.seats}, ${a.seats}, ${a.total_seats})"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:612:43)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.SQL_TABLE_NAME}

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found ${a.SQL_TABLE_NAME}"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:628:43)

  ● redshift › query with aliasname used twice

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      654 |             order_by: 2 desc, 1
      655 |         }
    > 656 |       `).malloyResultMatches(expressionModel, {first_three: 'SAB'});
          |          ^
      657 |     }
      658 |   );
      659 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:656:10)

  ● redshift › joined filtered sources

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      676 |           aircraft_count
      677 |       }
    > 678 |     `).malloyResultMatches(expressionModel, {
          |        ^
      679 |       model_count: 244,
      680 |       aircraft_count: 3599,
      681 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:678:8)

  ● redshift › joined filtered explores with NO dependencies

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         primary_key: state
      |         ^
    line 7: 'state' is not defined
      |       source: al is sf extend {where: state = 'AL'}
      |                                       ^
    line 11: 'state' is not defined
      |         join_one: al with state
      |                           ^
    line 11: join_one: Primary key 'undefined' not found in source
      |         join_one: al with state
      |                   ^
    line 10: 'state' is not defined
      |         where: state ~ 'A%'
      |                ^
    line 15: 'state' is not defined
      |         join_one: a with state
      |                          ^
    line 15: join_one: Primary key 'undefined' not found in source
      |         join_one: a with state
      |                   ^
    line 18: INTERNAL ERROR model/Segment.nextStructDef: state not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'allx',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 19, character: 10 },
              end: { line: 19, character: 29 }
            }
          },
          e: { node: 'field', path: [ 'state_count' ] },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'state_count'
        },
        {
          type: 'number',
          numberType: 'integer',
          name: 'a',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 20, character: 10 },
              end: { line: 20, character: 28 }
            }
          },
          e: { node: 'field', path: [ 'a', 'state_count' ] },
          compositeFieldUsage: {
            fields: [],
            joinedUsage: { a: { fields: [], joinedUsage: {} } }
          },
          expressionType: 'aggregate',
          code: 'a.state_count'
        },
        {
          type: 'number',
          numberType: 'integer',
          name: 'al',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 21, character: 10 },
              end: { line: 21, character: 32 }
            }
          },
          e: { node: 'field', path: [ 'a', 'al', 'state_count' ] },
          compositeFieldUsage: {
            fields: [],
            joinedUsage: {
              a: {
                fields: [],
                joinedUsage: { al: { fields: [], joinedUsage: {} } }
              }
            }
          },
          expressionType: 'aggregate',
          code: 'a.al.state_count'
        }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: {
          a: {
            fields: [],
            joinedUsage: { al: { fields: [], joinedUsage: {} } }
          }
        }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'allx', dir: 'desc' } ]
    }
      |       run: allx -> {
      |            ^

      741 |           al is a.al.state_count
      742 |       }
    > 743 |     `).malloyResultMatches(runtime, {allx: 51, a: 4, al: 1});
          |        ^
      744 |   });
      745 | });
      746 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:743:8)

  ● redshift › string literal quoting › quote single character

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string literal quoting › quote single quote

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string literal quoting › quote double quote

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") -> {
      |      ^

      811 |           select: double_quote is "${back}${dq}"
      812 |         }`
    > 813 |       ).malloyResultMatches(runtime, {double_quote: '"'});
          |         ^
      814 |     });
      815 |     test('quote backslash', async () => {
      816 |       expect(await sqlEq(`'${back}${back}'`, back)).isSqlEq();

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:813:9)

  ● redshift › string literal quoting › quote backslash

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › nullish ?? operator

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/ee967c00-89dc-54d5-9638-72ded1fcbf4c: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 5: 'null_value' is not defined
      |         where: null_value is null
      |                ^
    line 7: 'null_value' is not defined
      |           found_null is  null_value ?? 'correct',
      |                          ^
    line 8: 'string_value' is not defined
      |           else_pass is string_value ?? 'incorrect'
      |                        ^

      830 |           literal_null is null ?? 'correct'
      831 |       }`
    > 832 |     ).malloyResultMatches(runtime, {
          |       ^
      833 |       found_null: 'correct',
      834 |       else_pass: 'correct',
      835 |       literal_null: 'correct',

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:832:7)

  ● redshift › null safe booleans › select boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> {
      |                          ^
    line 12: 'tf' is not defined
      |           null_boolean is tf
      |                           ^

      854 |         select:
      855 |           null_boolean is tf
    > 856 |       }`).malloyResultMatches(runtime, {null_boolean: null});
          |           ^
      857 |     });
      858 |     it('not boolean', async () => {
      859 |       await expect(`run: ${nulls} -> {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:856:11)

  ● redshift › null safe booleans › not boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> {
      |                          ^
    line 12: 'tf' is not defined
      |           not_null_boolean is not tf
      |                                   ^

      860 |         select:
      861 |           not_null_boolean is not tf
    > 862 |       }`).malloyResultMatches(runtime, {not_null_boolean: is_true});
          |           ^
      863 |     });
      864 |     it('numeric != non-null to null', async () => {
      865 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:862:11)

  ● redshift › null safe booleans › numeric != non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is x != 9 }
      |                          ^
    line 10: 'x' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is x != 9 }
      |                                                              ^

      865 |       await expect(
      866 |         `run: ${nulls} -> { select: val_ne_null is x != 9 }`
    > 867 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      868 |     });
      869 |     it('string !~ non-null to null', async () => {
      870 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:867:9)

  ● redshift › null safe booleans › string !~ non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ 'z' }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ 'z' }
      |                                                              ^

      870 |       await expect(
      871 |         `run: ${nulls} -> { select: val_ne_null is a !~ 'z' }`
    > 872 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      873 |     });
      874 |     it('regex !~ non-null to null', async () => {
      875 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:872:9)

  ● redshift › null safe booleans › regex !~ non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ r'z' }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ r'z' }
      |                                                              ^

      875 |       await expect(
      876 |         `run: ${nulls} -> { select: val_ne_null is a !~ r'z' }`
    > 877 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      878 |     });
      879 |     it('numeric != null-to-null', async () => {
      880 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:877:9)

  ● redshift › null safe booleans › numeric != null-to-null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                          ^
    line 10: 'x' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                                                               ^
    line 10: 'y' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                                                                    ^

      880 |       await expect(
      881 |         `run: ${nulls} -> { select: null_ne_null is x != y }`
    > 882 |       ).malloyResultMatches(runtime, {null_ne_null: is_true});
          |         ^
      883 |     });
      884 |     it('string !~ null-to-null', async () => {
      885 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:882:9)

  ● redshift › null safe booleans › string !~ null-to-null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                                                               ^
    line 10: 'b' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                                                                    ^

      885 |       await expect(
      886 |         `run: ${nulls} -> { select: null_ne_null is a !~ b }`
    > 887 |       ).malloyResultMatches(runtime, {null_ne_null: is_true});
          |         ^
      888 |     });
      889 |   });
      890 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:887:9)

  ● redshift › dimension expressions expanded with parens properly

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      898 |           paren is    false and (fot)
      899 |       }`
    > 900 |     ).malloyResultMatches(runtime, {
          |       ^
      901 |       paren: booleanResult(false, databaseName),
      902 |       no_paren: booleanResult(false, databaseName),
      903 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:900:7)

  console.log
    BRIAN fianl status check: {
      '$metadata': {
        httpStatusCode: 200,
        requestId: '0609c098-95ce-4ba0-95de-342ea9670af5',
        extendedRequestId: undefined,
        cfId: undefined,
        attempts: 1,
        totalRetryDelay: 0
      },
      CreatedAt: 2025-02-27T01:30:47.532Z,
      Database: 'dev',
      Duration: 93949885,
      HasResultSet: true,
      Id: 'd3a01d54-bcf2-44fe-875a-e6c0d5b3b34e',
      RedshiftPid: 1073774701,
      RedshiftQueryId: 0,
      ResultFormat: 'json',
      ResultRows: -1,
      ResultSize: -1,
      SecretArn: 'arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg',
      Status: 'FINISHED',
      SubStatements: [
        {
          CreatedAt: 2025-02-27T01:30:47.646Z,
          Duration: 44127009,
          HasResultSet: false,
          Id: 'd3a01d54-bcf2-44fe-875a-e6c0d5b3b34e:1',
          QueryString: 'SET search_path TO malloytest;',
          RedshiftQueryId: 0,
          ResultRows: 0,
          ResultSize: 0,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:47.967Z
        },
        {
          CreatedAt: 2025-02-27T01:30:47.649Z,
          Duration: 49822876,
          HasResultSet: true,
          Id: 'd3a01d54-bcf2-44fe-875a-e6c0d5b3b34e:2',
          QueryString: 'SELECT type as "data_type", "column" as "col_name"\n' +
            '      FROM pg_table_def\n' +
            "      WHERE tablename = 'state_facts';",
          RedshiftQueryId: 0,
          ResultRows: 5,
          ResultSize: 112,
          Status: 'FINISHED',
          UpdatedAt: 2025-02-27T01:30:48.188Z
        }
      ],
      UpdatedAt: 2025-02-27T01:30:48.246Z,
      WorkgroupName: 'default-workgroup'
    }

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:336:17)

  console.log
    BRIAN table schema rows: [
      { data_type: 'character varying(256)', col_name: 'state' },
      { data_type: 'bigint', col_name: 'aircraft_count' },
      { data_type: 'bigint', col_name: 'airport_count' },
      { data_type: 'bigint', col_name: 'births' },
      { data_type: 'character varying(256)', col_name: 'popular_name' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:233:13)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:350:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:351:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpdc2ce287ed7843eea021da8cae47aa91;\n' +
        '      create temp table tmpdc2ce287ed7843eea021da8cae47aa91 as SELECT * FROM (\n' +
        '        SELECT 1 as "one" \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpdc2ce287ed7843eea021da8cae47aa91';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:15)

  console.log
    Error in SQL:

          drop table if exists tmpdc2ce287ed7843eea021da8cae47aa91;
          create temp table tmpdc2ce287ed7843eea021da8cae47aa91 as SELECT * FROM (
            SELECT 1 as "one"
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpdc2ce287ed7843eea021da8cae47aa91';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/sql_expressions.spec.ts (13.87 s)
  ✕ sql expression with turducken - redshift (1925 ms)
  ✕ sql expression in second of two queries in same block, dependent on first query - redshift (46 ms)
  ✕ sql expression in other sql expression - redshift (1413 ms)
  ✕ run sql expression as query - redshift (10 ms)

  ● sql expression with turducken - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 23 },
              end: { line: 4, character: 35 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |           redshift.table('malloytest.state_facts') -> {
      |           ^
    line 3: Invalid SQL, Error: Redefinition of undefined
      |         """SELECT * FROM (%{
      |         ^

      47 |         }) AS state_facts """
      48 |       ) -> { select: * }
    > 49 |     `).malloyResultMatches(runtime, {c: 51});
         |        ^
      50 |   });
      51 |   it(`sql expression in second of two queries in same block, dependent on first query - ${databaseName}`, async () => {
      52 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:49:8)

  ● sql expression in second of two queries in same block, dependent on first query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |         a is redshift.table('malloytest.state_facts') -> {
      |              ^
    line 7: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |           """SELECT * FROM (%{ a -> { select: * } }) AS state_facts """
      |                                ^
    line 7: Invalid SQL, Error: Redefinition of undefined
      |           """SELECT * FROM (%{ a -> { select: * } }) AS state_facts """
      |           ^

      59 |         ) -> { select: * }
      60 |       run: b
    > 61 |     `).malloyResultMatches(runtime, {c: 51});
         |        ^
      62 |   });
      63 |   it(`sql expression in other sql expression - ${databaseName}`, async () => {
      64 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:61:8)

  ● sql expression in other sql expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: Invalid SQL, Error fetching SELECTschema for sql://redshift/48724aa7-019f-58ec-95f8-f2869d7db6a5: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           redshift.sql("""SELECT 1 as "one" """) -> { group_by: one }
      |                        ^
    line 4: 'one' is not defined
      |           redshift.sql("""SELECT 1 as "one" """) -> { group_by: one }
      |                                                                 ^
    line 2: Invalid SQL, Error: Unknown Dialect ~malformed~
      |       run: redshift.sql("""
      |                         ^
    line 6: 'one' is not defined
      |       """) -> { group_by: one }
      |                           ^

      68 |         }) as the_table
      69 |       """) -> { group_by: one }
    > 70 |     `).malloyResultMatches(runtime, {one: 1});
         |        ^
      71 |   });
      72 |   it(`run sql expression as query - ${databaseName}`, async () => {
      73 |     await expect(

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:70:8)

  ● run sql expression as query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/48724aa7-019f-58ec-95f8-f2869d7db6a5: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""SELECT 1 as "one" """)
      |                   ^

      73 |     await expect(
      74 |       `run: ${databaseName}.sql("""SELECT 1 as ${q`one`} """)`
    > 75 |     ).malloyResultMatches(runtime, {one: 1});
         |       ^
      76 |   });
      77 | });
      78 |

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:75:7)

PASS packages/malloy/src/lang/test/expressions.spec.ts
  expressions
    ✓ field name (2 ms)
    ✓ function call (3 ms)
    ✓ raw function call codegen (2 ms)
    ✓ filtered measure (4 ms)
    ✓ filtered ungrouped aggregate (23 ms)
    ✓ correctly flags filtered scalar (1 ms)
    ✓ correctly flags filtered analytic (3 ms)
    ✓ can use calculate with partition by in select (29 ms)
    ✓ paren and applied div (1 ms)
    ✓ Can compare field ats (type timestamp) to NULL (1 ms)
    ✓ Can compare field ad (type date) to NULL (1 ms)
    ✓ Can compare field ai (type number) to NULL
    ✓ Can compare field astr (type string) to NULL (1 ms)
    ✓ Can compare field abool (type boolean) to NULL (1 ms)
    timeframes
      ✓ timestamp truncate second (178 ms)
      ✓ date truncate week (3 ms)
      ✓ timestamp difference - second (19 ms)
      ✓ timestamp difference - second (3 ms)
    operators
      ✓ addition (2 ms)
      ✓ typecheck addition lhs (3 ms)
      ✓ typecheck addition rhs (3 ms)
      ✓ subtraction (1 ms)
      ✓ multiplication (2 ms)
      ✓ mod (1 ms)
      ✓ division (2 ms)
      ✓ unary negation (1 ms)
      ✓ equal (6 ms)
      ✓ not equal (1 ms)
      ✓ greater than (2 ms)
      ✓ greater than or equal (1 ms)
      ✓ less than or equal (2 ms)
      ✓ less than (2 ms)
      ✓ match (3 ms)
      ✓ not match (2 ms)
      ✓ regexp-match (1 ms)
      ✓ not regexp-match (1 ms)
      ✓ apply as equality (3 ms)
      ✓ not (4 ms)
      ✓ and (2 ms)
      ✓ or (5 ms)
      ✓ null-check (??) (5 ms)
      ✓ normal is-null (1 ms)
      ✓ normal is-not-null (1 ms)
      ✓ apply is-null (1 ms)
      ✓ apply is-not-null (1 ms)
      ✓ coalesce type mismatch (3 ms)
      ✓ disallow date OP number (1 ms)
      ✓ disallow date OP timestamp (1 ms)
      ✓ disallow interval from date to timestamp (1 ms)
      ✓ compare to truncation uses straight comparison (1 ms)
      ✓ compare to granular result expression uses straight comparison (2 ms)
      ✓ apply granular-truncation uses range (2 ms)
      ✓ apply granular-literal alternation uses all literals for range (1 ms)
      ✓ apply followed by another condition (1 ms)
      ✓ apply followed by another condition, with parenthesis (3 ms)
      ✓ apply or-tree granular-literal doesnt turn into IN (2 ms)
      ✓ comparison promotes date literal to timestamp (1 ms)
      ✓ can apply range to date (9 ms)
      ✓ disallow date delta second (9 ms)
      ✓ disallow date delta minute (8 ms)
      ✓ disallow date delta hour (8 ms)
      ✓ apply with parens (2 ms)
      sql friendly warnings
        ✓ = null with warning (2 ms)
        ✓ is not null with warning (1 ms)
        ✓ like with warning (6 ms)
        ✓ NOT LIKE with warning (2 ms)
        ✓ x is expr y is not null (12 ms)
        ✓ not null::number (2 ms)
        ✓ (not null)::number (1 ms)
    expr props
      ✓ aggregate order by not allowed without experiments enabled (4 ms)
      ✓ aggregate limit not allowed without experiments enabled (4 ms)
      ✓ aggregate order_by not allowed with different experiment enabled (4 ms)
      ✓ aggregate limit not allowed with different experiment enabled (2 ms)
      ✓ props not allowed on most expressions (5 ms)
      ✓ analytics can take parititon_by and order_by (3 ms)
      ✓ partition by works with scalar and aggregate (4 ms)
      ✓ partition by fails with analytic and ungrouped aggregate (4 ms)
      ✓ analytics order_by requires expression (4 ms)
      ✓ string_agg_distinct order by cannot specify expression (3 ms)
      ✓ string_agg_distinct order by can be just direction (2 ms)
      ✓ string_agg order by can be just direction (4 ms)
      ✓ can specify multiple partition_bys (19 ms)
      ✓ can specify multiple order_bys (3 ms)
      ✓ aggregate order by cannot be aggregate (2 ms)
      ✓ aggregate order by cannot be analytic (2 ms)
      ✓ analytic order by can be an aggregate (3 ms)
      ✓ analytic order by can be an output field (1 ms)
      ✓ analytic order by must be an output field (2 ms)
      ✓ can specify multiple wheres (3 ms)
      ✓ string_agg can take order_by (5 ms)
    aggregate forms
      ✓ one.column.min() (3 ms)
      ✓ one.min(one.column) (1 ms)
      ✓ min(one.column) (2 ms)
      ✓ min(many.column) (2 ms)
      ✓ min() (1 ms)
      ✓ source.min(column) (2 ms)
      ✓ many.column.max() (2 ms)
      ✓ max(many.column) (2 ms)
      ✓ max() (1 ms)
      ✓ source.max(many.column) (4 ms)
      ✓ many.column.count() (1 ms)
      ✓ count() (2 ms)
      ✓ count(many.column) (2 ms)
      ✓ source.count() (1 ms)
      ✓ many.count() (1 ms)
      ✓ sum() (1 ms)
      ✓ sum(column) (2 ms)
      ✓ sum(column * 2) (2 ms)
      ✓ column.sum() (2 ms)
      ✓ source.sum(column) (2 ms)
      ✓ sum(many.column) (3 ms)
      ✓ source.sum(many.column) (2 ms)
      ✓ many.column.sum() (2 ms)
      ✓ many.sum(many.column) (2 ms)
      ✓ sum(one.column) (2 ms)
      ✓ sum(many.constant) (2 ms)
      ✓ source.sum(many.constant) (2 ms)
      ✓ sum(nested.column) (2 ms)
      ✓ nested.column.sum() (2 ms)
      ✓ source.sum(nested.column) (3 ms)
      ✓ can aggregate field defined with no join usage (3 ms)
      ✓ sum(inline.column) (2 ms)
      ✓ inline.column.sum() (2 ms)
      ✓ source.sum(inline.column) (2 ms)
      ✓ sum(many.field) (2 ms)
      ✓ source.sum(many.field) (2 ms)
      ✓ many.field.sum() (2 ms)
      ✓ many.sum(many.field) (2 ms)
      ✓ sum(many.field + many.field) (3 ms)
      ✓ source.sum(many.field + many.field) (3 ms)
      ✓ many.field + many.field.sum() (3 ms)
      ✓ many.sum(many.field + many.field) (2 ms)
      ✓ sum(many_field) (2 ms)
      ✓ source.sum(many_field) (1 ms)
      ✓ many_field.sum() (1 ms)
      ✓ many.sum(many_field) (2 ms)
      ✓ sum(one.many_field) (2 ms)
      ✓ source.sum(one.many_field) (2 ms)
      ✓ one.many_field.sum() (3 ms)
      ✓ many.sum(one.many_field) (2 ms)
      ✓ sum(many.field + one.field) (2 ms)
      ✓ source.sum(many.field + one.field) (2 ms)
      ✓ many.sum(many.field + one.field) (2 ms)
      ✓ many_one_field.sum() (2 ms)
      ✓ sum(many_one_field) (2 ms)
      ✓ source.sum(many_one_field) (2 ms)
      ✓ many.sum(many_one_field) (2 ms)
      ✓ sum(many.one.field) (2 ms)
      ✓ sum(many.one.one.field) (2 ms)
      ✓ many.avg(field) (2 ms)
      ✓ one.avg(field) (2 ms)
      ✓ cross.avg(field) (2 ms)
      ✓ cross.avg(cross.field) (2 ms)
      ✓ one.column.sum() (1 ms)
      ✓ one.sum(one.column) (2 ms)
      ✓ source.sum(one.column) (2 ms)
      ✓ sum(one.column + one.column) (2 ms)
      ✓ one.sum(one.column + one.column) (3 ms)
      ✓ source.sum(one.column + one.column) (2 ms)
      ✓ lag(sum(output)) (2 ms)
    case statements
      ✓ full (5 ms)
      ✓ with value (2 ms)
      ✓ no else (1 ms)
      ✓ wrong then type (2 ms)
      ✓ wrong when type (1 ms)
      ✓ wrong else type (1 ms)
      ✓ null then type okay second (1 ms)
      ✓ null then type okay first (2 ms)
      ✓ null else type okay (1 ms)
      ✓ null then type before else okay (1 ms)
      ✓ non boolean when (1 ms)
      ✓ type of null then second (1 ms)
      ✓ type of null then first (1 ms)
      ✓ type of null else (1 ms)
      ✓ type of null then type before else (1 ms)
      ✓ replacement for full case
      ✓ replacement for case with no else
      ✓ replacement for case with value
      ✓ interaction with pick (12 ms)
    pick statements
      ✓ full (7 ms)
      ✓ applied (2 ms)
      ✓ filtering (2 ms)
      ✓ null branch with else (6 ms)
      ✓ null branch no else (1 ms)
      ✓ null branch no apply (1 ms)
      ✓ tiering (2 ms)
      ✓ transforming (1 ms)
      ✓ when single values (1 ms)
      ✓ n-ary without else (2 ms)
      ✓ n-ary with mismatch when clauses (3 ms)
      ✓ n-ary with mismatched else clause (2 ms)
      ✓ applied else mismatch (1 ms)
      ✓ applied default mismatch (3 ms)
      ✓ applied when mismatch (2 ms)
  alternations as in
    ✓ a=b|c (1 ms)
    ✓ a!=b|c (1 ms)
    ✓ a=(b|c)
    ✓ a?b|c (2 ms)
    ✓ a=(b)|c (1 ms)
    ✓ a=b|c|d (2 ms)
    ✓ a=(b|c)|d (1 ms)
    ✓ a=b|(c|d) (2 ms)
    ✓ a=b|c&d (1 ms)
    ✓ a=b|>d (2 ms)
    ✓ a ? (= (b | c)) (1 ms)
    ✓ legacy in (2 ms)
    ○ skipped a ? (( =1) | 2)
  sql native fields in schema
    ✓ sql native reference in result allowed (1 ms)
    ✓ sql native reference can be compared to NULL (4 ms)
    ✓ flag unsupported equality (2 ms)
    ✓ flag unsupported compare (2 ms)
    ✓ allow unsupported equality when raw types match (2 ms)
    ✓ flag not applied to unsupported (1 ms)
    ✓ allow unsupported to be cast (2 ms)
    ✓ negative numbers are not tokens (1 ms)
    sql functions
      ✓ can aggregate a sql_ function (2 ms)
      ✓ error when interpolating field that does not exist (1 ms)
      ✓ error when using sql_ function without experiment (1 ms)
    cast
      ✓ sql cast (5 ms)
      ✓ sql safe cast (3 ms)
      ✓ malloy cast (2 ms)
      ✓ malloy safe cast (1 ms)
      ✓ sql cast illegal type name (1 ms)

Test Suites: 2 failed, 1 skipped, 1 passed, 3 of 4 total
Tests:       55 failed, 27 skipped, 222 passed, 304 total
Snapshots:   0 total
Time:        42.293 s
Ran all test suites matching /expr/i.
