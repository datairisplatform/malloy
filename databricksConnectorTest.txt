
> malloy@0.0.1 test
> jest --runInBand nomodel

  console.log
    BRIAN expected: {"zero_bare":0,"zero_paren":0}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { r: 1, zero: 0, zero_bare: 0, zero_paren: 0 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   1.0 as r,\n   1-(RANK() OVER(  ORDER BY  1.0 asc NULLS LAST )) as zero,\n   0-(1-(RANK() OVER(  ORDER BY  1.0 asc NULLS LAST ))) as zero_bare,\n   0-((1-(RANK() OVER(  ORDER BY  1.0 asc NULLS LAST )))) as zero_paren\nFROM malloytest.aircraft as base\nGROUP BY 1\nORDER BY 1 asc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"r","numberType":"integer","type":"number","resultMetadata":{"sourceField":"r","sourceExpression":"1.0","sourceClasses":["r"],"referenceId":"4c7ed4f8-fabb-41b1-bf96-2bfbb0ce113b","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":18},"end":{"line":2,"character":26}}}},{"name":"zero","type":"number","resultMetadata":{"sourceField":"zero","sourceExpression":"1 - rank()","sourceClasses":["zero"],"referenceId":"9b0e66c1-47f2-48ad-bf60-773399f80a0f","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":10},"end":{"line":5,"character":28}}}},{"name":"zero_bare","type":"number","resultMetadata":{"sourceField":"zero_bare","sourceExpression":"0 - zero","sourceClasses":["zero_bare"],"referenceId":"f873d5be-7b3a-4e0d-ad9a-83488ebd28bb","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":10},"end":{"line":6,"character":32}}}},{"name":"zero_paren","type":"number","resultMetadata":{"sourceField":"zero_paren","sourceExpression":"0 - (zero)","sourceClasses":["zero_paren"],"referenceId":"224470a1-a3ae-450f-880f-868caa191b38","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":10},"end":{"line":7,"character":34}}}}],"dialect":"postgres","primaryKey":"r","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"r","dir":"asc"}]}}],"sourceExplore":"databricks:malloytest.aircraft","connectionName":"databricks","result":[{"r":1,"zero":0,"zero_bare":0,"zero_paren":0}],"totalRows":1},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.aircraft","dialect":"postgres","tablePath":"malloytest.aircraft","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"tail_num","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"aircraft_serial","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"aircraft_model_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"aircraft_engine_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"number","numberType":"integer","name":"year_built","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"number","numberType":"integer","name":"aircraft_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"number","numberType":"integer","name":"aircraft_engine_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"number","numberType":"integer","name":"registrant_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"address1","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"address2","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"zip","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"country","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"certification","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"status_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"mode_s_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"string","name":"fract_owner","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"date","name":"last_action_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"date","name":"cert_issue_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},{"type":"date","name":"air_worth_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":50}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"r","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":18},"end":{"line":2,"character":26}}},"e":{"node":"numberLiteral","literal":"1.0"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"1.0"},{"type":"number","name":"zero","location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":10},"end":{"line":5,"character":28}}},"e":{"node":"-","kids":{"left":{"node":"numberLiteral","literal":"1"},"right":{"node":"function_call","overload":{"returnType":{"type":"number","expressionType":"scalar_analytic","evalSpace":"input"},"params":[],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[]},"src":["RANK(",")"]},"needsWindowOrderBy":true}}},"name":"rank","kids":{"args":[]},"expressionType":"scalar_analytic"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar_analytic","code":"1 - rank()"},{"type":"number","name":"zero_bare","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":10},"end":{"line":6,"character":32}}},"e":{"node":"-","kids":{"left":{"node":"numberLiteral","literal":"0"},"right":{"node":"outputField","name":"zero"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar_analytic","code":"0 - zero"},{"type":"number","name":"zero_paren","location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":10},"end":{"line":7,"character":34}}},"e":{"node":"-","kids":{"left":{"node":"numberLiteral","literal":"0"},"right":{"node":"()","e":{"node":"outputField","name":"zero"}}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar_analytic","code":"0 - (zero)"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"r","dir":"asc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":8,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"state":"WY"}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      { state: 'WY' }, { state: 'WV' }, { state: 'WI' },
      { state: 'WA' }, { state: 'VT' }, { state: 'VI' },
      { state: 'VA' }, { state: 'UT' }, { state: 'TX' },
      { state: 'TN' }, { state: 'SD' }, { state: 'SC' },
      { state: 'RI' }, { state: 'PR' }, { state: 'PA' },
      { state: 'OR' }, { state: 'OK' }, { state: 'OH' },
      { state: 'NY' }, { state: 'NV' }, { state: 'NM' },
      { state: 'NJ' }, { state: 'NH' }, { state: 'NE' },
      { state: 'ND' }, { state: 'NC' }, { state: 'MT' },
      { state: 'MS' }, { state: 'MO' }, { state: 'MN' },
      { state: 'MI' }, { state: 'ME' }, { state: 'MD' },
      { state: 'MA' }, { state: 'LA' }, { state: 'KY' },
      { state: 'KS' }, { state: 'IN' }, { state: 'IL' },
      { state: 'ID' }, { state: 'IA' }, { state: 'HI' },
      { state: 'GU' }, { state: 'GA' }, { state: 'FL' },
      { state: 'DE' }, { state: 'DC' }, { state: 'CT' },
      { state: 'CO' }, { state: 'CA' }, { state: 'AZ' },
      { state: 'AR' }, { state: 'AP' }, { state: 'AL' },
      { state: 'AK' }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage1","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.state as state\n  FROM malloytest.aircraft as base\n  WHERE base.state IS NOT NULL\n  GROUP BY 1\n)\nSELECT \n   base.state as state\nFROM __stage0 as base\nGROUP BY 1\nORDER BY 1 desc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage1","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"2137721d-3ac3-47c6-85e0-10d8404b14bc","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"state","dir":"desc"}]}}],"sourceExplore":"QuerySource-510888a3-12bb-41a8-9eff-8579c3627629","queryName":"foo","connectionName":"databricks","annotation":{"inherits":{}},"result":[{"state":"WY"},{"state":"WV"},{"state":"WI"},{"state":"WA"},{"state":"VT"},{"state":"VI"},{"state":"VA"},{"state":"UT"},{"state":"TX"},{"state":"TN"},{"state":"SD"},{"state":"SC"},{"state":"RI"},{"state":"PR"},{"state":"PA"},{"state":"OR"},{"state":"OK"},{"state":"OH"},{"state":"NY"},{"state":"NV"},{"state":"NM"},{"state":"NJ"},{"state":"NH"},{"state":"NE"},{"state":"ND"},{"state":"NC"},{"state":"MT"},{"state":"MS"},{"state":"MO"},{"state":"MN"},{"state":"MI"},{"state":"ME"},{"state":"MD"},{"state":"MA"},{"state":"LA"},{"state":"KY"},{"state":"KS"},{"state":"IN"},{"state":"IL"},{"state":"ID"},{"state":"IA"},{"state":"HI"},{"state":"GU"},{"state":"GA"},{"state":"FL"},{"state":"DE"},{"state":"DC"},{"state":"CT"},{"state":"CO"},{"state":"CA"},{"state":"AZ"},{"state":"AR"},{"state":"AP"},{"state":"AL"},{"state":"AK"}],"totalRows":55},"modelDef":{"name":"","exports":["q"],"contents":{"q":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.aircraft","dialect":"postgres","tablePath":"malloytest.aircraft","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"tail_num","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"aircraft_serial","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"aircraft_model_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"aircraft_engine_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"year_built","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"aircraft_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"aircraft_engine_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"registrant_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"address1","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"address2","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"zip","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"country","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"certification","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"status_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"mode_s_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"fract_owner","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"date","name":"last_action_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"date","name":"cert_issue_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"date","name":"air_worth_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state is not null","e":{"node":"is-not-null","e":{"node":"field","path":["state"]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"state","dir":"asc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":4,"character":7}}},"name":"q"}},"queryList":[{"type":"query","structRef":{"type":"query_source","name":"QuerySource-510888a3-12bb-41a8-9eff-8579c3627629","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"d3ba50e8-2dde-4acb-b471-38af9eaa5342","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"turtle","name":"foo","pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]}],"orderBy":[{"field":"state","dir":"desc"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"annotation":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":14},"end":{"line":9,"character":9}}}}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state is not null","e":{"node":"is-not-null","e":{"node":"field","path":["state"]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"state","dir":"asc"}]},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.aircraft","dialect":"postgres","tablePath":"malloytest.aircraft","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"tail_num","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"aircraft_serial","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"aircraft_model_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"aircraft_engine_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"year_built","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"aircraft_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"aircraft_engine_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"number","numberType":"integer","name":"registrant_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"address1","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"address2","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"zip","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"country","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"certification","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"status_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"mode_s_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"string","name":"fract_owner","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"date","name":"last_action_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"date","name":"cert_issue_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},{"type":"date","name":"air_worth_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":57}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state is not null","e":{"node":"is-not-null","e":{"node":"field","path":["state"]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"state","dir":"asc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":4,"character":7}}},"name":"q"},"parameters":{}},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]}],"orderBy":[{"field":"state","dir":"desc"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":11},"end":{"line":10,"character":14}}},"name":"foo","annotation":{"inherits":{}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"lower_state":"wy"}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { lower_state: 'wy' } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage1","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.state as state\n  FROM malloytest.state_facts as base\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 1\n)\nSELECT \n   LOWER(base.state) as lower_state\nFROM __stage0 as base\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage1","fields":[{"name":"lower_state","type":"string","resultMetadata":{"sourceField":"lower_state","sourceExpression":"lower(state)","sourceClasses":["lower_state"],"referenceId":"b664ee46-ce55-46b2-9bd2-7da8106812f3","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":21},"end":{"line":4,"character":48}}}}],"dialect":"postgres","primaryKey":"lower_state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"}}],"sourceExplore":"QuerySource-525a6062-5820-48ea-9ee4-f005253668e3","connectionName":"databricks","result":[{"lower_state":"wy"}],"totalRows":1},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"query_source","name":"QuerySource-525a6062-5820-48ea-9ee4-f005253668e3","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"965c9a19-7380-4dbc-b416-04ce16517742","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"string","name":"lower_state","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":21},"end":{"line":4,"character":48}}},"e":{"node":"function_call","overload":{"returnType":{"type":"string","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"value","allowedTypes":[{"type":"string","evalSpace":"input"}],"isVariadic":false}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["LOWER(",")"]}}}},"name":"lower","kids":{"args":[{"node":"field","path":["state"],"sql":"base.state"}]},"expressionType":"scalar"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"lower(state)"}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","limit":1,"orderBy":[{"field":"state","dir":"desc"}]},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]}],"orderBy":[{"field":"state","dir":"desc"}],"limit":1,"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":5,"character":34}}}},"parameters":{}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["lower_state"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":5,"character":34}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"avg_year":1969,"avg_seats":7}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { avg_seats: 7, avg_year: 1969 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   FLOOR(((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.seats, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0)))))) / NULLIF(COUNT(DISTINCT CASE WHEN base.seats IS NOT NULL THEN base.__distinct_key END), 0)) as avg_seats,\n   FLOOR(AVG(a_0.year_built)) as avg_year\nFROM (SELECT uuid() as __distinct_key, x.*  FROM malloytest.aircraft_models as x) as base\n LEFT JOIN malloytest.aircraft AS a_0\n  ON a_0.aircraft_model_code=base.aircraft_model_code\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"avg_seats","type":"number","resultMetadata":{"sourceField":"avg_seats","sourceExpression":"floor(avg(seats))","sourceClasses":["avg_seats"],"referenceId":"1d38a35e-b029-47be-8e14-f27db9687d84","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":17},"end":{"line":6,"character":47}}}},{"name":"avg_year","type":"number","resultMetadata":{"sourceField":"a.avg_year","sourceExpression":"floor(avg(year_built))","sourceClasses":["a.avg_year"],"referenceId":"c3e30cb0-4505-4619-ac80-ae76cece1a38","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":21},"end":{"line":4,"character":55}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"avg_seats","dir":"desc"}]}}],"sourceExplore":"m","connectionName":"databricks","result":[{"avg_seats":7,"avg_year":1969}],"totalRows":1},"modelDef":{"name":"","exports":["m"],"contents":{"m":{"type":"table","name":"databricks:malloytest.aircraft_models","dialect":"postgres","tablePath":"malloytest.aircraft_models","connection":"databricks","fields":[{"type":"string","name":"aircraft_model_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"string","name":"manufacturer","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"string","name":"model","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"aircraft_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"aircraft_engine_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"aircraft_category_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"amateur","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"engines","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"seats","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"weight","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","numberType":"integer","name":"speed","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":65}}}},{"type":"number","name":"avg_seats","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":17},"end":{"line":6,"character":47}}},"e":{"node":"function_call","overload":{"returnType":{"type":"number","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"value","allowedTypes":[{"type":"number","evalSpace":"input"}],"isVariadic":false}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}}}},"name":"floor","kids":{"args":[{"node":"aggregate","function":"avg","e":{"node":"field","path":["seats"]},"sql":"((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.seats, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0)))))) / NULLIF(COUNT(DISTINCT CASE WHEN base.seats IS NOT NULL THEN base.__distinct_key END), 0)"}]},"expressionType":"aggregate"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"floor(avg(seats))"},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.aircraft","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"tail_num","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"aircraft_serial","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"aircraft_model_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"aircraft_engine_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"number","numberType":"integer","name":"year_built","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"number","numberType":"integer","name":"aircraft_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"number","numberType":"integer","name":"aircraft_engine_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"number","numberType":"integer","name":"registrant_type_id","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"address1","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"address2","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"zip","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"region","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"country","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"certification","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"status_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"mode_s_code","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"string","name":"fract_owner","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"date","name":"last_action_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"date","name":"cert_issue_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"date","name":"air_worth_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":15},"end":{"line":3,"character":54}}}},{"type":"number","name":"avg_year","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":21},"end":{"line":4,"character":55}}},"e":{"node":"function_call","overload":{"returnType":{"type":"number","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"value","allowedTypes":[{"type":"number","evalSpace":"input"}],"isVariadic":false}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}}}},"name":"floor","kids":{"args":[{"node":"aggregate","function":"avg","e":{"node":"field","path":["year_built"]},"sql":"AVG(a_0.year_built)"}]},"expressionType":"aggregate"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"floor(avg(year_built))"}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":10},"end":{"line":5,"character":56}}},"parameters":{},"join":"many","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["a","aircraft_model_code"],"sql":"a_0.aircraft_model_code"},"right":{"node":"field","path":["aircraft_model_code"],"sql":"base.aircraft_model_code"}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":7,"character":7}}},"parameters":{},"as":"m"}},"queryList":[{"type":"query","structRef":"m","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["avg_seats"]},{"type":"fieldref","path":["a","avg_year"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"avg_seats","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":11},"end":{"line":8,"character":48}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"c":19701}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 19701 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   COALESCE(SUM(base.airport_count),0) as c\nFROM malloytest.state_facts as base\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","numberType":"integer","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"airport_count.sum()","sourceClasses":["c"],"referenceId":"b8dbdb27-a8ae-4fc7-89c9-34c3eeeab948","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":26},"end":{"line":5,"character":50}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"c","dir":"desc"}]}}],"sourceExplore":"b","connectionName":"databricks","result":[{"c":19701}],"totalRows":1},"modelDef":{"name":"","exports":["a","b"],"contents":{"a":{"type":"table","name":"databricks:malloytest.airports","dialect":"postgres","tablePath":"malloytest.airports","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"site_number","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"full_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"own_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"longitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"latitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"elevation","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"aero_cht","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"cbd_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cbd_dir","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"act_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cert","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fed_agree","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cust_intl","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"c_ldg_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"joint_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"mil_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cntl_twr","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"major","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":1,"character":58}}},"parameters":{},"as":"a"},"b":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":61}}}},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.airports","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"site_number","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"full_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"own_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"longitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"latitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"elevation","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"aero_cht","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"cbd_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cbd_dir","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"act_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cert","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fed_agree","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cust_intl","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"c_ldg_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"joint_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"mil_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cntl_twr","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"major","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":19},"end":{"line":3,"character":37}}},"parameters":{},"arguments":{},"join":"many","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"]},"right":{"node":"field","path":["a","state"]}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":14},"end":{"line":4,"character":7}}},"parameters":{},"as":"b"}},"queryList":[{"type":"query","structRef":"b","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":26},"end":{"line":5,"character":50}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"c","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":11},"end":{"line":5,"character":51}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: [{"state":null,"c":18605},{"state":"CA","c":984},{"state":"NH","c":112}]

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      { c: 18605, state: null },
      { c: 984, state: 'CA' },
      { c: 112, state: 'NH' }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as c,\n   a_0.state as state\nFROM (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) as base\n LEFT JOIN malloytest.airports AS a_0\n  ON base.state=a_0.state AND (a_0.state IN ('NH','CA'))\nGROUP BY 2\nORDER BY 1 desc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","numberType":"integer","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"airport_count.sum()","sourceClasses":["c"],"referenceId":"c6c9b737-0592-4497-9222-4cf44058ea1c","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":19},"end":{"line":7,"character":43}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"a.state","sourceClasses":["a.state"],"referenceId":"ec6f4339-bef6-4e77-897d-43e1da7ce8c3","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"c","dir":"desc"}]}}],"sourceExplore":"databricks:malloytest.state_facts","connectionName":"databricks","result":[{"c":18605,"state":null},{"c":984,"state":"CA"},{"c":112,"state":"NH"}],"totalRows":3},"modelDef":{"name":"","exports":["a"],"contents":{"a":{"type":"table","name":"databricks:malloytest.airports","dialect":"postgres","tablePath":"malloytest.airports","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"site_number","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"full_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"own_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"longitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"latitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"elevation","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"aero_cht","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"cbd_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cbd_dir","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"act_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cert","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fed_agree","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cust_intl","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"c_ldg_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"joint_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"mil_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cntl_twr","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"major","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":3,"character":7}}},"parameters":{},"filterList":[{"node":"filterCondition","code":"state = 'NH' | 'CA'","e":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["state"]},"oneOf":[{"node":"stringLiteral","literal":"NH"},{"node":"stringLiteral","literal":"CA"}]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"as":"a"}},"queryList":[{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":4,"character":53}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":4,"character":53}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":4,"character":53}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":4,"character":53}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":4,"character":53}}}},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.airports","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"code","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"site_number","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fac_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_region","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"faa_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"full_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"own_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"longitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"float","name":"latitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"elevation","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"aero_cht","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"number","numberType":"integer","name":"cbd_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cbd_dir","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"act_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cert","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"fed_agree","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cust_intl","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"c_ldg_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"joint_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"mil_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"cntl_twr","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}},{"type":"string","name":"major","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":58}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":19},"end":{"line":5,"character":37}}},"parameters":{},"filterList":[{"node":"filterCondition","code":"state = 'NH' | 'CA'","e":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["state"],"sql":"a_0.state"},"oneOf":[{"node":"stringLiteral","literal":"NH","sql":"'NH'"},{"node":"stringLiteral","literal":"CA","sql":"'CA'"}]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"arguments":{},"join":"many","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"],"sql":"base.state"},"right":{"node":"field","path":["a","state"],"sql":"a_0.state"}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":4,"character":53}}},"parameters":{}},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":19},"end":{"line":7,"character":43}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"},{"type":"fieldref","path":["a","state"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"c","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":9,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"c":19701}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 19701 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(a_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as c\nFROM malloytest.airports as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) AS a_0\n  ON base.state=a_0.state\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","numberType":"integer","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"a.airport_count.sum()","sourceClasses":["c"],"referenceId":"7986c4cb-dd1b-411d-a812-142cb4dd67c6","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":19},"end":{"line":6,"character":45}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"c","dir":"desc"}]}}],"sourceExplore":"b","connectionName":"databricks","result":[{"c":19701}],"totalRows":1},"modelDef":{"name":"","exports":["a","b"],"contents":{"a":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":1,"character":61}}},"parameters":{},"as":"a"},"b":{"type":"table","name":"databricks:malloytest.airports","dialect":"postgres","tablePath":"malloytest.airports","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"code","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"site_number","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"fac_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"fac_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"faa_region","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"faa_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"full_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"own_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"number","numberType":"float","name":"longitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"number","numberType":"float","name":"latitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"number","numberType":"integer","name":"elevation","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"aero_cht","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"number","numberType":"integer","name":"cbd_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"cbd_dir","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"act_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"cert","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"fed_agree","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"cust_intl","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"c_ldg_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"joint_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"mil_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"cntl_twr","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"string","name":"major","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":58}}}},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":18},"end":{"line":3,"character":36}}},"parameters":{},"arguments":{},"join":"one","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"],"sql":"base.state"},"right":{"node":"field","path":["a","state"],"sql":"a_0.state"}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":14},"end":{"line":4,"character":7}}},"parameters":{},"as":"b"}},"queryList":[{"type":"query","structRef":"b","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":19},"end":{"line":6,"character":45}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["a","airport_count"]},"structPath":["a"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.airport_count.sum()"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"c","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":11},"end":{"line":7,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: [{"state":"TX","c":1845},{"state":"LA","c":500},{"state":null,"c":0}]

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      { c: 1845, state: 'TX' },
      { c: 500, state: 'LA' },
      { c: 0, state: null }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(a_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as c,\n   a_0.state as state\nFROM malloytest.airports as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) AS a_0\n  ON base.state=a_0.state AND (a_0.state IN ('TX','LA'))\nGROUP BY 2\nORDER BY 1 desc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","numberType":"integer","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"a.airport_count.sum()","sourceClasses":["c"],"referenceId":"5c955f2d-9cab-4ae9-a35a-5df9f30ce8d7","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":19},"end":{"line":8,"character":45}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"a.state","sourceClasses":["a.state"],"referenceId":"8dd27a14-cc29-4f94-afef-8736ace0858f","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"c","dir":"desc"}]}}],"sourceExplore":"b","connectionName":"databricks","result":[{"c":1845,"state":"TX"},{"c":500,"state":"LA"},{"c":0,"state":null}],"totalRows":3},"modelDef":{"name":"","exports":["a","b"],"contents":{"a":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":3,"character":7}}},"parameters":{},"filterList":[{"node":"filterCondition","code":"state = 'TX' | 'LA'","e":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["state"]},"oneOf":[{"node":"stringLiteral","literal":"TX"},{"node":"stringLiteral","literal":"LA"}]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"as":"a"},"b":{"type":"table","name":"databricks:malloytest.airports","dialect":"postgres","tablePath":"malloytest.airports","connection":"databricks","fields":[{"type":"number","numberType":"integer","name":"id","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"code","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"site_number","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"fac_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"fac_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"faa_region","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"faa_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"city","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"county","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"full_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"own_type","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"number","numberType":"float","name":"longitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"number","numberType":"float","name":"latitude","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"number","numberType":"integer","name":"elevation","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"aero_cht","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"number","numberType":"integer","name":"cbd_dist","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"cbd_dir","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"act_date","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"cert","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"fed_agree","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"cust_intl","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"c_ldg_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"joint_use","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"mil_rts","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"cntl_twr","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"string","name":"major","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":58}}}},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":18},"end":{"line":5,"character":36}}},"parameters":{},"filterList":[{"node":"filterCondition","code":"state = 'TX' | 'LA'","e":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["state"],"sql":"a_0.state"},"oneOf":[{"node":"stringLiteral","literal":"TX","sql":"'TX'"},{"node":"stringLiteral","literal":"LA","sql":"'LA'"}]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"arguments":{},"join":"one","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"],"sql":"base.state"},"right":{"node":"field","path":["a","state"],"sql":"a_0.state"}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":14},"end":{"line":6,"character":7}}},"parameters":{},"as":"b"}},"queryList":[{"type":"query","structRef":"b","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":19},"end":{"line":8,"character":45}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["a","airport_count"]},"structPath":["a"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.airport_count.sum()"},{"type":"fieldref","path":["a","state"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"c","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":11},"end":{"line":10,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"row_count":2601,"left_sum":19701,"right_sum":19701,"left_small_sum":19701,"right_small_sum":19701}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      {
        row_count: 2601,
        left_count: 51,
        right_count: 51,
        left_sum: 19701,
        right_sum: 19701,
        left_small_sum: 19701,
        right_small_sum: 19701
      }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   count(distinct CONCAT(base.state,a_0.state)) as row_count,\n   COUNT(DISTINCT base.__distinct_key) as left_count,\n   COUNT(DISTINCT a_0.__distinct_key) as right_count,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as left_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(a_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as right_sum,\n   ROUND((COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE((base.airport_count*1.0/10000), 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0)*10000)::NUMERIC) as left_small_sum,\n   ROUND((COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE((base.airport_count*1.0/10000), 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0)*10000)::NUMERIC) as right_small_sum\nFROM (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) AS a_0\n  ON 1=1\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"row_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"row_count","sourceExpression":"count(concat(state,a.state))","sourceClasses":["row_count"],"referenceId":"2e5e33e5-6ca2-41f3-97bd-b093460427ca","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":51}}}},{"name":"left_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"left_count","sourceExpression":"count()","sourceClasses":["left_count"],"referenceId":"88270074-001e-426a-8c70-e77e85816a12","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":10},"end":{"line":10,"character":31}}}},{"name":"right_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"right_count","sourceExpression":"a.count()","sourceClasses":["right_count"],"referenceId":"ff61a6d1-4a5b-4a25-b111-9cd0e04c3a15","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":11,"character":10},"end":{"line":11,"character":34}}}},{"name":"left_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"left_sum","sourceExpression":"airport_count.sum()","sourceClasses":["left_sum"],"referenceId":"7a1b8d13-d053-4429-8d53-fa4ad361b11e","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":10},"end":{"line":12,"character":41}}}},{"name":"right_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"right_sum","sourceExpression":"a.airport_count.sum()","sourceClasses":["right_sum"],"referenceId":"1b4a692f-e026-4020-bb94-f67a2f3418be","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":13,"character":10},"end":{"line":13,"character":44}}}},{"name":"left_small_sum","type":"number","resultMetadata":{"sourceField":"left_small_sum","sourceExpression":"round(x.sum() * 10000)","sourceClasses":["left_small_sum"],"referenceId":"30fd9459-38bb-454d-a44a-ebaea6dcdc5a","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":14,"character":10},"end":{"line":14,"character":50}}}},{"name":"right_small_sum","type":"number","resultMetadata":{"sourceField":"right_small_sum","sourceExpression":"round(x.sum() * 10000)","sourceClasses":["right_small_sum"],"referenceId":"f1626eb8-cbde-43ce-8b6b-b7e5907b9099","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":15,"character":10},"end":{"line":15,"character":51}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"row_count","dir":"desc"}]}}],"sourceExplore":"f","connectionName":"databricks","result":[{"row_count":2601,"left_count":51,"right_count":51,"left_sum":19701,"right_sum":19701,"left_small_sum":19701,"right_small_sum":19701}],"totalRows":1},"modelDef":{"name":"","exports":["a","f"],"contents":{"a":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","name":"x","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":43}}},"e":{"node":"/","kids":{"left":{"node":"field","path":["airport_count"]},"right":{"node":"numberLiteral","literal":"10000"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"airport_count/10000"}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":3,"character":7}}},"parameters":{},"as":"a"},"f":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","name":"x","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":43}}},"e":{"node":"/","kids":{"left":{"node":"field","path":["airport_count"],"sql":"base.airport_count"},"right":{"node":"numberLiteral","literal":"10000","sql":"10000"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"airport_count/10000"},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","name":"x","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":43}}},"e":{"node":"/","kids":{"left":{"node":"field","path":["airport_count"]},"right":{"node":"numberLiteral","literal":"10000"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"airport_count/10000"}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":20},"end":{"line":5,"character":21}}},"parameters":{},"arguments":{},"join":"cross","matrixOperation":"left"}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":14},"end":{"line":6,"character":7}}},"parameters":{},"as":"f","arguments":{}}},"queryList":[{"type":"query","structRef":"f","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"row_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":51}}},"e":{"node":"aggregate","function":"distinct","e":{"node":"function_call","overload":{"returnType":{"type":"string","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"values","allowedTypes":[{"type":"string","evalSpace":"input"},{"type":"number","evalSpace":"input"},{"type":"date","evalSpace":"input"},{"type":"timestamp","evalSpace":"input"},{"type":"boolean","evalSpace":"input"}],"isVariadic":true}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"CAST(","suffix":"AS VARCHAR)"}]},"src":["CONCAT(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"CAST(","suffix":"AS VARCHAR)"}]},"src":["CONCAT(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}}}},"name":"concat","kids":{"args":[{"node":"field","path":["state"]},{"node":"field","path":["a","state"]}]},"expressionType":"scalar"}},"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"expressionType":"aggregate","code":"count(concat(state,a.state))"},{"type":"number","numberType":"integer","name":"left_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":10},"end":{"line":10,"character":31}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"right_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":11,"character":10},"end":{"line":11,"character":34}}},"e":{"node":"aggregate","function":"count","e":{"node":""},"structPath":["a"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.count()"},{"type":"number","numberType":"integer","name":"left_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":10},"end":{"line":12,"character":41}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"},{"type":"number","numberType":"integer","name":"right_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":13,"character":10},"end":{"line":13,"character":44}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["a","airport_count"]},"structPath":["a"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.airport_count.sum()"},{"type":"number","name":"left_small_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":14,"character":10},"end":{"line":14,"character":50}}},"e":{"node":"function_call","overload":{"returnType":{"type":"number","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"value","allowedTypes":[{"type":"number","evalSpace":"input"}],"isVariadic":false}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND((",")::NUMERIC)"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}}}},"name":"round","kids":{"args":[{"node":"*","kids":{"left":{"node":"aggregate","function":"sum","e":{"node":"field","path":["x"]}},"right":{"node":"numberLiteral","literal":"10000"}}}]},"expressionType":"aggregate"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"round(x.sum() * 10000)"},{"type":"number","name":"right_small_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":15,"character":10},"end":{"line":15,"character":51}}},"e":{"node":"function_call","overload":{"returnType":{"type":"number","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"value","allowedTypes":[{"type":"number","evalSpace":"input"}],"isVariadic":false}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND((",")::NUMERIC)"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["ROUND(",")"]}}}},"name":"round","kids":{"args":[{"node":"*","kids":{"left":{"node":"aggregate","function":"sum","e":{"node":"field","path":["x"]}},"right":{"node":"numberLiteral","literal":"10000"}}}]},"expressionType":"aggregate"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"round(x.sum() * 10000)"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"row_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":11},"end":{"line":16,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"row_count":51,"left_sum":19701,"right_sum":19701,"sum_sum":1024452}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      {
        row_count: 51,
        left_sum: 19701,
        right_sum: 19701,
        sum_sum: 1024452
      }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage1","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     COALESCE(SUM(base.airport_count),0) as r\n  FROM malloytest.state_facts as base\n)\nSELECT \n   count(distinct CONCAT(base.state,CAST(a_0.r AS string))) as row_count,\n   COALESCE(SUM(base.airport_count),0) as left_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(a_0.r, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as right_sum,\n   COALESCE(SUM(base.airport_count+a_0.r),0) as sum_sum\nFROM malloytest.state_facts as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM __stage0 as x) AS a_0\n  ON 1=1\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage1","fields":[{"name":"row_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"row_count","sourceExpression":"count(concat(state,a.r::string))","sourceClasses":["row_count"],"referenceId":"7c5ec441-5f2d-4970-a6ec-44e8af7dea61","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":55}}}},{"name":"left_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"left_sum","sourceExpression":"airport_count.sum()","sourceClasses":["left_sum"],"referenceId":"773fc6a8-65ff-4e4c-953c-1a4920ff027f","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":10},"end":{"line":10,"character":41}}}},{"name":"right_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"right_sum","sourceExpression":"a.r.sum()","sourceClasses":["right_sum"],"referenceId":"488a7677-ec24-4f7d-86bb-483e7d842402","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":11,"character":10},"end":{"line":11,"character":32}}}},{"name":"sum_sum","type":"number","resultMetadata":{"sourceField":"sum_sum","sourceExpression":"sum(airport_count + a.r)","sourceClasses":["sum_sum"],"referenceId":"18c32d2b-159d-4a9d-a6fc-77f2aa7d0dbf","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":10},"end":{"line":12,"character":45}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"row_count","dir":"desc"}]}}],"sourceExplore":"f","connectionName":"databricks","result":[{"row_count":51,"left_sum":19701,"right_sum":19701,"sum_sum":1024452}],"totalRows":1},"modelDef":{"name":"","exports":["q","f"],"contents":{"q":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"r","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":43}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"r","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":3,"character":7}}},"name":"q"},"f":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":19},"end":{"line":4,"character":61}}}},{"type":"query_source","name":"a","fields":[{"name":"r","numberType":"integer","type":"number","resultMetadata":{"sourceField":"r","sourceExpression":"airport_count.sum()","sourceClasses":["r"],"referenceId":"6de142a6-21f5-4fa1-9c16-5ca9eb354179","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":43}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"r","dir":"desc"}]},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":18},"end":{"line":1,"character":60}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"r","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":19},"end":{"line":2,"character":43}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"r","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":3,"character":7}}},"name":"q"},"join":"one","matrixOperation":"left","location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":18},"end":{"line":5,"character":24}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":14},"end":{"line":6,"character":7}}},"parameters":{},"as":"f"}},"queryList":[{"type":"query","structRef":"f","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"row_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":55}}},"e":{"node":"aggregate","function":"distinct","e":{"node":"function_call","overload":{"returnType":{"type":"string","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"values","allowedTypes":[{"type":"string","evalSpace":"input"},{"type":"number","evalSpace":"input"},{"type":"date","evalSpace":"input"},{"type":"timestamp","evalSpace":"input"},{"type":"boolean","evalSpace":"input"}],"isVariadic":true}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"CAST(","suffix":"AS VARCHAR)"}]},"src":["CONCAT(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"CAST(","suffix":"AS VARCHAR)"}]},"src":["CONCAT(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}}}},"name":"concat","kids":{"args":[{"node":"field","path":["state"]},{"node":"cast","dstType":{"type":"string"},"e":{"node":"field","path":["a","r"]},"safe":false,"srcType":{"type":"number"}}]},"expressionType":"scalar"}},"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"expressionType":"aggregate","code":"count(concat(state,a.r::string))"},{"type":"number","numberType":"integer","name":"left_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":10},"end":{"line":10,"character":41}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"},{"type":"number","numberType":"integer","name":"right_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":11,"character":10},"end":{"line":11,"character":32}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["a","r"]},"structPath":["a"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.r.sum()"},{"type":"number","name":"sum_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":10},"end":{"line":12,"character":45}}},"e":{"node":"aggregate","function":"sum","e":{"node":"+","kids":{"left":{"node":"field","path":["airport_count"]},"right":{"node":"field","path":["a","r"]}}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"expressionType":"aggregate","code":"sum(airport_count + a.r)"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"row_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":11},"end":{"line":13,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"row_count":102,"left_sum":19701,"right_sum":1560}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { row_count: 102, left_sum: 19701, right_sum: 1560 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   count(distinct CONCAT(base.state,a_0.state)) as row_count,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as left_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(a_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(a_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as right_sum\nFROM (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) AS a_0\n  ON a_0.state IN ('CA','NY')\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"row_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"row_count","sourceExpression":"count(concat(state,a.state))","sourceClasses":["row_count"],"referenceId":"ebdd87f0-cf91-4c69-8d38-33f255a73b05","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":10},"end":{"line":7,"character":51}}}},{"name":"left_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"left_sum","sourceExpression":"airport_count.sum()","sourceClasses":["left_sum"],"referenceId":"8167a074-89ca-4b65-8f34-91eca122e818","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":41}}}},{"name":"right_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"right_sum","sourceExpression":"a.airport_count.sum()","sourceClasses":["right_sum"],"referenceId":"d4205667-c5d5-4f5c-9e01-960641938dc8","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":44}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"row_count","dir":"desc"}]}}],"sourceExplore":"f","connectionName":"databricks","result":[{"row_count":102,"left_sum":19701,"right_sum":1560}],"totalRows":1},"modelDef":{"name":"","exports":["a","f"],"contents":{"a":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":1,"character":61}}},"parameters":{},"as":"a"},"f":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"table","name":"a","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":19},"end":{"line":1,"character":61}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":20},"end":{"line":3,"character":46}}},"parameters":{},"arguments":{},"join":"cross","matrixOperation":"left","onExpression":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["a","state"],"sql":"a_0.state"},"oneOf":[{"node":"stringLiteral","literal":"CA","sql":"'CA'"},{"node":"stringLiteral","literal":"NY","sql":"'NY'"}]}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":14},"end":{"line":4,"character":7}}},"parameters":{},"as":"f","arguments":{}}},"queryList":[{"type":"query","structRef":"f","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"row_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":10},"end":{"line":7,"character":51}}},"e":{"node":"aggregate","function":"distinct","e":{"node":"function_call","overload":{"returnType":{"type":"string","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"values","allowedTypes":[{"type":"string","evalSpace":"input"},{"type":"number","evalSpace":"input"},{"type":"date","evalSpace":"input"},{"type":"timestamp","evalSpace":"input"},{"type":"boolean","evalSpace":"input"}],"isVariadic":true}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"CAST(","suffix":"AS VARCHAR)"}]},"src":["CONCAT(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"CAST(","suffix":"AS VARCHAR)"}]},"src":["CONCAT(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"spread","e":{"node":"function_parameter","name":"values"},"prefix":"","suffix":""}]},"src":["CONCAT(",")"]}}}},"name":"concat","kids":{"args":[{"node":"field","path":["state"]},{"node":"field","path":["a","state"]}]},"expressionType":"scalar"}},"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"expressionType":"aggregate","code":"count(concat(state,a.state))"},{"type":"number","numberType":"integer","name":"left_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":41}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"},{"type":"number","numberType":"integer","name":"right_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":44}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["a","airport_count"]},"structPath":["a"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.airport_count.sum()"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"a":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"row_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":11},"end":{"line":10,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { state: 'IL', c: 1 }, { state: 'NJ', c: 1 }, { state: 'IN', c: 1 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN expected: {"ac_count":28,"ac_sum":10402,"am_count":4,"am_sum":1486}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { ac_count: 28, ac_sum: 10402, am_sum: 1486, am_count: 4 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage4","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage1 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage2 AS (\n  SELECT \n     b_0.state as state,\n     b_0.airport_count as airport_count\n  FROM __stage0 as base\n   LEFT JOIN __stage1 AS b_0\n    ON 1=1\n)\n, __stage3 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|M)'\n)\nSELECT \n   COUNT(1) as ac_count,\n   COALESCE(SUM(base.airport_count),0) as ac_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(am_states_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as am_sum,\n   COUNT(DISTINCT am_states_0.__distinct_key) as am_count\nFROM __stage2 as base\n INNER JOIN (SELECT uuid() as __distinct_key, x.*  FROM __stage3 as x) AS am_states_0\n  ON base.state=am_states_0.state\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage4","fields":[{"name":"ac_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_count","sourceExpression":"count()","sourceClasses":["ac_count"],"referenceId":"1ea6f32f-f0ed-4938-a859-140dda1d98b5","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}}},{"name":"ac_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_sum","sourceExpression":"airport_count.sum()","sourceClasses":["ac_sum"],"referenceId":"b0ca99da-1c4f-4e0f-b4be-06fe6d2b138b","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}}},{"name":"am_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_sum","sourceExpression":"airport_count.sum()","sourceClasses":["am_states.am_sum"],"referenceId":"4b2809fb-1962-4e7b-a661-28c52310cc8b","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}}},{"name":"am_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_count","sourceExpression":"count()","sourceClasses":["am_states.am_count"],"referenceId":"3fd615bf-5e77-4a3d-8474-f8ef0752da6a","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"ac_count","dir":"desc"}]},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"sourceExplore":"ac_states","connectionName":"databricks","result":[{"ac_count":28,"ac_sum":10402,"am_sum":1486,"am_count":4}],"totalRows":1},"modelDef":{"name":"","exports":["am_states","ac_states_base","ac_states"],"contents":{"am_states":{"type":"query_source","name":"QuerySource-841c3140-ee72-4c3b-bb88-02801cc27c06","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"91ff826e-e4d5-472d-ba46-2b316baa3524","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"90bfd668-eb6e-45c7-be2d-6d915513f4b7","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"ba157e23-caff-466e-b477-df8906992159","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"ea974511-41ea-43cc-9f88-6643dfa3b2d4","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"596643cf-b103-4c2b-a001-639852d9e5fe","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"as":"am_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":14},"end":{"line":10,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states_base":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base","modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states":{"type":"query_source","name":"QuerySource-9d3e848b-0345-4f37-869e-5432743ca982","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"b.state","sourceClasses":["b.state"],"referenceId":"46a47813-58f5-4aa9-8a17-8d75202e394a","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"b.airport_count","sourceClasses":["b.airport_count"],"referenceId":"52c91f14-c854-486c-8390-0cb9b2c96da8","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"ac_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"ac_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}},{"type":"project","queryFields":[{"type":"fieldref","path":["b","state"]},{"type":"fieldref","path":["b","airport_count"]}],"extendSource":[{"type":"query_source","name":"b","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"1328de97-1761-49e0-8dae-fc26e1804533","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"b79061d2-986b-43cf-95f3-ac08333fa33b","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"be8ff79f-d58e-4a76-b526-be9343baf72c","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"e41e5777-7026-43a6-8710-0ff111c31736","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"7084572e-6c46-41b6-b9bb-ad9a5b46a4a9","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base"},"join":"cross","matrixOperation":"left","location":{"url":"internal://internal.malloy","range":{"start":{"line":20,"character":22},"end":{"line":20,"character":41}}}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"b":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}}},"parameters":{},"as":"ac_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":18,"character":14},"end":{"line":29,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}},"queryList":[{"type":"query","structRef":"ac_states","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["ac_count"]},{"type":"fieldref","path":["ac_sum"]},{"type":"fieldref","path":["am_states","am_sum"]},{"type":"fieldref","path":["am_states","am_count"]}],"extendSource":[{"type":"query_source","name":"am_states","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"91ff826e-e4d5-472d-ba46-2b316baa3524","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"90bfd668-eb6e-45c7-be2d-6d915513f4b7","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"ba157e23-caff-466e-b477-df8906992159","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"ea974511-41ea-43cc-9f88-6643dfa3b2d4","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"596643cf-b103-4c2b-a001-639852d9e5fe","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":33,"character":20},"end":{"line":33,"character":62}}},"arguments":{},"join":"one","matrixOperation":"inner","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"]},"right":{"node":"field","path":["am_states","state"]}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"ac_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":31,"character":11},"end":{"line":41,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"dependencies":{},"annotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"ac_count":49,"ac_sum":21336,"am_count":4,"am_sum":1486}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { ac_count: 49, ac_sum: 21336, am_sum: 1486, am_count: 4 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage4","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage1 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage2 AS (\n  SELECT \n     b_0.state as state,\n     b_0.airport_count as airport_count\n  FROM __stage0 as base\n   LEFT JOIN __stage1 AS b_0\n    ON 1=1\n)\n, __stage3 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|M)'\n)\nSELECT \n   COUNT(1) as ac_count,\n   COALESCE(SUM(base.airport_count),0) as ac_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(am_states_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as am_sum,\n   COUNT(DISTINCT am_states_0.__distinct_key) as am_count\nFROM __stage2 as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM __stage3 as x) AS am_states_0\n  ON base.state=am_states_0.state\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage4","fields":[{"name":"ac_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_count","sourceExpression":"count()","sourceClasses":["ac_count"],"referenceId":"5e40cfab-93cb-40d3-a355-5f199434bb54","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}}},{"name":"ac_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_sum","sourceExpression":"airport_count.sum()","sourceClasses":["ac_sum"],"referenceId":"a756a640-b73c-44a4-85c6-b3614239a203","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}}},{"name":"am_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_sum","sourceExpression":"airport_count.sum()","sourceClasses":["am_states.am_sum"],"referenceId":"29bd5e38-41ab-4cca-8ced-5f1fcaedcfc8","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}}},{"name":"am_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_count","sourceExpression":"count()","sourceClasses":["am_states.am_count"],"referenceId":"7422efad-d4b5-47b0-b899-c152d3434a09","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"ac_count","dir":"desc"}]},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"sourceExplore":"ac_states","connectionName":"databricks","result":[{"ac_count":49,"ac_sum":21336,"am_sum":1486,"am_count":4}],"totalRows":1},"modelDef":{"name":"","exports":["am_states","ac_states_base","ac_states"],"contents":{"am_states":{"type":"query_source","name":"QuerySource-ef9783dd-ddd0-4cb4-a7c9-c3fe17abb2ab","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"22e3d671-a30c-4cfc-a99d-55c38d5d83cc","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"02afe157-cecb-4398-9adf-68c4e367f3eb","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"f540c02c-a79f-4454-820f-7ae2fcfff74c","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"b87f9fb6-2653-4e1d-95fe-b77b6888d60a","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"bc3f362e-708c-40b1-8a23-bdf9d17c2124","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"as":"am_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":14},"end":{"line":10,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states_base":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base","modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states":{"type":"query_source","name":"QuerySource-4b8a1828-b8a5-4a99-b797-f25567b36fc9","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"b.state","sourceClasses":["b.state"],"referenceId":"873e70ac-d93b-4735-8815-1c2cee1a3187","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"b.airport_count","sourceClasses":["b.airport_count"],"referenceId":"81ac8a6b-5f23-43cd-b19b-83b7d005f0f0","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"ac_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"ac_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}},{"type":"project","queryFields":[{"type":"fieldref","path":["b","state"]},{"type":"fieldref","path":["b","airport_count"]}],"extendSource":[{"type":"query_source","name":"b","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"49c7e51b-731f-491f-ab32-4f305eca59b0","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"01822322-0b41-4579-b876-75a2241c6aca","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"3fc9fcb3-3559-47ee-90f1-f85fd470c48e","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"7d96e615-ce6b-401c-aa0d-85869e9481bd","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"f9882c95-e24a-49d7-a9ba-c4ec75d08f68","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base"},"join":"cross","matrixOperation":"left","location":{"url":"internal://internal.malloy","range":{"start":{"line":20,"character":22},"end":{"line":20,"character":41}}}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"b":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}}},"parameters":{},"as":"ac_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":18,"character":14},"end":{"line":29,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}},"queryList":[{"type":"query","structRef":"ac_states","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["ac_count"]},{"type":"fieldref","path":["ac_sum"]},{"type":"fieldref","path":["am_states","am_sum"]},{"type":"fieldref","path":["am_states","am_count"]}],"extendSource":[{"type":"query_source","name":"am_states","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"22e3d671-a30c-4cfc-a99d-55c38d5d83cc","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"02afe157-cecb-4398-9adf-68c4e367f3eb","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"f540c02c-a79f-4454-820f-7ae2fcfff74c","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"b87f9fb6-2653-4e1d-95fe-b77b6888d60a","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"bc3f362e-708c-40b1-8a23-bdf9d17c2124","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":33,"character":20},"end":{"line":33,"character":61}}},"arguments":{},"join":"one","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"]},"right":{"node":"field","path":["am_states","state"]}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"ac_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":31,"character":11},"end":{"line":41,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"dependencies":{},"annotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"ac_count":28,"ac_sum":10402,"am_count":12,"am_sum":4139}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { ac_count: 28, ac_sum: 10402, am_sum: 4139, am_count: 12 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage4","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage1 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage2 AS (\n  SELECT \n     b_0.state as state,\n     b_0.airport_count as airport_count\n  FROM __stage0 as base\n   LEFT JOIN __stage1 AS b_0\n    ON 1=1\n)\n, __stage3 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|M)'\n)\nSELECT \n   COUNT(DISTINCT base.__distinct_key) as ac_count,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as ac_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(am_states_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as am_sum,\n   COUNT(DISTINCT am_states_0.__distinct_key) as am_count\nFROM (SELECT uuid() as __distinct_key, x.*  FROM __stage2 as x) as base\n RIGHT JOIN (SELECT uuid() as __distinct_key, x.*  FROM __stage3 as x) AS am_states_0\n  ON base.state=am_states_0.state\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage4","fields":[{"name":"ac_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_count","sourceExpression":"count()","sourceClasses":["ac_count"],"referenceId":"365faf7a-0ab8-4949-bc12-4f519be59022","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}}},{"name":"ac_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_sum","sourceExpression":"airport_count.sum()","sourceClasses":["ac_sum"],"referenceId":"53322adf-34a1-480e-a794-4e77af563587","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}}},{"name":"am_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_sum","sourceExpression":"airport_count.sum()","sourceClasses":["am_states.am_sum"],"referenceId":"a9f64b53-4743-4b61-b94b-da3b1a5eacd3","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}}},{"name":"am_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_count","sourceExpression":"count()","sourceClasses":["am_states.am_count"],"referenceId":"0e086cef-0719-47a5-9458-91af209bb806","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"ac_count","dir":"desc"}]},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"sourceExplore":"ac_states","connectionName":"databricks","result":[{"ac_count":28,"ac_sum":10402,"am_sum":4139,"am_count":12}],"totalRows":1},"modelDef":{"name":"","exports":["am_states","ac_states_base","ac_states"],"contents":{"am_states":{"type":"query_source","name":"QuerySource-f28a121b-7b08-4841-aa5f-8a36ada82128","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"2bdbc822-d7b7-4487-8207-118510b7d6ed","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"c737c77e-40b1-4ca3-bb8b-2a21f7d3b245","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"a3c43e18-78e6-4312-b423-2f909f6296cd","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"e624236f-e5c2-4094-a5cf-d7c150971b88","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"bc09b663-2581-4883-895e-f4a7eb56d134","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"as":"am_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":14},"end":{"line":10,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states_base":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base","modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states":{"type":"query_source","name":"QuerySource-21bc2d58-05f4-41ab-a26a-b8af54458b69","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"b.state","sourceClasses":["b.state"],"referenceId":"4da774eb-3021-4f21-acd3-e86b6499e7ad","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"b.airport_count","sourceClasses":["b.airport_count"],"referenceId":"34fd2c1f-af55-4a8e-b18a-f80037582353","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"ac_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"ac_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}},{"type":"project","queryFields":[{"type":"fieldref","path":["b","state"]},{"type":"fieldref","path":["b","airport_count"]}],"extendSource":[{"type":"query_source","name":"b","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"fd8cacb4-4fa2-468b-93fb-2f04b49ae89b","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"0c24666a-f145-4a88-9684-3d56c22312b7","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"3d8223fe-4428-426b-a18a-da5fc6b41d16","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"a4e934c6-a636-4fe6-9a17-7ad48c51cc59","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"b7284f7a-a7c8-4d61-a0ac-4f2c6df4bd5c","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base"},"join":"cross","matrixOperation":"left","location":{"url":"internal://internal.malloy","range":{"start":{"line":20,"character":22},"end":{"line":20,"character":41}}}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"b":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}}},"parameters":{},"as":"ac_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":18,"character":14},"end":{"line":29,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}},"queryList":[{"type":"query","structRef":"ac_states","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["ac_count"]},{"type":"fieldref","path":["ac_sum"]},{"type":"fieldref","path":["am_states","am_sum"]},{"type":"fieldref","path":["am_states","am_count"]}],"extendSource":[{"type":"query_source","name":"am_states","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"2bdbc822-d7b7-4487-8207-118510b7d6ed","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"c737c77e-40b1-4ca3-bb8b-2a21f7d3b245","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"a3c43e18-78e6-4312-b423-2f909f6296cd","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"e624236f-e5c2-4094-a5cf-d7c150971b88","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"bc09b663-2581-4883-895e-f4a7eb56d134","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":33,"character":20},"end":{"line":33,"character":62}}},"arguments":{},"join":"one","matrixOperation":"right","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"]},"right":{"node":"field","path":["am_states","state"]}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"ac_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":31,"character":11},"end":{"line":41,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"dependencies":{},"annotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"ac_count":49,"ac_sum":21336,"am_count":12,"am_sum":4139}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { ac_count: 49, ac_sum: 21336, am_sum: 4139, am_count: 12 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage4","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage1 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|C)'\n)\n, __stage2 AS (\n  SELECT \n     b_0.state as state,\n     b_0.airport_count as airport_count\n  FROM __stage0 as base\n   LEFT JOIN __stage1 AS b_0\n    ON 1=1\n)\n, __stage3 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|M)'\n)\nSELECT \n   COUNT(DISTINCT base.__distinct_key) as ac_count,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as ac_sum,\n   COALESCE((SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(am_states_0.airport_count, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(am_states_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))))),0) as am_sum,\n   COUNT(DISTINCT am_states_0.__distinct_key) as am_count\nFROM (SELECT uuid() as __distinct_key, x.*  FROM __stage2 as x) as base\n FULL JOIN (SELECT uuid() as __distinct_key, x.*  FROM __stage3 as x) AS am_states_0\n  ON base.state=am_states_0.state\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage4","fields":[{"name":"ac_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_count","sourceExpression":"count()","sourceClasses":["ac_count"],"referenceId":"1b584d84-8045-4a1e-8c30-8394d42d7da1","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}}},{"name":"ac_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"ac_sum","sourceExpression":"airport_count.sum()","sourceClasses":["ac_sum"],"referenceId":"2b942b45-e774-4161-9d3f-9ef23869ec02","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}}},{"name":"am_sum","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_sum","sourceExpression":"airport_count.sum()","sourceClasses":["am_states.am_sum"],"referenceId":"614e7e32-96a0-4c7b-8bdf-12780439724a","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}}},{"name":"am_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"am_states.am_count","sourceExpression":"count()","sourceClasses":["am_states.am_count"],"referenceId":"bc12b726-f1ac-49d3-a593-0b7e12176b85","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"ac_count","dir":"desc"}]},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"sourceExplore":"ac_states","connectionName":"databricks","result":[{"ac_count":49,"ac_sum":21336,"am_sum":4139,"am_count":12}],"totalRows":1},"modelDef":{"name":"","exports":["am_states","ac_states_base","ac_states"],"contents":{"am_states":{"type":"query_source","name":"QuerySource-9e15a8a1-e821-41f2-9372-d59e50b75469","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"711a35a6-125c-4c48-a398-97cc62b3e89f","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"37507c85-64d5-48c8-b62f-d59883c8919c","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"e8659fd3-be8b-4d2f-a2db-6a720502dd53","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"2325b80b-95e8-4c00-8ec4-6ae3c7f88f50","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"2e4b85d6-dff4-4b90-95da-116fbcb991ef","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"as":"am_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":14},"end":{"line":10,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states_base":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base","modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}},"ac_states":{"type":"query_source","name":"QuerySource-3b54fc40-b0ef-45f6-b968-99883828b9e9","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"b.state","sourceClasses":["b.state"],"referenceId":"b23ff991-07ef-46f9-a495-41e9994e46ad","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"b.airport_count","sourceClasses":["b.airport_count"],"referenceId":"8b2d4893-ed52-48ac-86b7-d6860c41588e","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"ac_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":27,"character":10},"end":{"line":27,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"ac_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":28,"character":10},"end":{"line":28,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}},{"type":"project","queryFields":[{"type":"fieldref","path":["b","state"]},{"type":"fieldref","path":["b","airport_count"]}],"extendSource":[{"type":"query_source","name":"b","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"1a7e6477-4e44-4509-a134-bc201cfaa978","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"a67aad77-5d07-4263-99b7-22c845299381","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"8ba4fa65-3668-4230-8934-f034d65c8e96","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"e2ce66ca-93d0-4615-a21b-559171574771","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"bd175b7c-b028-44a7-9f2c-c73681fb1675","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":31},"end":{"line":12,"character":73}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|C)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|C)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}},"name":"ac_states_base"},"join":"cross","matrixOperation":"left","location":{"url":"internal://internal.malloy","range":{"start":{"line":20,"character":22},"end":{"line":20,"character":41}}}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"b":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":12,"character":13},"end":{"line":15,"character":7}}}},"parameters":{},"as":"ac_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":18,"character":14},"end":{"line":29,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}},"queryList":[{"type":"query","structRef":"ac_states","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["ac_count"]},{"type":"fieldref","path":["ac_sum"]},{"type":"fieldref","path":["am_states","am_sum"]},{"type":"fieldref","path":["am_states","am_count"]}],"extendSource":[{"type":"query_source","name":"am_states","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"711a35a6-125c-4c48-a398-97cc62b3e89f","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"37507c85-64d5-48c8-b62f-d59883c8919c","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"e8659fd3-be8b-4d2f-a2db-6a720502dd53","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"2325b80b-95e8-4c00-8ec4-6ae3c7f88f50","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"2e4b85d6-dff4-4b90-95da-116fbcb991ef","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"am_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":10},"end":{"line":8,"character":29}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"},{"type":"number","numberType":"integer","name":"am_sum","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":39}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["airport_count"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"airport_count.sum()"}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":3,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":27},"end":{"line":10,"character":7}}}},"parameters":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":33,"character":20},"end":{"line":33,"character":61}}},"arguments":{},"join":"one","matrixOperation":"full","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"]},"right":{"node":"field","path":["am_states","state"]}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}},"defaultOrderBy":true,"orderBy":[{"field":"ac_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":31,"character":11},"end":{"line":41,"character":7}}},"modelAnnotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}],"dependencies":{},"annotation":{"notes":[{"text":"##! experimental.join_types\n","at":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":6},"end":{"line":2,"character":34}}}}],"id":"d93474be-58c4-55a3-84fd-a42d508abfff"}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"leafy_count":0,"root_count":1}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { leafy_count: 0, root_count: 1 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage1","malloy":"","sql":"WITH __stage0 AS (\n  SELECT \n     base.aircraft_count as aircraft_count,\n     base.airport_count as airport_count,\n     base.births as births,\n     base.popular_name as popular_name,\n     base.state as state\n  FROM malloytest.state_facts as base\n  WHERE base.state RLIKE '^(A|M)'\n)\nSELECT \n   COUNT(DISTINCT am_states_0.__distinct_key) as leafy_count,\n   COUNT(DISTINCT base.__distinct_key) as root_count\nFROM (SELECT uuid() as __distinct_key, x.*  FROM malloytest.state_facts as x) as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM __stage0 as x) AS am_states_0\n  ON base.state=am_states_0.state\nWHERE base.state='CA'\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage1","fields":[{"name":"leafy_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"leafy_count","sourceExpression":"am_states.count()","sourceClasses":["leafy_count"],"referenceId":"5983819b-fc95-4823-a872-a08b755536f7","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":13,"character":10},"end":{"line":13,"character":42}}}},{"name":"root_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"root_count","sourceExpression":"count()","sourceClasses":["root_count"],"referenceId":"5a6f2150-41fa-4b82-ac33-60424b2b341a","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":14,"character":10},"end":{"line":14,"character":31}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state = 'CA'","e":{"node":"=","kids":{"left":{"node":"field","path":["state"],"sql":"base.state"},"right":{"node":"stringLiteral","literal":"CA","sql":"'CA'"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"leafy_count","dir":"desc"}]}}],"sourceExplore":"states","connectionName":"databricks","result":[{"leafy_count":0,"root_count":1}],"totalRows":1},"modelDef":{"name":"","exports":["am_states","states"],"contents":{"am_states":{"type":"query_source","name":"QuerySource-ea6ba6b6-dcec-4dee-91f5-51f6cae8db96","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"8f7e8112-3134-4876-8d63-fd27e61d33e0","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"5e6a6db2-13b6-438a-97ad-35feb6e90795","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"2d30833a-de5b-47a7-a6fe-c1a154565a79","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"4849d944-74d5-493f-8c4f-a9ecae73ae20","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"ca34e7c1-0bf9-46b8-a5eb-7a2a57625741","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":4,"character":7}}}},"parameters":{},"as":"am_states","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":4,"character":7}}}},"states":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":24},"end":{"line":6,"character":66}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":24},"end":{"line":6,"character":66}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":24},"end":{"line":6,"character":66}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":24},"end":{"line":6,"character":66}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":24},"end":{"line":6,"character":66}}}},{"type":"query_source","name":"am_states","fields":[{"name":"aircraft_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"aircraft_count","sourceClasses":["aircraft_count"],"referenceId":"8f7e8112-3134-4876-8d63-fd27e61d33e0","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"airport_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"airport_count","sourceClasses":["airport_count"],"referenceId":"5e6a6db2-13b6-438a-97ad-35feb6e90795","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"births","numberType":"integer","type":"number","resultMetadata":{"sourceField":"births","sourceClasses":["births"],"referenceId":"2d30833a-de5b-47a7-a6fe-c1a154565a79","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"4849d944-74d5-493f-8c4f-a9ecae73ae20","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"ca34e7c1-0bf9-46b8-a5eb-7a2a57625741","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct"},"query":{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":1,"character":69}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["aircraft_count"]},{"type":"fieldref","path":["airport_count"]},{"type":"fieldref","path":["births"]},{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["state"]}],"filterList":[{"node":"filterCondition","code":"state ~ r'^(A|M)'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["state"]},"regex":{"node":"regexpLiteral","literal":"^(A|M)"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":27},"end":{"line":4,"character":7}}}},"parameters":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":19},"end":{"line":7,"character":53}}},"arguments":{},"join":"many","matrixOperation":"left","onExpression":{"node":"=","kids":{"left":{"node":"field","path":["state"],"sql":"base.state"},"right":{"node":"field","path":["am_states","state"],"sql":"am_states_0.state"}}},"onCompositeFieldUsage":{"fields":[],"joinedUsage":{"am_states":{"fields":[],"joinedUsage":{}}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":14},"end":{"line":8,"character":7}}},"parameters":{},"as":"states"}},"queryList":[{"type":"query","structRef":"states","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"leafy_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":13,"character":10},"end":{"line":13,"character":42}}},"e":{"node":"aggregate","function":"count","e":{"node":""},"structPath":["am_states"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"am_states.count()"},{"type":"number","numberType":"integer","name":"root_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":14,"character":10},"end":{"line":14,"character":31}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"}],"filterList":[{"node":"filterCondition","code":"state = 'CA'","e":{"node":"=","kids":{"left":{"node":"field","path":["state"]},"right":{"node":"stringLiteral","literal":"CA"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"leafy_count","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":11},"end":{"line":15,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"state":"TX","c":1845,"d":1845}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 51 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN expected: {"leafy_count":0,"root_count":1,"state":"CA","am_state":null}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

  console.log
    BRIAN expected: {"fieldValue":"AA"}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'AA',
        weight: 34577
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'AS',
        weight: 8453
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'B6',
        weight: 4842
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'CO',
        weight: 7139
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'DL',
        weight: 32130
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'EV',
        weight: 15769
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'HP',
        weight: 9750
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'MQ',
        weight: 15869
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'NW',
        weight: 33580
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'OH',
        weight: 4420
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'RU',
        weight: 16074
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'TZ',
        weight: 3033
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'UA',
        weight: 32757
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'US',
        weight: 37683
      },
      {
        fieldName: 'carrier',
        fieldPath: 'carrier',
        fieldType: 'string',
        fieldValue: 'WN',
        weight: 88751
      }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage2","malloy":"","sql":"WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE group_set\n      WHEN 0 THEN 'arr_delay'\n      WHEN 1 THEN 'arr_time'\n      WHEN 2 THEN 'cancelled'\n      WHEN 3 THEN 'carrier'\n      WHEN 4 THEN 'dep_delay'\n      WHEN 5 THEN 'dep_time'\n      WHEN 6 THEN 'destination'\n      WHEN 7 THEN 'distance'\n      WHEN 8 THEN 'diverted'\n      WHEN 9 THEN 'flight_num'\n      WHEN 10 THEN 'flight_time'\n      WHEN 11 THEN 'id2'\n      WHEN 12 THEN 'origin'\n      WHEN 13 THEN 'tail_num'\n      WHEN 14 THEN 'taxi_in'\n      WHEN 15 THEN 'taxi_out'\n    END as fieldName,\n    CASE group_set\n      WHEN 0 THEN 'arr_delay'\n      WHEN 1 THEN 'arr_time'\n      WHEN 2 THEN 'cancelled'\n      WHEN 3 THEN 'carrier'\n      WHEN 4 THEN 'dep_delay'\n      WHEN 5 THEN 'dep_time'\n      WHEN 6 THEN 'destination'\n      WHEN 7 THEN 'distance'\n      WHEN 8 THEN 'diverted'\n      WHEN 9 THEN 'flight_num'\n      WHEN 10 THEN 'flight_time'\n      WHEN 11 THEN 'id2'\n      WHEN 12 THEN 'origin'\n      WHEN 13 THEN 'tail_num'\n      WHEN 14 THEN 'taxi_in'\n      WHEN 15 THEN 'taxi_out'\n    END as fieldPath,\n    CASE group_set\n      WHEN 0 THEN 'number'\n      WHEN 1 THEN 'timestamp'\n      WHEN 2 THEN 'string'\n      WHEN 3 THEN 'string'\n      WHEN 4 THEN 'number'\n      WHEN 5 THEN 'timestamp'\n      WHEN 6 THEN 'string'\n      WHEN 7 THEN 'number'\n      WHEN 8 THEN 'string'\n      WHEN 9 THEN 'string'\n      WHEN 10 THEN 'number'\n      WHEN 11 THEN 'number'\n      WHEN 12 THEN 'string'\n      WHEN 13 THEN 'string'\n      WHEN 14 THEN 'number'\n      WHEN 15 THEN 'number'\n    END as fieldType,  CASE group_set WHEN 99999 THEN CAST(NULL as STRING)\n      WHEN 2 THEN base.cancelled\n      WHEN 3 THEN base.carrier\n      WHEN 6 THEN base.destination\n      WHEN 8 THEN base.diverted\n      WHEN 9 THEN base.flight_num\n      WHEN 12 THEN base.origin\n      WHEN 13 THEN base.tail_num\n    END as fieldValue,\n   COUNT(*) as weight,\n    CASE group_set\n      WHEN 99999 THEN ''    WHEN 0 THEN CONCAT(MIN(CAST(base.arr_delay as STRING)),' to ',CAST(MAX(base.arr_delay) as STRING))\n      WHEN 1 THEN CONCAT(MIN(CAST(DATE(base.arr_time) as STRING)),' to ',MAX(CAST(DATE(base.arr_time) as STRING)))\n      WHEN 4 THEN CONCAT(MIN(CAST(base.dep_delay as STRING)),' to ',CAST(MAX(base.dep_delay) as STRING))\n      WHEN 5 THEN CONCAT(MIN(CAST(DATE(base.dep_time) as STRING)),' to ',MAX(CAST(DATE(base.dep_time) as STRING)))\n      WHEN 7 THEN CONCAT(MIN(CAST(base.distance as STRING)),' to ',CAST(MAX(base.distance) as STRING))\n      WHEN 10 THEN CONCAT(MIN(CAST(base.flight_time as STRING)),' to ',CAST(MAX(base.flight_time) as STRING))\n      WHEN 11 THEN CONCAT(MIN(CAST(base.id2 as STRING)),' to ',CAST(MAX(base.id2) as STRING))\n      WHEN 14 THEN CONCAT(MIN(CAST(base.taxi_in as STRING)),' to ',CAST(MAX(base.taxi_in) as STRING))\n      WHEN 15 THEN CONCAT(MIN(CAST(base.taxi_out as STRING)),' to ',CAST(MAX(base.taxi_out) as STRING))\n    END as fieldRange\n  FROM malloytest.flights as base\n  CROSS JOIN (SELECT EXPLODE(SEQUENCE(0,16,1)) as group_set)\n  GROUP BY 1,2,3,4,5\n)\n, __stage1 AS (\n  SELECT\n    fieldName,\n    fieldPath,\n    fieldType,\n    COALESCE(fieldValue, fieldRange) as fieldValue,\n    weight\n  FROM __stage0\n)\nSELECT \n   base.fieldName as fieldName,\n   base.fieldPath as fieldPath,\n   base.fieldType as fieldType,\n   base.fieldValue as fieldValue,\n   base.weight as weight\nFROM __stage1 as base\nWHERE base.fieldName='carrier'\nORDER BY 4 ASC NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage2","fields":[{"name":"fieldName","type":"string","resultMetadata":{"sourceField":"fieldName","sourceClasses":["fieldName"],"referenceId":"8d491227-70c8-4cd5-ae12-a6bda06d74d3","fieldKind":"dimension"}},{"name":"fieldPath","type":"string","resultMetadata":{"sourceField":"fieldPath","sourceClasses":["fieldPath"],"referenceId":"526257be-16a6-4db7-9b8c-1eef2a29ef04","fieldKind":"dimension"}},{"name":"fieldType","type":"string","resultMetadata":{"sourceField":"fieldType","sourceClasses":["fieldType"],"referenceId":"d0ed14f3-9e10-4c14-b753-a191558983f1","fieldKind":"dimension"}},{"name":"fieldValue","type":"string","resultMetadata":{"sourceField":"fieldValue","sourceClasses":["fieldValue"],"referenceId":"396de618-f5b2-4789-a783-b9331f066635","fieldKind":"dimension"}},{"name":"weight","numberType":"integer","type":"number","resultMetadata":{"sourceField":"weight","sourceClasses":["weight"],"referenceId":"53c50ae8-e1e1-4b25-b26e-38bb5b10ea7d","fieldKind":"dimension"}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"~computeLastStage~","filterList":[{"node":"filterCondition","code":"fieldName = 'carrier'","e":{"node":"=","kids":{"left":{"node":"field","path":["fieldName"],"sql":"base.fieldName"},"right":{"node":"stringLiteral","literal":"carrier","sql":"'carrier'"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["~computeLastStage~"],"fieldKind":"struct","orderBy":[{"field":"fieldValue"}]}}],"sourceExplore":"databricks:malloytest.flights","connectionName":"databricks","result":[{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"AA","weight":34577},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"AS","weight":8453},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"B6","weight":4842},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"CO","weight":7139},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"DL","weight":32130},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"EV","weight":15769},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"HP","weight":9750},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"MQ","weight":15869},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"NW","weight":33580},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"OH","weight":4420},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"RU","weight":16074},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"TZ","weight":3033},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"UA","weight":32757},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"US","weight":37683},{"fieldName":"carrier","fieldPath":"carrier","fieldType":"string","fieldValue":"WN","weight":88751}],"totalRows":15},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.flights","dialect":"postgres","tablePath":"malloytest.flights","connection":"databricks","fields":[{"type":"string","name":"carrier","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"string","name":"origin","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"string","name":"destination","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"string","name":"flight_num","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"flight_time","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"string","name":"tail_num","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"timestamp","name":"dep_time","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"timestamp","name":"arr_time","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"dep_delay","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"arr_delay","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"taxi_out","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"taxi_in","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"distance","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"string","name":"cancelled","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"string","name":"diverted","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},{"type":"number","numberType":"integer","name":"id2","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":49}}}},"pipeline":[{"type":"index","indexFields":[{"type":"fieldref","path":["arr_delay"]},{"type":"fieldref","path":["arr_time"]},{"type":"fieldref","path":["cancelled"]},{"type":"fieldref","path":["carrier"]},{"type":"fieldref","path":["dep_delay"]},{"type":"fieldref","path":["dep_time"]},{"type":"fieldref","path":["destination"]},{"type":"fieldref","path":["distance"]},{"type":"fieldref","path":["diverted"]},{"type":"fieldref","path":["flight_num"]},{"type":"fieldref","path":["flight_time"]},{"type":"fieldref","path":["id2"]},{"type":"fieldref","path":["origin"]},{"type":"fieldref","path":["tail_num"]},{"type":"fieldref","path":["taxi_in"]},{"type":"fieldref","path":["taxi_out"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}},{"type":"project","queryFields":[{"type":"fieldref","path":["fieldName"]},{"type":"fieldref","path":["fieldPath"]},{"type":"fieldref","path":["fieldType"]},{"type":"fieldref","path":["fieldValue"]},{"type":"fieldref","path":["weight"]}],"orderBy":[{"field":"fieldValue"}],"filterList":[{"node":"filterCondition","code":"fieldName = 'carrier'","e":{"node":"=","kids":{"left":{"node":"field","path":["fieldName"]},"right":{"node":"stringLiteral","literal":"carrier"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":8,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"a":2}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { a: 2 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a as a\nFROM (\n        SELECT 2 as a\n      ) as base\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"a","numberType":"integer","type":"number","resultMetadata":{"sourceField":"a","sourceClasses":["a"],"referenceId":"e875bb27-838a-4e82-a7e8-720a67a05a69","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":36},"end":{"line":3,"character":9}}}}],"dialect":"postgres","primaryKey":"a","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"}}],"sourceExplore":"one","connectionName":"databricks","result":[{"a":2}],"totalRows":1},"modelDef":{"name":"","exports":["one"],"contents":{"one":{"type":"sql_select","name":"sql://databricks/9323f89f-13b3-5c73-b969-919b4f95deeb","connection":"databricks","dialect":"postgres","selectStr":"\n        SELECT 2 as a\n      ","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":36},"end":{"line":3,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":3,"character":10}}},"parameters":{},"as":"one"}},"queryList":[{"type":"query","structRef":"one","sourceArguments":{},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["a"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":4,"character":11},"end":{"line":6,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"avg_a":3}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { avg_a: 3, avg_b: 3 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   ((SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(base.a, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(base.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(base.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0)))))) / NULLIF(COUNT(DISTINCT CASE WHEN base.a IS NOT NULL THEN base.__distinct_key END), 0) as avg_a,\n   ((SUM(DISTINCT (CAST(conv(substring(md5(concat(x1_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(x1_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0))) + COALESCE(x1_0.a, 0)) - SUM(DISTINCT (CAST(conv(substring(md5(concat(x1_0.__distinct_key, '')), 1, 16), 16, 10) AS DECIMAL(38,0)) * 4294967296 + CAST(conv(substring(md5(concat(x1_0.__distinct_key, '')), 16, 8), 16, 10) AS DECIMAL(38,0)))))) / NULLIF(COUNT(DISTINCT CASE WHEN x1_0.a IS NOT NULL THEN x1_0.__distinct_key END), 0) as avg_b\nFROM (SELECT uuid() as __distinct_key, x.*  FROM (\n        SELECT 2 as a\n        UNION ALL SELECT 4\n        UNION ALL SELECT null\n      ) as x) as base\n LEFT JOIN (SELECT uuid() as __distinct_key, x.*  FROM (\n        SELECT 2 as a\n        UNION ALL SELECT 4\n        UNION ALL SELECT null\n      ) as x) AS x1_0\n  ON 1=1\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"avg_a","numberType":"integer","type":"number","resultMetadata":{"sourceField":"avg_a","sourceExpression":"a.avg()","sourceClasses":["avg_a"],"referenceId":"c821cfa6-b882-4cfa-a3b6-d8848233e66a","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":26}}}},{"name":"avg_b","numberType":"integer","type":"number","resultMetadata":{"sourceField":"avg_b","sourceExpression":"x1.a.avg()","sourceClasses":["avg_b"],"referenceId":"94291e16-0750-4412-80d9-e2f43ea03a18","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":10},"end":{"line":10,"character":29}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"avg_a","dir":"desc"}]}}],"sourceExplore":"one","connectionName":"databricks","result":[{"avg_a":3,"avg_b":3}],"totalRows":1},"modelDef":{"name":"","exports":["one"],"contents":{"one":{"type":"sql_select","name":"sql://databricks/3d746523-7927-521c-9d71-a24e72d90a94","connection":"databricks","dialect":"postgres","selectStr":"\n        SELECT 2 as a\n        UNION ALL SELECT 4\n        UNION ALL SELECT null\n      ","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":36},"end":{"line":5,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":14},"end":{"line":5,"character":10}}},"parameters":{},"as":"one"}},"queryList":[{"type":"query","structRef":"one","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"avg_a","location":{"url":"internal://internal.malloy","range":{"start":{"line":9,"character":10},"end":{"line":9,"character":26}}},"e":{"node":"aggregate","function":"avg","e":{"node":"field","path":["a"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"a.avg()"},{"type":"number","numberType":"integer","name":"avg_b","location":{"url":"internal://internal.malloy","range":{"start":{"line":10,"character":10},"end":{"line":10,"character":29}}},"e":{"node":"aggregate","function":"avg","e":{"node":"field","path":["x1","a"]},"structPath":["x1"]},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"x1.a.avg()"}],"extendSource":[{"type":"sql_select","name":"x1","connection":"databricks","dialect":"postgres","selectStr":"\n        SELECT 2 as a\n        UNION ALL SELECT 4\n        UNION ALL SELECT null\n      ","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":36},"end":{"line":5,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":30},"end":{"line":7,"character":39}}},"parameters":{},"arguments":{},"join":"cross","matrixOperation":"left"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"avg_a","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":11},"end":{"line":11,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      { state: 'IL', c: 1 }, { state: 'NJ', c: 1 }, { state: 'IN', c: 1 },
      { state: 'CA', c: 1 }, { state: 'OK', c: 1 }, { state: 'WY', c: 1 },
      { state: 'MN', c: 1 }, { state: 'CT', c: 1 }, { state: 'WV', c: 1 },
      { state: 'MT', c: 1 }, { state: 'WI', c: 1 }, { state: 'ND', c: 1 },
      { state: 'NH', c: 1 }, { state: 'OH', c: 1 }, { state: 'ID', c: 1 },
      { state: 'SD', c: 1 }, { state: 'AZ', c: 1 }, { state: 'MI', c: 1 },
      { state: 'OR', c: 1 }, { state: 'MS', c: 1 }, { state: 'NM', c: 1 },
      { state: 'AR', c: 1 }, { state: 'AL', c: 1 }, { state: 'FL', c: 1 },
      { state: 'CO', c: 1 }, { state: 'LA', c: 1 }, { state: 'KS', c: 1 },
      { state: 'KY', c: 1 }, { state: 'VA', c: 1 }, { state: 'NE', c: 1 },
      { state: 'MD', c: 1 }, { state: 'NY', c: 1 }, { state: 'ME', c: 1 },
      { state: 'UT', c: 1 }, { state: 'AK', c: 1 }, { state: 'WA', c: 1 },
      { state: 'DE', c: 1 }, { state: 'PA', c: 1 }, { state: 'SC', c: 1 },
      { state: 'TN', c: 1 }, { state: 'DC', c: 1 }, { state: 'GA', c: 1 },
      { state: 'IA', c: 1 }, { state: 'NC', c: 1 }, { state: 'MO', c: 1 },
      { state: 'VT', c: 1 }, { state: 'TX', c: 1 }, { state: 'MA', c: 1 },
      { state: 'NV', c: 1 }, { state: 'HI', c: 1 }, { state: 'RI', c: 1 }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN expected: {"births_per_100k":9742}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      { state: 'CA', births_per_100k: 9742 },
      { state: 'NY', births_per_100k: 8012 },
      { state: 'TX', births_per_100k: 7259 },
      { state: 'PA', births_per_100k: 5634 },
      { state: 'IL', births_per_100k: 5132 },
      { state: 'OH', births_per_100k: 4802 },
      { state: 'MI', births_per_100k: 3937 },
      { state: 'FL', births_per_100k: 3137 },
      { state: 'NC', births_per_100k: 2854 },
      { state: 'NJ', births_per_100k: 2812 },
      { state: 'GA', births_per_100k: 2767 },
      { state: 'MA', births_per_100k: 2562 },
      { state: 'IN', births_per_100k: 2424 },
      { state: 'MO', births_per_100k: 2296 },
      { state: 'VA', births_per_100k: 2263 },
      { state: 'TN', births_per_100k: 2135 },
      { state: 'WI', births_per_100k: 2058 },
      { state: 'AL', births_per_100k: 1909 },
      { state: 'MN', births_per_100k: 1885 },
      { state: 'LA', births_per_100k: 1877 },
      { state: 'KY', births_per_100k: 1809 },
      { state: 'WA', births_per_100k: 1566 },
      { state: 'MD', births_per_100k: 1511 },
      { state: 'SC', births_per_100k: 1485 },
      { state: 'OK', births_per_100k: 1398 },
      { state: 'IA', births_per_100k: 1389 },
      { state: 'MS', births_per_100k: 1342 },
      { state: 'CO', births_per_100k: 1158 },
      { state: 'CT', births_per_100k: 1136 },
      { state: 'AR', births_per_100k: 1126 },
      { state: 'AZ', births_per_100k: 1125 },
      { state: 'KS', births_per_100k: 1086 },
      { state: 'WV', births_per_100k: 1001 },
      { state: 'OR', births_per_100k: 903 },
      { state: 'UT', births_per_100k: 779 },
      { state: 'NE', births_per_100k: 762 },
      { state: 'NM', births_per_100k: 554 },
      { state: 'DC', births_per_100k: 479 },
      { state: 'ME', births_per_100k: 467 },
      { state: 'RI', births_per_100k: 388 },
      { state: 'ID', births_per_100k: 388 },
      { state: 'ND', births_per_100k: 358 },
      { state: 'SD', births_per_100k: 354 },
      { state: 'NH', births_per_100k: 322 },
      { state: 'HI', births_per_100k: 321 },
      { state: 'MT', births_per_100k: 318 },
      { state: 'NV', births_per_100k: 285 },
      { state: 'DE', births_per_100k: 208 },
      { state: 'VT', births_per_100k: 184 },
      { state: 'WY', births_per_100k: 143 },
      { state: 'AK', births_per_100k: 137 }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage1","malloy":"","sql":"WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      base.state\n      END as state__1,\n    FLOOR(((CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base.births),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base.births),0)\n      END)) OVER ())*100000) as births_per_100k__1\n  FROM malloytest.state_facts as base\n  CROSS JOIN (SELECT EXPLODE(SEQUENCE(0,1,1)) as group_set)\n  GROUP BY 1,2\n)\nSELECT\n  state__1 as state,\n  GET((ARRAY_AGG(births_per_100k__1) FILTER (WHERE group_set=1 AND births_per_100k__1 IS NOT NULL)),0) as births_per_100k\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage1","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"bfeae068-a47f-462f-8db5-97a80a94eb25","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"name":"births_per_100k","type":"number","resultMetadata":{"sourceField":"births_per_100k","sourceExpression":"floor(total_births/ all(total_births) * 100000)","sourceClasses":["births_per_100k"],"referenceId":"9ac807d5-0bdb-4e94-86d8-39d9695d1757","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":17},"end":{"line":3,"character":83}}}}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"births_per_100k","dir":"desc"}]}}],"sourceExplore":"databricks:malloytest.state_facts","connectionName":"databricks","result":[{"state":"CA","births_per_100k":9742},{"state":"NY","births_per_100k":8012},{"state":"TX","births_per_100k":7259},{"state":"PA","births_per_100k":5634},{"state":"IL","births_per_100k":5132},{"state":"OH","births_per_100k":4802},{"state":"MI","births_per_100k":3937},{"state":"FL","births_per_100k":3137},{"state":"NC","births_per_100k":2854},{"state":"NJ","births_per_100k":2812},{"state":"GA","births_per_100k":2767},{"state":"MA","births_per_100k":2562},{"state":"IN","births_per_100k":2424},{"state":"MO","births_per_100k":2296},{"state":"VA","births_per_100k":2263},{"state":"TN","births_per_100k":2135},{"state":"WI","births_per_100k":2058},{"state":"AL","births_per_100k":1909},{"state":"MN","births_per_100k":1885},{"state":"LA","births_per_100k":1877},{"state":"KY","births_per_100k":1809},{"state":"WA","births_per_100k":1566},{"state":"MD","births_per_100k":1511},{"state":"SC","births_per_100k":1485},{"state":"OK","births_per_100k":1398},{"state":"IA","births_per_100k":1389},{"state":"MS","births_per_100k":1342},{"state":"CO","births_per_100k":1158},{"state":"CT","births_per_100k":1136},{"state":"AR","births_per_100k":1126},{"state":"AZ","births_per_100k":1125},{"state":"KS","births_per_100k":1086},{"state":"WV","births_per_100k":1001},{"state":"OR","births_per_100k":903},{"state":"UT","births_per_100k":779},{"state":"NE","births_per_100k":762},{"state":"NM","births_per_100k":554},{"state":"DC","births_per_100k":479},{"state":"ME","births_per_100k":467},{"state":"RI","births_per_100k":388},{"state":"ID","births_per_100k":388},{"state":"ND","births_per_100k":358},{"state":"SD","births_per_100k":354},{"state":"NH","births_per_100k":322},{"state":"HI","births_per_100k":321},{"state":"MT","births_per_100k":318},{"state":"NV","births_per_100k":285},{"state":"DE","births_per_100k":208},{"state":"VT","births_per_100k":184},{"state":"WY","births_per_100k":143},{"state":"AK","births_per_100k":137}],"totalRows":51},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}}},{"type":"number","numberType":"integer","name":"total_births","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":17},"end":{"line":2,"character":45}}},"e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["births"]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"births.sum()"},{"type":"number","name":"births_per_100k","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":17},"end":{"line":3,"character":83}}},"e":{"node":"function_call","overload":{"returnType":{"type":"number","expressionType":"scalar","evalSpace":"input"},"params":[{"name":"value","allowedTypes":[{"type":"number","evalSpace":"input"}],"isVariadic":false}],"dialect":{"postgres":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"standardsql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"duckdb":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"snowflake":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"trino":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"presto":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}},"mysql":{"e":{"node":"genericSQLExpr","kids":{"args":[{"node":"function_parameter","name":"value"}]},"src":["FLOOR(",")"]}}}},"name":"floor","kids":{"args":[{"node":"*","kids":{"left":{"node":"/","kids":{"left":{"node":"field","path":["total_births"],"sql":"(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base.births),0)\n  END)"},"right":{"node":"all","e":{"node":"field","path":["total_births"]},"sql":"MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base.births),0)\n  END)) OVER ()"}},"sql":"((CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base.births),0)\n  END)*1.0/MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base.births),0)\n  END)) OVER ())"},"right":{"node":"numberLiteral","literal":"100000","sql":"100000"}},"sql":"(((CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base.births),0)\n  END)*1.0/MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base.births),0)\n  END)) OVER ())*100000)"}]},"expressionType":"ungrouped_aggregate"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"ungrouped_aggregate","code":"floor(total_births/ all(total_births) * 100000)"}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":53}}},"parameters":{}},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]},{"type":"fieldref","path":["births_per_100k"]}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"births_per_100k","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":7,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: [{"state":"CA","m":52504699},{"state":"NY","m":52504699}]

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { state: 'CA', m: 52504699 }, { state: 'NY', m: 52504699 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage1","malloy":"","sql":"WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      base.state\n      END as state__1,\n    MAX(CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base.births),0)\n      END) OVER () as m__1\n  FROM malloytest.state_facts as base\n  CROSS JOIN (SELECT EXPLODE(SEQUENCE(0,1,1)) as group_set)\n  WHERE base.state IN ('CA','NY')\n  GROUP BY 1,2\n)\nSELECT\n  state__1 as state,\n  GET((ARRAY_AGG(m__1) FILTER (WHERE group_set=1 AND m__1 IS NOT NULL)),0) as m\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 1 ASC NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage1","fields":[{"name":"state","type":"string","resultMetadata":{"sourceField":"state","sourceClasses":["state"],"referenceId":"afc42329-b130-4ba1-bf68-19609e2e8faa","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}}},{"name":"m","numberType":"integer","type":"number","resultMetadata":{"sourceField":"m","sourceExpression":"all(births.sum())","sourceClasses":["m"],"referenceId":"7455e925-ed7a-4d8f-a16c-1c52a815c402","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":17},"end":{"line":2,"character":39}}}}],"dialect":"postgres","primaryKey":"state","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"state='CA' | 'NY'","e":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["state"],"sql":"base.state"},"oneOf":[{"node":"stringLiteral","literal":"CA","sql":"'CA'"},{"node":"stringLiteral","literal":"NY","sql":"'NY'"}]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"state"}]}}],"sourceExplore":"databricks:malloytest.state_facts","connectionName":"databricks","result":[{"state":"CA","m":52504699},{"state":"NY","m":52504699}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}}},{"type":"number","numberType":"integer","name":"m","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":17},"end":{"line":2,"character":39}}},"e":{"node":"all","e":{"node":"aggregate","function":"sum","e":{"node":"field","path":["births"]}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"ungrouped_aggregate","code":"all(births.sum())"}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":1,"character":54}}},"parameters":{},"filterList":[{"node":"filterCondition","code":"state='CA' | 'NY'","e":{"node":"in","not":false,"kids":{"e":{"node":"field","path":["state"],"sql":"base.state"},"oneOf":[{"node":"stringLiteral","literal":"CA","sql":"'CA'"},{"node":"stringLiteral","literal":"NY","sql":"'NY'"}]}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}]},"pipeline":[{"type":"reduce","queryFields":[{"type":"fieldref","path":["state"]},{"type":"fieldref","path":["m"]}],"orderBy":[{"field":"state"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":12},"end":{"line":8,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { one: 1 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { one: 1 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { one: 1 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [
      { carrier: 'AA' }, { carrier: 'AS' },
      { carrier: 'B6' }, { carrier: 'CO' },
      { carrier: 'DL' }, { carrier: 'EV' },
      { carrier: 'HP' }, { carrier: 'MQ' },
      { carrier: 'NW' }, { carrier: 'OH' },
      { carrier: 'RU' }, { carrier: 'TZ' },
      { carrier: 'UA' }, { carrier: 'US' },
      { carrier: 'WN' }
    ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN expected: {"all_births":295727065,"all_name":197260594}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    Exeption when running SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set IN (2,1) THEN
          base.popular_name
          END as popular_name__2,
        CASE WHEN group_set=2 THEN
          base.state
          END as state__2,
        CASE WHEN group_set=2 THEN
          COALESCE(SUM(base.births),0)
          END as total_births__2,
        MAX((CASE WHEN group_set=0 THEN
          COALESCE(SUM(base.births),0)
          END)) OVER () as all_births__2,
        MAX((CASE WHEN group_set=1 THEN
          COALESCE(SUM(base.births),0)
          END)) OVER (PARTITION BY CASE WHEN group_set IN (2,1) THEN
          base.popular_name
          END) as all_name__2
      FROM malloytest.state_facts as base
      CROSS JOIN (SELECT EXPLODE(SEQUENCE(0,2,1)) as group_set)
      GROUP BY 1,2,3
    )
    SELECT
      popular_name__2 as popular_name,
      state__2 as state,
      GET((ARRAY_AGG(total_births__2) FILTER (WHERE group_set=2 AND total_births__2 IS NOT NULL)),0) as total_births,
      GET((ARRAY_AGG(all_births__2) FILTER (WHERE group_set=2 AND all_births__2 IS NOT NULL)),0) as all_births,
      GET((ARRAY_AGG(all_name__2) FILTER (WHERE group_set=2 AND all_name__2 IS NOT NULL)),0) as all_name
    FROM __stage0
    WHERE group_set NOT IN (0,1)
    GROUP BY 1,2
    ORDER BY 3 desc NULLS LAST

      at DatabricksTestConnection.runSQL (test/src/runtimes.ts:128:15)

  console.log
    Exception: Error: [MISSING_AGGREGATION] The non-aggregating expression "popular_name" is based on columns which are not participating in the GROUP BY clause.
    Add the columns or the expression to the GROUP BY, aggregate the expression, or use "any_value(popular_name)" if you do not care which of the values within a group is returned. SQLSTATE: 42803

      at DatabricksTestConnection.runSQL (test/src/runtimes.ts:130:15)

  console.log
    BRIAN expected: {"a":1}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { a: 1 }, { a: 3 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a as a\nFROM (SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4) as base\nORDER BY 1 ASC NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"a","numberType":"integer","type":"number","resultMetadata":{"sourceField":"a","sourceClasses":["a"],"referenceId":"584006a4-6883-41c0-b1a4-ba9e47061ae0","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}}],"dialect":"postgres","primaryKey":"a","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":1}]}}],"sourceExplore":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connectionName":"databricks","result":[{"a":1},{"a":3}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connection":"databricks","dialect":"postgres","selectStr":"SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},{"type":"number","numberType":"integer","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["a"]}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":4,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"a":1}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { a: 1, b: 2 }, { a: 3, b: 4 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a as a,\n   base.b as b\nFROM (SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4) as base\nORDER BY 1 asc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"a","numberType":"integer","type":"number","resultMetadata":{"sourceField":"a","sourceClasses":["a"],"referenceId":"223c3641-2efe-4144-991e-60a8886cc8cb","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":0,"character":5},"end":{"line":0,"character":66}}}},{"name":"b","numberType":"integer","type":"number","resultMetadata":{"sourceField":"b","sourceClasses":["b"],"referenceId":"a50cd8ba-1451-4679-862f-90eddaf0b1a4","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":0,"character":5},"end":{"line":0,"character":66}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"a","dir":"asc"}]}}],"sourceExplore":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connectionName":"databricks","result":[{"a":1,"b":2},{"a":3,"b":4}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connection":"databricks","dialect":"postgres","selectStr":"SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":0,"character":5},"end":{"line":0,"character":66}}}},{"type":"number","numberType":"integer","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":0,"character":5},"end":{"line":0,"character":66}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":0,"character":5},"end":{"line":0,"character":66}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["a"]},{"type":"fieldref","path":["b"]}],"orderBy":[{"field":"a","dir":"asc"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":0,"character":5},"end":{"line":3,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"state_count":6}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { popular_name: 'Emma', SOMETHING: 'something', state_count: 6 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.popular_name as popular_name,\n   base.SOMETHING as SOMETHING,\n   base.state_count as state_count\nFROM (\n        SELECT\n          *\n          , 'something' as SOMETHING\n        FROM (SELECT \n   base.popular_name as popular_name,\n   COUNT(1) as state_count\nFROM malloytest.state_facts as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n) AS by_name_query\n      ) as base\nWHERE base.popular_name='Emma'\nORDER BY 3 desc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"popular_name","type":"string","resultMetadata":{"sourceField":"popular_name","sourceClasses":["popular_name"],"referenceId":"841da6e4-e728-4346-b547-51537282cfc0","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":11,"character":9}}}},{"name":"SOMETHING","type":"string","resultMetadata":{"sourceField":"SOMETHING","sourceClasses":["SOMETHING"],"referenceId":"dc41eea1-3a9c-4b95-80be-3a4e7974ed3e","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":11,"character":9}}}},{"name":"state_count","numberType":"integer","type":"number","resultMetadata":{"sourceField":"state_count","sourceClasses":["state_count"],"referenceId":"3d3a2c17-a6e8-4e5f-bcc6-3cb9a765ffd4","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":11,"character":9}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[{"node":"filterCondition","code":"popular_name = 'Emma'","e":{"node":"=","kids":{"left":{"node":"field","path":["popular_name"],"sql":"base.popular_name"},"right":{"node":"stringLiteral","literal":"Emma","sql":"'Emma'"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"state_count","dir":"desc"}]}}],"sourceExplore":"sql://databricks/64a03b90-2b1a-573b-9938-e709e1344777","connectionName":"databricks","result":[{"popular_name":"Emma","SOMETHING":"something","state_count":6}],"totalRows":1},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/64a03b90-2b1a-573b-9938-e709e1344777","connection":"databricks","dialect":"postgres","selectStr":"\n        SELECT\n          *\n          , 'something' as SOMETHING\n        FROM (SELECT \n   base.popular_name as popular_name,\n   COUNT(1) as state_count\nFROM malloytest.state_facts as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n) AS by_name_query\n      ","fields":[{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":11,"character":9}}}},{"type":"number","numberType":"integer","name":"state_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":11,"character":9}}}},{"type":"string","name":"SOMETHING","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":11,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":11,"character":10}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["popular_name"]},{"type":"fieldref","path":["SOMETHING"]},{"type":"fieldref","path":["state_count"]}],"orderBy":[{"field":"state_count","dir":"desc"}],"filterList":[{"node":"filterCondition","code":"popular_name = 'Emma'","e":{"node":"=","kids":{"left":{"node":"field","path":["popular_name"]},"right":{"node":"stringLiteral","literal":"Emma"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":14,"character":9}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"c":2}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 2 }, { c: 4 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a+1 as c\nFROM (SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4) as base\nORDER BY 1 ASC NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"a + 1","sourceClasses":["c"],"referenceId":"34baf132-434f-494c-a309-4619aaf6490f","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":29},"end":{"line":2,"character":39}}}}],"dialect":"postgres","primaryKey":"c","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":1}]}}],"sourceExplore":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connectionName":"databricks","result":[{"c":2},{"c":4}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connection":"databricks","dialect":"postgres","selectStr":"SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},{"type":"number","numberType":"integer","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["c"]}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":29},"end":{"line":2,"character":39}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a + 1"}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":5,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"c":2}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 2 }, { c: 4 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a+1 as c\nFROM (SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4) as base\nORDER BY 1 ASC NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"a + 1","sourceClasses":["c"],"referenceId":"6b83f393-3f24-4cd4-83e2-4d00000011bf","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":31},"end":{"line":3,"character":41}}}}],"dialect":"postgres","primaryKey":"c","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":1}]}}],"sourceExplore":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","queryName":"bar","connectionName":"databricks","annotation":{"inherits":{}},"result":[{"c":2},{"c":4}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connection":"databricks","dialect":"postgres","selectStr":"SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},{"type":"number","numberType":"integer","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},{"type":"turtle","name":"bar","pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["c"]}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":31},"end":{"line":3,"character":41}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a + 1"}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"annotation":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":14},"end":{"line":6,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}},"parameters":{}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["c"]}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":31},"end":{"line":3,"character":41}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a + 1"}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":7,"character":14}}},"name":"bar","annotation":{"inherits":{}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"d":3}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 2, d: 3 }, { c: 4, d: 5 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a+1 as c,\n   (base.a+1)+1 as d\nFROM (SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4) as base\nORDER BY 1 ASC NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"a + 1","sourceClasses":["c"],"referenceId":"0608acb0-8c0f-4643-ab2e-18415fc0ff66","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":30},"end":{"line":3,"character":40}}}},{"name":"d","type":"number","resultMetadata":{"sourceField":"d","sourceExpression":"c + 1","sourceClasses":["d"],"referenceId":"95063d3a-4b75-4728-a244-c5316654a308","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":30},"end":{"line":8,"character":40}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":1}]}}],"sourceExplore":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","queryName":"baz","connectionName":"databricks","annotation":{"inherits":{"inherits":{}}},"result":[{"c":2,"d":3},{"c":4,"d":5}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/d22e79ea-9dc8-5064-9f3d-bfe453230304","connection":"databricks","dialect":"postgres","selectStr":"SELECT 1 as a, 2 as b UNION ALL SELECT 3, 4","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},{"type":"number","numberType":"integer","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}}},{"type":"turtle","name":"bar","pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["c"]}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":30},"end":{"line":3,"character":40}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a + 1"}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"annotation":{},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":14},"end":{"line":6,"character":9}}}},{"type":"turtle","name":"baz","pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["c"]},{"type":"fieldref","path":["d"]}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":30},"end":{"line":3,"character":40}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a + 1"},{"type":"number","name":"d","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":30},"end":{"line":8,"character":40}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["c"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"c + 1"}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"annotation":{"inherits":{}},"location":{"url":"internal://internal.malloy","range":{"start":{"line":7,"character":14},"end":{"line":11,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":1,"character":72}}},"parameters":{}},"pipeline":[{"type":"project","queryFields":[{"type":"fieldref","path":["c"]},{"type":"fieldref","path":["d"]}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":30},"end":{"line":3,"character":40}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a + 1"},{"type":"number","name":"d","location":{"url":"internal://internal.malloy","range":{"start":{"line":8,"character":30},"end":{"line":8,"character":40}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["c"]},"right":{"node":"numberLiteral","literal":"1"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"c + 1"}],"orderBy":[{"field":1}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":12,"character":14}}},"name":"baz","annotation":{"inherits":{"inherits":{}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"llo":2,"m2":1}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { llo: 2, m2: 1 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   COUNT(CASE WHEN base.a RLIKE 'llo' THEN 1 END) as llo,\n   COUNT(CASE WHEN COALESCE(NOT (base.a RLIKE 'bozo'),TRUE) THEN 1 END) as m2\nFROM (\n        SELECT 'hello mom' as a, 'cheese tastes good' as b\n        UNION ALL SELECT 'lloyd is a bozo', 'michael likes poetry'\n      ) as base\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"llo","numberType":"integer","type":"number","resultMetadata":{"sourceField":"llo","sourceExpression":"count() {where: a ~ r'llo'}","sourceClasses":["llo"],"referenceId":"9ae809ec-dfa4-4029-98d9-138e36943724","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":19},"end":{"line":5,"character":53}}}},{"name":"m2","numberType":"integer","type":"number","resultMetadata":{"sourceField":"m2","sourceExpression":"count() {where: a !~ r'bozo'}","sourceClasses":["m2"],"referenceId":"9a0c2be4-ca97-4d6a-afac-5465bf989702","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":19},"end":{"line":6,"character":54}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"llo","dir":"desc"}]}}],"sourceExplore":"sql://databricks/b68f2fb6-c8d9-5320-9764-3ab902bf3258","connectionName":"databricks","result":[{"llo":2,"m2":1}],"totalRows":1},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/b68f2fb6-c8d9-5320-9764-3ab902bf3258","connection":"databricks","dialect":"postgres","selectStr":"\n        SELECT 'hello mom' as a, 'cheese tastes good' as b\n        UNION ALL SELECT 'lloyd is a bozo', 'michael likes poetry'\n      ","fields":[{"type":"string","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":4,"character":9}}}},{"type":"string","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":4,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":4,"character":10}}}},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"llo","location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":19},"end":{"line":5,"character":53}}},"e":{"node":"filteredExpr","kids":{"e":{"node":"aggregate","function":"count","e":{"node":""}},"filterList":[{"node":"filterCondition","code":"a ~ r'llo'","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["a"]},"regex":{"node":"regexpLiteral","literal":"llo"}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count() {where: a ~ r'llo'}"},{"type":"number","numberType":"integer","name":"m2","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":19},"end":{"line":6,"character":54}}},"e":{"node":"filteredExpr","kids":{"e":{"node":"aggregate","function":"count","e":{"node":""}},"filterList":[{"node":"filterCondition","code":"a !~ r'bozo'","e":{"node":"not","e":{"node":"regexpMatch","kids":{"expr":{"node":"field","path":["a"]},"regex":{"node":"regexpLiteral","literal":"bozo"}}}},"expressionType":"scalar","compositeFieldUsage":{"fields":[],"joinedUsage":{}}}]}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count() {where: a !~ r'bozo'}"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"llo","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":7,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"x":30}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { x: 30 }, { x: 24 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   base.a*(base.b+4) as x\nFROM (\n        SELECT 5 as a, 2 as b\n        UNION ALL SELECT 3, 4\n      ) as base\nORDER BY 1 desc NULLS LAST\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"x","type":"number","resultMetadata":{"sourceField":"x","sourceExpression":"a * c","sourceClasses":["x"],"referenceId":"0fa916cd-53d8-473d-b814-8feb87778c88","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":16},"end":{"line":6,"character":27}}}}],"dialect":"postgres","primaryKey":"x","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"x","dir":"desc"}]}}],"sourceExplore":"sql://databricks/51fc242c-0360-526e-81c1-27731f2628da","connectionName":"databricks","result":[{"x":30},{"x":24}],"totalRows":2},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/51fc242c-0360-526e-81c1-27731f2628da","connection":"databricks","dialect":"postgres","selectStr":"\n        SELECT 5 as a, 2 as b\n        UNION ALL SELECT 3, 4\n      ","fields":[{"type":"number","numberType":"integer","name":"a","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":4,"character":9}}}},{"type":"number","numberType":"integer","name":"b","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":4,"character":9}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":4,"character":10}}}},"pipeline":[{"type":"project","queryFields":[{"type":"number","name":"x","location":{"url":"internal://internal.malloy","range":{"start":{"line":6,"character":16},"end":{"line":6,"character":27}}},"e":{"node":"*","kids":{"left":{"node":"field","path":["a"]},"right":{"node":"field","path":["c"]}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"a * c"}],"extendSource":[{"type":"number","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":5,"character":29},"end":{"line":5,"character":39}}},"e":{"node":"+","kids":{"left":{"node":"field","path":["b"]},"right":{"node":"numberLiteral","literal":"4"}}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"b + 4"}],"orderBy":[{"field":"x","dir":"desc"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":11},"end":{"line":8,"character":7}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { airport_count: 19701 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { airport_count: 19701 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { x: 19701 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { x: 19701 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN expected: {"tick":"'"}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { tick: '' } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   '''' as tick\nFROM (SELECT 1 as one) as base\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"tick","type":"string","resultMetadata":{"sourceField":"tick","sourceExpression":"'\\''","sourceClasses":["tick"],"referenceId":"0a63b715-782e-453b-ab02-b5f1d55e6d66","fieldKind":"dimension"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":18},"end":{"line":2,"character":30}}}}],"dialect":"postgres","primaryKey":"tick","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct"}}],"sourceExplore":"sql://databricks/41039b60-64d7-5e39-a4da-2d99662d5b41","connectionName":"databricks","result":[{"tick":""}],"totalRows":1},"modelDef":{"name":"","exports":[],"contents":{},"queryList":[{"type":"query","structRef":{"type":"sql_select","name":"sql://databricks/41039b60-64d7-5e39-a4da-2d99662d5b41","connection":"databricks","dialect":"postgres","selectStr":"SELECT 1 as one","fields":[{"type":"number","numberType":"integer","name":"one","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":1,"character":46}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":1,"character":46}}}},"pipeline":[{"type":"project","queryFields":[{"type":"string","name":"tick","location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":18},"end":{"line":2,"character":30}}},"e":{"node":"stringLiteral","literal":"'"},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"scalar","code":"'\\''"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":13},"end":{"line":3,"character":9}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

  console.log
    BRIAN expected: {"back":"\\"}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    Exeption when running SQL:
     SELECT 
       '\' as back
    FROM (SELECT 1 as one) as base

      at DatabricksTestConnection.runSQL (test/src/runtimes.ts:128:15)

  console.log
    Exception: Error: 
    [PARSE_SYNTAX_ERROR] Syntax error at or near '''. SQLSTATE: 42601 (line 2, pos 3)
    
    == SQL ==
    SELECT 
       '\' as back
    ---^^^
    FROM (SELECT 1 as one) as base

      at DatabricksTestConnection.runSQL (test/src/runtimes.ts:130:15)

  console.log
    BRIAN expected: {"c":51}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:122:13)

{"level":"info","message":"Created DBSQLClient"}
{"level":"info","message":"DBSQLClient: initializing thrift client"}
  console.log
    BRIAN databricks pure result:

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:381:17)

  console.log
    [ { c: 51 } ]

      at _callee12$ (packages/malloy-db-databricks/src/databricks_connection.ts:382:17)

  console.log
    BRIAN actual result: {"queryResult":{"lastStageName":"__stage0","malloy":"","sql":"SELECT \n   COUNT(1) as c\nFROM malloytest.state_facts as base\n","dependenciesToMaterialize":{},"structs":[{"type":"query_result","name":"__stage0","fields":[{"name":"c","numberType":"integer","type":"number","resultMetadata":{"sourceField":"c","sourceExpression":"count()","sourceClasses":["c"],"referenceId":"22011222-1eda-4d84-aad8-47500b4fb5bb","filterList":[],"fieldKind":"measure"},"location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":21},"end":{"line":3,"character":33}}}}],"dialect":"postgres","connection":"databricks","resultMetadata":{"sourceField":"ignoreme","filterList":[],"sourceClasses":["ignoreme"],"fieldKind":"struct","orderBy":[{"field":"c","dir":"desc"}]}}],"sourceExplore":"create","connectionName":"databricks","result":[{"c":51}],"totalRows":1},"modelDef":{"name":"","exports":["create"],"contents":{"create":{"type":"table","name":"databricks:malloytest.state_facts","dialect":"postgres","tablePath":"malloytest.state_facts","connection":"databricks","fields":[{"type":"string","name":"state","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":1,"character":68}}}},{"type":"number","numberType":"integer","name":"aircraft_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":1,"character":68}}}},{"type":"number","numberType":"integer","name":"airport_count","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":1,"character":68}}}},{"type":"number","numberType":"integer","name":"births","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":1,"character":68}}}},{"type":"string","name":"popular_name","location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":26},"end":{"line":1,"character":68}}}}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":1,"character":16},"end":{"line":1,"character":68}}},"parameters":{},"as":"create"}},"queryList":[{"type":"query","structRef":"create","sourceArguments":{},"pipeline":[{"type":"reduce","queryFields":[{"type":"number","numberType":"integer","name":"c","location":{"url":"internal://internal.malloy","range":{"start":{"line":3,"character":21},"end":{"line":3,"character":33}}},"e":{"node":"aggregate","function":"count","e":{"node":""}},"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"expressionType":"aggregate","code":"count()"}],"filterList":[],"compositeFieldUsage":{"fields":[],"joinedUsage":{}},"defaultOrderBy":true,"orderBy":[{"field":"c","dir":"desc"}]}],"location":{"url":"internal://internal.malloy","range":{"start":{"line":2,"character":13},"end":{"line":4,"character":9}}}}],"dependencies":{}}}

      at Object.malloyResultMatches (test/src/util/db-jest-matchers.ts:154:15)

FAIL test/src/databases/all/nomodel.spec.ts (68.797 s)
  ✓ parenthesize output field values - databricks (3426 ms)
  ✓ bug 151 which used to throw unknown dialect is still fixed- databricks (1842 ms)
  ✓ refine query from query  - databricks (1728 ms)
  ✓ source- not -found  - databricks (20 ms)
  ✓ join_many - databricks (2871 ms)
  ✓ join_many condition no primary key - databricks (1670 ms)
  ✓ join_many filter multiple values - databricks (1778 ms)
  ✓ join_one condition no primary key - databricks (1142 ms)
  ✓ join_one filter multiple values - databricks (1092 ms)
  ✓ join_many cross from  - databricks (1180 ms)
  ✓ join_one only  - databricks (1078 ms)
  ✓ join_many cross ON  - databricks (981 ms)
  ✓ limit - provided - databricks (769 ms)
  ✓ join inner- databricks (1450 ms)
  ✓ join left - databricks (1002 ms)
  ✓ join right - databricks (1118 ms)
  ✓ join full - databricks (1339 ms)
  ✓ leafy count - databricks (868 ms)
  ✓ nest/unnest -basic - databricks (1 ms)
  ✓ count at root should not use distinct key - databricks (884 ms)
  ✓ leafy nested count - databricks (2 ms)
  ✓ basic index - databricks (5041 ms)
  ✓ sql block- databricks (1399 ms)
  ✓ avg ignore null- databricks (2231 ms)
  ✓ limit - not provided - databricks (913 ms)
  ✓ ungrouped top level - databricks (1036 ms)
  ✓ ungrouped - eliminate rows  - databricks (955 ms)
  ✓ run simple sql - databricks (1242 ms)
  ✓ simple sql is exactly as written - databricks (505 ms)
  ✓ source from query defined as sql query - databricks (501 ms)
  ✓ source from query defined as other query - databricks (1119 ms)
  ✕ all with parameters - basic  - databricks (573 ms)
  ✓ sql as source - databricks (1399 ms)
  ✓ sql directly - databricks (593 ms)
  ✓ sql with turducken- databricks (1984 ms)
  ✓ local declarations external query - databricks (588 ms)
  ✓ local declarations named query - databricks (590 ms)
  ✓ local declarations refined named query - databricks (656 ms)
  ✓ regexp match- databricks (1895 ms)
  ✓ substitution precedence- databricks (1386 ms)
  ✓ removes surpuflous order_by - solo aggregates - databricks (557 ms)
  ✓ removes surpuflous order_by - pipeline - databricks (951 ms)
  ✓ removes surpuflous order_by - joined_query - databricks (1008 ms)
  ✓ removes surpuflous order_by - joined_query pipeline - databricks (925 ms)
  ○ skipped number as null 2 - databricks
  ○ skipped ungrouped top level with nested  - databricks
  ○ skipped ungrouped nested with no grouping above - databricks
  ○ skipped ungrouped - partial grouping - databricks
  ○ skipped ungrouped - all nested - databricks
  ○ skipped ungrouped nested  - databricks
  ○ skipped ungrouped nested expression  - databricks
  ○ skipped ungrouped nested group by float  - databricks
  ○ skipped all with parameters - nest  - databricks
  ○ skipped single value to udf - databricks
  ○ skipped Multi value to udf - databricks
  ○ skipped Multi value to udf group by - databricks
  ○ skipped array unnest - databricks
  ○ skipped array unnest x 2 - databricks
  ○ skipped can unnest simply from file - databricks
  ○ skipped can unnest from file - databricks
  ○ skipped can double unnest - databricks
  ○ skipped nest null - databricks
  ○ skipped Nested pipelines sort properly - databricks
  ○ skipped number as null- databricks
  quoting and strings
    ✕ backslash quote (1269 ms)
    ✕ backslash backslash (351 ms)
    ✓ source with reserve word (586 ms)
    ○ skipped spaces in names

  ● all with parameters - basic  - databricks

    query.run failed: [MISSING_AGGREGATION] The non-aggregating expression "popular_name" is based on columns which are not participating in the GROUP BY clause.
    Add the columns or the expression to the GROUP BY, aggregate the expression, or use "any_value(popular_name)" if you do not care which of the values within a group is returned. SQLSTATE: 42803
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set IN (2,1) THEN
          base.popular_name
          END as popular_name__2,
        CASE WHEN group_set=2 THEN
          base.state
          END as state__2,
        CASE WHEN group_set=2 THEN
          COALESCE(SUM(base.births),0)
          END as total_births__2,
        MAX((CASE WHEN group_set=0 THEN
          COALESCE(SUM(base.births),0)
          END)) OVER () as all_births__2,
        MAX((CASE WHEN group_set=1 THEN
          COALESCE(SUM(base.births),0)
          END)) OVER (PARTITION BY CASE WHEN group_set IN (2,1) THEN
          base.popular_name
          END) as all_name__2
      FROM malloytest.state_facts as base
      CROSS JOIN (SELECT EXPLODE(SEQUENCE(0,2,1)) as group_set)
      GROUP BY 1,2,3
    )
    SELECT
      popular_name__2 as popular_name,
      state__2 as state,
      GET((ARRAY_AGG(total_births__2) FILTER (WHERE group_set=2 AND total_births__2 IS NOT NULL)),0) as total_births,
      GET((ARRAY_AGG(all_births__2) FILTER (WHERE group_set=2 AND all_births__2 IS NOT NULL)),0) as all_births,
      GET((ARRAY_AGG(all_name__2) FILTER (WHERE group_set=2 AND all_name__2 IS NOT NULL)),0) as all_name
    FROM __stage0
    WHERE group_set NOT IN (0,1)
    GROUP BY 1,2
    ORDER BY 3 desc NULLS LAST

    Error: [MISSING_AGGREGATION] The non-aggregating expression "popular_name" is based on columns which are not participating in the GROUP BY clause.
    Add the columns or the expression to the GROUP BY, aggregate the expression, or use "any_value(popular_name)" if you do not care which of the values within a group is returned. SQLSTATE: 42803

      841 |           all_name is exclude(total_births, state)
      842 |       }
    > 843 |     `).malloyResultMatches(runtime, {
          |        ^
      844 |       all_births: 295727065,
      845 |       all_name: 197260594,
      846 |     });

      at DBSQLOperation.waitUntilReady (node_modules/@databricks/sql/lib/DBSQLOperation.ts:369:17)
      at async DBSQLOperation.fetchChunk (node_modules/@databricks/sql/lib/DBSQLOperation.ts:173:5)
      at async DBSQLOperation.fetchAll (node_modules/@databricks/sql/lib/DBSQLOperation.ts:149:21)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:843:8)

  ● quoting and strings › backslash quote

    SQL Generated:
      SELECT 
         '''' as tick
      FROM (SELECT 1 as one) as base
      
    Expected {tick: "'"} Got: ""

      1339 |           select: tick is '${back}${tick}'
      1340 |         }
    > 1341 |       `).malloyResultMatches(runtime, {tick});
           |          ^
      1342 |     });
      1343 |     test('backslash backslash', async () => {
      1344 |       await expect(`

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1341:10)

  ● quoting and strings › backslash backslash

    query.run failed: 
    [PARSE_SYNTAX_ERROR] Syntax error at or near '''. SQLSTATE: 42601 (line 2, pos 3)

    == SQL ==
    SELECT 
       '\' as back
    ---^^^
    FROM (SELECT 1 as one) as base

    SQL: SELECT 
       '\' as back
    FROM (SELECT 1 as one) as base

    [PARSE_SYNTAX_ERROR] Syntax error at or near '''. SQLSTATE: 42601 (line 2, pos 3)

    == SQL ==
    SELECT 
       '\' as back
    ---^^^
    FROM (SELECT 1 as one) as base

      1346 |           select: back is '${back}${back}'
      1347 |         }
    > 1348 |       `).malloyResultMatches(runtime, {back});
           |          ^
      1349 |     });
      1350 |
      1351 |     test('source with reserve word', async () => {

      at DBSQLOperation.waitUntilReady (node_modules/@databricks/sql/lib/DBSQLOperation.ts:369:17)
      at async DBSQLOperation.fetchChunk (node_modules/@databricks/sql/lib/DBSQLOperation.ts:173:5)
      at async DBSQLOperation.fetchAll (node_modules/@databricks/sql/lib/DBSQLOperation.ts:149:21)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1348:10)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 21 skipped, 44 passed, 68 total
Snapshots:   0 total
Time:        68.901 s
Ran all test suites matching /nomodel/i.
