
> malloy@0.0.1 test
> jest --runInBand

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp2e2cc419b76b4500a2a079c1bdc488b0;\n' +
        '      create temp table tmp2e2cc419b76b4500a2a079c1bdc488b0 as SELECT * FROM (\n' +
        '        \n' +
        '        SELECT 2 as "a"\n' +
        '      \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp2e2cc419b76b4500a2a079c1bdc488b0';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp2e2cc419b76b4500a2a079c1bdc488b0;
          create temp table tmp2e2cc419b76b4500a2a079c1bdc488b0 as SELECT * FROM (
            
            SELECT 2 as "a"
          
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp2e2cc419b76b4500a2a079c1bdc488b0';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp1abb3302574f4a8aa4d5ef5aafd1e409;\n' +
        '      create temp table tmp1abb3302574f4a8aa4d5ef5aafd1e409 as SELECT * FROM (\n' +
        '        \n' +
        '        SELECT 2 as "a"\n' +
        '        UNION ALL SELECT 4\n' +
        '        UNION ALL SELECT null\n' +
        '      \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp1abb3302574f4a8aa4d5ef5aafd1e409';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp1abb3302574f4a8aa4d5ef5aafd1e409;
          create temp table tmp1abb3302574f4a8aa4d5ef5aafd1e409 as SELECT * FROM (
            
            SELECT 2 as "a"
            UNION ALL SELECT 4
            UNION ALL SELECT null
          
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp1abb3302574f4a8aa4d5ef5aafd1e409';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpdfc897e0a1744d93897d94dbdc8eaf92;\n' +
        '      create temp table tmpdfc897e0a1744d93897d94dbdc8eaf92 as SELECT * FROM (\n' +
        '        select 1 as "one"\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpdfc897e0a1744d93897d94dbdc8eaf92';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpdfc897e0a1744d93897d94dbdc8eaf92;
          create temp table tmpdfc897e0a1744d93897d94dbdc8eaf92 as SELECT * FROM (
            select 1 as "one"
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpdfc897e0a1744d93897d94dbdc8eaf92';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT\n' +
        '    group_set,\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      COUNT(1)\n' +
        '      END as "t__1"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n' +
        '  GROUP BY 1\n' +
        ')\n' +
        ', __stage1 AS (\n' +
        '  SELECT\n' +
        '    (WITH __stage0 AS (\n' +
        '      SELECT \n' +
        `         JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"\n` +
        '      FROM UNNEST(ARRAY((SELECT TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT \n' +
        '        "t__1"::DOUBLE PRECISION as "t") as __x)) FILTER (WHERE group_set=1))[1])))) as base\n' +
        '    )\n' +
        '    SELECT JSONB_AGG(__stage0) FROM __stage0\n' +
        '    ) as "fun"\n' +
        '  FROM __stage0\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1
    )
    , __stage1 AS (
      SELECT
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM UNNEST(ARRAY((SELECT TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT 
            "t__1"::DOUBLE PRECISION as "t") as __x)) FILTER (WHERE group_set=1))[1])))) as base
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT\n' +
        '    group_set,\n' +
        '    2 as "two__0",\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      1\n' +
        '      END as "one__1",\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      COUNT(1)\n' +
        '      END as "t__1"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n' +
        '  GROUP BY 1,2,3\n' +
        ')\n' +
        ', __stage1 AS (\n' +
        '  SELECT\n' +
        '    "two__0" as "two",\n' +
        '    (WITH __stage0 AS (\n' +
        '      SELECT \n' +
        `         JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"\n` +
        '      FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n' +
        '        "one__1"::DOUBLE PRECISION as "one", \n' +
        '        "t__1"::DOUBLE PRECISION as "t"\n' +
        `        ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base\n` +
        '    )\n' +
        '    SELECT JSONB_AGG(__stage0) FROM __stage0\n' +
        '    ) as "fun"\n' +
        '  FROM __stage0\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        2 as "two__0",
        CASE WHEN group_set=1 THEN
          1
          END as "one__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3
    )
    , __stage1 AS (
      SELECT
        "two__0" as "two",
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
            "one__1"::DOUBLE PRECISION as "one", 
            "t__1"::DOUBLE PRECISION as "t"
            ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT\n' +
        '    group_set,\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      1\n' +
        '      END as "one__1",\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      COUNT(1)\n' +
        '      END as "t__1"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n' +
        '  GROUP BY 1,2\n' +
        ')\n' +
        ', __stage1 AS (\n' +
        '  SELECT\n' +
        '    (WITH __stage0 AS (\n' +
        '      SELECT \n' +
        `         JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"\n` +
        '      FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n' +
        '        "one__1"::DOUBLE PRECISION as "one", \n' +
        '        "t__1"::DOUBLE PRECISION as "t"\n' +
        `        ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base\n` +
        '      GROUP BY 1\n' +
        '      ORDER BY 1 asc NULLS LAST\n' +
        '    )\n' +
        '    SELECT JSONB_AGG(__stage0) FROM __stage0\n' +
        '    ) as "fun"\n' +
        '  FROM __stage0\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set=1 THEN
          1
          END as "one__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2
    )
    , __stage1 AS (
      SELECT
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
            "one__1"::DOUBLE PRECISION as "one", 
            "t__1"::DOUBLE PRECISION as "t"
            ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base
          GROUP BY 1
          ORDER BY 1 asc NULLS LAST
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpdaa75e24292b4c1f8afe1377499aa9e7;\n' +
        '      create temp table tmpdaa75e24292b4c1f8afe1377499aa9e7 as SELECT * FROM (\n' +
        '        SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpdaa75e24292b4c1f8afe1377499aa9e7';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpdaa75e24292b4c1f8afe1377499aa9e7;
          create temp table tmpdaa75e24292b4c1f8afe1377499aa9e7 as SELECT * FROM (
            SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpdaa75e24292b4c1f8afe1377499aa9e7';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp9374ec2304644c878f60d11959b2fb98;\n' +
        '      create temp table tmp9374ec2304644c878f60d11959b2fb98 as SELECT * FROM (\n' +
        '        \n' +
        `        SELECT 'hello mom' as "a", 'cheese tastes good' as "b"\n` +
        "        UNION ALL SELECT 'lloyd is a bozo', 'michael likes poetry'\n" +
        '      \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp9374ec2304644c878f60d11959b2fb98';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp9374ec2304644c878f60d11959b2fb98;
          create temp table tmp9374ec2304644c878f60d11959b2fb98 as SELECT * FROM (
            
            SELECT 'hello mom' as "a", 'cheese tastes good' as "b"
            UNION ALL SELECT 'lloyd is a bozo', 'michael likes poetry'
          
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp9374ec2304644c878f60d11959b2fb98';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp0ee829a9e0254870ba9b365bcee188d1;\n' +
        '      create temp table tmp0ee829a9e0254870ba9b365bcee188d1 as SELECT * FROM (\n' +
        '        \n' +
        '        SELECT 5 as "a", 2 as "b"\n' +
        '        UNION ALL SELECT 3, 4\n' +
        '      \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp0ee829a9e0254870ba9b365bcee188d1';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp0ee829a9e0254870ba9b365bcee188d1;
          create temp table tmp0ee829a9e0254870ba9b365bcee188d1 as SELECT * FROM (
            
            SELECT 5 as "a", 2 as "b"
            UNION ALL SELECT 3, 4
          
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp0ee829a9e0254870ba9b365bcee188d1';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpa6d29f071d7b4f66be763c7071495445;\n' +
        '      create temp table tmpa6d29f071d7b4f66be763c7071495445 as SELECT * FROM (\n' +
        '        SELECT 1 as one\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpa6d29f071d7b4f66be763c7071495445';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpa6d29f071d7b4f66be763c7071495445;
          create temp table tmpa6d29f071d7b4f66be763c7071495445 as SELECT * FROM (
            SELECT 1 as one
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpa6d29f071d7b4f66be763c7071495445';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/nomodel.spec.ts (35.567 s)
  ✕ parenthesize output field values - redshift (1798 ms)
  ✕ bug 151 which used to throw unknown dialect is still fixed- redshift (126 ms)
  ✕ refine query from query - redshift (1524 ms)
  ✓ source- not -found  - redshift (28 ms)
  ✕ join_many - redshift (1593 ms)
  ✕ join_many condition no primary key - redshift (1539 ms)
  ✕ join_many filter multiple values - redshift (20 ms)
  ✕ join_one condition no primary key - redshift (12 ms)
  ✕ join_one filter multiple values - redshift (13 ms)
  ✕ join_many cross from  - redshift (29 ms)
  ✕ join_one only  - redshift (15 ms)
  ✕ join_many cross ON  - redshift (9 ms)
  ✕ limit - provided - redshift (5 ms)
  ✕ join inner- redshift (121 ms)
  ✕ join left - redshift (11 ms)
  ✕ join right - redshift (13 ms)
  ✕ join full - redshift (11 ms)
  ✕ leafy count - redshift (8 ms)
  ✕ nest/unnest -basic - redshift (18 ms)
  ✕ count at root should not use distinct key - redshift (6 ms)
  ✕ leafy nested count - redshift (12 ms)
  ✕ basic index - redshift (1553 ms)
  ✕ number as null 2 - redshift (24 ms)
  ✕ sql block- redshift (1409 ms)
  ✕ avg ignore null- redshift (1514 ms)
  ✕ limit - not provided - redshift (15 ms)
  ✕ ungrouped top level - redshift (14 ms)
  ✕ ungrouped top level with nested  - redshift (13 ms)
  ✕ ungrouped - eliminate rows  - redshift (11 ms)
  ✕ ungrouped nested with no grouping above - redshift (10 ms)
  ✕ ungrouped - partial grouping - redshift (25 ms)
  ✕ ungrouped - all nested - redshift (13 ms)
  ✕ ungrouped nested  - redshift (7 ms)
  ✕ ungrouped nested expression  - redshift (7 ms)
  ✕ ungrouped nested group by float  - redshift (6 ms)
  ✕ run simple sql - redshift (1492 ms)
  ✕ simple sql is exactly as written - redshift (11 ms)
  ✕ source from query defined as sql query - redshift (10 ms)
  ✕ source from query defined as other query - redshift (11 ms)
  ✕ all with parameters - basic  - redshift (9 ms)
  ✕ all with parameters - nest  - redshift (11 ms)
  ✕ single value to udf - redshift (1522 ms)
  ✕ Multi value to udf - redshift (1341 ms)
  ✕ Multi value to udf group by - redshift (1368 ms)
  ✕ sql as source - redshift (1394 ms)
  ✕ sql directly - redshift (12 ms)
  ✕ sql with turducken- redshift (19 ms)
  ✕ local declarations external query - redshift (8 ms)
  ✕ local declarations named query - redshift (16 ms)
  ✕ local declarations refined named query - redshift (29 ms)
  ✕ regexp match- redshift (1499 ms)
  ✕ substitution precedence- redshift (1457 ms)
  ✕ array unnest - redshift (1 ms)
  ✕ array unnest x 2 - redshift (1 ms)
  ✕ nest null - redshift (28 ms)
  ✕ Nested pipelines sort properly - redshift (33 ms)
  ✕ number as null- redshift (8 ms)
  ✕ removes surpuflous order_by - solo aggregates - redshift (5 ms)
  ✕ removes surpuflous order_by - pipeline - redshift (5 ms)
  ✕ removes surpuflous order_by - joined_query - redshift (9 ms)
  ✕ removes surpuflous order_by - joined_query pipeline - redshift (8 ms)
  ○ skipped can unnest simply from file - redshift
  ○ skipped can unnest from file - redshift
  ○ skipped can double unnest - redshift
  quoting and strings
    ✕ backslash quote (1567 ms)
    ✕ backslash backslash (13 ms)
    ✕ source with reserve word (11 ms)
    ✕ spaces in names (49 ms)

  ● parenthesize output field values - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'r',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 18 },
              end: { line: 2, character: 26 }
            }
          },
          e: { node: 'numberLiteral', literal: '1.0' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: '1.0'
        },
        {
          type: 'number',
          name: 'zero',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 10 },
              end: { line: 5, character: 28 }
            }
          },
          e: {
            node: '-',
            kids: {
              left: { node: 'numberLiteral', literal: '1' },
              right: {
                node: 'function_call',
                overload: {
                  returnType: {
                    type: 'number',
                    expressionType: 'scalar_analytic',
                    evalSpace: 'input'
                  },
                  params: [],
                  dialect: {
                    postgres: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    standardsql: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    duckdb: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    snowflake: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    trino: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    presto: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    mysql: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    databricks: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    redshift: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    }
                  },
                  supportsOrderBy: undefined,
                  supportsLimit: undefined,
                  genericTypes: undefined,
                  isSymmetric: undefined
                },
                name: 'rank',
                kids: { args: [] },
                expressionType: 'scalar_analytic',
                structPath: undefined
              }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: '1 - rank()'
        },
        {
          type: 'number',
          name: 'zero_bare',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 6, character: 10 },
              end: { line: 6, character: 32 }
            }
          },
          e: {
            node: '-',
            kids: {
              left: { node: 'numberLiteral', literal: '0' },
              right: { node: 'outputField', name: 'zero' }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: '0 - zero'
        },
        {
          type: 'number',
          name: 'zero_paren',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 34 }
            }
          },
          e: {
            node: '-',
            kids: {
              left: { node: 'numberLiteral', literal: '0' },
              right: {
                node: '()',
                e: { node: 'outputField', name: 'zero' }
              }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: '0 - (zero)'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'r', dir: 'asc' } ]
    }
      |       run: redshift.table('malloytest.aircraft') -> {
      |            ^

      78 |           zero_paren is 0 - (zero)
      79 |       }
    > 80 |     `).malloyResultMatches(runtime, {zero_bare: 0, zero_paren: 0});
         |        ^
      81 |   });
      82 |
      83 |   // Issue: #151

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:80:8)

  ● bug 151 which used to throw unknown dialect is still fixed- redshift

    Could not prepare query to run: Cannot read properties of undefined (reading 'type')

      94 |         }
      95 |       } -> foo
    > 96 |       `).malloyResultMatches(runtime, {state: 'WY'});
         |          ^
      97 |   });
      98 |
      99 |   // Issue #149

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:96:10)

  ● refine query from query - redshift

    Could not prepare query to run: Cannot read properties of undefined (reading 'type')

      105 |           dimension: lower_state is lower(state)
      106 |         } -> {select: lower_state}
    > 107 |     `).malloyResultMatches(runtime, {lower_state: 'wy'});
          |        ^
      108 |   });
      109 |
      110 |   // issue #157

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:107:8)

  ● join_many - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'year_built' is not defined
      |             measure: avg_year is floor(avg(year_built))
      |                                            ^
    line 7: 'seats' is not defined
      |         measure: avg_seats is floor(avg(seats))
      |                                         ^
    line 6: 'aircraft_model_code' is not defined
      |           } on a.aircraft_model_code=aircraft_model_code
      |                ^
    line 6: 'aircraft_model_code' is not defined
      |           } on a.aircraft_model_code=aircraft_model_code
      |                                      ^

      137 |       }
      138 |       run: m->{aggregate: avg_seats, a.avg_year}
    > 139 |       `).malloyResultMatches(runtime, {avg_year: 1969, avg_seats: 7});
          |          ^
      140 |   });
      141 |
      142 |   it(`join_many condition no primary key - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:139:10)

  ● join_many condition no primary key - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         join_many: a on state=a.state
      |                         ^
    line 4: 'state' is not defined
      |         join_many: a on state=a.state
      |                               ^
    line 6: Reference to undefined value airport_count
      |       run: b->{aggregate: c is airport_count.sum()}
      |                                ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: b->{aggregate: c is airport_count.sum()}
      |            ^

      147 |       }
      148 |       run: b->{aggregate: c is airport_count.sum()}
    > 149 |     `).malloyResultMatches(runtime, {c: 19701});
          |        ^
      150 |   });
      151 |
      152 |   it(`join_many filter multiple values - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:149:8)

  ● join_many filter multiple values - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         where: state = 'NH' | 'CA'
      |                ^
    line 6: 'state' is not defined
      |         join_many: a on state=a.state
      |                         ^
    line 6: 'state' is not defined
      |         join_many: a on state=a.state
      |                               ^
    line 8: Reference to undefined value airport_count
      |         aggregate: c is airport_count.sum()
      |                         ^
    line 9: 'state' is not defined
      |         group_by: a.state
      |                   ^

      161 |         group_by: a.state
      162 |       }
    > 163 |     `).malloyResultMatches(runtime, [
          |        ^
      164 |       {state: null, c: 18605},
      165 |       {state: 'CA', c: 984},
      166 |       {state: 'NH', c: 112},

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:163:8)

  ● join_one condition no primary key - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         join_one: a on state=a.state
      |                        ^
    line 4: 'state' is not defined
      |         join_one: a on state=a.state
      |                              ^
    line 7: Reference to undefined value a.airport_count
      |         aggregate: c is a.airport_count.sum()
      |                         ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: b -> {
      |            ^

      177 |         aggregate: c is a.airport_count.sum()
      178 |       }
    > 179 |     `).malloyResultMatches(runtime, {c: 19701});
          |        ^
      180 |   });
      181 |
      182 |   it(`join_one filter multiple values - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:179:8)

  ● join_one filter multiple values - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         where: state = 'TX' | 'LA'
      |                ^
    line 6: 'state' is not defined
      |         join_one: a on state=a.state
      |                        ^
    line 6: 'state' is not defined
      |         join_one: a on state=a.state
      |                              ^
    line 9: Reference to undefined value a.airport_count
      |         aggregate: c is a.airport_count.sum()
      |                         ^
    line 10: 'state' is not defined
      |         group_by: a.state
      |                   ^

      192 |         group_by: a.state
      193 |       }
    > 194 |     `).malloyResultMatches(runtime, [
          |        ^
      195 |       {state: 'TX', c: 1845},
      196 |       {state: 'LA', c: 500},
      197 |       {state: null, c: 0},

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:194:8)

  ● join_many cross from  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'airport_count' is not defined
      |         dimension: x is airport_count/10000
      |                         ^
    line 10: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                     ^
    line 10: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                           ^
    line 13: Reference to undefined value airport_count
      |           left_sum is airport_count.sum()
      |                       ^
    line 14: Reference to undefined value a.airport_count
      |           right_sum is a.airport_count.sum()
      |                        ^

      220 |           right_small_sum is round(x.sum() * 10000)
      221 |       }
    > 222 |     `).malloyResultMatches(runtime, {
          |        ^
      223 |       row_count: 51 * 51,
      224 |       left_sum: 19701,
      225 |       right_sum: 19701,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:222:8)

  ● join_one only  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value airport_count
      |         aggregate: r is airport_count.sum()
      |                         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       query: q is redshift.table('malloytest.state_facts')->{
      |                   ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         join_one: a is q
      |                        ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         join_one: a is q
      |                        ^
    line 10: 'state' is not defined
      |           row_count is count(concat(state,a.r::string))
      |                                     ^
    line 10: 'r' is not defined
      |           row_count is count(concat(state,a.r::string))
      |                                           ^
    line 11: Reference to undefined value airport_count
      |           left_sum is airport_count.sum()
      |                       ^
    line 12: Reference to undefined value a.r
      |           right_sum is a.r.sum()
      |                        ^
    line 13: 'airport_count' is not defined
      |           sum_sum is sum(airport_count + a.r)
      |                          ^
    line 13: 'r' is not defined
      |           sum_sum is sum(airport_count + a.r)
      |                                          ^
    line 8: INTERNAL ERROR model/Segment.nextStructDef: Unknown Dialect ~malformed~
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'row_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 10 },
              end: { line: 9, character: 55 }
            }
          },
          e: {
            node: 'aggregate',
            function: 'distinct',
            e: {
              node: 'function_call',
              overload: {
                returnType: {
                  type: 'string',
                  expressionType: 'scalar',
                  evalSpace: 'input'
                },
                params: [
                  {
                    name: 'values',
                    allowedTypes: [
                      {
                        type: 'string',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'number',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'date',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'timestamp',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'boolean',
                        expressionType: undefined,
                        evalSpace: 'input'
                      }
                    ],
                    isVariadic: true
                  }
                ],
                dialect: {
                  postgres: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  standardsql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  duckdb: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  snowflake: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  trino: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  presto: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  mysql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  databricks: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  redshift: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  }
                },
                supportsOrderBy: undefined,
                supportsLimit: undefined,
                genericTypes: undefined,
                isSymmetric: undefined
              },
              name: 'concat',
              kids: {
                args: [
                  { node: 'error', message: 'field-not-found' },
                  {
                    node: 'cast',
                    dstType: { type: 'string' },
                    e: { node: 'error', message: 'field-not-found' },
                    safe: false
                  }
                ]
              },
              expressionType: 'scalar',
              structPath: undefined
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count(concat(state,a.r::string))'
        },
        {
          type: 'number',
          name: 'sum_sum',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 12, character: 10 },
              end: { line: 12, character: 45 }
            }
          },
          e: {
            node: 'aggregate',
            function: 'sum',
            e: { node: 'error', message: 'cascading error' }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'sum(airport_count + a.r)'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'row_count', dir: 'desc' } ]
    }
      |       run: f->{
      |            ^

      247 |           sum_sum is sum(airport_count + a.r)
      248 |       }
    > 249 |     `).malloyResultMatches(runtime, {
          |        ^
      250 |       row_count: 51,
      251 |       left_sum: 19701,
      252 |       right_sum: 19701,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:249:8)

  ● join_many cross ON  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         join_cross: a on a.state = 'CA' | 'NY'
      |                          ^
    line 8: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                     ^
    line 8: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                           ^
    line 9: Reference to undefined value airport_count
      |           left_sum is airport_count.sum()
      |                       ^
    line 10: Reference to undefined value a.airport_count
      |           right_sum is a.airport_count.sum()
      |                        ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'row_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 51 }
            }
          },
          e: {
            node: 'aggregate',
            function: 'distinct',
            e: {
              node: 'function_call',
              overload: {
                returnType: {
                  type: 'string',
                  expressionType: 'scalar',
                  evalSpace: 'input'
                },
                params: [
                  {
                    name: 'values',
                    allowedTypes: [
                      {
                        type: 'string',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'number',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'date',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'timestamp',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'boolean',
                        expressionType: undefined,
                        evalSpace: 'input'
                      }
                    ],
                    isVariadic: true
                  }
                ],
                dialect: {
                  postgres: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  standardsql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  duckdb: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  snowflake: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  trino: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  presto: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  mysql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  databricks: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  redshift: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  }
                },
                supportsOrderBy: undefined,
                supportsLimit: undefined,
                genericTypes: undefined,
                isSymmetric: undefined
              },
              name: 'concat',
              kids: {
                args: [
                  { node: 'error', message: 'field-not-found' },
                  { node: 'error', message: 'field-not-found' }
                ]
              },
              expressionType: 'scalar',
              structPath: undefined
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count(concat(state,a.state))'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'row_count', dir: 'desc' } ]
    }
      |       run: f->{
      |            ^

      270 |           right_sum is a.airport_count.sum()
      271 |       }
    > 272 |     `).malloyResultMatches(runtime, {
          |        ^
      273 |       row_count: 51 * 2,
      274 |       left_sum: 19701,
      275 |       right_sum: 1560,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:272:8)

  ● limit - provided - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 19 },
              end: { line: 3, character: 31 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      limit: 3,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● join inner- redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      343 |
      344 |       }
    > 345 |       `).malloyResultMatches(runtime, {
          |          ^
      346 |       ac_count: 28,
      347 |       ac_sum: 10402,
      348 |       am_count: 4,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:345:10)

  ● join left - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      369 |
      370 |       }
    > 371 |       `).malloyResultMatches(runtime, {
          |          ^
      372 |       ac_count: 49,
      373 |       ac_sum: 21336,
      374 |       am_count: 4,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:371:10)

  ● join right - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      395 |
      396 |       }
    > 397 |       `).malloyResultMatches(runtime, {
          |          ^
      398 |       ac_count: 28,
      399 |       ac_sum: 10402,
      400 |       am_count: 12,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:397:10)

  ● join full - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      423 |
      424 |       }
    > 425 |       `).malloyResultMatches(runtime, {
          |          ^
      426 |         ac_count: 49,
      427 |         ac_sum: 21336,
      428 |         am_count: 12,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:425:10)

  ● leafy count - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      452 |           root_count is count()
      453 |       }
    > 454 |       `).malloyResultMatches(runtime, {
          |          ^
      455 |       leafy_count: 0,
      456 |       root_count: 1,
      457 |     });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:454:10)

  ● nest/unnest -basic - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: c is airport_count.sum()
      |                         ^
    line 6: 'popular_name' is not defined
      |           group_by: popular_name
      |                     ^
    line 7: Reference to undefined value airport_count
      |           aggregate: d is airport_count.sum()
      |                           ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'turtle',
          name: 'p',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} }
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 14 },
              end: { line: 7, character: 9 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^
    line 10: 'state' is not defined
      |         group_by: state, c
      |                   ^
    line 10: 'c' is not defined
      |         group_by: state, c
      |                          ^
    line 11: Reference to undefined value p.d
      |         aggregate: p.d.sum()
      |         ^

      474 |         aggregate: p.d.sum()
      475 |       }
    > 476 |       `).malloyResultMatches(runtime, {
          |          ^
      477 |       state: 'TX',
      478 |       c: 1845,
      479 |       d: 1845,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:476:10)

  ● count at root should not use distinct key - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 34 },
              end: { line: 3, character: 46 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |       run: states -> { aggregate: c is count() }
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● leafy nested count - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      521 |           root_count is count()
      522 |       }
    > 523 |       `).malloyResultMatches(runtime, {
          |          ^
      524 |         leafy_count: 0,
      525 |         root_count: 1,
      526 |         state: 'CA',

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:523:10)

  ● basic index - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'index',
      indexFields: [ { type: 'fieldref', path: [ 'undefined' ] } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.flights') -> {
      |            ^
    line 8: 'fieldName' is not defined
      |         where: fieldName = 'carrier'
      |                ^
    line 7: 'fieldValue' is not defined
      |         order_by: fieldValue
      |                   ^
    line 7: Unknown field fieldValue in output space
      |         order_by: fieldValue
      |         ^

      541 |         where: fieldName = 'carrier'
      542 |       }
    > 543 |       `).malloyResultMatches(runtime, {
          |          ^
      544 |       fieldValue: 'AA',
      545 |     });
      546 |   });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:543:10)

  ● number as null 2 - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |           group_by: state
      |                     ^
    line 5: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 6: 'airport_count' is not defined
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                                          ^
    line 6: Case insensitivity for function names is deprecated, use 'nullif' instead
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                               ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'turtle',
          name: 'ugly',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  name: 'foo',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 5, character: 23 },
                      end: { line: 5, character: 62 }
                    }
                  },
                  e: {
                    node: '+',
                    kids: {
                      left: {
                        node: 'function_call',
                        overload: {
                          returnType: {
                            type: 'generic',
                            generic: 'T',
                            expressionType: 'scalar',
                            evalSpace: 'input'
                          },
                          params: [
                            {
                              name: 'value1',
                              allowedTypes: [
                                {
                                  type: 'generic',
                                  generic: 'T',
                                  expressionType: undefined,
                                  evalSpace: 'input'
                                }
                              ],
                              isVariadic: false
                            },
                            {
                              name: 'value2',
                              allowedTypes: [
                                {
                                  type: 'generic',
                                  generic: 'T',
                                  expressionType: undefined,
                                  evalSpace: 'input'
                                }
                              ],
                              isVariadic: false
                            }
                          ],
                          dialect: {
                            postgres: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            standardsql: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            duckdb: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            snowflake: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            trino: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            presto: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            mysql: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            databricks: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            redshift: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            }
                          },
                          supportsOrderBy: undefined,
                          supportsLimit: undefined,
                          genericTypes: [
                            {
                              name: 'T',
                              acceptibleTypes: [
                                { type: 'string' },
                                { type: 'number' },
                                { type: 'timestamp' },
                                { type: 'date' },
                                { type: 'json' }
                              ]
                            }
                          ],
                          isSymmetric: undefined
                        },
                        name: 'NULLIF',
                        kids: {
                          args: [
                            {
                              node: 'error',
                              message: 'cascading error'
                            },
                            { node: 'numberLiteral', literal: '0' }
                          ]
                        },
                        expressionType: 'aggregate',
                        structPath: undefined
                      },
                      right: { node: 'numberLiteral', literal: '1' }
                    }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'NULLIF(sum(airport_count)*0,0)+1'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'foo', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 16 },
              end: { line: 6, character: 11 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         run: redshift.table('malloytest.state_facts') -> {
      |              ^

      560 |           }
      561 |         }
    > 562 |       `).malloyResultMatches(runtime, {'ugly.foo': null});
          |          ^
      563 |     }
      564 |   );
      565 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:562:10)

  ● sql block- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/4ef1fa50-932f-58cf-b506-4d969cfe055b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: one is redshift.sql("""
      |                                   ^
    line 5: Reference to undefined object 'one'
      |       run: one -> {
      |            ^

      571 |       run: one -> {
      572 |         select: a
    > 573 |       }`).malloyResultMatches(runtime, {a: 2});
          |           ^
      574 |   });
      575 |
      576 |   // average should only include non-null values in the denominator

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:573:11)

  ● avg ignore null- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/d62d0d1c-c2df-5ac8-b40f-e6972870c1c9: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: one is redshift.sql("""
      |                                   ^
    line 7: Reference to undefined object 'one'
      |       run: one -> {
      |            ^

      587 |           avg_a is a.avg()
      588 |           avg_b is x1.a.avg()
    > 589 |       }`).malloyResultMatches(runtime, {avg_a: 3});
          |           ^
      590 |   });
      591 |
      592 |   it(`limit - not provided - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:589:11)

  ● limit - not provided - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: 'state' is not defined
      |           group_by: state
      |                     ^
    line 1: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 21 },
              end: { line: 2, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      | run: redshift.table('malloytest.state_facts') -> {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ungrouped top level - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: total_births is births.sum()
      |                                  ^
    line 4: all() expression must be an aggregate
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                             ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                  ^
    line 6: 'state' is not defined
      |         group_by: state
      |                   ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: births_per_100k
      |                    ^

      613 |         group_by: state
      614 |         aggregate: births_per_100k
    > 615 |       }`).malloyResultMatches(runtime, {births_per_100k: 9742});
          |           ^
      616 |   });
      617 |
      618 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:615:11)

  ● ungrouped top level with nested  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: total_births is births.sum()
      |                                  ^
    line 4: all() expression must be an aggregate
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                             ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                  ^
    line 6: 'state' is not defined
      |         group_by: state
      |                   ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: births_per_100k
      |                    ^
    line 9: 'popular_name' is not defined
      |           group_by: popular_name
      |                     ^
    line 10: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           aggregate: total_births
      |                      ^

      631 |         }
      632 |         limit: 1000
    > 633 |       }`).malloyResultMatches(runtime, {births_per_100k: 9742});
          |           ^
      634 |     }
      635 |   );
      636 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:633:11)

  ● ungrouped - eliminate rows  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: m is all(births.sum())
      |                           ^
    line 3: all() expression must be an aggregate
      |         measure: m is all(births.sum())
      |                           ^
    line 4: 'state' is not defined
      |         where: state='CA' | 'NY'
      |                ^
    line 7: 'state' is not defined
      |         group_by: state
      |                   ^
    line 8: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: m
      |                    ^

      644 |         group_by: state
      645 |         aggregate: m
    > 646 |       }`).malloyResultMatches(runtime, [
          |           ^
      647 |       {state: 'CA', m: 52504699},
      648 |       {state: 'NY', m: 52504699},
      649 |     ]);

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:646:11)

  ● ungrouped nested with no grouping above - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 5: all() expression must be an aggregate
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                               ^
    line 5: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                    ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           aggregate: total_births
      |                      ^
    line 9: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 10: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: births_per_100k
      |                        ^

      664 |             aggregate: births_per_100k
      665 |           }
    > 666 |         }`).malloyResultMatches(runtime, {'by_name.births_per_100k': 66703});
          |             ^
      667 |     }
      668 |   );
      669 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:666:13)

  ● ungrouped - partial grouping - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |           where: state = 'TX' | 'NY'
      |                  ^
    line 7: 'faa_region' is not defined
      |             faa_region
      |             ^
    line 8: 'state' is not defined
      |             state
      |             ^
    line 12: 'fac_type' is not defined
      |             airport_count is c { where: fac_type = 'AIRPORT'}
      |                                         ^
    line 14: 'fac_type' is not defined
      |             group_by: fac_type
      |                       ^

      693 |           }
      694 |         }
    > 695 |       `).malloyResultMatches(runtime, {
          |          ^
      696 |         'fac_type.all_': 1845,
      697 |         'fac_type.all_state_region': 1845,
      698 |         'fac_type.all_of_this_type': 1782,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:695:10)

  ● ungrouped - all nested - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |           where: state = 'TX' | 'NY'
      |                  ^
    line 7: 'state' is not defined
      |             state
      |             ^
    line 11: 'fac_type' is not defined
      |             airport_count is c { where: fac_type = 'AIRPORT'}
      |                                         ^
    line 13: 'fac_type' is not defined
      |             group_by: fac_type, major
      |                       ^
    line 13: 'major' is not defined
      |             group_by: fac_type, major
      |                                 ^

      724 |           }
      725 |         }
    > 726 |       `).malloyResultMatches(runtime, {
          |          ^
      727 |         'fac_type.all_': 1845,
      728 |         'fac_type.all_major': 1819,
      729 |       });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:726:10)

  ● ungrouped nested  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: all() expression must be an aggregate
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                               ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                    ^
    line 6: 'popular_name' is not defined
      |           group_by: popular_name
      |                     ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 9: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: births_per_100k
      |                        ^

      745 |           }
      746 |         }
    > 747 |       `).malloyResultMatches(runtime, {'by_state.births_per_100k': 36593});
          |          ^
      748 |     }
      749 |   );
      750 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:747:10)

  ● ungrouped nested expression  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: all() expression must be an aggregate
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                               ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                    ^
    line 6: 'popular_name' is not defined
      |           group_by: upper_name is upper(popular_name)
      |                                         ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 9: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: births_per_100k
      |                        ^

      763 |           }
      764 |         }
    > 765 |       `).malloyResultMatches(runtime, {'by_state.births_per_100k': 36593});
          |          ^
      766 |     }
      767 |   );
      768 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:765:10)

  ● ungrouped nested group by float  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: all() expression must be an aggregate
      |           measure: ug is all(total_births)
      |                              ^
    line 6: 'airport_count' is not defined
      |           group_by: f is floor(airport_count/300.0)
      |                                ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 9: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: ug
      |                        ^

      781 |           }
      782 |         }
    > 783 |       `).malloyResultMatches(runtime, {'by_state.ug': 62742230});
          |          ^
      784 |     }
      785 |   );
      786 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:783:10)

  ● run simple sql - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://conn/0577cfdb-5132-5eb5-96c4-5c5bc052db83: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: conn.sql('select 1 as "one"')
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● simple sql is exactly as written - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://conn/0577cfdb-5132-5eb5-96c4-5c5bc052db83: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: conn.sql('select 1 as "one"')
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● source from query defined as sql query - redshift

    Unknown Dialect ~malformed~

      37 |   const d = dialectMap.get(name);
      38 |   if (d === undefined) {
    > 39 |     throw new Error(`Unknown Dialect ${name}`);
         |           ^
      40 |   }
      41 |   return d;
      42 | }

      at getDialect (packages/malloy/src/dialect/dialect_map.ts:39:11)
      at Document.checkExperimentalDialect (packages/malloy/src/lang/ast/types/malloy-element.ts:640:17)
      at Document.setEntry (packages/malloy/src/lang/ast/types/malloy-element.ts:623:12)
      at DefineSource.execute (packages/malloy/src/lang/ast/statements/define-source.ts:87:11)
      at DefineSourceList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:457:12)
      at DocStatementList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:452:26)
      at Document.compile (packages/malloy/src/lang/ast/types/malloy-element.ts:539:35)
      at TranslateStep.step (packages/malloy/src/lang/parse-malloy.ts:648:34)
      at MalloyTranslator.translate (packages/malloy/src/lang/parse-malloy.ts:935:40)
      at _callee$ (packages/malloy/src/malloy.ts:344:33)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● source from query defined as other query - redshift

    Unknown Dialect ~malformed~

      37 |   const d = dialectMap.get(name);
      38 |   if (d === undefined) {
    > 39 |     throw new Error(`Unknown Dialect ${name}`);
         |           ^
      40 |   }
      41 |   return d;
      42 | }

      at getDialect (packages/malloy/src/dialect/dialect_map.ts:39:11)
      at Document.checkExperimentalDialect (packages/malloy/src/lang/ast/types/malloy-element.ts:640:17)
      at Document.setEntry (packages/malloy/src/lang/ast/types/malloy-element.ts:623:12)
      at DefineSource.execute (packages/malloy/src/lang/ast/statements/define-source.ts:87:11)
      at DefineSourceList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:457:12)
      at DocStatementList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:452:26)
      at Document.compile (packages/malloy/src/lang/ast/types/malloy-element.ts:539:35)
      at TranslateStep.step (packages/malloy/src/lang/parse-malloy.ts:648:34)
      at MalloyTranslator.translate (packages/malloy/src/lang/parse-malloy.ts:935:40)
      at _callee$ (packages/malloy/src/malloy.ts:344:33)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● all with parameters - basic  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: total_births is births.sum()
      |                                  ^
    line 5: 'popular_name' is not defined
      |         group_by: popular_name, state
      |                   ^
    line 5: 'state' is not defined
      |         group_by: popular_name, state
      |                                 ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           total_births
      |           ^
    line 8: all() expression must be an aggregate
      |           all_births is all(total_births)
      |                             ^
    line 9: exclude() expression must be an aggregate
      |           all_name is exclude(total_births, state)
      |                               ^

      843 |           all_name is exclude(total_births, state)
      844 |       }
    > 845 |     `).malloyResultMatches(runtime, {
          |        ^
      846 |       all_births: 295727065,
      847 |       all_name: 197260594,
      848 |     });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:845:8)

  ● all with parameters - nest  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: 'airport_count' is not defined
      |           dimension: abc is floor(airport_count/300)
      |                                   ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           aggregate: total_births
      |                      ^
    line 9: 'popular_name' is not defined
      |             group_by: popular_name, state
      |                       ^
    line 9: 'state' is not defined
      |             group_by: popular_name, state
      |                                     ^
    line 11: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |               total_births
      |               ^
    line 12: all() expression must be an aggregate
      |               all_births is all(total_births)
      |                                 ^
    line 13: exclude() expression must be an aggregate
      |               all_name is exclude(total_births, state)
      |                                   ^

      867 |           }
      868 |         }
    > 869 |       `).malloyResultMatches(runtime, {
          |          ^
      870 |         'by_stuff.all_births': 119809719,
      871 |         'by_stuff.all_name': 61091215,
      872 |       });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:869:10)

  ● single value to udf - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1
    )
    , __stage1 AS (
      SELECT
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM UNNEST(ARRAY((SELECT TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT 
            "t__1"::DOUBLE PRECISION as "t") as __x)) FILTER (WHERE group_set=1))[1])))) as base
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:885:10)

  ● Multi value to udf - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        2 as "two__0",
        CASE WHEN group_set=1 THEN
          1
          END as "one__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3
    )
    , __stage1 AS (
      SELECT
        "two__0" as "two",
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
            "one__1"::DOUBLE PRECISION as "one", 
            "t__1"::DOUBLE PRECISION as "t"
            ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:904:10)

  ● Multi value to udf group by - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set=1 THEN
          1
          END as "one__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2
    )
    , __stage1 AS (
      SELECT
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
            "one__1"::DOUBLE PRECISION as "one", 
            "t__1"::DOUBLE PRECISION as "t"
            ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base
          GROUP BY 1
          ORDER BY 1 asc NULLS LAST
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:920:10)

  ● sql as source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') -> {
      |            ^
    line 3: 'a' is not defined
      |         select: a
      |                 ^

      929 |         order_by: 1
      930 |       }
    > 931 |     `).malloyResultMatches(runtime, {a: 1});
          |        ^
      932 |   });
      933 |
      934 |   // have to add an order_by: otherwise it isn't deterministic.

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:931:8)

  ● sql directly - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4')->{
      |      ^
    line 3: 'a' is not defined
      |         order_by: a asc
      |                   ^
    line 3: Unknown field a in output space
      |         order_by: a asc
      |         ^

      939 |         order_by: a asc
      940 |       }`
    > 941 |     ).malloyResultMatches(runtime, {a: 1});
          |       ^
      942 |   });
      943 |
      944 |   // weirdly '*' must be the first thing in the select list in MySQL

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:941:7)

  ● sql with turducken- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 8: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 7: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'state_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 8, character: 23 },
              end: { line: 8, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'state_count', dir: 'desc' } ]
    }
      |           redshift.table('malloytest.state_facts') -> {
      |           ^
    line 2: Invalid SQL, Error: Redefinition of undefined
      |       run: redshift.sql("""
      |                         ^
    line 13: 'popular_name' is not defined
      |           select: *; where: popular_name = 'Emma'
      |                             ^
    line 14: 'state_count' is not defined
      |           order_by: state_count DESC
      |                     ^
    line 14: Unknown field state_count in output space
      |           order_by: state_count DESC
      |           ^

      959 |           order_by: state_count DESC
      960 |         }`;
    > 961 |     await expect(turduckenQuery).malloyResultMatches(runtime, {state_count: 6});
          |                                  ^
      962 |   });
      963 |
      964 |   // local declarations

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:961:34)

  ● local declarations external query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') -> {
      |            ^
    line 3: 'a' is not defined
      |         extend: { dimension: c is a + 1 }
      |                                   ^

      970 |         order_by: 1
      971 |       }
    > 972 |     `).malloyResultMatches(runtime, {c: 2});
          |        ^
      973 |   });
      974 |
      975 |   it(`local declarations named query - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:972:8)

  ● local declarations named query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') extend {
      |            ^
    line 4: 'a' is not defined
      |           extend: { dimension: c is a + 1 }
      |                                     ^

      982 |         }
      983 |       } -> bar
    > 984 |     `).malloyResultMatches(runtime, {c: 2});
          |        ^
      985 |   });
      986 |
      987 |   it(`local declarations refined named query - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:984:8)

  ● local declarations refined named query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') extend {
      |            ^
    line 4: 'a' is not defined
      |           extend: {dimension: c is a + 1}
      |                                    ^

       999 |         }
      1000 |       } -> baz
    > 1001 |     `).malloyResultMatches(runtime, {d: 3});
           |        ^
      1002 |   });
      1003 |
      1004 |   it(`regexp match- ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1001:8)

  ● regexp match- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b3d9302b-67e6-557a-ac21-08e7571d2402: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("""
      |                         ^
    line 6: 'a' is not defined
      |         aggregate: llo is count() {where: a ~ r'llo'}
      |                                           ^
    line 7: 'a' is not defined
      |         aggregate: m2 is count() {where: a !~ r'bozo'}
      |                                          ^

      1011 |         aggregate: m2 is count() {where: a !~ r'bozo'}
      1012 |       }
    > 1013 |     `).malloyResultMatches(runtime, {llo: 2, m2: 1});
           |        ^
      1014 |   });
      1015 |
      1016 |   it(`substitution precedence- ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1013:8)

  ● substitution precedence- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/4b582cd6-4cc7-5e32-82ab-f13111063e5d: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("""
      |                         ^
    line 6: 'b' is not defined
      |         extend: {dimension:  c is b + 4}
      |                                   ^
    line 7: 'a' is not defined
      |         select: x is  a * c
      |                       ^

      1024 |         order_by: x desc
      1025 |       }
    > 1026 |       `).malloyResultMatches(runtime, {x: 30});
           |          ^
      1027 |   });
      1028 |
      1029 |   test.when(runtime.supportsNesting && runtime.dialect.supportsArraysInData)(

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1026:10)

  ● array unnest - redshift

    TypeError: splitFN is not a function

      1035 |         SELECT
      1036 |           ${q`city`},
    > 1037 |           ${splitFN!(q`city`, ' ')} as ${q`words`}
           |             ^
      1038 |         FROM ${rootDbPath(databaseName)}malloytest.aircraft
      1039 |       """) -> {
      1040 |         where: words.value is not null

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1037:13)

  ● array unnest x 2 - redshift

    TypeError: splitFN is not a function

      1055 |         SELECT
      1056 |           ${q`city`},
    > 1057 |           ${splitFN!(q`city`, ' ')} as ${q`words`},
           |             ^
      1058 |           ${splitFN!(q`city`, 'A')} as ${q`abreak`}
      1059 |         FROM ${rootDbPath(databaseName)}malloytest.aircraft
      1060 |         WHERE ${q`city`} IS NOT null

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1057:13)

  ● nest null - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'faa_region' is not defined
      |           where: faa_region is null
      |                  ^
    line 4: 'faa_region' is not defined
      |           group_by: faa_region
      |                     ^
    line 7: 'state' is not defined
      |             where: state is not null
      |                    ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 12: 'state' is not defined
      |             where: state is not null
      |                    ^
    line 13: 'state' is not defined
      |             group_by: state
      |                       ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'airport_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 21 },
              end: { line: 4, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        },
        {
          type: 'turtle',
          name: 'by_state',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'airport_count',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 8, character: 23 },
                      end: { line: 8, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [
                {
                  node: 'filterCondition',
                  code: 'state is not null',
                  e: {
                    node: 'is-not-null',
                    e: { node: 'error', message: 'field-not-found' }
                  },
                  expressionType: 'scalar',
                  compositeFieldUsage: { fields: [], joinedUsage: {} }
                }
              ],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'airport_count', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 16 },
              end: { line: 9, character: 11 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        },
        {
          type: 'turtle',
          name: 'by_state1',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'airport_count',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 13, character: 23 },
                      end: { line: 13, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              limit: 1,
              filterList: [
                {
                  node: 'filterCondition',
                  code: 'state is not null',
                  e: {
                    node: 'is-not-null',
                    e: { node: 'error', message: 'field-not-found' }
                  },
                  expressionType: 'scalar',
                  compositeFieldUsage: { fields: [], joinedUsage: {} }
                }
              ],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'airport_count', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 10, character: 16 },
              end: { line: 15, character: 11 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [
        {
          node: 'filterCondition',
          code: 'faa_region is null',
          e: {
            node: 'is-null',
            e: { node: 'error', message: 'field-not-found' }
          },
          expressionType: 'scalar',
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'airport_count', dir: 'desc' } ]
    }
      |         run: redshift.table('malloytest.airports') -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● Nested pipelines sort properly - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 6: 'airport_count' is not defined
      |                 aggregate: airports is sum(airport_count)
      |                                            ^
    line 11: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 12: Reference to undefined value airports
      |                 aggregate: airports.sum()
      |                 ^
    line 12: Reference to undefined value airports
      |                 aggregate: airports.sum()
      |                 ^
    line 16: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 17: 'aircraft_count' is not defined
      |                 aggregate: aircrafts is sum(aircraft_count)
      |                                             ^
    line 22: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 23: Reference to undefined value aircrafts
      |                 aggregate: aircrafts.sum()
      |                 ^
    line 23: Reference to undefined value aircrafts
      |                 aggregate: aircrafts.sum()
      |                 ^
    line 27: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 28: 'aircraft_count' is not defined
      |                 aggregate: aircrafts is sum(aircraft_count)
      |                                             ^
    line 31: 'state' is not defined
      |               group_by: state
      |                         ^
    line 32: Reference to undefined value aircrafts
      |               aggregate: aircrafts.sum()
      |               ^
    line 35: 'popular_name' is not defined
      |                 where: popular_name ~ r'I'
      |                        ^
    line 36: 'popular_name' is not defined
      |                 group_by: popular_name
      |                           ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● number as null- redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |           group_by: state
      |                     ^
    line 7: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 8: 'airport_count' is not defined
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                                          ^
    line 8: Case insensitivity for function names is deprecated, use 'nullif' instead
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                               ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - solo aggregates - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - pipeline - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^
    line 8: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - joined_query - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       query: foo is  redshift.table('malloytest.state_facts') -> {
      |                      ^
    line 10: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 10: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 10: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                            ^
    line 10: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                                    ^
    line 12: Reference to undefined value foo.airport_count
      |         aggregate: x is foo.airport_count.sum()
      |                         ^
    line 8: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      extendSource: [
        {
          type: 'query_source',
          name: 'foo',
          dialect: '~malformed~',
          connection: '~unknown~',
          tablePath: '//undefined_error_table_path',
          fields: [],
          errorFactory: true,
          query: {
            type: 'query',
            structRef: {
              type: 'table',
              name: 'redshift:malloytest.state_facts',
              dialect: 'redshift',
              tablePath: 'malloytest.state_facts',
              connection: 'redshift',
              fields: [
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                }
              ],
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 1, character: 21 },
                  end: { line: 1, character: 61 }
                }
              }
            },
            pipeline: [
              {
                type: 'reduce',
                queryFields: [],
                orderBy: [ { field: 'state', dir: 'desc' } ],
                filterList: [],
                compositeFieldUsage: { fields: [], joinedUsage: {} }
              }
            ],
            location: {
              url: 'internal://internal.malloy',
              range: {
                start: { line: 1, character: 13 },
                end: { line: 5, character: 7 }
              }
            },
            name: 'foo',
            annotation: undefined,
            compositeResolvedSourceDef: undefined
          },
          parameters: undefined,
          join: 'one',
          matrixOperation: 'left',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 20 },
              end: { line: 9, character: 44 }
            }
          },
          onExpression: { node: 'error', message: 'cascading error' },
          onCompositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - joined_query pipeline - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       query: foo is  redshift.table('malloytest.state_facts') -> {
      |                      ^
    line 7: 'state' is not defined
      |         group_by: state
      |                   ^
    line 8: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 14: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 14: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 14: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                            ^
    line 14: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                                    ^
    line 16: Reference to undefined value foo.airport_count
      |         aggregate: x is foo.airport_count.sum()
      |                         ^
    line 12: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      extendSource: [
        {
          type: 'query_source',
          name: 'foo',
          dialect: '~malformed~',
          connection: '~unknown~',
          tablePath: '//undefined_error_table_path',
          fields: [],
          errorFactory: true,
          query: {
            type: 'query',
            structRef: {
              type: 'table',
              name: 'redshift:malloytest.state_facts',
              dialect: 'redshift',
              tablePath: 'malloytest.state_facts',
              connection: 'redshift',
              fields: [
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                }
              ],
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 1, character: 21 },
                  end: { line: 1, character: 61 }
                }
              }
            },
            pipeline: [
              {
                type: 'reduce',
                queryFields: [],
                orderBy: [ { field: 'state', dir: 'desc' } ],
                filterList: [],
                compositeFieldUsage: { fields: [], joinedUsage: {} }
              },
              {
                type: 'reduce',
                queryFields: [],
                orderBy: [ { field: 'state', dir: 'desc' } ],
                filterList: [],
                compositeFieldUsage: { fields: [], joinedUsage: {} }
              }
            ],
            location: {
              url: 'internal://internal.malloy',
              range: {
                start: { line: 1, character: 13 },
                end: { line: 9, character: 7 }
              }
            },
            name: 'foo',
            annotation: undefined,
            compositeResolvedSourceDef: undefined
          },
          parameters: undefined,
          join: 'one',
          matrixOperation: 'left',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 13, character: 20 },
              end: { line: 13, character: 44 }
            }
          },
          onExpression: { node: 'error', message: 'cascading error' },
          onCompositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● quoting and strings › backslash quote

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql('SELECT 1 as one') -> {
      |              ^

      1341 |           select: tick is '${back}${tick}'
      1342 |         }
    > 1343 |       `).malloyResultMatches(runtime, {tick});
           |          ^
      1344 |     });
      1345 |     test('backslash backslash', async () => {
      1346 |       await expect(`

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1343:10)

  ● quoting and strings › backslash backslash

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      1348 |           select: back is '${back}${back}'
      1349 |         }
    > 1350 |       `).malloyResultMatches(runtime, {back});
           |          ^
      1351 |     });
      1352 |
      1353 |     test('source with reserve word', async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1350:10)

  ● quoting and strings › source with reserve word

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |         run: create -> {
      |              ^

      1357 |           aggregate: c is count()
      1358 |         }
    > 1359 |       `).malloyResultMatches(runtime, {c: 51});
           |          ^
      1360 |     });
      1361 |
      1362 |     test.when(runtime.supportsNesting)('spaces in names', async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1359:10)

  ● quoting and strings › spaces in names

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |           join_one: `j space` is redshift.table('malloytest.state_facts') on `j space`.state=state
      |                                                                              ^
    line 3: 'state' is not defined
      |           join_one: `j space` is redshift.table('malloytest.state_facts') on `j space`.state=state
      |                                                                                              ^
    line 6: 'popular_name' is not defined
      |               `P O P` is popular_name
      |                          ^
    line 7: 'popular_name' is not defined
      |               `J P O P` is `j space`.popular_name
      |                            ^
    line 13: 'state' is not defined
      |               group_by: `J S` is `j space`.state
      |                                  ^
    line 12: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c o u n t',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 13, character: 25 },
              end: { line: 13, character: 47 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
    }
      |             nest: `by state` is {
      |                   ^
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c o u n t',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 23 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        },
        {
          type: 'number',
          name: 'R O W',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 14 },
              end: { line: 9, character: 37 }
            }
          },
          e: {
            node: 'function_call',
            overload: {
              returnType: {
                type: 'number',
                expressionType: 'scalar_analytic',
                evalSpace: 'input'
              },
              params: [],
              dialect: {
                postgres: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                standardsql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                duckdb: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                snowflake: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                trino: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                presto: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                mysql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                databricks: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                redshift: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                }
              },
              supportsOrderBy: undefined,
              supportsLimit: undefined,
              genericTypes: undefined,
              isSymmetric: undefined
            },
            name: 'row_number',
            kids: { args: [] },
            expressionType: 'scalar_analytic',
            structPath: undefined
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: 'row_number()'
        },
        {
          type: 'turtle',
          name: 'by state',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'c o u n t',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 13, character: 25 },
                      end: { line: 13, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 18 },
              end: { line: 14, character: 13 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
    }
      |           view: `q u e r y` is {
      |                 ^
    line 18: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c o u n t',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 23 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        },
        {
          type: 'number',
          name: 'R O W',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 14 },
              end: { line: 9, character: 37 }
            }
          },
          e: {
            node: 'function_call',
            overload: {
              returnType: {
                type: 'number',
                expressionType: 'scalar_analytic',
                evalSpace: 'input'
              },
              params: [],
              dialect: {
                postgres: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                standardsql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                duckdb: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                snowflake: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                trino: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                presto: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                mysql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                databricks: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                redshift: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                }
              },
              supportsOrderBy: undefined,
              supportsLimit: undefined,
              genericTypes: undefined,
              isSymmetric: undefined
            },
            name: 'row_number',
            kids: { args: [] },
            expressionType: 'scalar_analytic',
            structPath: undefined
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: 'row_number()'
        },
        {
          type: 'turtle',
          name: 'by state',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'c o u n t',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 13, character: 25 },
                      end: { line: 13, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 18 },
              end: { line: 14, character: 13 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
    }
      |         run: `space race` -> `q u e r y`
      |                              ^

      1379 |         }
      1380 |         run: \`space race\` -> \`q u e r y\`
    > 1381 |       `).malloyResultMatches(runtime, {'c o u n t': 24});
           |          ^
      1382 |     });
      1383 |   });
      1384 | });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1381:10)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp552620de540242ef8bf640678ec4661f;\n' +
        '      create temp table tmp552620de540242ef8bf640678ec4661f as SELECT * FROM (\n' +
        '        SELECT 10 as ten\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp552620de540242ef8bf640678ec4661f';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp552620de540242ef8bf640678ec4661f;
          create temp table tmp552620de540242ef8bf640678ec4661f as SELECT * FROM (
            SELECT 10 as ten
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp552620de540242ef8bf640678ec4661f';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp4c970194dc204677a13e04b92316348e;\n' +
        '      create temp table tmp4c970194dc204677a13e04b92316348e as SELECT * FROM (\n' +
        '        SELECT 1 as one\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp4c970194dc204677a13e04b92316348e';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp4c970194dc204677a13e04b92316348e;
          create temp table tmp4c970194dc204677a13e04b92316348e as SELECT * FROM (
            SELECT 1 as one
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp4c970194dc204677a13e04b92316348e';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpb7b8937adbe64efea4b7ed14abb0621d;\n' +
        '      create temp table tmpb7b8937adbe64efea4b7ed14abb0621d as SELECT * FROM (\n' +
        '        \n' +
        `          SELECT '' as "null_value", '' as "string_value"\n` +
        "          UNION ALL SELECT null, 'correct'\n" +
        '      \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpb7b8937adbe64efea4b7ed14abb0621d';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpb7b8937adbe64efea4b7ed14abb0621d;
          create temp table tmpb7b8937adbe64efea4b7ed14abb0621d as SELECT * FROM (
            
              SELECT '' as "null_value", '' as "string_value"
              UNION ALL SELECT null, 'correct'
          
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpb7b8937adbe64efea4b7ed14abb0621d';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp6467239a5e32436986276b9e6b1de958;\n' +
        '      create temp table tmp6467239a5e32436986276b9e6b1de958 as SELECT * FROM (\n' +
        '        \n' +
        '      SELECT\n' +
        '        0 as "n",\n' +
        '        1 as "x", 2 as "y",\n' +
        `        'a' as "a", 'b' as "b",\n` +
        '        (1 = 1) as "tf"\n' +
        '      UNION ALL SELECT\n' +
        '        5,\n' +
        '        null, null, null, null, null\n' +
        '    \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp6467239a5e32436986276b9e6b1de958';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp6467239a5e32436986276b9e6b1de958;
          create temp table tmp6467239a5e32436986276b9e6b1de958 as SELECT * FROM (
            
          SELECT
            0 as "n",
            1 as "x", 2 as "y",
            'a' as "a", 'b' as "b",
            (1 = 1) as "tf"
          UNION ALL SELECT
            5,
            null, null, null, null, null
        
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp6467239a5e32436986276b9e6b1de958';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/expr.spec.ts (22.464 s)
  redshift
    ✕ basic calculations (3348 ms)
    ✕ join dependencies tracked from annotated references
    ✕ Floor() -or any function bustage with aggregates
    ✕ computes mod correctly (1404 ms)
    ✕ model: expression fixups. (1 ms)
    ✕ simple turtle
    ✕ double turtle
    ✕ double turtle - pipeline
    ✕ model: turtle
    ✕ model: filtered turtle
    ✕ model: simple having
    ✕ model: having in a nest
    ✕ model: turtle having on main
    ✕ model: having float group by partition (60 ms)
    ✕ model: aggregate functions distinct min max
    ✕ model: dates named (1453 ms)
    ✕ named query metadata undefined (1 ms)
    ✕ named query metadata named
    ✕ named query metadata named head of pipeline
    ✕ filtered explores basic (1 ms)
    ✕ sql cast
    ✕ case expressions
    ✕ sql safe cast (1420 ms)
    ✕ many_field.sum() has correct locality (33 ms)
    ✕ query with aliasname used twice
    ✕ joined filtered sources (1 ms)
    ✕ joined filtered explores with NO dependencies (1397 ms)
    ✕ nullish ?? operator (1402 ms)
    ✕ dimension expressions expanded with parens properly (16 ms)
    ○ skipped joined filtered explores with dependencies
    sql expr functions
      ✕ sql_string
      ✕ sql_number
      ✕ sql_number can be sum()med
      ✕ sql_boolean (1 ms)
      ✕ sql_date
      ✕ sql_timestamp
      ✕ with ${TABLE}.field (1 ms)
      ✕ with ${field}
      [not yet supported]
        ✕ ${view_name.dimension_name} - one path (10 ms)
        ✕ ${view_name.dimension_name} - multiple paths (1 ms)
        ✕ ${view_name.SQL_TABLE_NAME} (1 ms)
    alternations with not-eq
      ○ skipped x not-eq y or z : x eq y
      ○ skipped x not-eq y or z : x eq z
      ○ skipped x not-eq y or z : else
      ○ skipped x not-eq y and not-eq z : x eq y
      ○ skipped x not-eq y and not-eq z : x eq z
      ○ skipped x not-eq y and not-eq z : else
    string literal quoting
      ✕ quote single character (53 ms)
      ✕ quote single quote (12 ms)
      ✕ quote double quote (6 ms)
      ✕ quote backslash (11 ms)
    null safe booleans
      ✕ select boolean (1329 ms)
      ✕ not boolean (26 ms)
      ✕ numeric != non-null to null (13 ms)
      ✕ string !~ non-null to null (11 ms)
      ✕ regex !~ non-null to null (9 ms)
      ✕ numeric != null-to-null (9 ms)
      ✕ string !~ null-to-null (9 ms)

  ● redshift › basic calculations

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      76 |           percent_boeing_floor,
      77 |       }
    > 78 |     `).malloyResultMatches(expressionModel, {
         |        ^
      79 |       total_seats: 452415,
      80 |       total_seats2: 452415,
      81 |       boeing_seats: 252771,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:78:8)

  ● redshift › join dependencies tracked from annotated references

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      92 |           group_by: aircraft_models.seats
      93 |         }
    > 94 |     `).malloyResultMatches(expressionModel, {
         |        ^
      95 |       seats: 0,
      96 |     });
      97 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:94:8)

  ● redshift › Floor() -or any function bustage with aggregates

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      105 |           percent_boeing_floor2 is floor(boeing_seats / total_seats * 100)
      106 |       }
    > 107 |     `).malloyResultMatches(expressionModel, {
          |        ^
      108 |       percent_boeing_floor: 55,
      109 |       percent_boeing_floor2: 55,
      110 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:107:8)

  ● redshift › computes mod correctly

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/8492fb55-e4fb-5805-adc6-f3d175aaafa9: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("SELECT 10 as ten") -> {select: mod is 10 % 3}
      |            ^

      114 |     await expect(`
      115 |       run: ${databaseName}.sql("SELECT 10 as ten") -> {select: mod is 10 % 3}
    > 116 |     `).malloyResultMatches(runtime, {mod: 1});
          |        ^
      117 |   });
      118 |
      119 |   // Model based version of sums.

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:116:8)

  ● redshift › model: expression fixups.

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      125 |           aircraft_models.boeing_seats
      126 |       }
    > 127 |     `).malloyResultMatches(expressionModel, {
          |        ^
      128 |       total_seats: 18294,
      129 |       boeing_seats: 6244,
      130 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:127:8)

  ● redshift › simple turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      145 |         limit: 3
      146 |       }
    > 147 |     `).malloyResultMatches(expressionModel, {
          |        ^
      148 |       'by_state.state': 'TX',
      149 |       'by_state.airport_count': 1845,
      150 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:147:8)

  ● redshift › double turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      169 |         }
      170 |       }
    > 171 |     `).malloyResultMatches(expressionModel, {
          |        ^
      172 |       'o.by_state.state': 'TX',
      173 |       'o.by_state.airport_count': 1845,
      174 |       'o.airport_count': 11146,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:171:8)

  ● redshift › double turtle - pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      195 |         aggregate: o.by_state.airport_count.sum()
      196 |       }
    > 197 |     `).malloyResultMatches(expressionModel, {
          |        ^
      198 |       'airport_count': 5023,
      199 |     });
      200 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:197:8)

  ● redshift › model: turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      202 |   // turtle expressions
      203 |   it('model: turtle', async () => {
    > 204 |     await expect('run: aircraft->by_manufacturer').malloyResultMatches(
          |                                                    ^
      205 |       expressionModel,
      206 |       {manufacturer: 'CESSNA'}
      207 |     );

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:204:52)

  ● redshift › model: filtered turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      214 |         nest: b is by_manufacturer + { where: aircraft_models.manufacturer ?~'B%'}
      215 |       }
    > 216 |     `).malloyResultMatches(expressionModel, {'b.manufacturer': 'BEECH'});
          |        ^
      217 |   });
      218 |
      219 |   // having.

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:216:8)

  ● redshift › model: simple having

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      227 |         limit: 2
      228 |       }
    > 229 |     `).malloyResultMatches(expressionModel, {aircraft_count: 91});
          |        ^
      230 |   });
      231 |
      232 |   test.when(runtime.supportsNesting)('model: having in a nest', async () => {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:229:8)

  ● redshift › model: having in a nest

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      245 |         }
      246 |       }
    > 247 |     `).malloyResultMatches(expressionModel, {'by_state.state': 'VA'});
          |        ^
      248 |   });
      249 |
      250 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:247:8)

  ● redshift › model: turtle having on main

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      270 |         }
      271 |       }
    > 272 |     `).malloyResultMatches(expressionModel, {
          |        ^
      273 |         'by_state.by_city.city': 'ALBUQUERQUE',
      274 |       });
      275 |     }

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:272:8)

  ● redshift › model: having float group by partition

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^
    line 31: 'engines' is not defined
      |             group_by: engines
      |                       ^

      291 |             aggregate: aircraft_model_count
      292 |           }
    > 293 |       }`).malloyResultMatches(runtime, {aircraft_model_count: 448});
          |           ^
      294 |     }
      295 |   );
      296 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:293:11)

  ● redshift › model: aggregate functions distinct min max

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      310 |           boeing_max_model is max(model) { where: manufacturer ? 'BOEING'},
      311 |       }
    > 312 |     `).malloyResultMatches(expressionModel, {
          |        ^
      313 |       distinct_seats: 187,
      314 |       boeing_distinct_seats: 85,
      315 |       min_seats: 0,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:312:8)

  ● redshift › model: dates named

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 't_date' is not defined
      |           t_date,
      |           ^
    line 5: 't_date' is not defined
      |           t_date_month is t_date.month,
      |                           ^
    line 6: 't_date' is not defined
      |           t_date_year is t_date.year,
      |                          ^
    line 7: 't_timestamp' is not defined
      |           t_timestamp,
      |           ^
    line 8: 't_timestamp' is not defined
      |           t_timestamp_date is t_timestamp.day,
      |                               ^
    line 9: 't_timestamp' is not defined
      |           t_timestamp_hour is t_timestamp.hour,
      |                               ^
    line 10: 't_timestamp' is not defined
      |           t_timestamp_minute is t_timestamp.minute,
      |                                 ^
    line 11: 't_timestamp' is not defined
      |           t_timestamp_second is t_timestamp.second,
      |                                 ^
    line 12: 't_timestamp' is not defined
      |           t_timestamp_month is t_timestamp.month,
      |                                ^
    line 13: 't_timestamp' is not defined
      |           t_timestamp_year is t_timestamp.year,
      |                               ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'date',
          name: 't_date_month',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 10 },
              end: { line: 4, character: 38 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_date.month'
        },
        {
          type: 'date',
          name: 't_date_year',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 10 },
              end: { line: 5, character: 36 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_date.year'
        },
        {
          type: 'date',
          name: 't_timestamp_date',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.day'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_hour',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 8, character: 10 },
              end: { line: 8, character: 46 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.hour'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_minute',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 10 },
              end: { line: 9, character: 50 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.minute'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_second',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 10, character: 10 },
              end: { line: 10, character: 50 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.second'
        },
        {
          type: 'date',
          name: 't_timestamp_month',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 10 },
              end: { line: 11, character: 48 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.month'
        },
        {
          type: 'date',
          name: 't_timestamp_year',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 12, character: 10 },
              end: { line: 12, character: 46 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.year'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 't_date_month', dir: 'desc' } ]
    }
      |       run: redshift.table('malloytest.alltypes')->{
      |            ^

      343 |           t_timestamp_year is t_timestamp.year,
      344 |       }
    > 345 |     `).malloyResultMatches(runtime, {
          |        ^
      346 |         t_date: new Date('2020-03-02'),
      347 |         t_date_month: new Date('2020-03-01'),
      348 |         t_date_year: new Date('2020-01-01'),

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:345:8)

  ● redshift › named query metadata undefined

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › named query metadata named

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › named query metadata named head of pipeline

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › filtered explores basic

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      399 |       run: aircraft extend { where: aircraft_models.manufacturer ? ~'B%' }
      400 |         -> {aggregate: m_count is count(aircraft_models.manufacturer) }
    > 401 |     `).malloyResultMatches(expressionModel, {m_count: 63});
          |        ^
      402 |   });
      403 |
      404 |   const nativeInt = databaseName === 'mysql' ? 'signed' : 'integer';

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:401:8)

  ● redshift › sql cast

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      408 |         group_by: a is "312"::"${nativeInt}"
      409 |       }
    > 410 |     `).malloyResultMatches(expressionModel, {a: 312});
          |        ^
      411 |   });
      412 |
      413 |   it('case expressions', async () => {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:410:8)

  ● redshift › case expressions

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      422 |           valuey is case manufacturer when 'BOEING' then 'BOEING' else 'NOT BOEING' end
      423 |       }
    > 424 |     `).malloyResultMatches(expressionModel, [
          |        ^
      425 |       {other: 'BOEING', nully: 'BOEING', valuey: 'BOEING'},
      426 |       {other: 'OTHER', nully: null, valuey: 'NOT BOEING'},
      427 |     ]);

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:424:8)

  ● redshift › sql safe cast

    Expected events - Expected
    + Received

      Array [
        Object {
          "data": Object {
    -       "code": "dialect-cast-unsafe-only",
    +       "code": "invalid-sql-source",
    +       "data": null,
    +       "message": "Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED",
          },
          "id": "translation-error",
        },
      ]

      443 |       });
      444 |     } else {
    > 445 |       await expect(safeCast).toEmitDuringTranslation(runtime, {
          |                              ^
      446 |         id: 'translation-error',
      447 |         data: {code: 'dialect-cast-unsafe-only'},
      448 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:445:30)

  ● redshift › many_field.sum() has correct locality

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'year_built' is not defined
      |         dimension: a_year_built is a.year_built
      |                                    ^
    line 4: 'aircraft_model_code' is not defined
      |         join_many: a on a.aircraft_model_code = a.aircraft_model_code
      |                         ^
    line 4: 'aircraft_model_code' is not defined
      |         join_many: a on a.aircraft_model_code = a.aircraft_model_code
      |                                                 ^

      462 |         aggregate: avg_a_year_built2 is floor(a.avg(a_year_built))
      463 |       }
    > 464 |     `).malloyResultMatches(runtime, {
          |        ^
      465 |       avg_a_year_built1: 1969,
      466 |       avg_a_year_built2: 1969,
      467 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:464:8)

  ● redshift › sql expr functions › sql_string

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      477 |           group_by: string_1 is sql_string("UPPER(\${manufacturer})")
      478 |         }
    > 479 |       `).malloyResultMatches(expressionModel, {
          |          ^
      480 |         string_1: 'AHRENS AIRCRAFT CORP.',
      481 |       });
      482 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:479:10)

  ● redshift › sql expr functions › sql_number

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      491 |           group_by: number_1 is sql_number("\${seats} * 2")
      492 |         }
    > 493 |   `).malloyResultMatches(expressionModel, {
          |      ^
      494 |         seats: 29,
      495 |         number_1: 58,
      496 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:493:6)

  ● redshift › sql expr functions › sql_number can be sum()med

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      508 |           aggregate: s is number_1.sum()
      509 |         }
    > 510 |       `).malloyResultMatches(expressionModel, {
          |          ^
      511 |         s: 58,
      512 |       });
      513 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:510:10)

  ● redshift › sql expr functions › sql_boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      522 |           group_by: boolean_2 is sql_boolean("\${engines} = 2")
      523 |         }
    > 524 |   `).malloyResultMatches(expressionModel, {
          |      ^
      525 |         boolean_1: booleanResult(true, databaseName),
      526 |         boolean_2: booleanResult(false, databaseName),
      527 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:524:6)

  ● redshift › sql expr functions › sql_date

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      536 |           group_by: date_1 is sql_date("\${last_action_date}")
      537 |         }
    > 538 |   `).malloyResultMatches(expressionModel, {
          |      ^
      539 |         date_1: new Date('2000-01-04T00:00:00.000Z'),
      540 |       });
      541 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:538:6)

  ● redshift › sql expr functions › sql_timestamp

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      549 |         group_by: timestamp_1 is sql_timestamp("\${last_action_date}")
      550 |         }
    > 551 |   `).malloyResultMatches(expressionModel, {
          |      ^
      552 |         timestamp_1: new Date('2000-01-04T00:00:00.000Z'),
      553 |       });
      554 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:551:6)

  ● redshift › sql expr functions › with ${TABLE}.field

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      562 |           group_by: string_1 is sql_string('UPPER(\${TABLE}.${q`manufacturer`})')
      563 |         }
    > 564 |       `).malloyResultMatches(expressionModel, {
          |          ^
      565 |         string_1: 'AHRENS AIRCRAFT CORP.',
      566 |       });
      567 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:564:10)

  ● redshift › sql expr functions › with ${field}

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      575 |           group_by: string_1 is sql_string("UPPER(\${manufacturer})")
      576 |         }
    > 577 |       `).malloyResultMatches(expressionModel, {
          |          ^
      578 |         string_1: 'AHRENS AIRCRAFT CORP.',
      579 |       });
      580 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:577:10)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.dimension_name} - one path

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found ${a.manufacturer}"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:596:43)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.dimension_name} - multiple paths

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found (${a.seats}, ${a.seats}, ${a.total_seats})"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:612:43)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.SQL_TABLE_NAME}

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found ${a.SQL_TABLE_NAME}"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:628:43)

  ● redshift › query with aliasname used twice

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      654 |             order_by: 2 desc, 1
      655 |         }
    > 656 |       `).malloyResultMatches(expressionModel, {first_three: 'SAB'});
          |          ^
      657 |     }
      658 |   );
      659 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:656:10)

  ● redshift › joined filtered sources

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      676 |           aircraft_count
      677 |       }
    > 678 |     `).malloyResultMatches(expressionModel, {
          |        ^
      679 |       model_count: 244,
      680 |       aircraft_count: 3599,
      681 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:678:8)

  ● redshift › joined filtered explores with NO dependencies

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         primary_key: state
      |         ^
    line 7: 'state' is not defined
      |       source: al is sf extend {where: state = 'AL'}
      |                                       ^
    line 11: 'state' is not defined
      |         join_one: al with state
      |                           ^
    line 11: join_one: Primary key 'undefined' not found in source
      |         join_one: al with state
      |                   ^
    line 10: 'state' is not defined
      |         where: state ~ 'A%'
      |                ^
    line 15: 'state' is not defined
      |         join_one: a with state
      |                          ^
    line 15: join_one: Primary key 'undefined' not found in source
      |         join_one: a with state
      |                   ^
    line 18: INTERNAL ERROR model/Segment.nextStructDef: state not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'allx',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 19, character: 10 },
              end: { line: 19, character: 29 }
            }
          },
          e: { node: 'field', path: [ 'state_count' ] },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'state_count'
        },
        {
          type: 'number',
          numberType: 'integer',
          name: 'a',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 20, character: 10 },
              end: { line: 20, character: 28 }
            }
          },
          e: { node: 'field', path: [ 'a', 'state_count' ] },
          compositeFieldUsage: {
            fields: [],
            joinedUsage: { a: { fields: [], joinedUsage: {} } }
          },
          expressionType: 'aggregate',
          code: 'a.state_count'
        },
        {
          type: 'number',
          numberType: 'integer',
          name: 'al',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 21, character: 10 },
              end: { line: 21, character: 32 }
            }
          },
          e: { node: 'field', path: [ 'a', 'al', 'state_count' ] },
          compositeFieldUsage: {
            fields: [],
            joinedUsage: {
              a: {
                fields: [],
                joinedUsage: { al: { fields: [], joinedUsage: {} } }
              }
            }
          },
          expressionType: 'aggregate',
          code: 'a.al.state_count'
        }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: {
          a: {
            fields: [],
            joinedUsage: { al: { fields: [], joinedUsage: {} } }
          }
        }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'allx', dir: 'desc' } ]
    }
      |       run: allx -> {
      |            ^

      741 |           al is a.al.state_count
      742 |       }
    > 743 |     `).malloyResultMatches(runtime, {allx: 51, a: 4, al: 1});
          |        ^
      744 |   });
      745 | });
      746 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:743:8)

  ● redshift › string literal quoting › quote single character

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string literal quoting › quote single quote

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string literal quoting › quote double quote

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") -> {
      |      ^

      811 |           select: double_quote is "${back}${dq}"
      812 |         }`
    > 813 |       ).malloyResultMatches(runtime, {double_quote: '"'});
          |         ^
      814 |     });
      815 |     test('quote backslash', async () => {
      816 |       expect(await sqlEq(`'${back}${back}'`, back)).isSqlEq();

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:813:9)

  ● redshift › string literal quoting › quote backslash

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › nullish ?? operator

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/ee967c00-89dc-54d5-9638-72ded1fcbf4c: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 5: 'null_value' is not defined
      |         where: null_value is null
      |                ^
    line 7: 'null_value' is not defined
      |           found_null is  null_value ?? 'correct',
      |                          ^
    line 8: 'string_value' is not defined
      |           else_pass is string_value ?? 'incorrect'
      |                        ^

      830 |           literal_null is null ?? 'correct'
      831 |       }`
    > 832 |     ).malloyResultMatches(runtime, {
          |       ^
      833 |       found_null: 'correct',
      834 |       else_pass: 'correct',
      835 |       literal_null: 'correct',

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:832:7)

  ● redshift › null safe booleans › select boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> {
      |                          ^
    line 12: 'tf' is not defined
      |           null_boolean is tf
      |                           ^

      854 |         select:
      855 |           null_boolean is tf
    > 856 |       }`).malloyResultMatches(runtime, {null_boolean: null});
          |           ^
      857 |     });
      858 |     it('not boolean', async () => {
      859 |       await expect(`run: ${nulls} -> {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:856:11)

  ● redshift › null safe booleans › not boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> {
      |                          ^
    line 12: 'tf' is not defined
      |           not_null_boolean is not tf
      |                                   ^

      860 |         select:
      861 |           not_null_boolean is not tf
    > 862 |       }`).malloyResultMatches(runtime, {not_null_boolean: is_true});
          |           ^
      863 |     });
      864 |     it('numeric != non-null to null', async () => {
      865 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:862:11)

  ● redshift › null safe booleans › numeric != non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is x != 9 }
      |                          ^
    line 10: 'x' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is x != 9 }
      |                                                              ^

      865 |       await expect(
      866 |         `run: ${nulls} -> { select: val_ne_null is x != 9 }`
    > 867 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      868 |     });
      869 |     it('string !~ non-null to null', async () => {
      870 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:867:9)

  ● redshift › null safe booleans › string !~ non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ 'z' }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ 'z' }
      |                                                              ^

      870 |       await expect(
      871 |         `run: ${nulls} -> { select: val_ne_null is a !~ 'z' }`
    > 872 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      873 |     });
      874 |     it('regex !~ non-null to null', async () => {
      875 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:872:9)

  ● redshift › null safe booleans › regex !~ non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ r'z' }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ r'z' }
      |                                                              ^

      875 |       await expect(
      876 |         `run: ${nulls} -> { select: val_ne_null is a !~ r'z' }`
    > 877 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      878 |     });
      879 |     it('numeric != null-to-null', async () => {
      880 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:877:9)

  ● redshift › null safe booleans › numeric != null-to-null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                          ^
    line 10: 'x' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                                                               ^
    line 10: 'y' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                                                                    ^

      880 |       await expect(
      881 |         `run: ${nulls} -> { select: null_ne_null is x != y }`
    > 882 |       ).malloyResultMatches(runtime, {null_ne_null: is_true});
          |         ^
      883 |     });
      884 |     it('string !~ null-to-null', async () => {
      885 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:882:9)

  ● redshift › null safe booleans › string !~ null-to-null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                                                               ^
    line 10: 'b' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                                                                    ^

      885 |       await expect(
      886 |         `run: ${nulls} -> { select: null_ne_null is a !~ b }`
    > 887 |       ).malloyResultMatches(runtime, {null_ne_null: is_true});
          |         ^
      888 |     });
      889 |   });
      890 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:887:9)

  ● redshift › dimension expressions expanded with parens properly

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      898 |           paren is    false and (fot)
      899 |       }`
    > 900 |     ).malloyResultMatches(runtime, {
          |       ^
      901 |       paren: booleanResult(false, databaseName),
      902 |       no_paren: booleanResult(false, databaseName),
      903 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:900:7)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpb29ca3db55d7482d87ab7d1ce9988756;\n' +
        '      create temp table tmpb29ca3db55d7482d87ab7d1ce9988756 as SELECT * FROM (\n' +
        '        \n' +
        '      SELECT JSONB_BUILD_ARRAY(2,4,6,8) AS "evens"\n' +
        '    \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpb29ca3db55d7482d87ab7d1ce9988756';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpb29ca3db55d7482d87ab7d1ce9988756;
          create temp table tmpb29ca3db55d7482d87ab7d1ce9988756 as SELECT * FROM (
            
          SELECT JSONB_BUILD_ARRAY(2,4,6,8) AS "evens"
        
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpb29ca3db55d7482d87ab7d1ce9988756';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp73354a68e0fe4e0293a3bc5177808af6;\n' +
        '      create temp table tmp73354a68e0fe4e0293a3bc5177808af6 as SELECT * FROM (\n' +
        '        SELECT 0 as z\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp73354a68e0fe4e0293a3bc5177808af6';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp73354a68e0fe4e0293a3bc5177808af6;
          create temp table tmp73354a68e0fe4e0293a3bc5177808af6 as SELECT * FROM (
            SELECT 0 as z
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp73354a68e0fe4e0293a3bc5177808af6';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpc0f600cb20a7479f9156c75e97e0924f;\n' +
        '      create temp table tmpc0f600cb20a7479f9156c75e97e0924f as SELECT * FROM (\n' +
        '        select 0 as o\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpc0f600cb20a7479f9156c75e97e0924f';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpc0f600cb20a7479f9156c75e97e0924f;
          create temp table tmpc0f600cb20a7479f9156c75e97e0924f as SELECT * FROM (
            select 0 as o
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpc0f600cb20a7479f9156c75e97e0924f';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp041f73d035974c1d8c8627eedbd930fa;\n' +
        '      create temp table tmp041f73d035974c1d8c8627eedbd930fa as SELECT * FROM (\n' +
        '        SELECT 0 AS O\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp041f73d035974c1d8c8627eedbd930fa';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp041f73d035974c1d8c8627eedbd930fa;
          create temp table tmp041f73d035974c1d8c8627eedbd930fa as SELECT * FROM (
            SELECT 0 AS O
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp041f73d035974c1d8c8627eedbd930fa';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp26ceadddd8cb4ce0b657cff3fc13bb45;\n' +
        '      create temp table tmp26ceadddd8cb4ce0b657cff3fc13bb45 as SELECT * FROM (\n' +
        '        SELECT 1 as "o"\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp26ceadddd8cb4ce0b657cff3fc13bb45';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp26ceadddd8cb4ce0b657cff3fc13bb45;
          create temp table tmp26ceadddd8cb4ce0b657cff3fc13bb45 as SELECT * FROM (
            SELECT 1 as "o"
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp26ceadddd8cb4ce0b657cff3fc13bb45';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp0058925c22f4405dbfed7505e8334338;\n' +
        '      create temp table tmp0058925c22f4405dbfed7505e8334338 as SELECT * FROM (\n' +
        '        \n' +
        '              SELECT\n' +
        '                10 as "a",\n' +
        '                11 as "b"\n' +
        '              UNION ALL SELECT 20 , 21\n' +
        '            \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp0058925c22f4405dbfed7505e8334338';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp0058925c22f4405dbfed7505e8334338;
          create temp table tmp0058925c22f4405dbfed7505e8334338 as SELECT * FROM (
            
                  SELECT
                    10 as "a",
                    11 as "b"
                  UNION ALL SELECT 20 , 21
                
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp0058925c22f4405dbfed7505e8334338';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp2fa3c3283d0949d3b8366db68044fb84;\n' +
        '      create temp table tmp2fa3c3283d0949d3b8366db68044fb84 as SELECT * FROM (\n' +
        `         SELECT JSONB_BUILD_ARRAY(JSONB_BUILD_OBJECT('a',10, 'b',11),JSONB_BUILD_OBJECT('a',20, 'b',21)) AS "ab" \n` +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp2fa3c3283d0949d3b8366db68044fb84';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp2fa3c3283d0949d3b8366db68044fb84;
          create temp table tmp2fa3c3283d0949d3b8366db68044fb84 as SELECT * FROM (
             SELECT JSONB_BUILD_ARRAY(JSONB_BUILD_OBJECT('a',10, 'b',11),JSONB_BUILD_OBJECT('a',20, 'b',21)) AS "ab" 
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp2fa3c3283d0949d3b8366db68044fb84';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpdc7b25d609b94d1b97ee71e09b960cc4;\n' +
        '      create temp table tmpdc7b25d609b94d1b97ee71e09b960cc4 as SELECT * FROM (\n' +
        '        \n' +
        `            SELECT JSONB_BUILD_ARRAY(JSONB_BUILD_OBJECT('a',10, 'b',11),JSONB_BUILD_OBJECT('a',20, 'b',21)) AS "sqlAB"\n` +
        '          \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpdc7b25d609b94d1b97ee71e09b960cc4';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpdc7b25d609b94d1b97ee71e09b960cc4;
          create temp table tmpdc7b25d609b94d1b97ee71e09b960cc4 as SELECT * FROM (
            
                SELECT JSONB_BUILD_ARRAY(JSONB_BUILD_OBJECT('a',10, 'b',11),JSONB_BUILD_OBJECT('a',20, 'b',21)) AS "sqlAB"
              
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpdc7b25d609b94d1b97ee71e09b960cc4';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/compound-atomic.spec.ts (22.657 s)
  compound atomic datatypes redshift
    simple arrays
      ✕ array literal dialect function (1450 ms)
      ✕ select array (210 ms)
      ✕ array can be passed to !function (9 ms)
      ✕ array.each in source (1467 ms)
      ✕ array.each in extend block (109 ms)
      ✕ array stored field with special chars in name (17 ms)
      ✕ bare array of array (6 ms)
      ✕ each.each array of array (8 ms)
      ○ skipped schema read allows array-un-nest on each
      ○ skipped cross join arrays
      ○ skipped Can read schema for array of arrays
    record
      ✕ record literal object (1359 ms)
      ✕ special character in record property name (14 ms)
      ✕ record stored in field with special chars in name (11 ms)
      ✕ simple record.property access (1433 ms)
      ✕ nested data looks like a record (1417 ms)
      ✕ record can be selected (30 ms)
      ✕ record literal can be selected (11 ms)
      ✕ select record literal from a source (7 ms)
      ✕ computed record.property from a source (8 ms)
      ✕ record.property from an extend block (8 ms)
      ✕ simple each on array property inside record (7 ms)
      ✕ each on array property inside record from source (7 ms)
      ✕ record with a record property (27 ms)
      ✕ record in source with a record property (8 ms)
      ✕ record dref in source with a record property (22 ms)
      ○ skipped can read schema of record object
      ✎ todo array or record where first entries are null
    repeated record
      ✕ repeated record from nest (1454 ms)
      ✕ select repeated record from literal dialect functions (1367 ms)
      ✕ repeat record from malloy literal (17 ms)
      ✕ repeated record can be selected and renamed (1344 ms)
      ✕ select repeated record passed down pipeline (16 ms)
      ✕ deref repeat record passed down pipeline (12 ms)
      ✕ select array of records from source (11 ms)
      ✕ deref array of records from source (9 ms)
      ✕ repeated record in source wth record property (7 ms)
      ✕ piped repeated record containing an array (10 ms)
      ✕ source repeated record containing an array (10 ms)

  ● compound atomic datatypes redshift › simple arrays › array literal dialect function

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e4b1437e-5a14-5e66-b6e0-eb610689fab4: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("""
      |                             ^

       98 |       test('array literal dialect function', async () => {
       99 |         await expect(`
    > 100 |           run: ${evens}`).malloyResultMatches(runtime, {
          |                           ^
      101 |           evens: evensObj,
      102 |         });
      103 |       });

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:100:27)

  ● compound atomic datatypes redshift › simple arrays › select array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/e4b1437e-5a14-5e66-b6e0-eb610689fab4: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("""
      |                             ^
    line 5: 'evens' is not defined
      |     """)->{select: nn is evens}
      |                          ^

      106 |           # test.verbose
      107 |           run: ${evens}->{select: nn is evens}
    > 108 |           `).malloyResultMatches(runtime, {nn: evensObj});
          |              ^
      109 |       });
      110 |       test.when(canReadCompoundSchema)(
      111 |         'schema read allows array-un-nest on each',

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:108:14)

  ● compound atomic datatypes redshift › simple arrays › array can be passed to !function

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/e4b1437e-5a14-5e66-b6e0-eb610689fab4: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 3: 'evens' is not defined
      |     """)->{ select: nby2 is JSONB_ARRAY_LENGTH!number(evens); } 
      |                                                       ^

      137 |         await expect(
      138 |           `run: ${evens}->{ select: nby2 is ${fn}!number(evens); } `
    > 139 |         ).malloyResultMatches(runtime, {nby2: evensObj.length});
          |           ^
      140 |       });
      141 |       test('array.each in source', async () => {
      142 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:139:11)

  ● compound atomic datatypes redshift › simple arrays › array.each in source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      144 |           extend { dimension: d4 is [1,2,3,4] }
      145 |           -> { select: die_roll is d4.each }
    > 146 |         `).malloyResultMatches(runtime, [
          |            ^
      147 |           {die_roll: 1},
      148 |           {die_roll: 2},
      149 |           {die_roll: 3},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:146:12)

  ● compound atomic datatypes redshift › simple arrays › array.each in extend block

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^

      157 |             select: die_roll is d4.each
      158 |           }
    > 159 |         `).malloyResultMatches(runtime, [
          |            ^
      160 |           {die_roll: 1},
      161 |           {die_roll: 2},
      162 |           {die_roll: 3},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:159:12)

  ● compound atomic datatypes redshift › simple arrays › array stored field with special chars in name

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |             run: redshift.sql("SELECT 0 as z")
      |                  ^
    line 5: '_'_' is not defined
      |             -> { select: num is `_\'_`.each }
      |                                 ^

      194 |             ->{ select: ${qname} is [1]}
      195 |             -> { select: num is ${qname}.each }`;
    > 196 |             await expect(malloySrc).malloyResultMatches(runtime, {});
          |                                     ^
      197 |             const result = await runtime.loadQuery(malloySrc).run();
      198 |             const ok =
      199 |               result.data.path(0, 'num').value === 1

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:196:37)

  ● compound atomic datatypes redshift › simple arrays › bare array of array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> { select: aoa is [[1,2]] }
      |                ^

      245 |         await expect(`
      246 |           run: ${empty} -> { select: aoa is [[1,2]] }
    > 247 |         `).malloyResultMatches(runtime, {aoa: [[1, 2]]});
          |            ^
      248 |       });
      249 |       test.when(supportsNestedArrays)('each.each array of array', async () => {
      250 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:247:12)

  ● compound atomic datatypes redshift › simple arrays › each.each array of array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: aoa is [[1,2]] } -> { select: aoa.each.each }
      |                ^

      250 |         await expect(`
      251 |           run: ${empty} extend { dimension: aoa is [[1,2]] } -> { select: aoa.each.each }
    > 252 |         `).malloyResultMatches(runtime, [{each: 1}, {each: 2}]);
          |            ^
      253 |       });
      254 |     });
      255 |     describe('record', () => {

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:252:12)

  ● compound atomic datatypes redshift › record › record literal object

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/bce2202a-417c-5497-85db-08444715a2d1: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("select 0 as o")
      |                ^

      267 |           run: ${conName}.sql("select 0 as o")
      268 |           -> { select: ${malloySizes}}
    > 269 |         `).malloyResultMatches(runtime, rec_eq());
          |            ^
      270 |       });
      271 |       // can't use special chars in column names in bq
      272 |       test.when(conName !== 'bigquery')(

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:269:12)

  ● compound atomic datatypes redshift › record › special character in record property name

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 0 as z") -> { select: `_\'_` is 'ok' }
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● compound atomic datatypes redshift › record › record stored in field with special chars in name

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |             run: redshift.sql("SELECT 0 as z")
      |                  ^
    line 4: '_'_' is not defined
      |             -> { select: num is `_\'_`.rnum }
      |                                 ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● compound atomic datatypes redshift › record › simple record.property access

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0effe34d-8cbf-5613-86f3-bc8952b7f843: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: small is sizes.s }
      |                ^
    line 2: 'sizes' is not defined
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: small is sizes.s }
      |                                                                                                                             ^

      317 |       test('simple record.property access', async () => {
      318 |         await expect(`
    > 319 |           run: ${sizes} -> { select: small is sizes.s }`).malloyResultMatches(
          |                                                           ^
      320 |           runtime,
      321 |           {small: 0}
      322 |         );

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:319:59)

  ● compound atomic datatypes redshift › record › nested data looks like a record

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0e4cd650-724c-5cc2-b93a-3251c931a63c: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 1 as "o"') -> {
      |                ^
    line 6: 'o' is not defined
      |                 s is sum(o) - 1,
      |                          ^
    line 7: 'o' is not defined
      |                 m is sum(o),
      |                          ^
    line 8: 'o' is not defined
      |                 x is sum(o) + 1,
      |                          ^
    line 9: 'o' is not defined
      |                 xl is sum(o) + 2
      |                           ^
    line 11: 'sizes' is not defined
      |           } -> { select: small is sizes.s }
      |                                   ^

      333 |                 xl is sum(o) + 2
      334 |             }
    > 335 |           } -> { select: small is sizes.s }`).malloyResultMatches(runtime, {
          |                                               ^
      336 |           small: 0,
      337 |         });
      338 |       });

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:335:47)

  ● compound atomic datatypes redshift › record › record can be selected

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0effe34d-8cbf-5613-86f3-bc8952b7f843: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: sizes }
      |                ^
    line 2: 'sizes' is not defined
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: sizes }
      |                                                                                                                    ^

      341 |           `
      342 |           run: ${sizes} -> { select: sizes }`
    > 343 |         ).malloyResultMatches(runtime, rec_eq());
          |           ^
      344 |       });
      345 |       test('record literal can be selected', async () => {
      346 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:343:11)

  ● compound atomic datatypes redshift › record › record literal can be selected

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0effe34d-8cbf-5613-86f3-bc8952b7f843: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: record is sizes }
      |                ^
    line 2: 'sizes' is not defined
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: record is sizes }
      |                                                                                                                              ^

      346 |         await expect(`
      347 |           run: ${sizes} -> { select: record is sizes }
    > 348 |         `).malloyResultMatches(runtime, rec_eq('record'));
          |            ^
      349 |       });
      350 |       test('select record literal from a source', async () => {
      351 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:348:12)

  ● compound atomic datatypes redshift › record › select record literal from a source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^

      354 |             select: sizes
      355 |           }
    > 356 |         `).malloyResultMatches(runtime, rec_eq());
          |            ^
      357 |       });
      358 |       test('computed record.property from a source', async () => {
      359 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:356:12)

  ● compound atomic datatypes redshift › record › computed record.property from a source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      361 |             extend { dimension: record is {s is 0, m is 1, l is 2, xl is 3} }
      362 |             -> { select: small is record.s }
    > 363 |         `).malloyResultMatches(runtime, {small: 0});
          |            ^
      364 |       });
      365 |       test('record.property from an extend block', async () => {
      366 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:363:12)

  ● compound atomic datatypes redshift › record › record.property from an extend block

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^

      369 |             select: small is record.s
      370 |           }
    > 371 |         `).malloyResultMatches(runtime, {small: 0});
          |            ^
      372 |       });
      373 |       test('simple each on array property inside record', async () => {
      374 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:371:12)

  ● compound atomic datatypes redshift › record › simple each on array property inside record

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> { select: nums is { odds is [1,3], evens is [2,4]} }
      |                ^
    line 3: 'nums' is not defined
      |           -> { select: odd is nums.odds.value }
      |                               ^

      375 |           run: ${empty} -> { select: nums is { odds is [1,3], evens is [2,4]} }
      376 |           -> { select: odd is nums.odds.value }
    > 377 |         `).malloyResultMatches(runtime, [{odd: 1}, {odd: 3}]);
          |            ^
      378 |       });
      379 |       test('each on array property inside record from source', async () => {
      380 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:377:12)

  ● compound atomic datatypes redshift › record › each on array property inside record from source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: nums is { odds is [1,3], evens is [2,4]} }
      |                ^

      381 |           run: ${empty} extend { dimension: nums is { odds is [1,3], evens is [2,4]} }
      382 |           -> { select: odd is nums.odds.each }
    > 383 |         `).malloyResultMatches(runtime, [{odd: 1}, {odd: 3}]);
          |            ^
      384 |       });
      385 |       const abc = "rec is {a is 'a', bc is {b is 'b', c is 'c'}}";
      386 |       test('record with a record property', async () => {

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:383:12)

  ● compound atomic datatypes redshift › record › record with a record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> { select: rec is {a is 'a', bc is {b is 'b', c is 'c'}} }
      |                ^
    line 3: 'rec' is not defined
      |           -> { select: rec.a, rec.bc.b, rec.bc.c }
      |                        ^
    line 3: 'rec' is not defined
      |           -> { select: rec.a, rec.bc.b, rec.bc.c }
      |                               ^
    line 3: 'rec' is not defined
      |           -> { select: rec.a, rec.bc.b, rec.bc.c }
      |                                         ^

      388 |           run: ${empty} -> { select: ${abc} }
      389 |           -> { select: rec.a, rec.bc.b, rec.bc.c }
    > 390 |         `).malloyResultMatches(runtime, {a: 'a', b: 'b', c: 'c'});
          |            ^
      391 |       });
      392 |       test('record in source with a record property', async () => {
      393 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:390:12)

  ● compound atomic datatypes redshift › record › record in source with a record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: rec is {a is 'a', bc is {b is 'b', c is 'c'}} }
      |                ^

      394 |           run: ${empty} extend { dimension: ${abc} }
      395 |           -> { select: rec.a, rec.bc.b, rec.bc.c }
    > 396 |         `).malloyResultMatches(runtime, {a: 'a', b: 'b', c: 'c'});
          |            ^
      397 |       });
      398 |       test('record dref in source with a record property', async () => {
      399 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:396:12)

  ● compound atomic datatypes redshift › record › record dref in source with a record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: rec is {a is 'a', bc is {b is 'b', c is 'c'}} }
      |                ^

      400 |           run: ${empty} extend { dimension: ${abc} }
      401 |           -> { select: b is pick rec.bc.b when true else 'b' }
    > 402 |         `).malloyResultMatches(runtime, {b: 'b'});
          |            ^
      403 |       });
      404 |       test.todo('array or record where first entries are null');
      405 |     });

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:402:12)

  ● compound atomic datatypes redshift › repeated record › repeated record from nest

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/06f481d0-1a2d-576a-b3fb-021b8c408f63: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |             run: redshift.sql("""
      |                               ^
    line 7: 'a' is not defined
      |             """) -> { nest: ab is { select: a, b } }
      |                                             ^
    line 7: 'b' is not defined
      |             """) -> { nest: ab is { select: a, b } }
      |                                                ^
    line 8: 'ab' is not defined
      |                  -> { select: ab.a, ab.b ; order_by: a}
      |                               ^
    line 8: 'ab' is not defined
      |                  -> { select: ab.a, ab.b ; order_by: a}
      |                                     ^

      441 |             """) -> { nest: ab is { select: a, b } }
      442 |                  -> { select: ab.a, ab.b ; order_by: a}
    > 443 |         `).malloyResultMatches(runtime, ab_eq);
          |            ^
      444 |       });
      445 |       test('select repeated record from literal dialect functions', async () => {
      446 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:443:12)

  ● compound atomic datatypes redshift › repeated record › select repeated record from literal dialect functions

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/33fbccea-6a58-5fe1-8666-7d426af32f59: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql(""" SELECT JSONB_BUILD_ARRAY(JSONB_BUILD_OBJECT('a',10, 'b',11),JSONB_BUILD_OBJECT('a',20, 'b',21)) AS "ab" """)
      |                             ^

      446 |         await expect(`
      447 |           run: ${conName}.sql(""" ${selectAB('ab')} """)
    > 448 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      449 |       });
      450 |       test('repeat record from malloy literal', async () => {
      451 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:448:12)

  ● compound atomic datatypes redshift › repeated record › repeat record from malloy literal

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      452 |           run: ${empty}
      453 |           -> { select: ab is ${abMalloy} }
    > 454 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      455 |       });
      456 |       test('repeated record can be selected and renamed', async () => {
      457 |         const src = `

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:454:12)

  ● compound atomic datatypes redshift › repeated record › repeated record can be selected and renamed

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/32253540-9219-53f1-b16c-354a638aac18: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("""
      |                             ^
    line 4: 'sqlAB' is not defined
      |           """) -> { select: ab is sqlAB }
      |                                   ^

      460 |           """) -> { select: ab is sqlAB }
      461 |       `;
    > 462 |         await expect(src).malloyResultMatches(runtime, {ab: ab_eq});
          |                           ^
      463 |       });
      464 |       test('select repeated record passed down pipeline', async () => {
      465 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:462:27)

  ● compound atomic datatypes redshift › repeated record › select repeated record passed down pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^
    line 4: 'pipeAb' is not defined
      |           -> { select: ab is pipeAb }
      |                              ^

      467 |           -> { select: pipeAb is ${abMalloy} }
      468 |           -> { select: ab is pipeAb }
    > 469 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      470 |       });
      471 |       test('deref repeat record passed down pipeline', async () => {
      472 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:469:12)

  ● compound atomic datatypes redshift › repeated record › deref repeat record passed down pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^
    line 4: 'pipeAb' is not defined
      |           -> { select: pipeAb.a, pipeAb.b }
      |                        ^
    line 4: 'pipeAb' is not defined
      |           -> { select: pipeAb.a, pipeAb.b }
      |                                  ^

      474 |           -> { select: pipeAb is ${abMalloy} }
      475 |           -> { select: pipeAb.a, pipeAb.b }
    > 476 |         `).malloyResultMatches(runtime, ab_eq);
          |            ^
      477 |       });
      478 |       test('select array of records from source', async () => {
      479 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:476:12)

  ● compound atomic datatypes redshift › repeated record › select array of records from source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      481 |           extend { dimension: abSrc is ${abMalloy} }
      482 |           -> { select: ab is abSrc }
    > 483 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      484 |       });
      485 |       test('deref array of records from source', async () => {
      486 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:483:12)

  ● compound atomic datatypes redshift › repeated record › deref array of records from source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      488 |           extend { dimension: ab is ${abMalloy} }
      489 |           -> { select: ab.a, ab.b }
    > 490 |         `).malloyResultMatches(runtime, ab_eq);
          |            ^
      491 |       });
      492 |       test('repeated record in source wth record property', async () => {
      493 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:490:12)

  ● compound atomic datatypes redshift › repeated record › repeated record in source wth record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: rec is [ {bc is  {b is 'b'}} ] }
      |                ^

      494 |           run: ${empty} extend { dimension: rec is [ {bc is  {b is 'b'}} ] }
      495 |           -> { select: rec.bc.b }
    > 496 |         `).malloyResultMatches(runtime, {b: 'b'});
          |            ^
      497 |       });
      498 |       test('piped repeated record containing an array', async () => {
      499 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:496:12)

  ● compound atomic datatypes redshift › repeated record › piped repeated record containing an array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^
    line 8: 'rrec' is not defined
      |             select: val is rrec.val, name is rrec.names.each
      |                            ^
    line 8: 'rrec' is not defined
      |             select: val is rrec.val, name is rrec.names.each
      |                                              ^

      507 |             order_by: val desc, name asc
      508 |           }
    > 509 |         `).malloyResultMatches(runtime, [
          |            ^
      510 |           {val: 2, name: 'due'},
      511 |           {val: 2, name: 'two'},
      512 |           {val: 1, name: 'one'},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:509:12)

  ● compound atomic datatypes redshift › repeated record › source repeated record containing an array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend {
      |                ^

      525 |             order_by: val desc, name asc
      526 |           }
    > 527 |         `).malloyResultMatches(runtime, [
          |            ^
      528 |           {val: 2, name: 'due'},
      529 |           {val: 2, name: 'two'},
      530 |           {val: 1, name: 'one'},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:527:12)

FAIL test/src/databases/all/functions.spec.ts (19.87 s)
  ● concat › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● round › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● floor › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ceil › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● length › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lower › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● upper › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● regexp_extract › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● replace › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● substr › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● raw function call › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works with struct - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works with implicit parameter - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works with filter - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a dimension  - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a dimension in the other order  - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a measure - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a measure but there is no group by - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works inside nest - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works outside nest, but with a nest nearby - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works ordered by dimension - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works ordered by aggregate - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works using unary minus in calculate block - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › properly isolated nested calculations - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      506 |             order_by: id2 desc
      507 |           }
    > 508 |       `).malloyResultMatches(expressionModel, {
          |          ^
      509 |         id2: 2,
      510 |       });
      511 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:508:10)

  ● lag › works with one param - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with expression field - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with expression - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with field, ordering by expression field - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with offset - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with default value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with now as the default value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● output field in calculate › output field referenceable in calculate - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works in nest - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works outside nest - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works with an aggregate which is not in the query - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works with a localized aggregate - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● trunc › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● log › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ln › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● exp › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● cos › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● acos › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sin › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● asin › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● tan › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● atan › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● atan2 › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sqrt › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● pow › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● abs › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sign › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● is_inf › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● is_nan › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● greatest › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● least › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● div › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● strpos › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● starts_with › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ends_with › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● trim › trim works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ltrim › ltrim works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rtrim › rtrim works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rand › is usually not the same value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● pi › is pi - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● byte_length › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ifnull › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● coalesce › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● nullif › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● chr › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ascii › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● unicode › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● string_repeat › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● reverse › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lead › works with one param - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lead › works with offset - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lead › works with default value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● last_value › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● avg_moving › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● avg_moving › works forward - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sum_moving › works - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1252 |         calculate: s is sum_moving(b, 2)
      1253 |         limit: 5
    > 1254 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1255 |         {b: 28810563, s: 28810563},
      1256 |         {b: 23694136, s: 23694136 + 28810563},
      1257 |         {b: 21467359, s: 21467359 + 23694136 + 28810563},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1254:11)

  ● sum_moving › works forward - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1268 |         calculate: s is sum_moving(b, 0, 2)
      1269 |         limit: 7
    > 1270 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1271 |         {b: 28810563, s: 28810563 + 23694136 + 21467359},
      1272 |         {b: 23694136, s: 23694136 + 21467359 + 16661910},
      1273 |         {b: 21467359, s: 21467359 + 16661910 + 15178876},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1270:11)

  ● min, max, sum / window, cumulative › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string_agg › works no order by - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1388 |         where: name = 'RUTHERFORD PAT R JR'
      1389 |         aggregate: f is string_agg(name)
    > 1390 |       }`).malloyResultMatches(expressionModel, {f: 'RUTHERFORD PAT R JR'});
           |           ^
      1391 |     });
      1392 |
      1393 |     it(`works with dotted shortcut - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1390:11)

  ● redshift › string_agg › works with dotted shortcut - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1395 |         where: name = 'RUTHERFORD PAT R JR'
      1396 |         aggregate: f is name.string_agg()
    > 1397 |       }`).malloyResultMatches(expressionModel, {f: 'RUTHERFORD PAT R JR'});
           |           ^
      1398 |     });
      1399 |
      1400 |     it(`works with order by field - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1397:11)

  ● redshift › string_agg › works with order by field - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1405 |           order_by: name
      1406 |         }
    > 1407 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1408 |         f: 'RUTHERFORD JAMES C,RUTHERFORD PAT R JR',
      1409 |       });
      1410 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1407:11)

  ● redshift › string_agg › works with multiple order_bys - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1429 |           order_by: city, name
      1430 |         }
    > 1431 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1432 |         f: 'RUTHERFORD PAT R JR,RUTHERFORD JAMES C',
      1433 |       });
      1434 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1431:11)

  ● redshift › string_agg › works with order by expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1445 |           order_by: length(name)
      1446 |         }
    > 1447 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1448 |         f: 'YANKEE FLYING CLUB INC,WESTCHESTER FLYING CLUB,WILSON FLYING SERVICE INC',
      1449 |       });
      1450 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1447:11)

  ● redshift › string_agg › works with order by join expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1455 |         where: name ~ r'.*ADVENTURE.*'
      1456 |         aggregate: f is string_agg(name, ',') { order_by: aircraft_models.model }
    > 1457 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1458 |         f: 'ADVENTURE INC,SEA PLANE ADVENTURE INC,A BALLOON ADVENTURES ALOFT,A AERONAUTICAL ADVENTURE INC',
      1459 |       });
      1460 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1457:11)

  ● redshift › string_agg › works with order asc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1469 |       } -> {
      1470 |         aggregate: f is string_agg(name, ',') { order_by: name asc }
    > 1471 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1472 |         f: 'WESTCHESTER FLYING CLUB,WILSON FLYING SERVICE INC,YANKEE FLYING CLUB INC',
      1473 |       });
      1474 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1471:11)

  ● redshift › string_agg › works with order desc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1483 |       } -> {
      1484 |         aggregate: f is string_agg(name, ',') { order_by: name desc }
    > 1485 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1486 |         f: 'YANKEE FLYING CLUB INC,WILSON FLYING SERVICE INC,WESTCHESTER FLYING CLUB',
      1487 |       });
      1488 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1485:11)

  ● redshift › string_agg › works with fanout and order_by - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1510 |           order_by: popular_name, state
      1511 |         }
    > 1512 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1513 |         s: 'IA,LA,MN,AL,AR,IN,ME,MT,NC,AZ,CA,CO,CT,FL,GA,HI,IL,KS,KY,MA,MO,NJ,NM,NV,NY,OH,OK,PA,RI,TN,TX,WV,WY,DC,MS,SC,ID,NE,UT,VA,AK,DE,MD,MI,ND,NH,OR,SD,VT,WA,WI',
      1514 |         c: 51,
      1515 |       });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1512:11)

  ● redshift › string_agg › works with fanout - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1531 |         aggregate: c is state_facts2.count()
      1532 |         aggregate: s is string_agg('o')
    > 1533 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1534 |         s: 'o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o',
      1535 |         c: 51,
      1536 |       });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1533:11)

  ● redshift › string_agg › works with fanout and separator - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1547 |         aggregate: c is state_facts2.count()
      1548 |         aggregate: s is string_agg('o', '')
    > 1549 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1550 |         s: 'ooooooooooooooooooooooooooooooooooooooooooooooooooo',
      1551 |         c: 51,
      1552 |       });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1549:11)

  ● redshift › string_agg › works with limit - redshift

    expect(received).rejects.toThrow(expected)

    Expected substring: "Function string_agg does not support limit"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1573:70)

  ● redshift › string_agg_distinct › actually distincts - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'tail_num' is not defined
      |           primary_key: tail_num
      |           ^
    line 7: 'aircraft_model_code' is not defined
      |           primary_key: aircraft_model_code
      |           ^
    line 8: 'aircraft_model_code' is not defined
      |           join_many: aircraft on aircraft_model_code = aircraft.aircraft_model_code
      |                                  ^
    line 8: 'aircraft_model_code' is not defined
      |           join_many: aircraft on aircraft_model_code = aircraft.aircraft_model_code
      |                                                        ^
    line 12: 'name' is not defined
      |           where: aircraft.name = 'RAYTHEON AIRCRAFT COMPANY' | 'FOWLER IRA R DBA'
      |                  ^
    line 13: Reference to undefined value aircraft.name
      |           aggregate: f_dist is aircraft.name.string_agg_distinct() { order_by: asc }
      |                                ^
    line 13: No matching overload for function string_agg_distinct()
      |           aggregate: f_dist is aircraft.name.string_agg_distinct() { order_by: asc }
      |                                ^
    line 14: Reference to undefined value aircraft.name
      |           aggregate: f_all is aircraft.name.string_agg() { order_by: aircraft.name }
      |                               ^
    line 14: No matching overload for function string_agg()
      |           aggregate: f_all is aircraft.name.string_agg() { order_by: aircraft.name }
      |                               ^

      1594 |           aggregate: f_dist is aircraft.name.string_agg_distinct() { order_by: asc }
      1595 |           aggregate: f_all is aircraft.name.string_agg() { order_by: aircraft.name }
    > 1596 |       }`).malloyResultMatches(runtime, {
           |           ^
      1597 |         f_dist: 'FOWLER IRA R DBA,RAYTHEON AIRCRAFT COMPANY',
      1598 |         f_all:
      1599 |           'FOWLER IRA R DBA,FOWLER IRA R DBA,RAYTHEON AIRCRAFT COMPANY,RAYTHEON AIRCRAFT COMPANY',

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1596:11)

  ● redshift › string_agg_distinct › works no order by - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1605 |         where: name = 'RUTHERFORD PAT R JR'
      1606 |         aggregate: f is string_agg_distinct(name)
    > 1607 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1608 |         f: 'RUTHERFORD PAT R JR',
      1609 |       });
      1610 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1607:11)

  ● redshift › string_agg_distinct › works with dotted shortcut - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1614 |         where: name = 'RUTHERFORD PAT R JR'
      1615 |         aggregate: f is name.string_agg_distinct()
    > 1616 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1617 |         f: 'RUTHERFORD PAT R JR',
      1618 |       });
      1619 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1616:11)

  ● redshift › string_agg_distinct › works with order by direction - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1626 |           order_by: asc
      1627 |         }
    > 1628 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1629 |         f: 'RUTHERFORD JAMES C,RUTHERFORD PAT R JR',
      1630 |       });
      1631 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1628:11)

  ● redshift › string_agg_distinct › works with order asc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1640 |       } -> {
      1641 |         aggregate: f is string_agg_distinct(name, ',') { order_by: asc }
    > 1642 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1643 |         f: 'WESTCHESTER FLYING CLUB,WILSON FLYING SERVICE INC,YANKEE FLYING CLUB INC',
      1644 |       });
      1645 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1642:11)

  ● redshift › string_agg_distinct › works with order desc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1654 |       } -> {
      1655 |         aggregate: f is string_agg_distinct(name, ',') { order_by: desc }
    > 1656 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1657 |         f: 'YANKEE FLYING CLUB INC,WILSON FLYING SERVICE INC,WESTCHESTER FLYING CLUB',
      1658 |       });
      1659 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1656:11)

  ● redshift › string_agg_distinct › works with limit - redshift

    expect(received).rejects.toThrow(expected)

    Expected substring: "Function string_agg_distinct does not support limit"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1679:70)

  ● redshift › partition_by › works - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1702 |         order_by: yr, qtr
      1703 |         where: dep_time < @2002
    > 1704 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1705 |         {yr: 2000, qtr: 1, qtr_flights: 12148, last_yr_qtr_flights: null},
      1706 |         {yr: 2000, qtr: 2, qtr_flights: 11599, last_yr_qtr_flights: null},
      1707 |         {yr: 2000, qtr: 3, qtr_flights: 12075, last_yr_qtr_flights: null},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1704:11)

  ● redshift › partition_by › works with aggregate - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1726 |         order_by: l
      1727 |         limit: 5
    > 1728 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1729 |         {l: 'A', c: 4, prev: null},
      1730 |         {l: 'C', c: 3, prev: null},
      1731 |         {l: 'D', c: 2, prev: null},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1728:11)

  ● redshift › partition_by › works with multiple order_bys - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1752 |           }
      1753 |         order_by: name
    > 1754 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1755 |         {name: 'AMERICAN AIRLINES INC', r: 3},
      1756 |         {name: 'CESSNA AIRCRAFT COMPANY', r: 4},
      1757 |         {name: 'FEDERAL EXPRESS CORP', r: 2},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1754:11)

  ● redshift › partition_by › can be used in a select

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1774 |           limit: 3
      1775 |         }
    > 1776 |       `).malloyResultMatches(expressionModel, [
           |          ^
      1777 |         {
      1778 |           state: 'CA',
      1779 |           births: 28810563,

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1776:10)


  ● Test suite failed to run

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1417 |           order_by: asc
      1418 |         }
    > 1419 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1420 |         f: 'RUTHERFORD JAMES C,RUTHERFORD PAT R JR',
      1421 |       });
      1422 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1419:11)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpc08135990f8b49b0b9176e83cdca7231;\n' +
        '      create temp table tmpc08135990f8b49b0b9176e83cdca7231 as SELECT * FROM (\n' +
        `        SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" \n` +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpc08135990f8b49b0b9176e83cdca7231';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpc08135990f8b49b0b9176e83cdca7231;
          create temp table tmpc08135990f8b49b0b9176e83cdca7231 as SELECT * FROM (
            SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" 
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpc08135990f8b49b0b9176e83cdca7231';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpa8d4888e47524ac3ad38c9a3f21e43f3;\n' +
        '      create temp table tmpa8d4888e47524ac3ad38c9a3f21e43f3 as SELECT * FROM (\n' +
        '        SELECT 1\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpa8d4888e47524ac3ad38c9a3f21e43f3';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpa8d4888e47524ac3ad38c9a3f21e43f3;
          create temp table tmpa8d4888e47524ac3ad38c9a3f21e43f3 as SELECT * FROM (
            SELECT 1
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpa8d4888e47524ac3ad38c9a3f21e43f3';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp4982e4596b4f4617bf6cc6fc038eedac;\n' +
        '      create temp table tmp4982e4596b4f4617bf6cc6fc038eedac as SELECT * FROM (\n' +
        '        SELECT 1 as one\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp4982e4596b4f4617bf6cc6fc038eedac';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp4982e4596b4f4617bf6cc6fc038eedac;
          create temp table tmp4982e4596b4f4617bf6cc6fc038eedac as SELECT * FROM (
            SELECT 1 as one
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp4982e4596b4f4617bf6cc6fc038eedac';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpd4cd8d2ebd224ba1a2cc25eae49ace82;\n' +
        '      create temp table tmpd4cd8d2ebd224ba1a2cc25eae49ace82 as SELECT * FROM (\n' +
        '        SELECT 1 as x\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpd4cd8d2ebd224ba1a2cc25eae49ace82';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpd4cd8d2ebd224ba1a2cc25eae49ace82;
          create temp table tmpd4cd8d2ebd224ba1a2cc25eae49ace82 as SELECT * FROM (
            SELECT 1 as x
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpd4cd8d2ebd224ba1a2cc25eae49ace82';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpfc44bdfe57c44eac870002ab320f8c7f;\n' +
        '      create temp table tmpfc44bdfe57c44eac870002ab320f8c7f as SELECT * FROM (\n' +
        `         SELECT DATE '2020-02-20'  AS "mex_20" \n` +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpfc44bdfe57c44eac870002ab320f8c7f';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpfc44bdfe57c44eac870002ab320f8c7f;
          create temp table tmpfc44bdfe57c44eac870002ab320f8c7f as SELECT * FROM (
             SELECT DATE '2020-02-20'  AS "mex_20" 
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpfc44bdfe57c44eac870002ab320f8c7f';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/time.spec.ts (18.906 s)
  redshift date and time
    ✕ date in sql_block no explore (7 ms)
    ✕ timestamp in sql_block no explore (7 ms)
    ✕ valid timestamp without seconds (8 ms)
    ✕ dependant join dialect fragments (47 ms)
    interval measurement
      ✕ forwards is positive (1747 ms)
      ✕ reverse is negative (30 ms)
      ✕ seconds (110 ms)
      ✕ minutes (14 ms)
      ✕ hours (11 ms)
      ✕ days (16 ms)
      ✕ timeDiff passed to a function preserves rhs (1372 ms)
    timestamp truncation
      ✕ trunc second (13 ms)
      ✕ trunc minute (11 ms)
      ✕ trunc hour (10 ms)
      ✕ trunc day (11 ms)
      ✕ trunc week (9 ms)
      ✕ trunc month (8 ms)
      ✕ trunc quarter (8 ms)
      ✕ trunc year (10 ms)
    timestamp extraction
      ✕ extract second (8 ms)
      ✕ extract minute (8 ms)
      ✕ extract hour (7 ms)
      ✕ extract day (9 ms)
      ✕ extract day_of_week (7 ms)
      ✕ first week day is one  (7 ms)
      ✕ extract day_of_year (8 ms)
      ✕ extract week (8 ms)
      ✕ extract month (7 ms)
      ✕ extract quarter (7 ms)
      ✕ extract year (7 ms)
    date truncation
      ✕ date trunc day (9 ms)
      ✕ date trunc week (7 ms)
      ✕ date trunc month (8 ms)
      ✕ date trunc quarter (8 ms)
      ✕ date trunc year (8 ms)
    date extraction
      ✕ date extract day (8 ms)
      ✕ date extract day_of_week (7 ms)
      ✕ date extract day_of_year (7 ms)
      ✕ date extract week (10 ms)
      ✕ date extract month (8 ms)
      ✕ date extract quarter (7 ms)
      ✕ date extract year (8 ms)
    delta computations
      ✕ timestamp delta second (11 ms)
      ✕ timestamp delta negative second (9 ms)
      ✕ timestamp delta minute (14 ms)
      ✕ timestamp delta hours (16 ms)
      ✕ timestamp delta week (14 ms)
      ✕ timestamp delta month (13 ms)
      ✕ timestamp delta quarter (15 ms)
      ✕ timestamp delta year (13 ms)
      ✕ date delta week (8 ms)
      ✕ date delta month (8 ms)
      ✕ date delta quarter (11 ms)
      ✕ date delta year (9 ms)
    for range edge tests
      date
        ✕ before for-range is outside (20 ms)
        ✕ first for-range is inside (7 ms)
        ✕ last for-range is outside (10 ms)
      timestamp
        ✕ before for-range is outside (7 ms)
        ✕ first for-range is inside (7 ms)
        ✕ last for-range is outside (7 ms)
    to range edge tests
      date
        ✕ before to is outside (6 ms)
        ✕ first to is inside (7 ms)
        ✕ last to is outside (7 ms)
      timestamp
        ✕ before to is outside (6 ms)
        ✕ first to is inside (8 ms)
        ✕ last to is outside (7 ms)
    granular time range checks
      ✕ minute implied truncated range (7 ms)
      ✕ day implied truncated range (7 ms)
      ✕ year implied truncated range (7 ms)
      ✕ timestamp in literal minute (7 ms)
      ✕ timestamp in literal day (6 ms)
      ✕ date in literal month (6 ms)
      ✕ timestamp in literal month (6 ms)
      ✕ timestamp in literal year (6 ms)
    timezone set correctly
      ✕ timezone set in source used by query (1537 ms)
      ✕ timezone set in view inside source (39 ms)
      ✕ timezone set in query using source (9 ms)
      ✕ multiple timezones (21 ms)
  redshift: tz literals
    ✕ redshift - default timezone is UTC (6 ms)
    ✕ literal with zone name (6 ms)
  redshift: query tz
    ✕ literal timestamps (6 ms)
    ✕ extract (24 ms)
    ✕ truncate day (1464 ms)
    ✕ cast timestamp to date (13 ms)
    ✕ cast date to timestamp (1476 ms)

  ● redshift date and time › interval measurement › forwards is positive

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › reverse is negative

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › seconds

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › minutes

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › hours

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › days

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › timeDiff passed to a function preserves rhs

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7f42210-8f99-5cd8-926d-39bc04d35e97: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1")
      |              ^

      100 |         run: ${dbName}.sql("SELECT 1")
      101 |         -> { select: yd is floor(days(@2001 to @2002)) }
    > 102 |       `).malloyResultMatches(runtime, {yd: 365});
          |          ^
      103 |       }
      104 |     );
      105 |

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:102:10)

  ● redshift date and time › timestamp truncation › trunc second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc hour

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract hour

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract day_of_week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › first week day is one 

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract day_of_year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract day_of_week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract day_of_year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta negative second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta hours

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › date › before for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › date › first for-range is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › date › last for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › timestamp › before for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › timestamp › first for-range is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › timestamp › last for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › date › before to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › date › first to is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › date › last to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › timestamp › before to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › timestamp › first to is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › timestamp › last to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date in sql_block no explore

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp in sql_block no explore

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › valid timestamp without seconds

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › minute implied truncated range

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › day implied truncated range

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › year implied truncated range

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › date in literal month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › dependant join dialect fragments

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: timeData is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """)
      |                                        ^
    line 3: Reference to undefined object 'timeData'
      |       run: timeData -> {
      |            ^

      482 |         group_by: t_month is joined.t_timestamp.month
      483 |       }
    > 484 |     `).malloyResultMatches(runtime, {t_month: new Date('2021-02-01')});
          |        ^
      485 |   });
      486 |
      487 |   describe('timezone set correctly', () => {

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:484:8)

  ● redshift date and time › timezone set correctly › timezone set in source used by query

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timezone set correctly › timezone set in view inside source

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timezone set correctly › timezone set in query using source

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timezone set correctly › multiple timezones

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql('SELECT 1 as one') extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: tz literals › redshift - default timezone is UTC

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: tz literals › literal with zone name

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: query tz › literal timestamps

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: query tz › extract

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") -> {
      |      ^

      696 |           mex_day is day(utc_midnight)
      697 |       }`
    > 698 |     ).malloyResultMatches(runtime, {mex_midnight: 18, mex_day: 19});
          |       ^
      699 |   });
      700 |
      701 |   test.when(

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:698:7)

  ● redshift: query tz › truncate day

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/f92abcd0-8ea9-5e83-a5fa-491530db5d06: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as x") -> {
      |      ^

      711 |         select: mex_day is utc_midnight.day
      712 |       }`
    > 713 |     ).malloyResultMatches(runtime, {mex_day: mex_19.toJSDate()});
          |       ^
      714 |   });
      715 |
      716 |   test.when(

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:713:7)

  ● redshift: query tz › cast timestamp to date

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/f92abcd0-8ea9-5e83-a5fa-491530db5d06: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as x") -> {
      |      ^

      725 |         select: mex_day is day(utc_midnight::date)
      726 |       }`
    > 727 |     ).malloyResultMatches(runtime, {mex_day: 19});
          |       ^
      728 |   });
      729 |
      730 |   test.when(

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:727:7)

  ● redshift: query tz › cast date to timestamp

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/51afc285-f0fe-5798-a8da-f3e4a167b051: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql(""" SELECT DATE '2020-02-20'  AS "mex_20" """) -> {
      |                   ^
    line 3: 'mex_20' is not defined
      |         select: mex_ts is mex_20::timestamp
      |                           ^

      736 |         select: mex_ts is mex_20::timestamp
      737 |       }`
    > 738 |     ).malloyResultMatches(runtime, {mex_ts: zone_2020.toJSDate()});
          |       ^
      739 |   });
      740 | });
      741 |

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:738:7)

FAIL test/src/databases/all/join.spec.ts (16.726 s)
  redshift
    ✕ model source refine join (3423 ms)
    ✕ model source refine in query join
    ✕ model: join fact table query (1 ms)
    ✕ model: source based on query
    ✕ model: funnel - merge two queries
    ✕ model: modeled funnel
    ✕ model: modeled funnel2
    ✕ model: double_pipe
    ✕ model: unnest is left join
    ✕ All joins at the same level
    ✕ join issue440 (1452 ms)
    ✕ join issue1092 (1549 ms)
    ✕ always join in query (1 ms)
    ✕ not always join in extend
    ✕ always inner join has side effects (in group_by)

  ● redshift › model source refine join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      73 |           aircraft_models.model_count
      74 |       }
    > 75 |     `).malloyResultMatches(joinModel, {model_count: 1416});
         |        ^
      76 |   });
      77 |
      78 |   it('model source refine in query join', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:75:8)

  ● redshift › model source refine in query join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      85 |           aircraft_models.model_count
      86 |       }
    > 87 |     `).malloyResultMatches(joinModel, {model_count: 1416});
         |        ^
      88 |   });
      89 |
      90 |   it('model: join fact table query', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:87:8)

  ● redshift › model: join fact table query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      103 |         limit: 1
      104 |       }
    > 105 |     `).malloyResultMatches(joinModel, {num_models: 1147});
          |        ^
      106 |   });
      107 |
      108 |   it('model: source based on query', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:105:8)

  ● redshift › model: source based on query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      119 |           limit: 1
      120 |         }
    > 121 |     `).malloyResultMatches(joinModel, {num_models: 1147});
          |        ^
      122 |   });
      123 |
      124 |   it('model: funnel - merge two queries', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:121:8)

  ● redshift › model: funnel - merge two queries

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      141 |           limit: 1
      142 |         }
    > 143 |     `).malloyResultMatches(joinModel, {
          |        ^
      144 |       num_models: 1147,
      145 |       total_seats: 252771,
      146 |     });

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:143:8)

  ● redshift › model: modeled funnel

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      159 |         limit: 1
      160 |       }
    > 161 |     `).malloyResultMatches(joinModel, {
          |        ^
      162 |       num_models: 1147,
      163 |       total_seats: 252771,
      164 |     });

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:161:8)

  ● redshift › model: modeled funnel2

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      175 |         limit: 1
      176 |       }
    > 177 |     `).malloyResultMatches(joinModel, {
          |        ^
      178 |       num_models: 1147,
      179 |       total_seats: 252771,
      180 |     });

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:177:8)

  ● redshift › model: double_pipe

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      191 |         select: f_sum2 is f_sum+1
      192 |       }
    > 193 |   `).malloyResultMatches(joinModel, {f_sum2: 60462});
          |      ^
      194 |   });
      195 |
      196 |   test.when(runtime.supportsNesting && runtime.dialect.supportsLeftJoinUnnest)(

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:193:6)

  ● redshift › model: unnest is left join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      219 |           limit: 5
      220 |         }
    > 221 |       `).malloyResultMatches(joinModel, [{}, {}, {}, {}, {}]);
          |          ^
      222 |     }
      223 |   );
      224 |

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:221:10)

  ● redshift › All joins at the same level

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      238 |         limit: 5
      239 |       }
    > 240 |     `).malloyResultMatches(joinModel, [{}, {}, {}, {}, {}]);
          |        ^
      241 |   });
      242 |
      243 |   it('join issue440', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:240:8)

  ● redshift › join issue440

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'tail_num' is not defined
      |         join_one: aircraft on aircraft.tail_num = tail_num
      |                               ^
    line 7: 'tail_num' is not defined
      |         join_one: aircraft on aircraft.tail_num = tail_num
      |                                                   ^
    line 8: 'aircraft_model_code' is not defined
      |         join_one: aircraft_models on aircraft_models.aircraft_model_code = aircraft.aircraft_model_code
      |                                      ^
    line 8: 'aircraft_model_code' is not defined
      |         join_one: aircraft_models on aircraft_models.aircraft_model_code = aircraft.aircraft_model_code
      |                                                                            ^
    line 12: 'model' is not defined
      |         group_by: testingtwo is aircraft_models.model
      |                                 ^
    line 11: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: flights-> {
      |            ^

      256 |         limit: 5
      257 |       }
    > 258 |     `).malloyResultMatches(runtime, [{}, {}, {}, {}, {}]);
          |        ^
      259 |   });
      260 |
      261 |   it('join issue1092', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:258:8)

  ● redshift › join issue1092

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         extend: {join_one: sf is redshift.table('malloytest.state_facts') on sf.state = state}
      |                                                                              ^
    line 3: 'state' is not defined
      |         extend: {join_one: sf is redshift.table('malloytest.state_facts') on sf.state = state}
      |                                                                                         ^
    line 4: Reference to undefined value sf.births
      |         aggregate: x is sf.births.sum() { where:  state = 'CA' }
      |                         ^
    line 4: Filtered expression requires an aggregate computation
      |         aggregate: x is sf.births.sum() { where:  state = 'CA' }
      |                         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      extendSource: [
        {
          type: 'table',
          name: 'sf',
          dialect: 'redshift',
          tablePath: 'malloytest.state_facts',
          connection: 'redshift',
          fields: [
            {
              type: 'string',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'number',
              numberType: 'integer',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'number',
              numberType: 'integer',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'number',
              numberType: 'integer',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'string',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            }
          ],
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 27 },
              end: { line: 2, character: 93 }
            }
          },
          join: 'one',
          matrixOperation: 'left',
          onExpression: { node: 'error', message: 'cascading error' },
          onCompositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      265 |         aggregate: x is sf.births.sum() { where:  state = 'CA' }
      266 |       }
    > 267 |     `).malloyResultMatches(runtime, [{}]);
          |        ^
      268 |   });
      269 |
      270 |   it('always join in query', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:267:8)

  ● redshift › always join in query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      276 |         aggregate: c is count()
      277 |       }
    > 278 |     `).malloyResultMatches(joinModel, {c: 51 * 51});
          |        ^
      279 |   });
      280 |
      281 |   it('not always join in extend', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:278:8)

  ● redshift › not always join in extend

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      289 |         aggregate: c is count()
      290 |       }
    > 291 |     `).malloyResultMatches(joinModel, {c: 51});
          |        ^
      292 |   });
      293 |
      294 |   it('always inner join has side effects (in group_by)', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:291:8)

  ● redshift › always inner join has side effects (in group_by)

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      301 |         aggregate: c is count()
      302 |       }
    > 303 |     `).malloyResultMatches(joinModel, {c: 0});
          |        ^
      304 |   });
      305 | });
      306 |

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:303:8)

FAIL test/src/databases/all/db_index.spec.ts (15.323 s)
  ✕ basic index  - redshift (1632 ms)
  ✕ index value map  - redshift (326 ms)
  ✕ index no sample rows - redshift (1491 ms)
  ✕ index rows count - redshift (19 ms)
  ✕ index rows count - redshift (1472 ms)

  ● basic index  - redshift

    TypeError: Cannot read properties of undefined (reading 'replace')

      109 |
      110 |   sqlMaybeQuoteIdentifier(identifier: string): string {
    > 111 |     return '"' + identifier.replace(/"/g, '""') + '"';
          |                             ^
      112 |   }
      113 | }
      114 |

      at RedshiftDialect.sqlMaybeQuoteIdentifier (packages/malloy/src/dialect/pg_impl.ts:111:29)
      at RedshiftDialect.sqlFieldReference (packages/malloy/src/dialect/redshift/redshift.ts:272:26)
      at QueryStruct.sqlChildReference (packages/malloy/src/model/malloy_query.ts:4499:25)
      at QueryFieldString.generateExpression (packages/malloy/src/model/malloy_query.ts:1417:24)
      at QueryQueryIndexStage.generateSQL (packages/malloy/src/model/malloy_query.ts:4003:33)
      at QueryQueryIndex.generateSQL (packages/malloy/src/model/malloy_query.ts:4197:31)
      at QueryQueryIndex.generateSQLFromPipeline (packages/malloy/src/model/malloy_query.ts:3884:30)
      at QueryModel.loadQuery (packages/malloy/src/model/malloy_query.ts:4978:19)
      at QueryModel.compileQuery (packages/malloy/src/model/malloy_query.ts:5035:19)
      at QueryModel._callee$ (packages/malloy/src/model/malloy_query.ts:5118:21)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at node_modules/@babel/runtime/helpers/asyncToGenerator.js:27:7
      at QueryModel.apply (node_modules/@babel/runtime/helpers/asyncToGenerator.js:19:12)
      at QueryModel.searchIndex (packages/malloy/src/model/malloy_query.ts:5161:4)
      at ModelMaterializer._callee19$ (packages/malloy/src/malloy.ts:2884:29)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● index value map  - redshift

    undefined not found

      4759 |     if (found === undefined) {
      4760 |       const pathErr = path.length > 1 ? ` in ${path.join('.')}` : '';
    > 4761 |       throw new Error(`${notFound} not found${pathErr}`);
           |             ^
      4762 |     }
      4763 |     return found;
      4764 |   }

      at QueryStruct.getFieldByName (packages/malloy/src/model/malloy_query.ts:4761:13)
      at QueryStruct.getQueryFieldByName (packages/malloy/src/model/malloy_query.ts:4768:24)
      at QueryQueryIndexStage.expandField (packages/malloy/src/model/malloy_query.ts:3944:31)
      at QueryQueryIndexStage.expandFields (packages/malloy/src/model/malloy_query.ts:3954:32)
      at QueryQueryIndexStage.prepare (packages/malloy/src/model/malloy_query.ts:2650:12)
      at QueryQueryIndex.generateSQL (packages/malloy/src/model/malloy_query.ts:4196:9)
      at QueryQueryIndex.generateSQLFromPipeline (packages/malloy/src/model/malloy_query.ts:3884:30)
      at QueryModel.loadQuery (packages/malloy/src/model/malloy_query.ts:4978:19)
      at QueryModel.compileQuery (packages/malloy/src/model/malloy_query.ts:5035:19)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1028:40)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● index no sample rows - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |       } -> {index:one, state }
      |                   ^

      94 |       } -> {index:one, state }
      95 |         -> {select: fieldName, weight, fieldValue; order_by: 2 desc; where: fieldName = 'one'}
    > 96 |     `).malloyResultMatches(runtime, {fieldName: 'one', weight: 51});
         |        ^
      97 |   });
      98 |
      99 |   // bigquery doesn't support row count based sampling.

      at Object.<anonymous> (test/src/databases/all/db_index.spec.ts:96:8)

  ● index rows count - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         } -> {index:one, state; sample: 10 }
      |                     ^

      108 |         } -> {index:one, state; sample: 10 }
      109 |             -> {select: fieldName, weight, fieldValue; order_by: 2 desc; where: fieldName = 'one'}
    > 110 |       `).malloyResultMatches(runtime, {fieldName: 'one', weight: 10});
          |          ^
      111 |   });
      112 |
      113 |   it.when(databaseName !== 'trino' && databaseName !== 'presto')(

      at Object.<anonymous> (test/src/databases/all/db_index.spec.ts:110:10)

  ● index rows count - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'tail_num' is not defined
      |       } -> {index:one, tail_num; sample: 50% }
      |                   ^

      119 |       } -> {index:one, tail_num; sample: 50% }
      120 |         -> {select: fieldName, weight, fieldValue; order_by: 2 desc; where: fieldName = 'one'}
    > 121 |     `).malloyResultMatches(runtime, {fieldName: 'one'});
          |        ^
      122 |       // Hard to get consistent results here so just check that we get a value back.
      123 |     }
      124 |   );

      at Object.<anonymous> (test/src/databases/all/db_index.spec.ts:121:8)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmpd18cc32ab0c64942bb1d46d0e0ffbd5d;\n' +
        '      create temp table tmpd18cc32ab0c64942bb1d46d0e0ffbd5d as SELECT * FROM (\n' +
        '        SELECT 1 as "n"\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmpd18cc32ab0c64942bb1d46d0e0ffbd5d';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmpd18cc32ab0c64942bb1d46d0e0ffbd5d;
          create temp table tmpd18cc32ab0c64942bb1d46d0e0ffbd5d as SELECT * FROM (
            SELECT 1 as "n"
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmpd18cc32ab0c64942bb1d46d0e0ffbd5d';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp2760e3c0cd3e43de82f993b2c72d128a;\n' +
        '      create temp table tmp2760e3c0cd3e43de82f993b2c72d128a as SELECT * FROM (\n' +
        '        SELECT 2 as "n"\n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp2760e3c0cd3e43de82f993b2c72d128a';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp2760e3c0cd3e43de82f993b2c72d128a;
          create temp table tmp2760e3c0cd3e43de82f993b2c72d128a as SELECT * FROM (
            SELECT 2 as "n"
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp2760e3c0cd3e43de82f993b2c72d128a';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/lenses.spec.ts (13.728 s)
  ✕ named view plus named view - redshift (1788 ms)
  ✕ named view plus measure - redshift (25 ms)
  ✕ dimension plus named view - redshift (10 ms)
  ✕ where headed - redshift (16 ms)
  ✕ named view plus named view in source - redshift (16 ms)
  ✕ dimension plus named view in source - redshift (6 ms)
  ✕ named view plus dimension in source - redshift (8 ms)
  ✕ literal view plus named view - redshift (9 ms)
  ✕ literal view plus measure - redshift (7 ms)
  ✕ measure plus literal view - redshift (11 ms)
  ✕ literal view plus named view in source - redshift (7 ms)
  ✕ literal view plus measure in source - redshift (8 ms)
  ✕ named view plus literal view - redshift (13 ms)
  ✕ literal view plus literal view - redshift (6 ms)
  ✕ three named views - redshift (13 ms)
  ✕ nested no name - redshift (15 ms)
  ✕ nested with name - redshift (7 ms)
  ✕ nested no name with dimension head - redshift (6 ms)
  ✕ nest dimension only - redshift (6 ms)
  ✕ joined dimension in middle of refinements - redshift (1349 ms)
  ✕ nest joined dimension refined - redshift (16 ms)
  ✕ joined dimension refined - redshift (10 ms)
  ✕ nest joined dimension bare - redshift (8 ms)
  ✕ joined dimension bare - redshift (9 ms)
  ✕ joined dimension nest refinement - redshift (8 ms)
  ✕ nest dimension only in refinement - redshift (11 ms)
  ✕ view dimension only - redshift (5 ms)
  ✕ view join dimension only - redshift (6 ms)
  ✕ run dimension only - redshift (5 ms)
  ✕ copy of view with lens - redshift (7 ms)
  ✕ aggregate copy bug with only old refinement - redshift (12 ms)
  ✕ aggregate copy bug with only old old refinement - redshift (7 ms)
  ✕ but still need to be able to use as output field - redshift (11 ms)
  ✕ aggregate copy bug - redshift (8 ms)
  ○ skipped nest measure only in second stage - redshift
  ○ skipped second stage refinement chain - redshift
  ○ skipped second stage refinement chain in nest - redshift

  ● named view plus named view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> d + m
      |            ^

      45 |       }
      46 |       run: x -> d + m
    > 47 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      48 |   });
      49 |   it(`named view plus measure - ${databaseName}`, async () => {
      50 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:47:8)

  ● named view plus measure - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> d + c
      |            ^

      54 |       }
      55 |       run: x -> d + c
    > 56 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      57 |   });
      58 |   it(`dimension plus named view - ${databaseName}`, async () => {
      59 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:56:8)

  ● dimension plus named view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> n + m
      |            ^

      62 |       }
      63 |       run: x -> n + m
    > 64 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      65 |   });
      66 |   it(`where headed - ${databaseName}`, async () => {
      67 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:64:8)

  ● where headed - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> { where: true } + m
      |            ^

      70 |       }
      71 |       run: x -> { where: true } + m
    > 72 |     `).malloyResultMatches(runtime, {c: 1});
         |        ^
      73 |   });
      74 |   it(`named view plus named view in source - ${databaseName}`, async () => {
      75 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:72:8)

  ● named view plus named view in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 7: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      80 |       }
      81 |       run: x -> y
    > 82 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      83 |   });
      84 |   it(`dimension plus named view in source - ${databaseName}`, async () => {
      85 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:82:8)

  ● dimension plus named view in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is n + m
      |                    ^
    line 4: Named refinements of multi-stage views are not supported
      |         view: y is n + m
      |               ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      89 |       }
      90 |       run: x -> y
    > 91 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      92 |   });
      93 |   it(`named view plus dimension in source - ${databaseName}`, async () => {
      94 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:91:8)

  ● named view plus dimension in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is m + n
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

       98 |       }
       99 |       run: x -> y
    > 100 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      101 |   });
      102 |   it(`literal view plus named view - ${databaseName}`, async () => {
      103 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:100:8)

  ● literal view plus named view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> { group_by: n } + m
      |            ^

      106 |       }
      107 |       run: x -> { group_by: n } + m
    > 108 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      109 |   });
      110 |   it(`literal view plus measure - ${databaseName}`, async () => {
      111 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:108:8)

  ● literal view plus measure - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> { group_by: n } + c
      |            ^

      114 |       }
      115 |       run: x -> { group_by: n } + c
    > 116 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      117 |   });
      118 |   it(`measure plus literal view - ${databaseName}`, async () => {
      119 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:116:8)

  ● measure plus literal view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> c + { group_by: n }
      |            ^

      122 |       }
      123 |       run: x -> c + { group_by: n }
    > 124 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      125 |   });
      126 |   it(`literal view plus named view in source - ${databaseName}`, async () => {
      127 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:124:8)

  ● literal view plus named view in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is { group_by: n } + m
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      131 |       }
      132 |       run: x -> y
    > 133 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      134 |   });
      135 |   it(`literal view plus measure in source - ${databaseName}`, async () => {
      136 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:133:8)

  ● literal view plus measure in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is { group_by: n } + c
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      140 |       }
      141 |       run: x -> y
    > 142 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      143 |   });
      144 |   it(`named view plus literal view - ${databaseName}`, async () => {
      145 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:142:8)

  ● named view plus literal view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 5: Reference to undefined object 'x'
      |       run: x -> d + { aggregate: c is count() }
      |            ^

      148 |       }
      149 |       run: x -> d + { aggregate: c is count() }
    > 150 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      151 |   });
      152 |   it(`literal view plus literal view - ${databaseName}`, async () => {
      153 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:150:8)

  ● literal view plus literal view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"')
      |                    ^
    line 3: Reference to undefined object 'x'
      |       run: x -> { group_by: n } + { aggregate: c is count() }
      |            ^

      154 |       source: x is ${databaseName}.sql('SELECT 1 as ${q`n`}')
      155 |       run: x -> { group_by: n } + { aggregate: c is count() }
    > 156 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      157 |   });
      158 |   it(`three named views - ${databaseName}`, async () => {
      159 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:156:8)

  ● three named views - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d1 is { group_by: n1 is n }
      |                                       ^
    line 4: 'n' is not defined
      |         view: d2 is { group_by: n2 is n }
      |                                       ^
    line 7: Reference to undefined object 'x'
      |       run: x -> d1 + d2 + m
      |            ^

      164 |       }
      165 |       run: x -> d1 + d2 + m
    > 166 |     `).malloyResultMatches(runtime, {n1: 1, n2: 1, c: 1});
          |        ^
      167 |   });
      168 |   it(`nested no name - ${databaseName}`, async () => {
      169 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:166:8)

  ● nested no name - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      175 |         nest: d + m
      176 |       }
    > 177 |     `).malloyResultMatches(runtime, {'d.n': 1, 'd.c': 1});
          |        ^
      178 |   });
      179 |   it(`nested with name - ${databaseName}`, async () => {
      180 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:177:8)

  ● nested with name - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      186 |         nest: y is d + m
      187 |       }
    > 188 |     `).malloyResultMatches(runtime, {'y.n': 1, 'y.c': 1});
          |        ^
      189 |   });
      190 |   it(`nested no name with dimension head - ${databaseName}`, async () => {
      191 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:188:8)

  ● nested no name with dimension head - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      196 |         nest: n + m
      197 |       }
    > 198 |     `).malloyResultMatches(runtime, {'n.n': 1, 'n.c': 1});
          |        ^
      199 |   });
      200 |   it(`nest dimension only - ${databaseName}`, async () => {
      201 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:198:8)

  ● nest dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      206 |         nest: n
      207 |       }
    > 208 |     `).malloyResultMatches(runtime, {'n.n': 1});
          |        ^
      209 |   });
      210 |   it(`joined dimension in middle of refinements - ${databaseName}`, async () => {
      211 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:208:8)

  ● joined dimension in middle of refinements - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> m + y.n + { limit: 1 }
      |            ^

      215 |       }
      216 |       run: x -> m + y.n + { limit: 1 }
    > 217 |     `).malloyResultMatches(runtime, {'n': 2, 'c': 1});
          |        ^
      218 |   });
      219 |   it(`nest joined dimension refined - ${databaseName}`, async () => {
      220 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:217:8)

  ● nest joined dimension refined - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 1 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 1 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      226 |         nest: y.n + { limit: 1 }
      227 |       }
    > 228 |     `).malloyResultMatches(runtime, {'n.n': 1});
          |        ^
      229 |   });
      230 |   it(`joined dimension refined - ${databaseName}`, async () => {
      231 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:228:8)

  ● joined dimension refined - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y.n + { limit: 1 }
      |            ^

      235 |       }
      236 |       run: x -> y.n + { limit: 1 }
    > 237 |     `).malloyResultMatches(runtime, {'n': 2});
          |        ^
      238 |   });
      239 |   it(`nest joined dimension bare - ${databaseName}`, async () => {
      240 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:237:8)

  ● nest joined dimension bare - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      246 |         nest: y.n
      247 |       }
    > 248 |     `).malloyResultMatches(runtime, {'n.n': 2});
          |        ^
      249 |   });
      250 |   it(`joined dimension bare - ${databaseName}`, async () => {
      251 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:248:8)

  ● joined dimension bare - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y.n
      |            ^

      255 |       }
      256 |       run: x -> y.n
    > 257 |     `).malloyResultMatches(runtime, {'n': 2});
          |        ^
      258 |   });
      259 |   it(`joined dimension nest refinement - ${databaseName}`, async () => {
      260 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:257:8)

  ● joined dimension nest refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> { nest: m + y.n }
      |            ^

      264 |       }
      265 |       run: x -> { nest: m + y.n }
    > 266 |     `).malloyResultMatches(runtime, {'m.c': 1, 'm.n': 2});
          |        ^
      267 |   });
      268 |   it.skip(`nest measure only in second stage - ${databaseName}`, async () => {
      269 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:266:8)

  ● nest dimension only in refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> m + {
      |            ^

      284 |         nest: n
      285 |       }
    > 286 |     `).malloyResultMatches(runtime, {'n.n': 1, 'c': 1});
          |        ^
      287 |   });
      288 |   it(`view dimension only - ${databaseName}`, async () => {
      289 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:286:8)

  ● view dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: m is n
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> m
      |            ^

      292 |       }
      293 |       run: x -> m
    > 294 |     `).malloyResultMatches(runtime, {n: 1});
          |        ^
      295 |   });
      296 |   it(`view join dimension only - ${databaseName}`, async () => {
      297 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:294:8)

  ● view join dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 4: 'n' is not defined
      |         view: m is y.n
      |                    ^
    line 6: Reference to undefined object 'x'
      |       run: x -> m
      |            ^

      301 |       }
      302 |       run: x -> m
    > 303 |     `).malloyResultMatches(runtime, {n: 2});
          |        ^
      304 |   });
      305 |   it(`run dimension only - ${databaseName}`, async () => {
      306 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:303:8)

  ● run dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"')
      |                    ^
    line 3: Reference to undefined object 'x'
      |       run: x -> n
      |            ^

      307 |       source: x is ${databaseName}.sql('SELECT 1 as ${q`n`}')
      308 |       run: x -> n
    > 309 |     `).malloyResultMatches(runtime, {n: 1});
          |        ^
      310 |   });
      311 |   it.skip(`second stage refinement chain - ${databaseName}`, async () => {
      312 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:309:8)

  ● copy of view with lens - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: v is { group_by: n } + metrics
      |                                ^
    line 7: Reference to undefined object 'x'
      |       run: x -> v2
      |            ^

      330 |       }
      331 |       run: x -> v2
    > 332 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      333 |   });
      334 |   it(`aggregate copy bug with only old refinement - ${databaseName}`, async () => {
      335 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:332:8)

  ● aggregate copy bug with only old refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> c + {
      |            ^

      340 |         aggregate: e is c { where: false }
      341 |       }
    > 342 |     `).malloyResultMatches(runtime, {c: 1, e: 0});
          |        ^
      343 |   });
      344 |   it(`aggregate copy bug with only old old refinement - ${databaseName}`, async () => {
      345 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:342:8)

  ● aggregate copy bug with only old old refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 6: Reference to undefined object 'x'
      |       run: x -> v + {
      |            ^

      351 |         aggregate: e is c { where: false }
      352 |       }
    > 353 |     `).malloyResultMatches(runtime, {c: 1, e: 0});
          |        ^
      354 |   });
      355 |   it(`but still need to be able to use as output field - ${databaseName}`, async () => {
      356 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:353:8)

  ● but still need to be able to use as output field - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 6: Reference to undefined object 'x'
      |       run: x -> v + {
      |            ^

      362 |         calculate: e is lag(c)
      363 |       }
    > 364 |     `).malloyResultMatches(runtime, {c: 1, e: null});
          |        ^
      365 |   });
      366 |   it(`aggregate copy bug - ${databaseName}`, async () => {
      367 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:364:8)

  ● aggregate copy bug - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> n + c + {
      |            ^

      372 |         aggregate: e is c { where: false }
      373 |       }
    > 374 |     `).malloyResultMatches(runtime, {n: 1, c: 1, e: 0});
          |        ^
      375 |   });
      376 | });
      377 |

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:374:8)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      '\n' +
        '      drop table if exists tmp84de8f98313f4c58933739e06f55c136;\n' +
        '      create temp table tmp84de8f98313f4c58933739e06f55c136 as SELECT * FROM (\n' +
        '        SELECT 1 as "one" \n' +
        '      ) as x where false;\n' +
        '      SELECT column_name, c.data_type, e.data_type as element_type\n' +
        '      FROM information_schema.columns c LEFT JOIN information_schema.element_types e\n' +
        "        ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)\n" +
        '          = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))\n' +
        "      where table_name='tmp84de8f98313f4c58933739e06f55c136';\n" +
        '    '
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     
          drop table if exists tmp84de8f98313f4c58933739e06f55c136;
          create temp table tmp84de8f98313f4c58933739e06f55c136 as SELECT * FROM (
            SELECT 1 as "one" 
          ) as x where false;
          SELECT column_name, c.data_type, e.data_type as element_type
          FROM information_schema.columns c LEFT JOIN information_schema.element_types e
            ON ((c.table_catalog, c.table_schema, c.table_name, 'TABLE', c.dtd_identifier)
              = (e.object_catalog, e.object_schema, e.object_name, e.object_type, e.collection_type_identifier))
          where table_name='tmp84de8f98313f4c58933739e06f55c136';

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/sql_expressions.spec.ts (13.594 s)
  ✕ sql expression with turducken - redshift (1828 ms)
  ✕ sql expression in second of two queries in same block, dependent on first query - redshift (51 ms)
  ✕ sql expression in other sql expression - redshift (1386 ms)
  ✕ run sql expression as query - redshift (11 ms)

  ● sql expression with turducken - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 23 },
              end: { line: 4, character: 35 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |           redshift.table('malloytest.state_facts') -> {
      |           ^
    line 3: Invalid SQL, Error: Redefinition of undefined
      |         """SELECT * FROM (%{
      |         ^

      47 |         }) AS state_facts """
      48 |       ) -> { select: * }
    > 49 |     `).malloyResultMatches(runtime, {c: 51});
         |        ^
      50 |   });
      51 |   it(`sql expression in second of two queries in same block, dependent on first query - ${databaseName}`, async () => {
      52 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:49:8)

  ● sql expression in second of two queries in same block, dependent on first query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |         a is redshift.table('malloytest.state_facts') -> {
      |              ^
    line 7: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |           """SELECT * FROM (%{ a -> { select: * } }) AS state_facts """
      |                                ^
    line 7: Invalid SQL, Error: Redefinition of undefined
      |           """SELECT * FROM (%{ a -> { select: * } }) AS state_facts """
      |           ^

      59 |         ) -> { select: * }
      60 |       run: b
    > 61 |     `).malloyResultMatches(runtime, {c: 51});
         |        ^
      62 |   });
      63 |   it(`sql expression in other sql expression - ${databaseName}`, async () => {
      64 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:61:8)

  ● sql expression in other sql expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: Invalid SQL, Error fetching SELECTschema for sql://redshift/48724aa7-019f-58ec-95f8-f2869d7db6a5: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           redshift.sql("""SELECT 1 as "one" """) -> { group_by: one }
      |                        ^
    line 4: 'one' is not defined
      |           redshift.sql("""SELECT 1 as "one" """) -> { group_by: one }
      |                                                                 ^
    line 2: Invalid SQL, Error: Unknown Dialect ~malformed~
      |       run: redshift.sql("""
      |                         ^
    line 6: 'one' is not defined
      |       """) -> { group_by: one }
      |                           ^

      68 |         }) as the_table
      69 |       """) -> { group_by: one }
    > 70 |     `).malloyResultMatches(runtime, {one: 1});
         |        ^
      71 |   });
      72 |   it(`run sql expression as query - ${databaseName}`, async () => {
      73 |     await expect(

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:70:8)

  ● run sql expression as query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/48724aa7-019f-58ec-95f8-f2869d7db6a5: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""SELECT 1 as "one" """)
      |                   ^

      73 |     await expect(
      74 |       `run: ${databaseName}.sql("""SELECT 1 as ${q`one`} """)`
    > 75 |     ).malloyResultMatches(runtime, {one: 1});
         |       ^
      76 |   });
      77 | });
      78 |

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:75:7)

FAIL test/src/databases/all/composite_sources.spec.ts (12.751 s)
  redshift
    ✕ basic composite usage (1976 ms)
    ✕ composite usage multistage (47 ms)
    ✕ composite view multistage (22 ms)
    ✕ composite source used in join (48 ms)
    ✕ composite field from joined source used in join on (16 ms)
    ✕ composite field from joining source used in join on (19 ms)
    ✕ query against composite resolves nested composite source even when no composite fields (10 ms)
    ✕ composite field used in view (8 ms)
    ✕ composite field used in view refined with scalar (22 ms)
    ✕ composite field used in view refined with literal view (18 ms)
    ✕ composite field used in refined query (24 ms)
    ✕ composite of a composite (28 ms)
    ✕ definitions from composite extension carry through (9 ms)
    ✕ filters from composite extension carry through (8 ms)
    ✕ composite of a composite where greedy is bad- redshift (11 ms)
    ✕ composite with parameters (19 ms)
    ✕ issue where measure defined on composite source has the wrong structPath (12 ms)
    ✕ issue where query against composite source with no composite field usage does not resolve the source (7 ms)
    ✕ reference composite field in nest (14 ms)
    ✕ composite with select * (10 ms)
    ✕ composite with each (14 ms)
    ✕ complex nesting composite without join (10 ms)
    ✕ complex nesting composite with join -- literal view (11 ms)
    ✕ complex nesting composite with join -- double extend to define view (11 ms)
    ✕ complex nesting composite with join -- defined view (11 ms)
    index queries against composite sources
      ✕ index query selects second input (8 ms)
      ✕ index query selects first input (6 ms)
      ✕ index query resolves when two stages (9 ms)

  ● redshift › basic composite usage

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:25:8)

  ● redshift › composite usage multistage

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:33:8)

  ● redshift › composite view multistage

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:43:8)

  ● redshift › composite source used in join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 6: 'state' is not defined
      |         join_one: x on x.state = state
      |                        ^
    line 6: 'state' is not defined
      |         join_one: x on x.state = state
      |                                  ^

      52 |       }
      53 |       run: y -> { group_by: x.foo }
    > 54 |     `).malloyResultMatches(runtime, {foo: 1});
         |        ^
      55 |   });
      56 |   it('composite field from joined source used in join on', async () => {
      57 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:54:8)

  ● redshift › composite field from joined source used in join on

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |       source: x is compose(state_facts, state_facts extend { dimension: state_copy is state })
      |                                                                                       ^
    line 11: 'state' is not defined
      |       run: y -> { group_by: ca.state; where: state = 'IL' }
      |                                              ^
    line 11: 'state' is not defined
      |       run: y -> { group_by: ca.state; where: state = 'IL' }
      |                             ^
    line 11: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [
        {
          node: 'filterCondition',
          code: "state = 'IL'",
          e: { node: 'error', message: 'cascading error' },
          expressionType: 'scalar',
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: y -> { group_by: ca.state; where: state = 'IL' }
      |            ^

      66 |       }
      67 |       run: y -> { group_by: ca.state; where: state = 'IL' }
    > 68 |     `).malloyResultMatches(runtime, {state: 'CA'});
         |        ^
      69 |   });
      70 |   it('composite field from joining source used in join on', async () => {
      71 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:68:8)

  ● redshift › composite field from joining source used in join on

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 14: 'state' is not defined
      |         join_one: state_facts on state_one = state_facts.state
      |                                              ^
    line 16: 'state' is not defined
      |       run: x -> { group_by: state_facts.state }
      |                             ^
    line 16: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> { group_by: state_facts.state }
      |            ^

      85 |       }
      86 |       run: x -> { group_by: state_facts.state }
    > 87 |     `).malloyResultMatches(runtime, {state: 'CA'});
         |        ^
      88 |   });
      89 |   it('query against composite resolves nested composite source even when no composite fields', async () => {
      90 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:87:8)

  ● redshift › query against composite resolves nested composite source even when no composite fields

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:103:8)

  ● redshift › composite field used in view

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:114:8)

  ● redshift › composite field used in view refined with scalar

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |           where: state = 'CA'
      |                  ^
    line 6: 'state' is not defined
      |           group_by: state
      |                     ^

      126 |       }
      127 |       run: x -> v + foo
    > 128 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      129 |   });
      130 |   it('composite field used in view refined with literal view', async () => {
      131 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:128:8)

  ● redshift › composite field used in view refined with literal view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |           where: state = 'CA'
      |                  ^
    line 6: 'state' is not defined
      |           group_by: state
      |                     ^

      140 |       }
      141 |       run: x -> v + { group_by: foo }
    > 142 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      143 |   });
      144 |   it('composite field used in refined query', async () => {
      145 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:142:8)

  ● redshift › composite field used in refined query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |           where: state = 'CA'
      |                  ^
    line 6: 'state' is not defined
      |           group_by: state
      |                     ^

      155 |       query: v is x -> v
      156 |       run: v + { group_by: foo }
    > 157 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      158 |   });
      159 |   it('composite of a composite', async () => {
      160 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:157:8)

  ● redshift › composite of a composite

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:174:8)

  ● redshift › definitions from composite extension carry through

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:187:8)

  ● redshift › filters from composite extension carry through

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 8: 'state' is not defined
      |         where: state = 'CA'
      |                ^
    line 10: 'state' is not defined
      |       run: x -> { group_by: foo, state }
      |                                  ^

      198 |       }
      199 |       run: x -> { group_by: foo, state }
    > 200 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      201 |   });
      202 |   it(`composite of a composite where greedy is bad- ${databaseName}`, async () => {
      203 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:200:8)

  ● redshift › composite of a composite where greedy is bad- redshift

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:217:8)

  ● redshift › composite with parameters

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:228:8)

  ● redshift › issue where measure defined on composite source has the wrong structPath

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: Reference to undefined value airport_count
      |         measure: total_airport_count is airport_count.sum()
      |                                         ^
    line 8: 'state' is not defined
      |         where: state = 'CA'
      |                ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: total_airport_count
      |                    ^

      238 |         where: state = 'CA'
      239 |       }
    > 240 |     `).malloyResultMatches(runtime, {total_airport_count: 984});
          |        ^
      241 |   });
      242 |   it('issue where query against composite source with no composite field usage does not resolve the source', async () => {
      243 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:240:8)

  ● redshift › issue where query against composite source with no composite field usage does not resolve the source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: Reference to undefined value airport_count
      |         measure: total_airport_count is airport_count.sum()
      |                                         ^

      249 |         group_by: x is 1
      250 |       }
    > 251 |     `).malloyResultMatches(runtime, {x: 1});
          |        ^
      252 |   });
      253 |   it('reference composite field in nest', async () => {
      254 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:251:8)

  ● redshift › reference composite field in nest

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:262:8)

  ● redshift › composite with select *

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:272:8)

  ● redshift › composite with each

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:285:8)

  ● redshift › complex nesting composite without join

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:306:8)

  ● redshift › complex nesting composite with join -- literal view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 15: 'state' is not defined
      |         join_one: state_facts on the_state = state_facts.state
      |                                              ^
    line 17: 'state' is not defined
      |       run: x -> { group_by: state_facts.state }
      |                             ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> { group_by: state_facts.state }
      |            ^

      324 |       }
      325 |       run: x -> { group_by: state_facts.state }
    > 326 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      327 |   });
      328 |   it('complex nesting composite with join -- double extend to define view', async () => {
      329 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:326:8)

  ● redshift › complex nesting composite with join -- double extend to define view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 15: 'state' is not defined
      |         join_one: state_facts on the_state = state_facts.state
      |                                              ^
    line 17: 'state' is not defined
      |         view: y is { group_by: state_facts.state }
      |                                ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         view: y is { group_by: state_facts.state }
      |               ^
    line 19: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> y
      |                 ^

      346 |       }
      347 |       run: x -> y
    > 348 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      349 |   });
      350 |   it('complex nesting composite with join -- defined view', async () => {
      351 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:348:8)

  ● redshift › complex nesting composite with join -- defined view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 15: 'state' is not defined
      |         join_one: state_facts on the_state = state_facts.state
      |                                              ^
    line 17: 'state' is not defined
      |         view: y is { group_by: state_facts.state }
      |                                ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         view: y is { group_by: state_facts.state }
      |               ^
    line 19: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> y
      |                 ^

      368 |       }
      369 |       run: x -> y
    > 370 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      371 |   });
      372 |   describe('index queries against composite sources', () => {
      373 |     it('index query selects second input', async () => {

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:370:8)

  ● redshift › index queries against composite sources › index query selects second input

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:381:10)

  ● redshift › index queries against composite sources › index query selects first input

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:391:10)

  ● redshift › index queries against composite sources › index query resolves when two stages

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:401:10)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     1+1 as "param_plus_one"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         1+1 as "param_plus_one"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     1 + 1 as "param_plus_one"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         1 + 1 as "param_plus_one"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     1 as "p"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         1 as "p"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     10 as "param_value"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         10 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     11 as "param_value"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         11 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     11 as "param_value"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         11 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT\n' +
        '    group_set,\n' +
        '    10 as "param_value_1__0",\n' +
        '    10 as "param_value_2__0",\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      10\n' +
        '      END as "param_value_1__1",\n' +
        '    CASE WHEN group_set=1 THEN\n' +
        '      10\n' +
        '      END as "param_value_3__1"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n' +
        '  GROUP BY 1,2,3,4,5\n' +
        ')\n' +
        ', __stage1 AS (\n' +
        '  SELECT\n' +
        '    "param_value_1__0" as "param_value_1",\n' +
        '    "param_value_2__0" as "param_value_2",\n' +
        '    COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n' +
        '      "param_value_1__1"::DOUBLE PRECISION as "param_value_1", \n' +
        '      "param_value_3__1"::DOUBLE PRECISION as "param_value_3"\n' +
        `      ) as __x)  ORDER BY  "param_value_1__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "n"\n` +
        '  FROM __stage0\n' +
        '  GROUP BY 1,2\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        10 as "param_value_1__0",
        10 as "param_value_2__0",
        CASE WHEN group_set=1 THEN
          10
          END as "param_value_1__1",
        CASE WHEN group_set=1 THEN
          10
          END as "param_value_3__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3,4,5
    )
    , __stage1 AS (
      SELECT
        "param_value_1__0" as "param_value_1",
        "param_value_2__0" as "param_value_2",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
          "param_value_1__1"::DOUBLE PRECISION as "param_value_1", 
          "param_value_3__1"::DOUBLE PRECISION as "param_value_3"
          ) as __x)  ORDER BY  "param_value_1__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "n"
      FROM __stage0
      GROUP BY 1,2
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     1 as "param_value"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        ')\n' +
        ', __stage1 AS (\n' +
        '  SELECT \n' +
        '     base."param_value" as "param_value"\n' +
        '  FROM __stage0 as base\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         1 as "param_value"
      FROM "malloytest"."state_facts" as base
    )
    , __stage1 AS (
      SELECT 
         base."param_value" as "param_value"
      FROM __stage0 as base
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        `     EXTRACT(day FROM DATE_TRUNC('month', DATE '2024-04-11')) as "date_value"\n` +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         EXTRACT(day FROM DATE_TRUNC('month', DATE '2024-04-11')) as "date_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     10 as "param_value"\n' +
        '  FROM "malloytest"."state_facts" as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         10 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/parameters.spec.ts (26.4 s)
  ✕ number param used in dimension - redshift (3487 ms)
  ✕ number param used in sql function - redshift (1336 ms)
  ✕ can pass param into joined source correctly - redshift (95 ms)
  ✕ can pass param into extended source - redshift (1425 ms)
  ✕ can shadow field that is excepted - redshift (23 ms)
  ✕ default value propagates - redshift (1316 ms)
  ✕ default value can be overridden - redshift (1382 ms)
  ✕ default value passed through extension propagates - redshift (1384 ms)
  ✕ use parameter in nested view - redshift (1411 ms)
  ✕ can use param in join on - redshift (22 ms)
  ✕ can use param in join with - redshift (20 ms)
  ✕ source arguments in query propagate when turned into source - redshift (1475 ms)
  ✕ date parameters keep granularity when passing in - redshift (1371 ms)
  ✕ can use parameter in null check - redshift (29 ms)
  ✕ default value not passed through extension propagates - redshift (1332 ms)
  ○ skipped string param used in group_by - redshift
  ○ skipped reference field in source in argument - redshift
  ○ skipped can use dimension that uses field that is excepted - redshift
  ○ skipped can shadow field that is excepted, using dimension that uses field that is excepted - redshift
  ○ skipped can pass param into joined source from query - redshift
  ○ skipped can pass param into query definition - redshift

  ● number param used in dimension - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1+1 as "param_plus_one"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:26:8)

  ● number param used in sql function - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1 + 1 as "param_plus_one"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:35:8)

  ● can pass param into joined source correctly - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 6: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 12: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 19: 'state' is not defined
      |           s1 is state,
      |                 ^
    line 20: 'state' is not defined
      |           s2 is state_facts.state
      |                 ^

      76 |         aggregate: c is count()
      77 |       }
    > 78 |     `).malloyResultMatches(runtime, {s1: 'CA', s2: 'CA', c: 1});
         |        ^
      79 |   });
      80 |   it(`can pass param into extended source - ${databaseName}`, async () => {
      81 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:78:8)

  ● can pass param into extended source - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1 as "p"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:88:8)

  ● can shadow field that is excepted - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: Illegal `except:` of parameter
      |           except: state
      |                   ^

      149 |         }
      150 |       `
    > 151 |     ).malloyResultMatches(runtime, {hardcoded_state: 'NOT A STATE'});
          |       ^
      152 |   });
      153 |   it(`default value propagates - ${databaseName}`, async () => {
      154 |     await expect(

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:151:7)

  ● default value propagates - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         10 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:162:7)

  ● default value can be overridden - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         11 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:173:7)

  ● default value passed through extension propagates - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         11 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:185:7)

  ● use parameter in nested view - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        10 as "param_value_1__0",
        10 as "param_value_2__0",
        CASE WHEN group_set=1 THEN
          10
          END as "param_value_1__1",
        CASE WHEN group_set=1 THEN
          10
          END as "param_value_3__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3,4,5
    )
    , __stage1 AS (
      SELECT
        "param_value_1__0" as "param_value_1",
        "param_value_2__0" as "param_value_2",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
          "param_value_1__1"::DOUBLE PRECISION as "param_value_1", 
          "param_value_3__1"::DOUBLE PRECISION as "param_value_3"
          ) as __x)  ORDER BY  "param_value_1__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "n"
      FROM __stage0
      GROUP BY 1,2
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:204:7)

  ● can use param in join on - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 10: 'state' is not defined
      |         join_many: state_facts on state_facts.state = state_filter
      |                                   ^
    line 8: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 15: 'state' is not defined
      |           s1 is state,
      |                 ^
    line 16: 'state' is not defined
      |           s2 is state_facts.state
      |                 ^
    line 13: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 16, character: 19 },
              end: { line: 16, character: 31 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |       run: state_facts2(state_filter is "CA") -> {
      |            ^

      269 |         aggregate: c is count()
      270 |       }
    > 271 |     `).malloyResultMatches(runtime, {s1: 'CA', s2: 'CA', c: 1});
          |        ^
      272 |   });
      273 |   it(`can use param in join with - ${databaseName}`, async () => {
      274 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:271:8)

  ● can use param in join with - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         primary_key: state
      |         ^
    line 12: join_one: Primary key 'undefined' not found in source
      |         join_one: state_facts with state_filter
      |                   ^
    line 10: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 17: 'state' is not defined
      |           s1 is state,
      |                 ^
    line 18: 'state' is not defined
      |           s2 is state_facts.state
      |                 ^

      292 |         aggregate: c is count()
      293 |       }
    > 294 |     `).malloyResultMatches(runtime, {s1: 'CA', s2: 'CA', c: 1});
          |        ^
      295 |   });
      296 |   it(`source arguments in query propagate when turned into source - ${databaseName}`, async () => {
      297 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:294:8)

  ● source arguments in query propagate when turned into source - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1 as "param_value"
      FROM "malloytest"."state_facts" as base
    )
    , __stage1 AS (
      SELECT 
         base."param_value" as "param_value"
      FROM __stage0 as base
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:305:8)

  ● date parameters keep granularity when passing in - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         EXTRACT(day FROM DATE_TRUNC('month', DATE '2024-04-11')) as "date_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:314:8)

  ● can use parameter in null check - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |         where: param is null and state = state_filter
      |                                  ^
    line 9: 'state' is not defined
      |       run: state_facts -> { group_by: state }
      |                                       ^

      324 |       }
      325 |       run: state_facts -> { group_by: state }
    > 326 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      327 |   });
      328 |   it(`default value not passed through extension propagates - ${databaseName}`, async () => {
      329 |     await expect(

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:326:8)

  ● default value not passed through extension propagates - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         10 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:338:7)

PASS test/src/databases/all/problems.spec.ts (12.126 s)
  warnings
    ✓ can appear after errors - redshift (1772 ms)
    ✓ can appear before errors - redshift (16 ms)
    ✓ can appear alone - redshift (8 ms)

  console.log
    Batch query failed with status: FAILED

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:349:17)

  console.log
    Error executing Redshift batch query: Error: Batch query did not finish successfully. Status: FAILED
        at _callee10$ (/Users/brian/Documents/repos/malloy/packages/malloy-db-redshift/src/redshift_connection.ts:350:15)
        at tryCatch (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
        at Generator.<anonymous> (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
        at Generator.next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
        at asyncGeneratorStep (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
        at _next (/Users/brian/Documents/repos/malloy/node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:378:15)

  console.log
    SQL that caused error: [
      'SET search_path TO malloytest;',
      'WITH __stage0 AS (\n' +
        '  SELECT \n' +
        '     COUNT(1) as "fetch"\n' +
        '  FROM "malloytest"."aircraft_models" as base\n' +
        ')\n' +
        ', __stage1 AS (\n' +
        '  SELECT \n' +
        '     base."fetch" as "fetch"\n' +
        '  FROM __stage0 as base\n' +
        '  GROUP BY 1\n' +
        '  ORDER BY 1 asc NULLS LAST\n' +
        ')\n' +
        'SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage'
    ]

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:379:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT 
         COUNT(1) as "fetch"
      FROM "malloytest"."aircraft_models" as base
    )
    , __stage1 AS (
      SELECT 
         base."fetch" as "fetch"
      FROM __stage0 as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/orderby.spec.ts (18.275 s)
  redshift
    ✕ boolean type - redshift (2090 ms)
    ✕ boolean in pipeline - redshift (29 ms)
    ✕ filtered measures in model are aggregates #352 - redshift (11 ms)
    ✕ reserved words are quoted - redshift (1395 ms)
    ✕ reserved words are quoted in turtles - redshift (1480 ms)
    ✕ aggregate and scalar conditions - redshift (18 ms)
    ✕ modeled having simple - redshift (18 ms)
    ✕ modeled having complex - redshift (20 ms)
    ✕ turtle references joined element - redshift (2925 ms)
    ○ skipped reserved words in structure definitions

  ● redshift › boolean type - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'seats' is not defined
      |         group_by: big is seats >=20
      |                          ^

      45 |         aggregate: model_count is count()
      46 |       }
    > 47 |     `).malloyResultMatches(orderByModel, {
         |        ^
      48 |       big: booleanResult(false, databaseName),
      49 |       model_count: 58451,
      50 |     });

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:47:8)

  ● redshift › boolean in pipeline - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'manufacturer' is not defined
      |           manufacturer,
      |           ^
    line 5: 'seats' is not defined
      |           big is seats >=21
      |                  ^

      62 |         aggregate: model_count is model_count.sum()
      63 |       }
    > 64 |     `).malloyResultMatches(orderByModel, {
         |        ^
      65 |       big: booleanResult(false, databaseName),
      66 |       model_count: 58500,
      67 |     });

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:64:8)

  ● redshift › filtered measures in model are aggregates #352 - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'manufacturer' is not defined
      |         aggregate: j_names is model_count {where: manufacturer ~ 'J%'}
      |                                                   ^

      75 |         group_by: j_names
      76 |       }
    > 77 |     `).malloyResultMatches(orderByModel, {j_names: 1358});
         |        ^
      78 |   });
      79 |
      80 |   it(`reserved words are quoted - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:77:8)

  ● redshift › reserved words are quoted - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         COUNT(1) as "fetch"
      FROM "malloytest"."aircraft_models" as base
    )
    , __stage1 AS (
      SELECT 
         base."fetch" as "fetch"
      FROM __stage0 as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:87:8)

  ● redshift › reserved words are quoted in turtles - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'popular_name' is not defined
      |           group_by: select is upper(popular_name)
      |                                     ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'turtle',
          name: 'withx',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'string',
                  name: 'select',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 3, character: 20 },
                      end: { line: 3, character: 49 }
                    }
                  },
                  e: {
                    node: 'function_call',
                    overload: {
                      returnType: {
                        type: 'string',
                        expressionType: 'scalar',
                        evalSpace: 'input'
                      },
                      params: [
                        {
                          name: 'value',
                          allowedTypes: [
                            {
                              type: 'string',
                              expressionType: undefined,
                              evalSpace: 'input'
                            }
                          ],
                          isVariadic: false
                        }
                      ],
                      dialect: {
                        postgres: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        standardsql: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        duckdb: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        snowflake: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        trino: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        presto: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        mysql: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        databricks: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        redshift: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        }
                      },
                      supportsOrderBy: undefined,
                      supportsLimit: undefined,
                      genericTypes: undefined,
                      isSymmetric: undefined
                    },
                    name: 'upper',
                    kids: {
                      args: [
                        {
                          node: 'error',
                          message: 'field-not-found'
                        }
                      ]
                    },
                    expressionType: 'scalar',
                    structPath: undefined
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'scalar',
                  code: 'upper(popular_name)'
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'fetch',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 4, character: 21 },
                      end: { line: 4, character: 37 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'fetch', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 14 },
              end: { line: 5, character: 9 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts')->{
      |            ^
    line 9: 'withx' is not defined
      |           withxz is lower(withx.select)
      |                           ^
    line 10: 'withx' is not defined
      |           fetch is withx.fetch
      |                    ^

      102 |           fetch is withx.fetch
      103 |       }
    > 104 |     `).malloyResultMatches(orderByModel, {});
          |        ^
      105 |     }
      106 |   );
      107 |

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:104:8)

  ● redshift › aggregate and scalar conditions - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'manufacturer' is not defined
      |         aggregate: model_count is count(){ where: manufacturer ? ~'A%' }
      |                                                   ^

      125 |         aggregate: model_count is count(){ where: manufacturer ? ~'A%' }
      126 |       }
    > 127 |     `).malloyResultMatches(orderByModel, {});
          |        ^
      128 |   });
      129 |
      130 |   // I'm not sure I have the syntax right here...

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:127:8)

  ● redshift › modeled having simple - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'manufacturer' is not defined
      |         group_by: manufacturer
      |                   ^
    line 9: 'manufacturer' is not defined
      |         select: manufacturer, model_count
      |                 ^

      140 |         select: manufacturer, model_count
      141 |       }
    > 142 |     `).malloyResultMatches(orderByModel, {model_count: 102});
          |        ^
      143 |   });
      144 |
      145 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:142:8)

  ● redshift › modeled having complex - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'manufacturer' is not defined
      |           group_by: manufacturer
      |                     ^
    line 8: 'manufacturer' is not defined
      |             group_by: manufacturer
      |                       ^
    line 14: 'manufacturer' is not defined
      |           select: manufacturer, model_count
      |                   ^

      161 |           select: manufacturer, model_count
      162 |         }
    > 163 |       `).malloyResultMatches(orderByModel, {model_count: 102});
          |          ^
      164 |     }
      165 |   );
      166 |

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:163:10)

  ● redshift › turtle references joined element - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'tail_num' is not defined
      |         primary_key: tail_num
      |         ^
    line 8: 'id2' is not defined
      |         primary_key: id2
      |         ^
    line 9: 'tail_num' is not defined
      |         join_one: a with tail_num
      |                          ^
    line 9: join_one: Primary key 'undefined' not found in source
      |         join_one: a with tail_num
      |                   ^
    line 13: 'carrier' is not defined
      |           group_by: carrier
      |                     ^
    line 12: INTERNAL ERROR model/Segment.nextStructDef: tail_num not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        { type: 'fieldref', path: [ 'flight_count' ] },
        { type: 'fieldref', path: [ 'a', 'aircraft_count' ] }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: { a: { fields: [], joinedUsage: {} } }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'flight_count', dir: 'desc' } ]
    }
      |         view: foo is {
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: tail_num not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        { type: 'fieldref', path: [ 'flight_count' ] },
        { type: 'fieldref', path: [ 'a', 'aircraft_count' ] }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: { a: { fields: [], joinedUsage: {} } }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'flight_count', dir: 'desc' } ]
    }
      |       } -> foo
      |            ^

      183 |         }
      184 |       } -> foo
    > 185 |     `).malloyResultMatches(orderByModel, {});
          |        ^
      186 |   });
      187 | });
      188 |

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:185:8)

PASS test/src/core/dependencies.spec.ts (15.277 s)
  dependencies
    ✓ typescript references should not be circular (2312 ms)
    ✓ javascript references should not be circular (12466 ms)
    ○ skipped malloy/src/lang typescript should not be circular
    ○ skipped malloy-render/src typescript should not be circular

PASS packages/malloy/src/lang/test/expressions.spec.ts
  expressions
    ✓ field name (2 ms)
    ✓ function call (2 ms)
    ✓ raw function call codegen (3 ms)
    ✓ filtered measure (4 ms)
    ✓ filtered ungrouped aggregate (24 ms)
    ✓ correctly flags filtered scalar (1 ms)
    ✓ correctly flags filtered analytic (3 ms)
    ✓ can use calculate with partition by in select (30 ms)
    ✓ paren and applied div (1 ms)
    ✓ Can compare field ats (type timestamp) to NULL (2 ms)
    ✓ Can compare field ad (type date) to NULL (1 ms)
    ✓ Can compare field ai (type number) to NULL (1 ms)
    ✓ Can compare field astr (type string) to NULL (1 ms)
    ✓ Can compare field abool (type boolean) to NULL
    timeframes
      ✓ timestamp truncate second (171 ms)
      ✓ date truncate week (3 ms)
      ✓ timestamp difference - second (9 ms)
      ✓ timestamp difference - second (2 ms)
    operators
      ✓ addition (2 ms)
      ✓ typecheck addition lhs (2 ms)
      ✓ typecheck addition rhs (2 ms)
      ✓ subtraction (2 ms)
      ✓ multiplication (3 ms)
      ✓ mod (2 ms)
      ✓ division (2 ms)
      ✓ unary negation (1 ms)
      ✓ equal (6 ms)
      ✓ not equal (1 ms)
      ✓ greater than (2 ms)
      ✓ greater than or equal (2 ms)
      ✓ less than or equal (2 ms)
      ✓ less than (1 ms)
      ✓ match (2 ms)
      ✓ not match (2 ms)
      ✓ regexp-match (6 ms)
      ✓ not regexp-match (1 ms)
      ✓ apply as equality (3 ms)
      ✓ not (5 ms)
      ✓ and (2 ms)
      ✓ or (4 ms)
      ✓ null-check (??) (5 ms)
      ✓ normal is-null (1 ms)
      ✓ normal is-not-null (1 ms)
      ✓ apply is-null (1 ms)
      ✓ apply is-not-null (1 ms)
      ✓ coalesce type mismatch (1 ms)
      ✓ disallow date OP number (2 ms)
      ✓ disallow date OP timestamp (3 ms)
      ✓ disallow interval from date to timestamp (1 ms)
      ✓ compare to truncation uses straight comparison (2 ms)
      ✓ compare to granular result expression uses straight comparison (3 ms)
      ✓ apply granular-truncation uses range (2 ms)
      ✓ apply granular-literal alternation uses all literals for range (1 ms)
      ✓ apply followed by another condition (1 ms)
      ✓ apply followed by another condition, with parenthesis (3 ms)
      ✓ apply or-tree granular-literal doesnt turn into IN (3 ms)
      ✓ comparison promotes date literal to timestamp (1 ms)
      ✓ can apply range to date (10 ms)
      ✓ disallow date delta second (8 ms)
      ✓ disallow date delta minute (11 ms)
      ✓ disallow date delta hour (7 ms)
      ✓ apply with parens (2 ms)
      sql friendly warnings
        ✓ = null with warning (2 ms)
        ✓ is not null with warning (2 ms)
        ✓ like with warning (6 ms)
        ✓ NOT LIKE with warning (2 ms)
        ✓ x is expr y is not null (11 ms)
        ✓ not null::number (2 ms)
        ✓ (not null)::number (5 ms)
    expr props
      ✓ aggregate order by not allowed without experiments enabled (4 ms)
      ✓ aggregate limit not allowed without experiments enabled (3 ms)
      ✓ aggregate order_by not allowed with different experiment enabled (3 ms)
      ✓ aggregate limit not allowed with different experiment enabled (6 ms)
      ✓ props not allowed on most expressions (4 ms)
      ✓ analytics can take parititon_by and order_by (3 ms)
      ✓ partition by works with scalar and aggregate (3 ms)
      ✓ partition by fails with analytic and ungrouped aggregate (3 ms)
      ✓ analytics order_by requires expression (3 ms)
      ✓ string_agg_distinct order by cannot specify expression (3 ms)
      ✓ string_agg_distinct order by can be just direction (2 ms)
      ✓ string_agg order by can be just direction (2 ms)
      ✓ can specify multiple partition_bys (22 ms)
      ✓ can specify multiple order_bys (3 ms)
      ✓ aggregate order by cannot be aggregate (3 ms)
      ✓ aggregate order by cannot be analytic (2 ms)
      ✓ analytic order by can be an aggregate (2 ms)
      ✓ analytic order by can be an output field (2 ms)
      ✓ analytic order by must be an output field (2 ms)
      ✓ can specify multiple wheres (3 ms)
      ✓ string_agg can take order_by (5 ms)
    aggregate forms
      ✓ one.column.min() (3 ms)
      ✓ one.min(one.column) (5 ms)
      ✓ min(one.column) (2 ms)
      ✓ min(many.column) (2 ms)
      ✓ min() (1 ms)
      ✓ source.min(column) (2 ms)
      ✓ many.column.max() (2 ms)
      ✓ max(many.column) (2 ms)
      ✓ max() (1 ms)
      ✓ source.max(many.column) (2 ms)
      ✓ many.column.count() (1 ms)
      ✓ count() (2 ms)
      ✓ count(many.column) (3 ms)
      ✓ source.count() (2 ms)
      ✓ many.count() (2 ms)
      ✓ sum() (1 ms)
      ✓ sum(column) (2 ms)
      ✓ sum(column * 2) (2 ms)
      ✓ column.sum() (3 ms)
      ✓ source.sum(column) (2 ms)
      ✓ sum(many.column) (2 ms)
      ✓ source.sum(many.column) (2 ms)
      ✓ many.column.sum() (3 ms)
      ✓ many.sum(many.column) (2 ms)
      ✓ sum(one.column) (1 ms)
      ✓ sum(many.constant) (2 ms)
      ✓ source.sum(many.constant) (2 ms)
      ✓ sum(nested.column) (2 ms)
      ✓ nested.column.sum() (2 ms)
      ✓ source.sum(nested.column) (2 ms)
      ✓ can aggregate field defined with no join usage (3 ms)
      ✓ sum(inline.column) (4 ms)
      ✓ inline.column.sum() (2 ms)
      ✓ source.sum(inline.column) (2 ms)
      ✓ sum(many.field) (2 ms)
      ✓ source.sum(many.field) (2 ms)
      ✓ many.field.sum() (2 ms)
      ✓ many.sum(many.field) (2 ms)
      ✓ sum(many.field + many.field) (3 ms)
      ✓ source.sum(many.field + many.field) (2 ms)
      ✓ many.field + many.field.sum() (3 ms)
      ✓ many.sum(many.field + many.field) (4 ms)
      ✓ sum(many_field) (2 ms)
      ✓ source.sum(many_field) (1 ms)
      ✓ many_field.sum() (2 ms)
      ✓ many.sum(many_field) (2 ms)
      ✓ sum(one.many_field) (2 ms)
      ✓ source.sum(one.many_field) (2 ms)
      ✓ one.many_field.sum() (2 ms)
      ✓ many.sum(one.many_field) (2 ms)
      ✓ sum(many.field + one.field) (4 ms)
      ✓ source.sum(many.field + one.field) (3 ms)
      ✓ many.sum(many.field + one.field) (2 ms)
      ✓ many_one_field.sum() (2 ms)
      ✓ sum(many_one_field) (2 ms)
      ✓ source.sum(many_one_field) (2 ms)
      ✓ many.sum(many_one_field) (2 ms)
      ✓ sum(many.one.field) (1 ms)
      ✓ sum(many.one.one.field) (2 ms)
      ✓ many.avg(field) (4 ms)
      ✓ one.avg(field) (2 ms)
      ✓ cross.avg(field) (2 ms)
      ✓ cross.avg(cross.field) (2 ms)
      ✓ one.column.sum() (2 ms)
      ✓ one.sum(one.column) (1 ms)
      ✓ source.sum(one.column) (2 ms)
      ✓ sum(one.column + one.column) (2 ms)
      ✓ one.sum(one.column + one.column) (2 ms)
      ✓ source.sum(one.column + one.column) (3 ms)
      ✓ lag(sum(output)) (3 ms)
    case statements
      ✓ full (5 ms)
      ✓ with value (2 ms)
      ✓ no else (1 ms)
      ✓ wrong then type (1 ms)
      ✓ wrong when type (1 ms)
      ✓ wrong else type (2 ms)
      ✓ null then type okay second (1 ms)
      ✓ null then type okay first (1 ms)
      ✓ null else type okay (1 ms)
      ✓ null then type before else okay (1 ms)
      ✓ non boolean when (1 ms)
      ✓ type of null then second (2 ms)
      ✓ type of null then first (1 ms)
      ✓ type of null else
      ✓ type of null then type before else (1 ms)
      ✓ replacement for full case
      ✓ replacement for case with no else
      ✓ replacement for case with value
      ✓ interaction with pick (12 ms)
    pick statements
      ✓ full (7 ms)
      ✓ applied (2 ms)
      ✓ filtering (1 ms)
      ✓ null branch with else (6 ms)
      ✓ null branch no else (1 ms)
      ✓ null branch no apply (3 ms)
      ✓ tiering (1 ms)
      ✓ transforming (2 ms)
      ✓ when single values (1 ms)
      ✓ n-ary without else (2 ms)
      ✓ n-ary with mismatch when clauses (4 ms)
      ✓ n-ary with mismatched else clause (2 ms)
      ✓ applied else mismatch (2 ms)
      ✓ applied default mismatch (2 ms)
      ✓ applied when mismatch (2 ms)
  alternations as in
    ✓ a=b|c (2 ms)
    ✓ a!=b|c (1 ms)
    ✓ a=(b|c) (1 ms)
    ✓ a?b|c (1 ms)
    ✓ a=(b)|c (1 ms)
    ✓ a=b|c|d (2 ms)
    ✓ a=(b|c)|d (1 ms)
    ✓ a=b|(c|d) (1 ms)
    ✓ a=b|c&d (3 ms)
    ✓ a=b|>d (2 ms)
    ✓ a ? (= (b | c)) (1 ms)
    ✓ legacy in (2 ms)
    ○ skipped a ? (( =1) | 2)
  sql native fields in schema
    ✓ sql native reference in result allowed (2 ms)
    ✓ sql native reference can be compared to NULL (3 ms)
    ✓ flag unsupported equality (2 ms)
    ✓ flag unsupported compare (2 ms)
    ✓ allow unsupported equality when raw types match (1 ms)
    ✓ flag not applied to unsupported (2 ms)
    ✓ allow unsupported to be cast (1 ms)
    ✓ negative numbers are not tokens (4 ms)
    sql functions
      ✓ can aggregate a sql_ function (2 ms)
      ✓ error when interpolating field that does not exist (1 ms)
      ✓ error when using sql_ function without experiment (1 ms)
    cast
      ✓ sql cast (5 ms)
      ✓ sql safe cast (3 ms)
      ✓ malloy cast (1 ms)
      ✓ malloy safe cast (1 ms)
      ✓ sql cast illegal type name (1 ms)

PASS packages/malloy/src/lang/test/parse.spec.ts
  ✓ non breaking space in source (1 ms)
  model statements
    ✓ errors on redefinition of query (47 ms)
    ✓ ##! experimental enables all experiments (6 ms)
    ✓ experimental explicit enable (3 ms)
    ✓ experiments do not bleed into one another (2 ms)
    ✓ experiment failures in parse are flagged (1 ms)
    ✓ experiment failures in second pass are flagged (2 ms)
    table method
      ✓ table method works (125 ms)
      ✓ table method works with quoted connection name (4 ms)
      ✓ table method fails when connection name is wrong (1 ms)
      ✓ table method fails when connection is not a connection (8 ms)
      ✓ cannot refine table (144 ms)
      ✓ table function is deprecated (5 ms)
      ✓ cannot run table (2 ms)
  error handling
    ✓ no close brace (376 ms)
    ✓ field and query with same name does not overflow (94 ms)
    ✓ redefine source (4 ms)
    ✓ query from undefined source (2 ms)
    ✓ query with expression from undefined source (17 ms)
    ✓ join reference before definition (20 ms)
    ✓ non-rename rename (3 ms)
    ✓ reference to field in its definition (10 ms)
    ✓ empty model (1 ms)
    ✓ one line model  (1 ms)
    ✓ query without fields (8 ms)
    ✓ refine cannot change query type (16 ms)
    ✓ undefined field ref in query (5 ms)
    ✓ query on source with errors (2 ms)
    ✓ detect duplicate output field names (25 ms)
    ✓ detect join tail overlap existing ref (9 ms)
    ✓ undefined in expression with regex compare (12 ms)
    ✓ detect output collision on join references (3 ms)
    ✓ rejoin a query is renamed (25 ms)
    ✓ popping out of embedding when not embedded (1 ms)
    ✓ bad sql in sql block (5 ms)
  translate imports
    ✓ import at (8 ms)
  translation need error locations
    ✓ import error location (1 ms)
    ✓ sql struct error location (6 ms)
    ✓ table struct error location (4 ms)
  error cascading
    ✓ errors can appear in multiple top level objects (5 ms)
    ✓ dependent errors do not cascade (208 ms)
    ✓ error type inference is good (125 ms)
    ✓ eval space of errors is preserved (127 ms)
  pipeline comprehension
    ✓ second query gets namespace from first (47 ms)
    ✓ second query doesn't have access to original fields (3 ms)
    ✓ new query can append ops to existing query (4 ms)
    ✓ new query can refine and append to exisiting query (9 ms)
    ✓ reference to a query can include a refinement (10 ms)
    ✓ Querying an sourcebased on a query (8 ms)
    ✓ new query appends to existing query (3 ms)
  raw function call with type specified
    ✓ timestamp_seconds (2 ms)
  sql expressions
    ✓ reference to sql expression in unextended source (2 ms)
    ✓ sql expression legal with single quote (2 ms)
    ✓ sql expression legal with double quote (2 ms)
    ✓ reference to sql expression in extended source (2 ms)
    ✓ reference to sql expression in named query (1 ms)
    ✓ reference to sql expression in unnamed query (2 ms)
    ✓ cannot refine sql query (4 ms)
    ✓ reference to sql expression in join (3 ms)
    ✓ reference to sql expression in run (2 ms)
    ✓ reference to sql expression in query def (2 ms)
    ✓ reference to sql expression in anonymous query (1 ms)
    ✓ cannot refine a SQL query saved as a query (2 ms)
    ✓ cannot refine a SQL query directly (2 ms)
  extend and refine
    extend and refine, new syntax
      ✓ query name with query refinements (2 ms)
      ✓ query name with source refinements (2 ms)
      ✓ source name with query refinements (1 ms)
      ✓ source name with source refinements (1 ms)
      ✓ query with source refinements (2 ms)
      ✓ query with extension then new stage (4 ms)
    extend and refine, old syntax
      ✓ query name with query refinements (2 ms)
      ✓ query name with source refinements (2 ms)
      ✓ source name with query refinements (1 ms)
      ✓ source name with source refinements (1 ms)
      query name with ambiguous refinements
        ✓ adding segment to ambuguously refined query (12 ms)
        ✓ automatically recognize this as a query refinement without new stage (6 ms)
        ✓ can extend a query into a source (5 ms)
        ✓ can also add an arrow to clarify that it is a query (86 ms)
    extend and refine fallout
      ✓ syntactically valid to run a source, but still illegal (1 ms)
      ✓ syntactically valid to refine a source, but illegal (2 ms)
    turtles
      ✓ explicit refine in turtle works (7 ms)
      ✓ implicit refine in turtle works (3 ms)
    nests
      ✓ explicit refine in nest (3 ms)
      ✓ refine in nest (2 ms)
  miscellaneous m4 warnings
    ✓ project is deprecated (2 ms)
    ✓ query leading arrow (3 ms)
  m3/m4 source query sentences
    ✓ M4 should error on these sq expressions (3 ms)
    ✓ legal sqexpressions (10 ms)
  sql_functions
    ✓ can aggregate sql function (6 ms)

PASS test/src/core/tags.spec.ts
  tagParse to Tag
    ✓ tag just_name (9 ms)
    ✓ tag name=bare_string (1 ms)
    ✓ tag name="quoted_string" (2 ms)
    ✓ tag name {prop1} (2 ms)
    ✓ tag name {prop1 prop2=value} (1 ms)
    ✓ tag name.prop
    ✓ tag name.prop=value
    ✓ tag name.prop.sub=value
    ✓ tag name{first3=[a, b, c]} (2 ms)
    ✓ tag name{first1=[a,]}
    ✓ tag name{first=[a {A}]}
    ✓ tag name{first=[{A}]} (1 ms)
    ✓ tag name=value {prop}
    ✓ tag name.prop={prop2} (1 ms)
    ✓ tag no yes -no
    ✓ tag x -x.y (1 ms)
    ✓ tag x={y} -x.y
    ✓ tag x={y z} -x.y (1 ms)
    ✓ tag x={y z} x {-y} (5 ms)
    ✓ tag x=1 x {xx=11} (1 ms)
    ✓ tag x.y=xx x=1 {...}
    ✓ tag a {b c} a=1 (1 ms)
    ✓ tag a=1 a=...{b}
    ✓ tag a=red { shade=dark } color=$(a) shade=$(a.shade) (1 ms)
    ✓ tag x=.01 (1 ms)
    ✓ tag x=-7
    ✓ tag x=7
    ✓ tag x=7.0 (1 ms)
    ✓ tag x=.7
    ✓ tag x=.7e2
    ✓ tag x=7E2 (1 ms)
    ✓ tag `spacey name`=Zaphod (1 ms)
    ✓ tag image { alt=hello { field=department } } (1 ms)
    ✓ tag image image.alt=hello image.alt.field=department
    ✓ tag can remove.properties -...
    ✓ inherits can be over-ridden (1 ms)
    ○ skipped unskip to debug just one of the expressions
  Tag access
    ✓ just text
    ✓ tag path (1 ms)
    ✓ just array
    ✓ array as text
    ✓ text as array
    ✓ just numeric
    ✓ text as numeric
    ✓ array as numeric (1 ms)
    ✓ full text array
    ✓ filtered text array
    ✓ full numeric array (1 ms)
    ✓ filtered numeric array
    ✓ has (1 ms)
  ## top level
    ✓ top level tags are available in the model def (203 ms)
  tags in results
    ✓ nameless query (283 ms)
    ✓ named query (30 ms)
    ✓ turtle query (111 ms)
    ✓ field ref has tag (24 ms)
    ✓ atomic field model scope tag (10 ms)
    ✓ nested query has tag (53 ms)
    ✓ render usage test case (20 ms)
    ✓ User defined scopes nest properly (9 ms)
    ✓ inherited model tags override (15 ms)
    ✓ property access on existing tag (which does not yet have properties) (1 ms)
    ✓ nested fields of same field do not share tags (17 ms)

PASS test/src/render/drill.spec.ts
  drill query
    ✓ can handle joined-in table fields (525 ms)
    ✓ can handle expression fields (23 ms)
    ✓ can handle renamed and multi-word field names (23 ms)
    ✓ can handle queries with no filter (18 ms)

PASS packages/malloy/src/lang/test/query.spec.ts
  query:
    basic query syntax
      ✓ run:anonymous query (285 ms)
      ✓ query:anonymous query m4 warning (18 ms)
      ✓ named query: (7 ms)
      ✓ run query ref (3 ms)
      ✓ query from query (3 ms)
      ✓ query with refinements from query (4 ms)
      ✓ chained query operations (22 ms)
      ✓ query output refined into another query (97 ms)
      ✓ query with shortcut filtered turtle (15 ms)
      ✓ query with filtered turtle (5 ms)
      ✓ nest: in group_by: (12 ms)
      ✓ reduce pipe project (28 ms)
      ✓ refine and extend query (3 ms)
      ✓ query refinement preserves original (6 ms)
      ✓ query composition preserves original (3 ms)
      ✓ all ungroup with args (7 ms)
      ✓ all ungroup checks args (2 ms)
      ✓ exclude ungroup with args (13 ms)
      ✓ exclude ungroup checks args (3 ms)
      ✓ exclude problem revealed by production models (58 ms)
      ✓ exclude output checking survives refinement (27 ms)
    query operation typechecking
      field declarations
        ✓ cannot use aggregate in group_by (2 ms)
        ✓ cannot use ungrouped_aggregate in group_by (1 ms)
        ✓ cannot use analytic in group_by (2 ms)
        ✓ cannot use aggregate in dimension (1 ms)
        ✓ cannot use ungrouped_aggregate in dimension (2 ms)
        ✓ cannot use analytic in dimension (1 ms)
        ✓ cannot use scalar in measure (1 ms)
        ✓ cannot use analytic in measure (4 ms)
        ✓ cannot use scalar in aggregate (2 ms)
        ✓ cannot use analytic in aggregate (1 ms)
        ✓ cannot use scalar in calculate (2 ms)
        ✓ cannot use aggregate in calculate (2 ms)
        ✓ cannot use aggregate in project (1 ms)
        ✓ cannot use analytic in project (1 ms)
        ✓ cannot use analytic in extended source (7 ms)
        ✓ cannot use aggregate in index (3 ms)
        ✓ can use aggregate in except (3 ms)
      field references
        ✓ cannot use aggregate in group_by (80 ms)
        ✓ cannot use query in group_by (3 ms)
        ✓ cannot use scalar in aggregate (1 ms)
        ✓ cannot use scalar in calculate (2 ms)
        ✓ cannot use aggregate in calculate (1 ms)
        ✓ cannot use query in project (2 ms)
        ✓ cannot use query in index (1 ms)
        ✓ cannot use query in calculate (2 ms)
        ✓ cannot use query in aggregate (2 ms)
        ✓ cannot use aggregate in calculate, preserved over refinement (2 ms)
        ✓ cannot use scalar in calculate, preserved over refinement (1 ms)
        ✓ cannot use analytic in group_by, preserved over refinement (5 ms)
        ✓ cannot use analytic in order_by, preserved over refinement (4 ms)
        ✓ cannot ungroup an ungrouped (1 ms)
        ✓ cannot aggregate an ungrouped (2 ms)
        ✓ cannot aggregate an aggregate (1 ms)
        ✓ can use field def in group_by, preserved over refinement (2 ms)
        ✓ can use field ref in group_by, preserved over refinement (2 ms)
    function typechecking
      ✓ use function correctly (1 ms)
      ✓ function incorrect case (2 ms)
      ✓ function no matching overload (1 ms)
      ✓ unknown function (2 ms)
      ✓ can select different overload (1 ms)
      ✓ can pass different expression types (5 ms)
      ✓ function return type correct (2 ms)
      ✓ function return type incorrect (2 ms)
      ✓ can use output value in calculate (1 ms)
      ✓ cannot use output value in group_by (2 ms)
      ✓ lag can check that other args are constant (1 ms)
      ✓ lag can check that other args are literal (2 ms)
      ✓ lag can check that other args are nonnull (2 ms)
      ✓ lag can use constant values for other args (1 ms)
      ✓ cannot name top level objects same as functions (2 ms)
      ✓ `now` is considered constant` (1 ms)
      ✓ cannot use a field which is a constant in a constant param (27 ms)
      ✓ cannot use struct in function arg (1 ms)
      ✓ cannot use stddev with no arguments (2 ms)
      ✓ can use stddev with postfix syntax (2 ms)
      ✓ can use stddev with postfix syntax on join (2 ms)
      ✓ can use calculate with a measure (2 ms)
      ✓ cannot use calculate with input fields (1 ms)
      ✓ can use calculate with aggregate field which is not in query (2 ms)
      ✓ cannot use agregate as argument to agg function (1 ms)
      ✓ cannot use calculate with no other fields (2 ms)
      ✓ today: cannot order by analytic function (1 ms)
      ✓ cannot use analytic in calculate -- and preserved over refinement (5 ms)
      ✓ cannot use aggregate analytic in project (1 ms)
      ✓ reference field in join (2 ms)
      ✓ reference field in double nested join inside nest (13 ms)
      ✓ can reference select: inline join.* field in calculate (2 ms)
      ✓ can reference select: join.* field in calculate (2 ms)
      ✓ can reference implied output entries in calculate (3 ms)
      ○ skipped cannot use float in round precision
      ○ skipped reference join as field
      dialect functions
        ✓ can use function enabled in this dialect (standardsql) (2 ms)
        ✓ cannot use function enabled in a different dialect (duckdb) (1 ms)
    qops
      ✓ group by single (5 ms)
      ✓ group_by x is x' (2 ms)
      ✓ group by multiple (1 ms)
      ✓ aggregate single (1 ms)
      ✓ calculate in reduce (2 ms)
      ✓ calculate in project (19 ms)
      ✓ aggregate reference (1 ms)
      ✓ timeunit reference (2 ms)
      ✓ aggregate multiple (1 ms)
      ✓ project ref (2 ms)
      ✓ expands star correctly (2 ms)
      ✓ expands join dot star correctly (4 ms)
      ✓ expands star with exclusions (2 ms)
      ✓ array in query is passed into fields (1 ms)
      ✓ star error checking (10 ms)
      ✓ regress check extend: and star (2 ms)
      ✓ project def (1 ms)
      ✓ project multiple (1 ms)
      ✓ index single
      ✓ regress check extend: and star (4 ms)
      ✓ project def (2 ms)
      ✓ project multiple (1 ms)
      ✓ index single (1 ms)
      ✓ index path (1 ms)
      ✓ index unique on path (2 ms)
      ✓ index join.* (1 ms)
      ✓ index multiple (2 ms)
      ✓ index by (1 ms)
      ✓ index sampled (2 ms)
      ✓ index unsampled (1 ms)
      ✓ index sample-percent (2 ms)
      ✓ index sample-rows (1 ms)
      ✓ top N (4 ms)
      ✓ limit N (1 ms)
      ✓ order by multiple (4 ms)
      ✓ agg cannot be used in where (2 ms)
      ✓ analytic cannot be used in where (2 ms)
      ✓ analytic cannot be used in having (2 ms)
      ✓ where single (2 ms)
      ✓ having single (1 ms)
      ✓ compound having still works (7 ms)
      ✓ compound aggregate still works (3 ms)
      ✓ where multiple (2 ms)
      ✓ filters preserve source formatting in code: (3 ms)
      ✓ field expressions preserve source formatting in code: (4 ms)
      ✓ nest single (4 ms)
      ✓ nest multiple (11 ms)
      ✓ nest ref (2 ms)
      ✓ refine query with extended source (17 ms)
      ✓ refine query source with field (3 ms)
      ✓ refine query source with join (18 ms)
      order by variations
        ✓ order by (1 ms)
        ✓ order by preserved over refinement (2 ms)
        ✓ order by must be in the output space (1 ms)
        ✓ order by asc (1 ms)
        ✓ order by desc (1 ms)
        ✓ order by N (2 ms)
        ✓ first aggregate used for default ordering (1 ms)
        ✓ first temporal used for default ordering (1 ms)
        ✓ first used for ordering when appropriate (2 ms)
      extend block
        ✓ works with dimension (1 ms)
        ✓ works with measure (2 ms)
        ✓ works with join_one (2 ms)
        ✓ works with join_many (2 ms)
        ✓ works with join_cross (1 ms)
        ✓ works with multiple in one block (2 ms)
        ✓ works with multiple blocks (1 ms)
      declare/query join warnings
        ✓ declare warning in query (5 ms)
        ✓ declare warning in source (1 ms)
        ✓ joins in query (2 ms)
    refinement location rules
      ✓ where clauses go into the first segment (3 ms)
      ✓ having clauses go into the last segment (3 ms)
      ✓ limit goes into the last segment (2 ms)
      ✓ order_by goes into the last segment (2 ms)
      ✓ group_by illegal in long pipes (2 ms)
      ✓ aggregate illegal in long pipes (1 ms)
      ✓ calcluate illegal in long pipes (2 ms)
      ✓ extend illegal in long pipes (2 ms)
      ✓ nest illegal in long pipes (1 ms)
      ✓ all single stage refinements are accepted (7 ms)

PASS packages/malloy/src/lang/test/annotation.spec.ts
  document annotation
    ✓ every source annotation point (144 ms)
    ✓ multi line source annotation (3 ms)
    ✓ inherited annotation source (88 ms)
    ✓ define full query annotation points (185 ms)
    ✓ run statement annotation points (6 ms)
    ✓ multi line query annotation (5 ms)
    ✓ inherited annotation query (32 ms)
    ✓ query from turtle inherits turtle annotation (14 ms)
    ✓ model annotations (3 ms)
    ✓ ignores objectless object annotations (1 ms)
    ✓ errors reported from compiler flags (3 ms)
    ✓ checking compiler flags (1 ms)
    ✓ extended models inherit model flags (3 ms)
  source definition annotations
    ✓ turtle block annotation (2 ms)
    ✓ refined turtle inherits annotation (4 ms)
    ✓ dimension block annotation (16 ms)
    ✓ measure block annotation (10 ms)
    ✓ join_one-with block annotation (27 ms)
    ✓ join_many-on block annotation (16 ms)
    ✓ ignores model annotation (2 ms)
  query operation annotations
    ✓ ignores model annotation (1 ms)
    ✓ project new definition annotation (13 ms)
    ✓ select: ref inherits annotation (6 ms)
    ✓ group_by def (28 ms)
    ✓ caculate def (32 ms)
    ✓ group_by ref inherits (6 ms)
    ✓ aggregate def (13 ms)
    ✓ aggregate ref inherits (6 ms)
    ✓ nest annotation (15 ms)
    ✓ nest from existing inherits annotation (3 ms)
    ✓ annotations preserved from path references (88 ms)
    ✓ a reference can have an annotation (2 ms)
    include annotations
      ✓ inherit: star (108 ms)
      ✓ new tags are inherited, not added (12 ms)
      ✓ modifier: star (6 ms)
      ✓ inherit: list (35 ms)
      ✓ modifier: list (7 ms)
      ✓ tags except: list (24 ms)
      ✓ tags except: star (6 ms)
      ✓ oprhaned annotation (4 ms)

PASS packages/malloy/src/lang/test/source.spec.ts
  source:
    ✓ table (279 ms)
    ✓ shorcut fitlered table (113 ms)
    ✓ fitlered table (2 ms)
    ✓ ref source with no refinement (4 ms)
    ✓ source from query (164 ms)
    ✓ refine source (8 ms)
    ✓ source refinement preserves original (3 ms)
    ✓ dates do not become timestamps (2 ms)
    source properties
      ✓ single dimension (2 ms)
      ✓ field def with null value (2 ms)
      ✓ multiple dimensions (10 ms)
      ✓ single declare ok b4 m4 (12 ms)
      ✓ multiple declare ok b4 m4 (2 ms)
      ✓ single measure (3 ms)
      ✓ multiple measures (23 ms)
      ✓ single where (3 ms)
      ✓ multiple where (4 ms)
      ✓ where clause can use the join namespace in source refined query (134 ms)
      ✓ primary_key (1 ms)
      ✓ rename (2 ms)
      ✓ accept single (2 ms)
      ✓ accept multi (1 ms)
      ✓ except single (1 ms)
      ✓ except multi (5 ms)
      ✓ turtle in a source can be called view (1 ms)
      ✓ turtle in source can be called query with m4 warning (2 ms)
      ✓ refined explore-query (16 ms)
      ✓ chained explore-query (7 ms)
      ✓ chained explore-query with refinement two steps (8 ms)
      ✓ pipelined explore-query with refinement (2 ms)
      ✓ pipelined explore-query with view chain (5 ms)
      ✓ multiple explore-query (3 ms)
      joins
        ✓ with (2 ms)
        ✓ with (2 ms)
        ✓ with dotted ref (1 ms)
        ✓ one on (2 ms)
        ✓ one is on (2 ms)
        ✓ many on (6 ms)
        ✓ many with (1 ms)
        ✓ many is on (2 ms)
        ✓ cross (1 ms)
        ✓ cross is (2 ms)
        ✓ cross on (1 ms)
        ✓ multiple joins (4 ms)
        ✓ with requires primary key (2 ms)
        ✓ can join a query without a rename (37 ms)
        ✓ can with join a single column query (10 ms)
      access modifiers and include
        ✓ private not accessible in query (109 ms)
        ✓ internal not accessible in query (3 ms)
        ✓ internal is accessible in source extension (2 ms)
        ✓ private is inaccessible in source extension (4 ms)
        ✓ internal is inaccessible in joining source on (7 ms)
        ✓ internal at definition time (2 ms)
        ✓ internal is inaccessible in joining source field (3 ms)
        ✓ internal is inaccessible in view reference (3 ms)
        ✓ private field used in view is accessible outside via view (3 ms)
        ✓ use internal field in query in extension (2 ms)
        ✓ cannot expand access from private (2 ms)
        ✓ can expand access from internal explicitly (3 ms)
        ✓ can expand access from internal with star (5 ms)
        ✓ star does not expand access (2 ms)
        ✓ access modifier * (2 ms)
        ✓ private things can be used in immediate extension (2 ms)
        ✓ private things cannot be used in later extension (1 ms)
        ✓ access modifier * except (21 ms)
        ✓ access modifier * nonconflicting use (2 ms)
        ✓ cannot override in same source (2 ms)
        ✓ rename in include (4 ms)
        ✓ commas optional in include (35 ms)
        ✓ include and except list (21 ms)
        ✓ except and include list (2 ms)
    composite sources
      ✓ basic composite source (3 ms)

PASS packages/malloy/src/lang/test/parameters.spec.ts
  parameters
    ✓ can declare parameter with no default value (131 ms)
    ✓ can declare parameter with default value literal (9 ms)
    ✓ can declare parameter with default value constant (9 ms)
    ✓ cannot specify default value with incompatible type (2 ms)
    ✓ error if paramter has no type or value (1 ms)
    ✓ error if paramter type is null (2 ms)
    ✓ allowed to write null::string (2 ms)
    ✓ allowed to write ::string is null (2 ms)
    ✓ can use param in null equality expression (260 ms)
    ✓ error if paramter type is range (11 ms)
    ✓ no additional error if default value type is error (2 ms)
    ✓ can declare parameter with inferred type (1 ms)
    ✓ can pass parameter into extended base source (3 ms)
    ✓ can pass parameter to override default value with constant (2 ms)
    ✓ can pass parameter to override default value with param value (2 ms)
    ✓ can pass parameter into named base source (1 ms)
    ✓ can pass differently-named parameter into extended base source (2 ms)
    ✓ can pass differently-named parameter into named base source (2 ms)
    ✓ can pass parameter into base source longhand (1 ms)
    ✓ can pass parameter into base source shorthand (2 ms)
    ✓ can use declared parameter in dimension (9 ms)
    ✓ can use declared parameter in sql function (8 ms)
    ✓ can use declared parameter in nest extending other (40 ms)
    ✓ can use declared parameter in source extension in view (80 ms)
    ✓ can use declared parameter in nest with table (4 ms)
    ✓ can pass argument for param (6 ms)
    ✓ can not pass argument for default-valued param (2 ms)
    ✓ can pass zero args for source with default-valued param (2 ms)
    ✓ can pass non-literal argument for param (2 ms)
    ✓ parameter not included in wildcard (5 ms)
    ✓ cannot reference renamed param in query against source (2 ms)
    ✓ cannot reference param in query against source (2 ms)
    ✓ cannot reference param in source extension (1 ms)
    ✓ cannot reference param in in-query source extension (2 ms)
    ✓ can reference field in source in argument (2 ms)
    ✓ can pass through parameter to joined source (shorthand) (54 ms)
    ✓ can pass through parameter to joined source (longhand) (7 ms)
    ✓ can reference param in query against source (2 ms)
    ✓ can reference param in view in source (3 ms)
    ✓ can declare dimension which is just the parameter (1 ms)
    ✓ cannot reference param in expression in query against source (2 ms)
    ✓ error when declaring parameter twice (1 ms)
    ✓ error when declaring parameter with same name as field (extended) (2 ms)
    ✓ can shadow field that is excepted (3 ms)
    ✓ error when declaring parameter with same name as field (not extended) (3 ms)
    ✓ do not inherit parameters from base source (2 ms)
    ✓ error when declaring field with same name as parameter (1 ms)
    ✓ error when declaring parameter without experiment enabled (1 ms)
    ✓ cannot except parameter from extended source (1 ms)
    ✓ cannot except parameter in direct extend (2 ms)
    ✓ cannot accept parameter (1 ms)
    ✓ error when using parameter without experiment enabled (1 ms)
    ✓ parameters cannot reference themselves (2 ms)
    ✓ error when circularly referencing mutually recursive parameters in argument (2 ms)
    ✓ error when passing param with no name (2 ms)
    ✓ error when passing param with incorrect name (1 ms)
    ✓ error when passing param multiple times (2 ms)
    ✓ error when not specifying argument for param with parentheses (3 ms)
    ✓ error when not specifying argument for param without parentheses (2 ms)
    ✓ error when not specifying argument for param second time (2 ms)
    ✓ error when referencing parameter that does not exist in join definition (2 ms)
    ✓ error when referencing identifier in default param value (1 ms)
    ✓ can not pass parameter into source of query yet (2 ms)
    ✓ source arguments from query propagate as arguments not parameters (17 ms)
    ✓ source arguments carry over from previous invocation (1 ms)
    ○ skipped can pass parameter into source of query
    ○ skipped can pass through parameter to source in joined query
    ○ skipped can pass through parameter to view in joined query
    ○ skipped can pass through parameter to source in query in SQL source
    ○ skipped can pass through parameter to view in query in SQL source
    ○ skipped can pass through parameter to source in query in joined SQL source
    ○ skipped can use param in multi-stage query
    ○ skipped can add an annotation to a param

PASS packages/malloy/src/lang/test/composite-field-usage.spec.ts
  composite sources
    composite field usage
      ✓ looked up value (2 ms)
      ✓ multiple values (1 ms)
      ✓ value plus constant (2 ms)
      ✓ join usage (8 ms)
      ✓ join usage complex (1 ms)
      ✓ measure defined in composite source (2 ms)
      ✓ measure with filter defined in composite source (1 ms)
    composite source resolution and validation
      ✓ compose fails on group_by that is relevant (174 ms)
      ✓ compose fails on filter that is relevant (4 ms)
      ✓ compose fails in case where second field has overlap with first (3 ms)
      ✓ compose resolution succeeds nested (22 ms)
      ✓ good composite field usage works (2 ms)
      ✓ index on composite translates (8 ms)
      ✓ raw run of composite source fails (2 ms)
      ✓ composite source with parameter (7 ms)
      ✓ composite source does not include private field (3 ms)
      ✓ composite source does not resolve to private field (3 ms)
      ✓ composite source does include internal field (7 ms)
      ✓ access level mismatch in composite (before) (3 ms)
      ✓ access level mismatch in composite (after) (2 ms)
      ✓ array.each is okay (4 ms)
      ✓ timevalue extract okay (3 ms)

PASS packages/malloy/src/lang/test/imports.spec.ts
  import:
    ✓ simple source (128 ms)
    ✓ simple source with importBaseURL (3 ms)
    ✓ simple query (181 ms)
    ✓ query based source with named structref (137 ms)
    ✓ missing import (1 ms)
    ✓ chained imports (4 ms)
    ✓ relative imports (5 ms)
    ✓ relative imports with errors (14 ms)
    ✓ source references expanded when not exported (25 ms)
    ✓ selective import of source (3 ms)
    ✓ renaming import of source (3 ms)
    ✓ selective import of source, not found (2 ms)
    ✓ selective renamed import of source, not found (4 ms)
    ✓ selective import of source, no-redefinition (3 ms)

PASS packages/malloy/src/lang/test/syntax-errors.spec.ts
  errors
    ✓ source missing closing curly: EOF (140 ms)
    ✓ view is missing name (85 ms)
    ✓ missing closing curly, source>view (189 ms)
    ✓ incorrect opening curly after dimension (16 ms)
    ✓ misspelled primarykey (1 ms)
    ✓ missing opening curly after source extend keyword (319 ms)

PASS packages/malloy/src/lang/test/lenses.spec.ts
  lenses
    ✓ long lens patterns (446 ms)
    ✓ lens parens patterns (41 ms)
    ✓ cannot have overlapping names (12 ms)
    ✓ cannot override limit (6 ms)
    ✓ cannot override ordering (10 ms)
    ✓ weird issue with order by constant group by (3 ms)
    ✓ can add a limit late (7 ms)
    ✓ cannot refine with incompatible view types (35 ms)
    ✓ can reference dimension at head of query when experiment is enabled (1 ms)
    ✓ can change refine precedence (12 ms)
    ✓ cannot refine with multi-stage (4 ms)
    ✓ cannot refine with literal multi-stage (10 ms)
    ✓ can reference dimension in refinement when experiment is enabled (2 ms)
    ✓ can reference join field when experiment is enabled (26 ms)
    ✓ can reference join field in refinement when experiment is enabled (7 ms)
    ✓ can reference join field in nest refinement when experiment is enabled (4 ms)
    ✓ can nest dimension when experiment is enabled (3 ms)
    ✓ cannot use join_name in refinement shortcut (6 ms)
    ✓ cannot use view from join as whole pipeline (7 ms)
    ✓ cannot use view from join in nest (3 ms)
    ✓ cannot use view from join as nest view head (4 ms)
    ✓ cannot use view from join as lens in query (3 ms)
    ✓ cannot use view from join as lens in nest (4 ms)
    ✓ can nest dimension with refinement when experiment is enabled (22 ms)
    ✓ cannot reference join (2 ms)
    ✓ cannot reference field in LHS of refinement in group_by (7 ms)
    ✓ cannot named-refine multi-stage query (4 ms)
    ○ skipped can split multi-stage refinement with plus
  partial views
    ✓ allow where-headed refinement chains (4 ms)
    ✓ order by tacked on the end should work (12 ms)
    ✓ name can be inferred with arrow (3 ms)
    ✓ nice error when nest has no name (1 ms)
    ✓ disallow chains that have no fields in view (4 ms)
    ✓ disallow chains that have no fields in multi-stage (3 ms)
    ✓ copy of view with refinement should work (3 ms)
    ○ skipped partial with index

PASS packages/malloy/src/lang/test/sql-block.spec.ts
  connection sql()
    ✓ source from sql (216 ms)
    ✓ source from imported sql-based-source (171 ms)
    ✓ simple turducken (27 ms)
    ✓ turduckenzilla (216 ms)
    ✓ source from extended sql-based-source (4 ms)

PASS packages/malloy/src/lang/test/locations.spec.ts
  source locations
    ✓ renamed source location (129 ms)
    ✓ refined source location (24 ms)
    ✓ location of defined dimension (76 ms)
    ✓ location of defined measure (4 ms)
    ✓ location of defined view (169 ms)
    ✓ location of defined field inside a view (3 ms)
    ✓ location of filtered field inside a view (18 ms)
    ✓ location of field inherited from table (2 ms)
    ✓ location of field inherited from sql source (10 ms)
    ✓ location of fields inherited from a query (20 ms)
    ✓ location of named query (35 ms)
    ✓ location of field in named query (2 ms)
    ✓ location of renamed field (3 ms)
    ✓ location of join on (23 ms)
    ✓ location of join with (3 ms)
    ✓ location of field in join (8 ms)
    ✓ undefined query location (2 ms)
    ✓ undefined field reference (1 ms)
    ✓ bad query (2 ms)
    ○ skipped undefined field reference in top
    ○ skipped undefined field reference in order_by
    ✎ todo location of parameter
  source references
    ✓ reference to explore (2 ms)
    ✓ reference to query in query (4 ms)
    ✓ reference to query in query (version 2) (2 ms)
    ✓ reference to query (2 ms)
    ✓ reference to query in query head (2 ms)
    ✓ reference to query in refined query (3 ms)
    ✓ reference to field in expression (9 ms)
    ✓ reference to quoted field in expression (4 ms)
    ✓ reference to joined field in expression (14 ms)
    ✓ reference to joined join in expression (3 ms)
    ✓ reference to field not in expression (group by) (1 ms)
    ✓ reference to field not in expression (project) (2 ms)
    ✓ reference to field in aggregate (2 ms)
    ✓ reference to field in measure (2 ms)
    ✓ reference to field in filter (1 ms)
    ✓ reference to field in aggregate source (3 ms)
    ✓ reference to join in aggregate source (6 ms)
    ✓ reference to join in aggregate in expr (2 ms)
    ✓ reference to sourcein join (2 ms)
    ✓ reference to field in aggregate (in expr) (2 ms)
    ✓ reference to field in rename (1 ms)
    ✓ reference to field in join with (2 ms)
    ○ skipped reference to field in order by
    ○ skipped reference to field in order by (output space)
    ○ skipped reference to field in top
    ○ skipped reference to field in top (output space)

PASS packages/malloy/src/lang/test/document-symbol-walker.spec.ts
  ✓ source symbols are included (296 ms)
  ✓ query symbols are included (26 ms)
  ✓ run (def) symbols are included (1 ms)
  ✓ run (ref) symbols are included (1 ms)
  ✓ expression field defs are included (103 ms)
  ✓ renamed fields are included (2 ms)
  ✓ name only fields are included (3 ms)
  ✓ turtle fields are included (162 ms)
  ✓ turtle children fields are included
  ✓ turtle children turtles are included (12 ms)
  ✓ refinement chain gets name correctly (20 ms)
  ✓ arrow in nest infers name correctly (3 ms)
  ✓ join withs are included (17 ms)
  ✓ join ons are included (1 ms)
  ✓ source lenses go before block annotations when one source (3 ms)
  ✓ source lenses go before individual annotations when more than one source (11 ms)
  ✓ query lenses go before block annotations when one source (3 ms)
  ✓ query lenses go before individual annotations when more than one source (11 ms)
  ✓ anonymous query lenses go before block annotations (2 ms)
  ✓ run lenses go before block annotations (1 ms)
  ✓ multiline unnamed queries include last line (1 ms)
  ✓ multiline named queries include last line
  ✓ (regression) query does not use source block range (26 ms)

PASS test/src/core/sql_source.spec.ts
  turducken
    ✓ malloy source code is wrapped in parens (343 ms)
    ✓ malloy source code not double-wrapped in parens (8 ms)

PASS packages/malloy/src/lang/test/document-help-context-walker.spec.ts
  ✓ Supports model properties (410 ms)
  ✓ Supports source properties (3 ms)
  ✓ Supports query properties (3 ms)

PASS packages/malloy/src/lang/test/literals.spec.ts
  literals
    ✓ integer (42 ms)
    ✓ string (3 ms)
    ✓ string with quoted quote (1 ms)
    ✓ string with quoted backslash (2 ms)
    ✓ @1960 (3 ms)
    ✓ @1960-Q2 (6 ms)
    ✓ @1960-06 (2 ms)
    ✓ @1960-06-26-WK (2 ms)
    ✓ @1960-06-30 (2 ms)
    ✓ @1960-06-30 10 (1 ms)
    ✓ @1960-06-30 10:30 (2 ms)
    ✓ @1960-06-30 10:30:00 (2 ms)
    ✓ @1960-06-30 10:30:00.123 (1 ms)
    ✓ @1960-06-30T10:30:00 (1 ms)
    ✓ @1960-06-30 10:30:00[America/Los_Angeles] (2 ms)
    ✓ morphic value for @1960 is 1960-01-01 00:00:00 (1 ms)
    ✓ morphic value for @1960-Q2 is 1960-04-01 00:00:00 (4 ms)
    ✓ morphic value for @1960-06 is 1960-06-01 00:00:00 (1 ms)
    ✓ morphic value for @1960-06-26-Wk is 1960-06-26 00:00:00 (1 ms)
    ✓ morphic value for @1960-06-30 is 1960-06-30 00:00:00 (1 ms)
    ✓ morphic value for @1960-06-30 00:00 is undefined (1 ms)
    ✓ minute+locale (1 ms)
    ✓ second 8601
    ✓ null (1 ms)
    ✓ now (1 ms)
    ✓ true (1 ms)
    ✓ false (1 ms)
    ✓ regex (2 ms)
    quote comprehension inside strings
      ✓ \b
      ✓ \f
      ✓ \n
      ✓ \r
      ✓ \t
      ✓ unicode ?
      ✓ normal stuff
      ✓ stuff & nonsense
      ✓ one thing\nnext thing
      ✓ quote stripping works
    string parsing in language
      ✓ multi-line indent increasing (5 ms)
      ✓ multi-line indent decreasing (1 ms)
      ✓ multi-line indent keep (1 ms)
      ✓ timezone single quote (245 ms)
      ✓ timezone double quote (3 ms)
      ✓ timezone triple quote (2 ms)
      ✓ timezone with illegal query (7 ms)
      ✓ table single quote (11 ms)
      ✓ table double quote
      ✓ table triple quote
      ✓ sql single quote (2 ms)
      ✓ sql double quote (1 ms)
      ✓ sql triple quote (1 ms)
      ✓ import single quote (1 ms)
      ✓ import double quote
      ✓ import triple quote
      ✓ literal single quote (1 ms)
      ✓ literal double quote (1 ms)
      ✓ literal triple quote (1 ms)
      ✓ a string containing a tab
    compound literals
      ✓ simple record literal (8 ms)
      ✓ record literal with path (13 ms)
      ✓ array of records with same schema (3 ms)
      ✓ array of records with head schema (1 ms)

PASS packages/malloy/src/lang/test/find-table-path-walker.spec.ts
  ✓ Table path can be retrieved (228 ms)
  ✓ Table path can not be retrieved
  ✓ Table path can not be retrieved for non string path (3 ms)

PASS packages/malloy/src/lang/test/pretranslate.spec.ts
  pretranslated models
    ✓ import of pretranslated (110 ms)

PASS packages/malloy/src/lang/test/model-annotation-walker.spec.ts
  ✓ model annotations can be retrieved (376 ms)
  ✓ does not explode if bad parse (2 ms)

PASS packages/malloy-malloy-sql/src/grammar/test/parse.spec.ts
  MalloySQL parse
    Should parse inital comments
      ✓ initial single-line forward-slash comment (1 ms)
      ✓ initial single-line double-dash comment (1 ms)
      ✓ initial multi-line comment
      ✓ initial comments mixed
    Should parse control statement
      ✓ Should parse immediate delimiter (1 ms)
      ✓ Should parse initial comments and delimiter
      ✓ Should parse multiple empty control statements (1 ms)
    Should parse statement
      ✓ Should parse statement with comments (1 ms)
      ✓ Should parse statements
    connection: config
      ✓ Should not allow connection in >>>malloy line
      ✓ Should not allow anything besides comments in >>>malloy line
      ✓ Should handle a connection in a delimiter
      ✓ Should handle a connection in a comment (1 ms)
      ✓ Should mark a connection as inherited
    Embedded Malloy
      ✓ Parenthesized embedded malloy can handle space between ( and {%
      ✓ Non-parenthesized embedded malloy
    Parse output
      ✓ Should provide correct output for single statement (1 ms)
      ✓ Should provide correct output for multiple statements
      ✓ Should provide correct output for mulitple statements with embedded malloy (1 ms)
      ✓ Should provide correct output for embedded >>> (2 ms)
      ✓ Should provide correct output for cells that contain only comments

PASS packages/malloy-db-trino/src/trino_connection.spec.ts
  Trino connection
    schema parser
      ✓ parses arrays (1 ms)
      ✓ parses inline
      ✓ parses nested
      ✓ parses a simple type
      ✓ parses a decimal integer type
      ✓ parses a decimal float type
      ✓ parses row with timestamp(3)
      ✓ parses deep nesting

PASS packages/malloy-syntax-highlight/grammars/malloy/malloy.spec.ts
  malloy
    ✓ correctly tokenizes
	"// / ' " """ // unable to break out of /* line comments"
	with correct colors (1 ms)
    ✓ correctly tokenizes
	" -- a different -- line comment"
	with correct colors
    ✓ correctly tokenizes
	"    /* *** / * // " " ' \'"
	"   """ multi-line * /*"
	"" */  -- escaped block"
	with correct colors
    ✓ correctly tokenizes
	"  sample: true"
	with correct colors
    ✓ correctly tokenizes
	"fl1ght_y34r is `Year of Flight 256/* */`  -- escapes identifier"
	with correct colors (1 ms)
    ✓ correctly tokenizes
	"`Year"
	"  -- escapes quoted identifier at newline"
	with correct colors
    ✓ correctly tokenizes
	"`Disposable Income` is (0.88 * b1) + 84 / 100.00 * b2 + (.79 * `b3`)  "
	with correct colors
    ✓ correctly tokenizes
	"(123E4, 1E-27, E4, 0E+1)"
	with correct colors
    ✓ correctly tokenizes
	"avg(count(distinct session_id))"
	with correct colors (1 ms)
    ✓ correctly tokenizes
	"`year` is year(dep_time)::string  // interpret year as 'categorical'"
	with correct colors
    ✓ correctly tokenizes
	"is hash!number(us3r_n4me)  -- SQL function usage"
	with correct colors
    ✓ correctly tokenizes
	"(@2001-02-03 04:05:06.001[America/Mexico_City], @2005-01-28 12:12:12.999, @1961-02-14 09:30:15, @2017-10-03 07:23) "
	with correct colors
    ✓ correctly tokenizes
	"event_time ~ @2003-Q1 for 6 quarters"
	with correct colors
    ✓ correctly tokenizes
	"(@2021, @2022-06, @2022-09-09, @2023-06-25-WK)"
	with correct colors (1 ms)
    ✓ correctly tokenizes
	"'a string with \escapes\u0FF1 \'more\"
	with correct colors
    ✓ correctly tokenizes
	"state ? """ multiple " " \u "" \u2001 ' /* -- // " \"
	" lines "
	" """  -- exited"
	with correct colors
    ✓ correctly tokenizes
	"/'regexp string /*-- \escapes\uFFFF \'more\"
	with correct colors (1 ms)
    ✓ correctly tokenizes
	""/* -- \e\uFFFF \'\"
	with correct colors
    ✓ correctly tokenizes
	"state ~ 'CA' | r'M.' | "CO" | /'O.'  -- end"
	with correct colors
    ✓ correctly tokenizes
	"run: duckdb.sql(""""
	"  SELECT 1"
	"""")"
	with correct colors

PASS packages/malloy/src/lang/test/model_serialization.spec.ts
  serializeModel
    ✓ Stringify on an `explore` with no parent nor source explore
    ✓ No parent nor source explore
    ✓ Having parent and source explores (1 ms)

PASS packages/malloy/src/lang/test/field-symbols.spec.ts
  structdef comprehension
    ✓ import string field
    ✓ import float field
    ✓ import integer field
    ✓ import boolean field
    ✓ import unsupported field
    ✓ import repeated record
    ✓ import inline field
    ✓ import join field
    ✓ import query stage field (1 ms)
    ✓ import struct with parameters

PASS packages/malloy/src/model/utils.spec.ts
  model/utils
    ✓ should generate deterministic hashes (1 ms)
    ✓ should generate unique hashes

Summary of all failing tests
FAIL test/src/databases/all/nomodel.spec.ts (35.567 s)
  ● parenthesize output field values - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'r',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 18 },
              end: { line: 2, character: 26 }
            }
          },
          e: { node: 'numberLiteral', literal: '1.0' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: '1.0'
        },
        {
          type: 'number',
          name: 'zero',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 10 },
              end: { line: 5, character: 28 }
            }
          },
          e: {
            node: '-',
            kids: {
              left: { node: 'numberLiteral', literal: '1' },
              right: {
                node: 'function_call',
                overload: {
                  returnType: {
                    type: 'number',
                    expressionType: 'scalar_analytic',
                    evalSpace: 'input'
                  },
                  params: [],
                  dialect: {
                    postgres: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    standardsql: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    duckdb: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    snowflake: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    trino: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    presto: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    mysql: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    databricks: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    },
                    redshift: {
                      e: {
                        node: 'genericSQLExpr',
                        kids: { args: [] },
                        src: [ 'RANK(', ')' ]
                      },
                      needsWindowOrderBy: true,
                      between: undefined,
                      defaultOrderByArgIndex: undefined
                    }
                  },
                  supportsOrderBy: undefined,
                  supportsLimit: undefined,
                  genericTypes: undefined,
                  isSymmetric: undefined
                },
                name: 'rank',
                kids: { args: [] },
                expressionType: 'scalar_analytic',
                structPath: undefined
              }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: '1 - rank()'
        },
        {
          type: 'number',
          name: 'zero_bare',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 6, character: 10 },
              end: { line: 6, character: 32 }
            }
          },
          e: {
            node: '-',
            kids: {
              left: { node: 'numberLiteral', literal: '0' },
              right: { node: 'outputField', name: 'zero' }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: '0 - zero'
        },
        {
          type: 'number',
          name: 'zero_paren',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 34 }
            }
          },
          e: {
            node: '-',
            kids: {
              left: { node: 'numberLiteral', literal: '0' },
              right: {
                node: '()',
                e: { node: 'outputField', name: 'zero' }
              }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: '0 - (zero)'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'r', dir: 'asc' } ]
    }
      |       run: redshift.table('malloytest.aircraft') -> {
      |            ^

      78 |           zero_paren is 0 - (zero)
      79 |       }
    > 80 |     `).malloyResultMatches(runtime, {zero_bare: 0, zero_paren: 0});
         |        ^
      81 |   });
      82 |
      83 |   // Issue: #151

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:80:8)

  ● bug 151 which used to throw unknown dialect is still fixed- redshift

    Could not prepare query to run: Cannot read properties of undefined (reading 'type')

      94 |         }
      95 |       } -> foo
    > 96 |       `).malloyResultMatches(runtime, {state: 'WY'});
         |          ^
      97 |   });
      98 |
      99 |   // Issue #149

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:96:10)

  ● refine query from query - redshift

    Could not prepare query to run: Cannot read properties of undefined (reading 'type')

      105 |           dimension: lower_state is lower(state)
      106 |         } -> {select: lower_state}
    > 107 |     `).malloyResultMatches(runtime, {lower_state: 'wy'});
          |        ^
      108 |   });
      109 |
      110 |   // issue #157

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:107:8)

  ● join_many - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'year_built' is not defined
      |             measure: avg_year is floor(avg(year_built))
      |                                            ^
    line 7: 'seats' is not defined
      |         measure: avg_seats is floor(avg(seats))
      |                                         ^
    line 6: 'aircraft_model_code' is not defined
      |           } on a.aircraft_model_code=aircraft_model_code
      |                ^
    line 6: 'aircraft_model_code' is not defined
      |           } on a.aircraft_model_code=aircraft_model_code
      |                                      ^

      137 |       }
      138 |       run: m->{aggregate: avg_seats, a.avg_year}
    > 139 |       `).malloyResultMatches(runtime, {avg_year: 1969, avg_seats: 7});
          |          ^
      140 |   });
      141 |
      142 |   it(`join_many condition no primary key - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:139:10)

  ● join_many condition no primary key - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         join_many: a on state=a.state
      |                         ^
    line 4: 'state' is not defined
      |         join_many: a on state=a.state
      |                               ^
    line 6: Reference to undefined value airport_count
      |       run: b->{aggregate: c is airport_count.sum()}
      |                                ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: b->{aggregate: c is airport_count.sum()}
      |            ^

      147 |       }
      148 |       run: b->{aggregate: c is airport_count.sum()}
    > 149 |     `).malloyResultMatches(runtime, {c: 19701});
          |        ^
      150 |   });
      151 |
      152 |   it(`join_many filter multiple values - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:149:8)

  ● join_many filter multiple values - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         where: state = 'NH' | 'CA'
      |                ^
    line 6: 'state' is not defined
      |         join_many: a on state=a.state
      |                         ^
    line 6: 'state' is not defined
      |         join_many: a on state=a.state
      |                               ^
    line 8: Reference to undefined value airport_count
      |         aggregate: c is airport_count.sum()
      |                         ^
    line 9: 'state' is not defined
      |         group_by: a.state
      |                   ^

      161 |         group_by: a.state
      162 |       }
    > 163 |     `).malloyResultMatches(runtime, [
          |        ^
      164 |       {state: null, c: 18605},
      165 |       {state: 'CA', c: 984},
      166 |       {state: 'NH', c: 112},

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:163:8)

  ● join_one condition no primary key - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         join_one: a on state=a.state
      |                        ^
    line 4: 'state' is not defined
      |         join_one: a on state=a.state
      |                              ^
    line 7: Reference to undefined value a.airport_count
      |         aggregate: c is a.airport_count.sum()
      |                         ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: b -> {
      |            ^

      177 |         aggregate: c is a.airport_count.sum()
      178 |       }
    > 179 |     `).malloyResultMatches(runtime, {c: 19701});
          |        ^
      180 |   });
      181 |
      182 |   it(`join_one filter multiple values - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:179:8)

  ● join_one filter multiple values - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         where: state = 'TX' | 'LA'
      |                ^
    line 6: 'state' is not defined
      |         join_one: a on state=a.state
      |                        ^
    line 6: 'state' is not defined
      |         join_one: a on state=a.state
      |                              ^
    line 9: Reference to undefined value a.airport_count
      |         aggregate: c is a.airport_count.sum()
      |                         ^
    line 10: 'state' is not defined
      |         group_by: a.state
      |                   ^

      192 |         group_by: a.state
      193 |       }
    > 194 |     `).malloyResultMatches(runtime, [
          |        ^
      195 |       {state: 'TX', c: 1845},
      196 |       {state: 'LA', c: 500},
      197 |       {state: null, c: 0},

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:194:8)

  ● join_many cross from  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'airport_count' is not defined
      |         dimension: x is airport_count/10000
      |                         ^
    line 10: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                     ^
    line 10: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                           ^
    line 13: Reference to undefined value airport_count
      |           left_sum is airport_count.sum()
      |                       ^
    line 14: Reference to undefined value a.airport_count
      |           right_sum is a.airport_count.sum()
      |                        ^

      220 |           right_small_sum is round(x.sum() * 10000)
      221 |       }
    > 222 |     `).malloyResultMatches(runtime, {
          |        ^
      223 |       row_count: 51 * 51,
      224 |       left_sum: 19701,
      225 |       right_sum: 19701,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:222:8)

  ● join_one only  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value airport_count
      |         aggregate: r is airport_count.sum()
      |                         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       query: q is redshift.table('malloytest.state_facts')->{
      |                   ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         join_one: a is q
      |                        ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         join_one: a is q
      |                        ^
    line 10: 'state' is not defined
      |           row_count is count(concat(state,a.r::string))
      |                                     ^
    line 10: 'r' is not defined
      |           row_count is count(concat(state,a.r::string))
      |                                           ^
    line 11: Reference to undefined value airport_count
      |           left_sum is airport_count.sum()
      |                       ^
    line 12: Reference to undefined value a.r
      |           right_sum is a.r.sum()
      |                        ^
    line 13: 'airport_count' is not defined
      |           sum_sum is sum(airport_count + a.r)
      |                          ^
    line 13: 'r' is not defined
      |           sum_sum is sum(airport_count + a.r)
      |                                          ^
    line 8: INTERNAL ERROR model/Segment.nextStructDef: Unknown Dialect ~malformed~
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'row_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 10 },
              end: { line: 9, character: 55 }
            }
          },
          e: {
            node: 'aggregate',
            function: 'distinct',
            e: {
              node: 'function_call',
              overload: {
                returnType: {
                  type: 'string',
                  expressionType: 'scalar',
                  evalSpace: 'input'
                },
                params: [
                  {
                    name: 'values',
                    allowedTypes: [
                      {
                        type: 'string',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'number',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'date',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'timestamp',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'boolean',
                        expressionType: undefined,
                        evalSpace: 'input'
                      }
                    ],
                    isVariadic: true
                  }
                ],
                dialect: {
                  postgres: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  standardsql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  duckdb: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  snowflake: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  trino: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  presto: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  mysql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  databricks: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  redshift: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  }
                },
                supportsOrderBy: undefined,
                supportsLimit: undefined,
                genericTypes: undefined,
                isSymmetric: undefined
              },
              name: 'concat',
              kids: {
                args: [
                  { node: 'error', message: 'field-not-found' },
                  {
                    node: 'cast',
                    dstType: { type: 'string' },
                    e: { node: 'error', message: 'field-not-found' },
                    safe: false
                  }
                ]
              },
              expressionType: 'scalar',
              structPath: undefined
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count(concat(state,a.r::string))'
        },
        {
          type: 'number',
          name: 'sum_sum',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 12, character: 10 },
              end: { line: 12, character: 45 }
            }
          },
          e: {
            node: 'aggregate',
            function: 'sum',
            e: { node: 'error', message: 'cascading error' }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'sum(airport_count + a.r)'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'row_count', dir: 'desc' } ]
    }
      |       run: f->{
      |            ^

      247 |           sum_sum is sum(airport_count + a.r)
      248 |       }
    > 249 |     `).malloyResultMatches(runtime, {
          |        ^
      250 |       row_count: 51,
      251 |       left_sum: 19701,
      252 |       right_sum: 19701,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:249:8)

  ● join_many cross ON  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         join_cross: a on a.state = 'CA' | 'NY'
      |                          ^
    line 8: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                     ^
    line 8: 'state' is not defined
      |           row_count is count(concat(state,a.state))
      |                                           ^
    line 9: Reference to undefined value airport_count
      |           left_sum is airport_count.sum()
      |                       ^
    line 10: Reference to undefined value a.airport_count
      |           right_sum is a.airport_count.sum()
      |                        ^
    line 6: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'row_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 51 }
            }
          },
          e: {
            node: 'aggregate',
            function: 'distinct',
            e: {
              node: 'function_call',
              overload: {
                returnType: {
                  type: 'string',
                  expressionType: 'scalar',
                  evalSpace: 'input'
                },
                params: [
                  {
                    name: 'values',
                    allowedTypes: [
                      {
                        type: 'string',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'number',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'date',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'timestamp',
                        expressionType: undefined,
                        evalSpace: 'input'
                      },
                      {
                        type: 'boolean',
                        expressionType: undefined,
                        evalSpace: 'input'
                      }
                    ],
                    isVariadic: true
                  }
                ],
                dialect: {
                  postgres: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  standardsql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  duckdb: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  snowflake: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  trino: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  presto: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: 'CAST(',
                            suffix: 'AS VARCHAR)'
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  mysql: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  databricks: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  },
                  redshift: {
                    e: {
                      node: 'genericSQLExpr',
                      kids: {
                        args: [
                          {
                            node: 'spread',
                            e: {
                              node: 'function_parameter',
                              name: 'values'
                            },
                            prefix: '',
                            suffix: ''
                          }
                        ]
                      },
                      src: [ 'CONCAT(', ')' ]
                    },
                    needsWindowOrderBy: undefined,
                    between: undefined,
                    defaultOrderByArgIndex: undefined
                  }
                },
                supportsOrderBy: undefined,
                supportsLimit: undefined,
                genericTypes: undefined,
                isSymmetric: undefined
              },
              name: 'concat',
              kids: {
                args: [
                  { node: 'error', message: 'field-not-found' },
                  { node: 'error', message: 'field-not-found' }
                ]
              },
              expressionType: 'scalar',
              structPath: undefined
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count(concat(state,a.state))'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'row_count', dir: 'desc' } ]
    }
      |       run: f->{
      |            ^

      270 |           right_sum is a.airport_count.sum()
      271 |       }
    > 272 |     `).malloyResultMatches(runtime, {
          |        ^
      273 |       row_count: 51 * 2,
      274 |       left_sum: 19701,
      275 |       right_sum: 1560,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:272:8)

  ● limit - provided - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 19 },
              end: { line: 3, character: 31 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      limit: 3,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● join inner- redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      343 |
      344 |       }
    > 345 |       `).malloyResultMatches(runtime, {
          |          ^
      346 |       ac_count: 28,
      347 |       ac_sum: 10402,
      348 |       am_count: 4,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:345:10)

  ● join left - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      369 |
      370 |       }
    > 371 |       `).malloyResultMatches(runtime, {
          |          ^
      372 |       ac_count: 49,
      373 |       ac_sum: 21336,
      374 |       am_count: 4,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:371:10)

  ● join right - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      395 |
      396 |       }
    > 397 |       `).malloyResultMatches(runtime, {
          |          ^
      398 |       ac_count: 28,
      399 |       ac_sum: 10402,
      400 |       am_count: 12,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:397:10)

  ● join full - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      423 |
      424 |       }
    > 425 |       `).malloyResultMatches(runtime, {
          |          ^
      426 |         ac_count: 49,
      427 |         ac_sum: 21336,
      428 |         am_count: 12,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:425:10)

  ● leafy count - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      452 |           root_count is count()
      453 |       }
    > 454 |       `).malloyResultMatches(runtime, {
          |          ^
      455 |       leafy_count: 0,
      456 |       root_count: 1,
      457 |     });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:454:10)

  ● nest/unnest -basic - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: c is airport_count.sum()
      |                         ^
    line 6: 'popular_name' is not defined
      |           group_by: popular_name
      |                     ^
    line 7: Reference to undefined value airport_count
      |           aggregate: d is airport_count.sum()
      |                           ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'turtle',
          name: 'p',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} }
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 14 },
              end: { line: 7, character: 9 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^
    line 10: 'state' is not defined
      |         group_by: state, c
      |                   ^
    line 10: 'c' is not defined
      |         group_by: state, c
      |                          ^
    line 11: Reference to undefined value p.d
      |         aggregate: p.d.sum()
      |         ^

      474 |         aggregate: p.d.sum()
      475 |       }
    > 476 |       `).malloyResultMatches(runtime, {
          |          ^
      477 |       state: 'TX',
      478 |       c: 1845,
      479 |       d: 1845,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:476:10)

  ● count at root should not use distinct key - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 34 },
              end: { line: 3, character: 46 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |       run: states -> { aggregate: c is count() }
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● leafy nested count - redshift

    Could not prepare query to run: Unknown Dialect ~malformed~

      521 |           root_count is count()
      522 |       }
    > 523 |       `).malloyResultMatches(runtime, {
          |          ^
      524 |         leafy_count: 0,
      525 |         root_count: 1,
      526 |         state: 'CA',

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:523:10)

  ● basic index - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'index',
      indexFields: [ { type: 'fieldref', path: [ 'undefined' ] } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.flights') -> {
      |            ^
    line 8: 'fieldName' is not defined
      |         where: fieldName = 'carrier'
      |                ^
    line 7: 'fieldValue' is not defined
      |         order_by: fieldValue
      |                   ^
    line 7: Unknown field fieldValue in output space
      |         order_by: fieldValue
      |         ^

      541 |         where: fieldName = 'carrier'
      542 |       }
    > 543 |       `).malloyResultMatches(runtime, {
          |          ^
      544 |       fieldValue: 'AA',
      545 |     });
      546 |   });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:543:10)

  ● number as null 2 - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |           group_by: state
      |                     ^
    line 5: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 6: 'airport_count' is not defined
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                                          ^
    line 6: Case insensitivity for function names is deprecated, use 'nullif' instead
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                               ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'turtle',
          name: 'ugly',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  name: 'foo',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 5, character: 23 },
                      end: { line: 5, character: 62 }
                    }
                  },
                  e: {
                    node: '+',
                    kids: {
                      left: {
                        node: 'function_call',
                        overload: {
                          returnType: {
                            type: 'generic',
                            generic: 'T',
                            expressionType: 'scalar',
                            evalSpace: 'input'
                          },
                          params: [
                            {
                              name: 'value1',
                              allowedTypes: [
                                {
                                  type: 'generic',
                                  generic: 'T',
                                  expressionType: undefined,
                                  evalSpace: 'input'
                                }
                              ],
                              isVariadic: false
                            },
                            {
                              name: 'value2',
                              allowedTypes: [
                                {
                                  type: 'generic',
                                  generic: 'T',
                                  expressionType: undefined,
                                  evalSpace: 'input'
                                }
                              ],
                              isVariadic: false
                            }
                          ],
                          dialect: {
                            postgres: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            standardsql: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            duckdb: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            snowflake: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            trino: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            presto: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            mysql: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            databricks: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            },
                            redshift: {
                              e: {
                                node: 'genericSQLExpr',
                                kids: {
                                  args: [
                                    {
                                      node: 'function_parameter',
                                      name: 'value1'
                                    },
                                    {
                                      node: 'function_parameter',
                                      name: 'value2'
                                    }
                                  ]
                                },
                                src: [ 'NULLIF(', ',', ')' ]
                              },
                              needsWindowOrderBy: undefined,
                              between: undefined,
                              defaultOrderByArgIndex: undefined
                            }
                          },
                          supportsOrderBy: undefined,
                          supportsLimit: undefined,
                          genericTypes: [
                            {
                              name: 'T',
                              acceptibleTypes: [
                                { type: 'string' },
                                { type: 'number' },
                                { type: 'timestamp' },
                                { type: 'date' },
                                { type: 'json' }
                              ]
                            }
                          ],
                          isSymmetric: undefined
                        },
                        name: 'NULLIF',
                        kids: {
                          args: [
                            {
                              node: 'error',
                              message: 'cascading error'
                            },
                            { node: 'numberLiteral', literal: '0' }
                          ]
                        },
                        expressionType: 'aggregate',
                        structPath: undefined
                      },
                      right: { node: 'numberLiteral', literal: '1' }
                    }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'NULLIF(sum(airport_count)*0,0)+1'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'foo', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 16 },
              end: { line: 6, character: 11 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         run: redshift.table('malloytest.state_facts') -> {
      |              ^

      560 |           }
      561 |         }
    > 562 |       `).malloyResultMatches(runtime, {'ugly.foo': null});
          |          ^
      563 |     }
      564 |   );
      565 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:562:10)

  ● sql block- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/4ef1fa50-932f-58cf-b506-4d969cfe055b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: one is redshift.sql("""
      |                                   ^
    line 5: Reference to undefined object 'one'
      |       run: one -> {
      |            ^

      571 |       run: one -> {
      572 |         select: a
    > 573 |       }`).malloyResultMatches(runtime, {a: 2});
          |           ^
      574 |   });
      575 |
      576 |   // average should only include non-null values in the denominator

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:573:11)

  ● avg ignore null- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/d62d0d1c-c2df-5ac8-b40f-e6972870c1c9: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: one is redshift.sql("""
      |                                   ^
    line 7: Reference to undefined object 'one'
      |       run: one -> {
      |            ^

      587 |           avg_a is a.avg()
      588 |           avg_b is x1.a.avg()
    > 589 |       }`).malloyResultMatches(runtime, {avg_a: 3});
          |           ^
      590 |   });
      591 |
      592 |   it(`limit - not provided - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:589:11)

  ● limit - not provided - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: 'state' is not defined
      |           group_by: state
      |                     ^
    line 1: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 21 },
              end: { line: 2, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      | run: redshift.table('malloytest.state_facts') -> {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ungrouped top level - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: total_births is births.sum()
      |                                  ^
    line 4: all() expression must be an aggregate
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                             ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                  ^
    line 6: 'state' is not defined
      |         group_by: state
      |                   ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: births_per_100k
      |                    ^

      613 |         group_by: state
      614 |         aggregate: births_per_100k
    > 615 |       }`).malloyResultMatches(runtime, {births_per_100k: 9742});
          |           ^
      616 |   });
      617 |
      618 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:615:11)

  ● ungrouped top level with nested  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: total_births is births.sum()
      |                                  ^
    line 4: all() expression must be an aggregate
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                             ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |         measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                  ^
    line 6: 'state' is not defined
      |         group_by: state
      |                   ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: births_per_100k
      |                    ^
    line 9: 'popular_name' is not defined
      |           group_by: popular_name
      |                     ^
    line 10: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           aggregate: total_births
      |                      ^

      631 |         }
      632 |         limit: 1000
    > 633 |       }`).malloyResultMatches(runtime, {births_per_100k: 9742});
          |           ^
      634 |     }
      635 |   );
      636 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:633:11)

  ● ungrouped - eliminate rows  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: m is all(births.sum())
      |                           ^
    line 3: all() expression must be an aggregate
      |         measure: m is all(births.sum())
      |                           ^
    line 4: 'state' is not defined
      |         where: state='CA' | 'NY'
      |                ^
    line 7: 'state' is not defined
      |         group_by: state
      |                   ^
    line 8: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: m
      |                    ^

      644 |         group_by: state
      645 |         aggregate: m
    > 646 |       }`).malloyResultMatches(runtime, [
          |           ^
      647 |       {state: 'CA', m: 52504699},
      648 |       {state: 'NY', m: 52504699},
      649 |     ]);

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:646:11)

  ● ungrouped nested with no grouping above - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 5: all() expression must be an aggregate
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                               ^
    line 5: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                    ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           aggregate: total_births
      |                      ^
    line 9: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 10: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: births_per_100k
      |                        ^

      664 |             aggregate: births_per_100k
      665 |           }
    > 666 |         }`).malloyResultMatches(runtime, {'by_name.births_per_100k': 66703});
          |             ^
      667 |     }
      668 |   );
      669 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:666:13)

  ● ungrouped - partial grouping - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |           where: state = 'TX' | 'NY'
      |                  ^
    line 7: 'faa_region' is not defined
      |             faa_region
      |             ^
    line 8: 'state' is not defined
      |             state
      |             ^
    line 12: 'fac_type' is not defined
      |             airport_count is c { where: fac_type = 'AIRPORT'}
      |                                         ^
    line 14: 'fac_type' is not defined
      |             group_by: fac_type
      |                       ^

      693 |           }
      694 |         }
    > 695 |       `).malloyResultMatches(runtime, {
          |          ^
      696 |         'fac_type.all_': 1845,
      697 |         'fac_type.all_state_region': 1845,
      698 |         'fac_type.all_of_this_type': 1782,

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:695:10)

  ● ungrouped - all nested - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |           where: state = 'TX' | 'NY'
      |                  ^
    line 7: 'state' is not defined
      |             state
      |             ^
    line 11: 'fac_type' is not defined
      |             airport_count is c { where: fac_type = 'AIRPORT'}
      |                                         ^
    line 13: 'fac_type' is not defined
      |             group_by: fac_type, major
      |                       ^
    line 13: 'major' is not defined
      |             group_by: fac_type, major
      |                                 ^

      724 |           }
      725 |         }
    > 726 |       `).malloyResultMatches(runtime, {
          |          ^
      727 |         'fac_type.all_': 1845,
      728 |         'fac_type.all_major': 1819,
      729 |       });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:726:10)

  ● ungrouped nested  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: all() expression must be an aggregate
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                               ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                    ^
    line 6: 'popular_name' is not defined
      |           group_by: popular_name
      |                     ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 9: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: births_per_100k
      |                        ^

      745 |           }
      746 |         }
    > 747 |       `).malloyResultMatches(runtime, {'by_state.births_per_100k': 36593});
          |          ^
      748 |     }
      749 |   );
      750 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:747:10)

  ● ungrouped nested expression  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: all() expression must be an aggregate
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                                                               ^
    line 4: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |           measure: births_per_100k is floor(total_births/ all(total_births) * 100000)
      |                    ^
    line 6: 'popular_name' is not defined
      |           group_by: upper_name is upper(popular_name)
      |                                         ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 9: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: births_per_100k
      |                        ^

      763 |           }
      764 |         }
    > 765 |       `).malloyResultMatches(runtime, {'by_state.births_per_100k': 36593});
          |          ^
      766 |     }
      767 |   );
      768 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:765:10)

  ● ungrouped nested group by float  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: all() expression must be an aggregate
      |           measure: ug is all(total_births)
      |                              ^
    line 6: 'airport_count' is not defined
      |           group_by: f is floor(airport_count/300.0)
      |                                ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 9: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |             aggregate: ug
      |                        ^

      781 |           }
      782 |         }
    > 783 |       `).malloyResultMatches(runtime, {'by_state.ug': 62742230});
          |          ^
      784 |     }
      785 |   );
      786 |

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:783:10)

  ● run simple sql - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://conn/0577cfdb-5132-5eb5-96c4-5c5bc052db83: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: conn.sql('select 1 as "one"')
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● simple sql is exactly as written - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://conn/0577cfdb-5132-5eb5-96c4-5c5bc052db83: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: conn.sql('select 1 as "one"')
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● source from query defined as sql query - redshift

    Unknown Dialect ~malformed~

      37 |   const d = dialectMap.get(name);
      38 |   if (d === undefined) {
    > 39 |     throw new Error(`Unknown Dialect ${name}`);
         |           ^
      40 |   }
      41 |   return d;
      42 | }

      at getDialect (packages/malloy/src/dialect/dialect_map.ts:39:11)
      at Document.checkExperimentalDialect (packages/malloy/src/lang/ast/types/malloy-element.ts:640:17)
      at Document.setEntry (packages/malloy/src/lang/ast/types/malloy-element.ts:623:12)
      at DefineSource.execute (packages/malloy/src/lang/ast/statements/define-source.ts:87:11)
      at DefineSourceList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:457:12)
      at DocStatementList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:452:26)
      at Document.compile (packages/malloy/src/lang/ast/types/malloy-element.ts:539:35)
      at TranslateStep.step (packages/malloy/src/lang/parse-malloy.ts:648:34)
      at MalloyTranslator.translate (packages/malloy/src/lang/parse-malloy.ts:935:40)
      at _callee$ (packages/malloy/src/malloy.ts:344:33)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● source from query defined as other query - redshift

    Unknown Dialect ~malformed~

      37 |   const d = dialectMap.get(name);
      38 |   if (d === undefined) {
    > 39 |     throw new Error(`Unknown Dialect ${name}`);
         |           ^
      40 |   }
      41 |   return d;
      42 | }

      at getDialect (packages/malloy/src/dialect/dialect_map.ts:39:11)
      at Document.checkExperimentalDialect (packages/malloy/src/lang/ast/types/malloy-element.ts:640:17)
      at Document.setEntry (packages/malloy/src/lang/ast/types/malloy-element.ts:623:12)
      at DefineSource.execute (packages/malloy/src/lang/ast/statements/define-source.ts:87:11)
      at DefineSourceList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:457:12)
      at DocStatementList.executeList (packages/malloy/src/lang/ast/types/malloy-element.ts:452:26)
      at Document.compile (packages/malloy/src/lang/ast/types/malloy-element.ts:539:35)
      at TranslateStep.step (packages/malloy/src/lang/parse-malloy.ts:648:34)
      at MalloyTranslator.translate (packages/malloy/src/lang/parse-malloy.ts:935:40)
      at _callee$ (packages/malloy/src/malloy.ts:344:33)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● all with parameters - basic  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |         measure: total_births is births.sum()
      |                                  ^
    line 5: 'popular_name' is not defined
      |         group_by: popular_name, state
      |                   ^
    line 5: 'state' is not defined
      |         group_by: popular_name, state
      |                                 ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           total_births
      |           ^
    line 8: all() expression must be an aggregate
      |           all_births is all(total_births)
      |                             ^
    line 9: exclude() expression must be an aggregate
      |           all_name is exclude(total_births, state)
      |                               ^

      843 |           all_name is exclude(total_births, state)
      844 |       }
    > 845 |     `).malloyResultMatches(runtime, {
          |        ^
      846 |       all_births: 295727065,
      847 |       all_name: 197260594,
      848 |     });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:845:8)

  ● all with parameters - nest  - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value births
      |           measure: total_births is births.sum()
      |                                    ^
    line 4: 'airport_count' is not defined
      |           dimension: abc is floor(airport_count/300)
      |                                   ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |           aggregate: total_births
      |                      ^
    line 9: 'popular_name' is not defined
      |             group_by: popular_name, state
      |                       ^
    line 9: 'state' is not defined
      |             group_by: popular_name, state
      |                                     ^
    line 11: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |               total_births
      |               ^
    line 12: all() expression must be an aggregate
      |               all_births is all(total_births)
      |                                 ^
    line 13: exclude() expression must be an aggregate
      |               all_name is exclude(total_births, state)
      |                                   ^

      867 |           }
      868 |         }
    > 869 |       `).malloyResultMatches(runtime, {
          |          ^
      870 |         'by_stuff.all_births': 119809719,
      871 |         'by_stuff.all_name': 61091215,
      872 |       });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:869:10)

  ● single value to udf - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1
    )
    , __stage1 AS (
      SELECT
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM UNNEST(ARRAY((SELECT TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT 
            "t__1"::DOUBLE PRECISION as "t") as __x)) FILTER (WHERE group_set=1))[1])))) as base
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:885:10)

  ● Multi value to udf - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        2 as "two__0",
        CASE WHEN group_set=1 THEN
          1
          END as "one__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3
    )
    , __stage1 AS (
      SELECT
        "two__0" as "two",
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
            "one__1"::DOUBLE PRECISION as "one", 
            "t__1"::DOUBLE PRECISION as "t"
            ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:904:10)

  ● Multi value to udf group by - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        CASE WHEN group_set=1 THEN
          1
          END as "one__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "t__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2
    )
    , __stage1 AS (
      SELECT
        (WITH __stage0 AS (
          SELECT 
             JSONB_EXTRACT_PATH_TEXT(base,'t')::double precision+1 as "t1"
          FROM JSONB_ARRAY_ELEMENTS(COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
            "one__1"::DOUBLE PRECISION as "one", 
            "t__1"::DOUBLE PRECISION as "t"
            ) as __x)  ORDER BY  "t__1" desc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB)) as base
          GROUP BY 1
          ORDER BY 1 asc NULLS LAST
        )
        SELECT JSONB_AGG(__stage0) FROM __stage0
        ) as "fun"
      FROM __stage0
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:920:10)

  ● sql as source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') -> {
      |            ^
    line 3: 'a' is not defined
      |         select: a
      |                 ^

      929 |         order_by: 1
      930 |       }
    > 931 |     `).malloyResultMatches(runtime, {a: 1});
          |        ^
      932 |   });
      933 |
      934 |   // have to add an order_by: otherwise it isn't deterministic.

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:931:8)

  ● sql directly - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4')->{
      |      ^
    line 3: 'a' is not defined
      |         order_by: a asc
      |                   ^
    line 3: Unknown field a in output space
      |         order_by: a asc
      |         ^

      939 |         order_by: a asc
      940 |       }`
    > 941 |     ).malloyResultMatches(runtime, {a: 1});
          |       ^
      942 |   });
      943 |
      944 |   // weirdly '*' must be the first thing in the select list in MySQL

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:941:7)

  ● sql with turducken- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 8: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 7: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'state_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 8, character: 23 },
              end: { line: 8, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'state_count', dir: 'desc' } ]
    }
      |           redshift.table('malloytest.state_facts') -> {
      |           ^
    line 2: Invalid SQL, Error: Redefinition of undefined
      |       run: redshift.sql("""
      |                         ^
    line 13: 'popular_name' is not defined
      |           select: *; where: popular_name = 'Emma'
      |                             ^
    line 14: 'state_count' is not defined
      |           order_by: state_count DESC
      |                     ^
    line 14: Unknown field state_count in output space
      |           order_by: state_count DESC
      |           ^

      959 |           order_by: state_count DESC
      960 |         }`;
    > 961 |     await expect(turduckenQuery).malloyResultMatches(runtime, {state_count: 6});
          |                                  ^
      962 |   });
      963 |
      964 |   // local declarations

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:961:34)

  ● local declarations external query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') -> {
      |            ^
    line 3: 'a' is not defined
      |         extend: { dimension: c is a + 1 }
      |                                   ^

      970 |         order_by: 1
      971 |       }
    > 972 |     `).malloyResultMatches(runtime, {c: 2});
          |        ^
      973 |   });
      974 |
      975 |   it(`local declarations named query - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:972:8)

  ● local declarations named query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') extend {
      |            ^
    line 4: 'a' is not defined
      |           extend: { dimension: c is a + 1 }
      |                                     ^

      982 |         }
      983 |       } -> bar
    > 984 |     `).malloyResultMatches(runtime, {c: 2});
          |        ^
      985 |   });
      986 |
      987 |   it(`local declarations refined named query - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:984:8)

  ● local declarations refined named query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/6f716047-130a-50e6-bdf0-b3a6c47b892b: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql('SELECT 1 as "a", 2 as "b" UNION ALL SELECT 3, 4') extend {
      |            ^
    line 4: 'a' is not defined
      |           extend: {dimension: c is a + 1}
      |                                    ^

       999 |         }
      1000 |       } -> baz
    > 1001 |     `).malloyResultMatches(runtime, {d: 3});
           |        ^
      1002 |   });
      1003 |
      1004 |   it(`regexp match- ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1001:8)

  ● regexp match- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b3d9302b-67e6-557a-ac21-08e7571d2402: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("""
      |                         ^
    line 6: 'a' is not defined
      |         aggregate: llo is count() {where: a ~ r'llo'}
      |                                           ^
    line 7: 'a' is not defined
      |         aggregate: m2 is count() {where: a !~ r'bozo'}
      |                                          ^

      1011 |         aggregate: m2 is count() {where: a !~ r'bozo'}
      1012 |       }
    > 1013 |     `).malloyResultMatches(runtime, {llo: 2, m2: 1});
           |        ^
      1014 |   });
      1015 |
      1016 |   it(`substitution precedence- ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1013:8)

  ● substitution precedence- redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/4b582cd6-4cc7-5e32-82ab-f13111063e5d: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("""
      |                         ^
    line 6: 'b' is not defined
      |         extend: {dimension:  c is b + 4}
      |                                   ^
    line 7: 'a' is not defined
      |         select: x is  a * c
      |                       ^

      1024 |         order_by: x desc
      1025 |       }
    > 1026 |       `).malloyResultMatches(runtime, {x: 30});
           |          ^
      1027 |   });
      1028 |
      1029 |   test.when(runtime.supportsNesting && runtime.dialect.supportsArraysInData)(

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1026:10)

  ● array unnest - redshift

    TypeError: splitFN is not a function

      1035 |         SELECT
      1036 |           ${q`city`},
    > 1037 |           ${splitFN!(q`city`, ' ')} as ${q`words`}
           |             ^
      1038 |         FROM ${rootDbPath(databaseName)}malloytest.aircraft
      1039 |       """) -> {
      1040 |         where: words.value is not null

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1037:13)

  ● array unnest x 2 - redshift

    TypeError: splitFN is not a function

      1055 |         SELECT
      1056 |           ${q`city`},
    > 1057 |           ${splitFN!(q`city`, ' ')} as ${q`words`},
           |             ^
      1058 |           ${splitFN!(q`city`, 'A')} as ${q`abreak`}
      1059 |         FROM ${rootDbPath(databaseName)}malloytest.aircraft
      1060 |         WHERE ${q`city`} IS NOT null

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1057:13)

  ● nest null - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'faa_region' is not defined
      |           where: faa_region is null
      |                  ^
    line 4: 'faa_region' is not defined
      |           group_by: faa_region
      |                     ^
    line 7: 'state' is not defined
      |             where: state is not null
      |                    ^
    line 8: 'state' is not defined
      |             group_by: state
      |                       ^
    line 12: 'state' is not defined
      |             where: state is not null
      |                    ^
    line 13: 'state' is not defined
      |             group_by: state
      |                       ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'airport_count',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 21 },
              end: { line: 4, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        },
        {
          type: 'turtle',
          name: 'by_state',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'airport_count',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 8, character: 23 },
                      end: { line: 8, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [
                {
                  node: 'filterCondition',
                  code: 'state is not null',
                  e: {
                    node: 'is-not-null',
                    e: { node: 'error', message: 'field-not-found' }
                  },
                  expressionType: 'scalar',
                  compositeFieldUsage: { fields: [], joinedUsage: {} }
                }
              ],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'airport_count', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 16 },
              end: { line: 9, character: 11 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        },
        {
          type: 'turtle',
          name: 'by_state1',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'airport_count',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 13, character: 23 },
                      end: { line: 13, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              limit: 1,
              filterList: [
                {
                  node: 'filterCondition',
                  code: 'state is not null',
                  e: {
                    node: 'is-not-null',
                    e: { node: 'error', message: 'field-not-found' }
                  },
                  expressionType: 'scalar',
                  compositeFieldUsage: { fields: [], joinedUsage: {} }
                }
              ],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'airport_count', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 10, character: 16 },
              end: { line: 15, character: 11 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [
        {
          node: 'filterCondition',
          code: 'faa_region is null',
          e: {
            node: 'is-null',
            e: { node: 'error', message: 'field-not-found' }
          },
          expressionType: 'scalar',
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'airport_count', dir: 'desc' } ]
    }
      |         run: redshift.table('malloytest.airports') -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● Nested pipelines sort properly - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 6: 'airport_count' is not defined
      |                 aggregate: airports is sum(airport_count)
      |                                            ^
    line 11: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 12: Reference to undefined value airports
      |                 aggregate: airports.sum()
      |                 ^
    line 12: Reference to undefined value airports
      |                 aggregate: airports.sum()
      |                 ^
    line 16: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 17: 'aircraft_count' is not defined
      |                 aggregate: aircrafts is sum(aircraft_count)
      |                                             ^
    line 22: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 23: Reference to undefined value aircrafts
      |                 aggregate: aircrafts.sum()
      |                 ^
    line 23: Reference to undefined value aircrafts
      |                 aggregate: aircrafts.sum()
      |                 ^
    line 27: 'state' is not defined
      |                 group_by: state
      |                           ^
    line 28: 'aircraft_count' is not defined
      |                 aggregate: aircrafts is sum(aircraft_count)
      |                                             ^
    line 31: 'state' is not defined
      |               group_by: state
      |                         ^
    line 32: Reference to undefined value aircrafts
      |               aggregate: aircrafts.sum()
      |               ^
    line 35: 'popular_name' is not defined
      |                 where: popular_name ~ r'I'
      |                        ^
    line 36: 'popular_name' is not defined
      |                 group_by: popular_name
      |                           ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● number as null- redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'state' is not defined
      |           group_by: state
      |                     ^
    line 7: 'popular_name' is not defined
      |             group_by: popular_name
      |                       ^
    line 8: 'airport_count' is not defined
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                                          ^
    line 8: Case insensitivity for function names is deprecated, use 'nullif' instead
      |             aggregate: foo is NULLIF(sum(airport_count)*0,0)+1
      |                               ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - solo aggregates - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - pipeline - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^
    line 8: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - joined_query - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       query: foo is  redshift.table('malloytest.state_facts') -> {
      |                      ^
    line 10: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 10: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 10: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                            ^
    line 10: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                                    ^
    line 12: Reference to undefined value foo.airport_count
      |         aggregate: x is foo.airport_count.sum()
      |                         ^
    line 8: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      extendSource: [
        {
          type: 'query_source',
          name: 'foo',
          dialect: '~malformed~',
          connection: '~unknown~',
          tablePath: '//undefined_error_table_path',
          fields: [],
          errorFactory: true,
          query: {
            type: 'query',
            structRef: {
              type: 'table',
              name: 'redshift:malloytest.state_facts',
              dialect: 'redshift',
              tablePath: 'malloytest.state_facts',
              connection: 'redshift',
              fields: [
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                }
              ],
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 1, character: 21 },
                  end: { line: 1, character: 61 }
                }
              }
            },
            pipeline: [
              {
                type: 'reduce',
                queryFields: [],
                orderBy: [ { field: 'state', dir: 'desc' } ],
                filterList: [],
                compositeFieldUsage: { fields: [], joinedUsage: {} }
              }
            ],
            location: {
              url: 'internal://internal.malloy',
              range: {
                start: { line: 1, character: 13 },
                end: { line: 5, character: 7 }
              }
            },
            name: 'foo',
            annotation: undefined,
            compositeResolvedSourceDef: undefined
          },
          parameters: undefined,
          join: 'one',
          matrixOperation: 'left',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 20 },
              end: { line: 9, character: 44 }
            }
          },
          onExpression: { node: 'error', message: 'cascading error' },
          onCompositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● removes surpuflous order_by - joined_query pipeline - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         group_by: state
      |                   ^
    line 4: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       query: foo is  redshift.table('malloytest.state_facts') -> {
      |                      ^
    line 7: 'state' is not defined
      |         group_by: state
      |                   ^
    line 8: Reference to undefined value airport_count
      |         aggregate: airport_count.sum()
      |         ^
    line 14: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 14: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      orderBy: [ { field: 'state', dir: 'desc' } ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |           join_one: foo on state = foo.state
      |                     ^
    line 14: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                            ^
    line 14: 'state' is not defined
      |           join_one: foo on state = foo.state
      |                                    ^
    line 16: Reference to undefined value foo.airport_count
      |         aggregate: x is foo.airport_count.sum()
      |                         ^
    line 12: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      extendSource: [
        {
          type: 'query_source',
          name: 'foo',
          dialect: '~malformed~',
          connection: '~unknown~',
          tablePath: '//undefined_error_table_path',
          fields: [],
          errorFactory: true,
          query: {
            type: 'query',
            structRef: {
              type: 'table',
              name: 'redshift:malloytest.state_facts',
              dialect: 'redshift',
              tablePath: 'malloytest.state_facts',
              connection: 'redshift',
              fields: [
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                },
                {
                  type: 'string',
                  name: undefined,
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 1, character: 21 },
                      end: { line: 1, character: 61 }
                    }
                  }
                }
              ],
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 1, character: 21 },
                  end: { line: 1, character: 61 }
                }
              }
            },
            pipeline: [
              {
                type: 'reduce',
                queryFields: [],
                orderBy: [ { field: 'state', dir: 'desc' } ],
                filterList: [],
                compositeFieldUsage: { fields: [], joinedUsage: {} }
              },
              {
                type: 'reduce',
                queryFields: [],
                orderBy: [ { field: 'state', dir: 'desc' } ],
                filterList: [],
                compositeFieldUsage: { fields: [], joinedUsage: {} }
              }
            ],
            location: {
              url: 'internal://internal.malloy',
              range: {
                start: { line: 1, character: 13 },
                end: { line: 9, character: 7 }
              }
            },
            name: 'foo',
            annotation: undefined,
            compositeResolvedSourceDef: undefined
          },
          parameters: undefined,
          join: 'one',
          matrixOperation: 'left',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 13, character: 20 },
              end: { line: 13, character: 44 }
            }
          },
          onExpression: { node: 'error', message: 'cascading error' },
          onCompositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● quoting and strings › backslash quote

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql('SELECT 1 as one') -> {
      |              ^

      1341 |           select: tick is '${back}${tick}'
      1342 |         }
    > 1343 |       `).malloyResultMatches(runtime, {tick});
           |          ^
      1344 |     });
      1345 |     test('backslash backslash', async () => {
      1346 |       await expect(`

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1343:10)

  ● quoting and strings › backslash backslash

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      1348 |           select: back is '${back}${back}'
      1349 |         }
    > 1350 |       `).malloyResultMatches(runtime, {back});
           |          ^
      1351 |     });
      1352 |
      1353 |     test('source with reserve word', async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1350:10)

  ● quoting and strings › source with reserve word

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |         run: create -> {
      |              ^

      1357 |           aggregate: c is count()
      1358 |         }
    > 1359 |       `).malloyResultMatches(runtime, {c: 51});
           |          ^
      1360 |     });
      1361 |
      1362 |     test.when(runtime.supportsNesting)('spaces in names', async () => {

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1359:10)

  ● quoting and strings › spaces in names

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |           join_one: `j space` is redshift.table('malloytest.state_facts') on `j space`.state=state
      |                                                                              ^
    line 3: 'state' is not defined
      |           join_one: `j space` is redshift.table('malloytest.state_facts') on `j space`.state=state
      |                                                                                              ^
    line 6: 'popular_name' is not defined
      |               `P O P` is popular_name
      |                          ^
    line 7: 'popular_name' is not defined
      |               `J P O P` is `j space`.popular_name
      |                            ^
    line 13: 'state' is not defined
      |               group_by: `J S` is `j space`.state
      |                                  ^
    line 12: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c o u n t',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 13, character: 25 },
              end: { line: 13, character: 47 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
    }
      |             nest: `by state` is {
      |                   ^
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c o u n t',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 23 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        },
        {
          type: 'number',
          name: 'R O W',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 14 },
              end: { line: 9, character: 37 }
            }
          },
          e: {
            node: 'function_call',
            overload: {
              returnType: {
                type: 'number',
                expressionType: 'scalar_analytic',
                evalSpace: 'input'
              },
              params: [],
              dialect: {
                postgres: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                standardsql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                duckdb: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                snowflake: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                trino: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                presto: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                mysql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                databricks: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                redshift: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                }
              },
              supportsOrderBy: undefined,
              supportsLimit: undefined,
              genericTypes: undefined,
              isSymmetric: undefined
            },
            name: 'row_number',
            kids: { args: [] },
            expressionType: 'scalar_analytic',
            structPath: undefined
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: 'row_number()'
        },
        {
          type: 'turtle',
          name: 'by state',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'c o u n t',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 13, character: 25 },
                      end: { line: 13, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 18 },
              end: { line: 14, character: 13 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
    }
      |           view: `q u e r y` is {
      |                 ^
    line 18: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c o u n t',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 23 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        },
        {
          type: 'number',
          name: 'R O W',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 14 },
              end: { line: 9, character: 37 }
            }
          },
          e: {
            node: 'function_call',
            overload: {
              returnType: {
                type: 'number',
                expressionType: 'scalar_analytic',
                evalSpace: 'input'
              },
              params: [],
              dialect: {
                postgres: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                standardsql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                duckdb: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                snowflake: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                trino: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                presto: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                mysql: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                databricks: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                },
                redshift: {
                  e: {
                    node: 'genericSQLExpr',
                    kids: { args: [] },
                    src: [ 'ROW_NUMBER(', ')' ]
                  },
                  needsWindowOrderBy: true,
                  between: undefined,
                  defaultOrderByArgIndex: undefined
                }
              },
              supportsOrderBy: undefined,
              supportsLimit: undefined,
              genericTypes: undefined,
              isSymmetric: undefined
            },
            name: 'row_number',
            kids: { args: [] },
            expressionType: 'scalar_analytic',
            structPath: undefined
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar_analytic',
          code: 'row_number()'
        },
        {
          type: 'turtle',
          name: 'by state',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'c o u n t',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 13, character: 25 },
                      end: { line: 13, character: 47 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 18 },
              end: { line: 14, character: 13 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c o u n t', dir: 'desc' } ]
    }
      |         run: `space race` -> `q u e r y`
      |                              ^

      1379 |         }
      1380 |         run: \`space race\` -> \`q u e r y\`
    > 1381 |       `).malloyResultMatches(runtime, {'c o u n t': 24});
           |          ^
      1382 |     });
      1383 |   });
      1384 | });

      at Object.<anonymous> (test/src/databases/all/nomodel.spec.ts:1381:10)

FAIL test/src/databases/all/expr.spec.ts (22.464 s)
  ● redshift › basic calculations

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      76 |           percent_boeing_floor,
      77 |       }
    > 78 |     `).malloyResultMatches(expressionModel, {
         |        ^
      79 |       total_seats: 452415,
      80 |       total_seats2: 452415,
      81 |       boeing_seats: 252771,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:78:8)

  ● redshift › join dependencies tracked from annotated references

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      92 |           group_by: aircraft_models.seats
      93 |         }
    > 94 |     `).malloyResultMatches(expressionModel, {
         |        ^
      95 |       seats: 0,
      96 |     });
      97 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:94:8)

  ● redshift › Floor() -or any function bustage with aggregates

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      105 |           percent_boeing_floor2 is floor(boeing_seats / total_seats * 100)
      106 |       }
    > 107 |     `).malloyResultMatches(expressionModel, {
          |        ^
      108 |       percent_boeing_floor: 55,
      109 |       percent_boeing_floor2: 55,
      110 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:107:8)

  ● redshift › computes mod correctly

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/8492fb55-e4fb-5805-adc6-f3d175aaafa9: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       run: redshift.sql("SELECT 10 as ten") -> {select: mod is 10 % 3}
      |            ^

      114 |     await expect(`
      115 |       run: ${databaseName}.sql("SELECT 10 as ten") -> {select: mod is 10 % 3}
    > 116 |     `).malloyResultMatches(runtime, {mod: 1});
          |        ^
      117 |   });
      118 |
      119 |   // Model based version of sums.

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:116:8)

  ● redshift › model: expression fixups.

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      125 |           aircraft_models.boeing_seats
      126 |       }
    > 127 |     `).malloyResultMatches(expressionModel, {
          |        ^
      128 |       total_seats: 18294,
      129 |       boeing_seats: 6244,
      130 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:127:8)

  ● redshift › simple turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      145 |         limit: 3
      146 |       }
    > 147 |     `).malloyResultMatches(expressionModel, {
          |        ^
      148 |       'by_state.state': 'TX',
      149 |       'by_state.airport_count': 1845,
      150 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:147:8)

  ● redshift › double turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      169 |         }
      170 |       }
    > 171 |     `).malloyResultMatches(expressionModel, {
          |        ^
      172 |       'o.by_state.state': 'TX',
      173 |       'o.by_state.airport_count': 1845,
      174 |       'o.airport_count': 11146,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:171:8)

  ● redshift › double turtle - pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      195 |         aggregate: o.by_state.airport_count.sum()
      196 |       }
    > 197 |     `).malloyResultMatches(expressionModel, {
          |        ^
      198 |       'airport_count': 5023,
      199 |     });
      200 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:197:8)

  ● redshift › model: turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      202 |   // turtle expressions
      203 |   it('model: turtle', async () => {
    > 204 |     await expect('run: aircraft->by_manufacturer').malloyResultMatches(
          |                                                    ^
      205 |       expressionModel,
      206 |       {manufacturer: 'CESSNA'}
      207 |     );

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:204:52)

  ● redshift › model: filtered turtle

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      214 |         nest: b is by_manufacturer + { where: aircraft_models.manufacturer ?~'B%'}
      215 |       }
    > 216 |     `).malloyResultMatches(expressionModel, {'b.manufacturer': 'BEECH'});
          |        ^
      217 |   });
      218 |
      219 |   // having.

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:216:8)

  ● redshift › model: simple having

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      227 |         limit: 2
      228 |       }
    > 229 |     `).malloyResultMatches(expressionModel, {aircraft_count: 91});
          |        ^
      230 |   });
      231 |
      232 |   test.when(runtime.supportsNesting)('model: having in a nest', async () => {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:229:8)

  ● redshift › model: having in a nest

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      245 |         }
      246 |       }
    > 247 |     `).malloyResultMatches(expressionModel, {'by_state.state': 'VA'});
          |        ^
      248 |   });
      249 |
      250 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:247:8)

  ● redshift › model: turtle having on main

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      270 |         }
      271 |       }
    > 272 |     `).malloyResultMatches(expressionModel, {
          |        ^
      273 |         'by_state.by_city.city': 'ALBUQUERQUE',
      274 |       });
      275 |     }

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:272:8)

  ● redshift › model: having float group by partition

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^
    line 31: 'engines' is not defined
      |             group_by: engines
      |                       ^

      291 |             aggregate: aircraft_model_count
      292 |           }
    > 293 |       }`).malloyResultMatches(runtime, {aircraft_model_count: 448});
          |           ^
      294 |     }
      295 |   );
      296 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:293:11)

  ● redshift › model: aggregate functions distinct min max

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      310 |           boeing_max_model is max(model) { where: manufacturer ? 'BOEING'},
      311 |       }
    > 312 |     `).malloyResultMatches(expressionModel, {
          |        ^
      313 |       distinct_seats: 187,
      314 |       boeing_distinct_seats: 85,
      315 |       min_seats: 0,

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:312:8)

  ● redshift › model: dates named

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 't_date' is not defined
      |           t_date,
      |           ^
    line 5: 't_date' is not defined
      |           t_date_month is t_date.month,
      |                           ^
    line 6: 't_date' is not defined
      |           t_date_year is t_date.year,
      |                          ^
    line 7: 't_timestamp' is not defined
      |           t_timestamp,
      |           ^
    line 8: 't_timestamp' is not defined
      |           t_timestamp_date is t_timestamp.day,
      |                               ^
    line 9: 't_timestamp' is not defined
      |           t_timestamp_hour is t_timestamp.hour,
      |                               ^
    line 10: 't_timestamp' is not defined
      |           t_timestamp_minute is t_timestamp.minute,
      |                                 ^
    line 11: 't_timestamp' is not defined
      |           t_timestamp_second is t_timestamp.second,
      |                                 ^
    line 12: 't_timestamp' is not defined
      |           t_timestamp_month is t_timestamp.month,
      |                                ^
    line 13: 't_timestamp' is not defined
      |           t_timestamp_year is t_timestamp.year,
      |                               ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'date',
          name: 't_date_month',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 10 },
              end: { line: 4, character: 38 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_date.month'
        },
        {
          type: 'date',
          name: 't_date_year',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 5, character: 10 },
              end: { line: 5, character: 36 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_date.year'
        },
        {
          type: 'date',
          name: 't_timestamp_date',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 7, character: 10 },
              end: { line: 7, character: 45 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.day'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_hour',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 8, character: 10 },
              end: { line: 8, character: 46 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.hour'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_minute',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 9, character: 10 },
              end: { line: 9, character: 50 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.minute'
        },
        {
          type: 'timestamp',
          name: 't_timestamp_second',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 10, character: 10 },
              end: { line: 10, character: 50 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.second'
        },
        {
          type: 'date',
          name: 't_timestamp_month',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 11, character: 10 },
              end: { line: 11, character: 48 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.month'
        },
        {
          type: 'date',
          name: 't_timestamp_year',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 12, character: 10 },
              end: { line: 12, character: 46 }
            }
          },
          e: { node: 'error', message: 'granularity typecheck' },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'scalar',
          code: 't_timestamp.year'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 't_date_month', dir: 'desc' } ]
    }
      |       run: redshift.table('malloytest.alltypes')->{
      |            ^

      343 |           t_timestamp_year is t_timestamp.year,
      344 |       }
    > 345 |     `).malloyResultMatches(runtime, {
          |        ^
      346 |         t_date: new Date('2020-03-02'),
      347 |         t_date_month: new Date('2020-03-01'),
      348 |         t_date_year: new Date('2020-01-01'),

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:345:8)

  ● redshift › named query metadata undefined

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › named query metadata named

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › named query metadata named head of pipeline

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › filtered explores basic

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      399 |       run: aircraft extend { where: aircraft_models.manufacturer ? ~'B%' }
      400 |         -> {aggregate: m_count is count(aircraft_models.manufacturer) }
    > 401 |     `).malloyResultMatches(expressionModel, {m_count: 63});
          |        ^
      402 |   });
      403 |
      404 |   const nativeInt = databaseName === 'mysql' ? 'signed' : 'integer';

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:401:8)

  ● redshift › sql cast

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      408 |         group_by: a is "312"::"${nativeInt}"
      409 |       }
    > 410 |     `).malloyResultMatches(expressionModel, {a: 312});
          |        ^
      411 |   });
      412 |
      413 |   it('case expressions', async () => {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:410:8)

  ● redshift › case expressions

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      422 |           valuey is case manufacturer when 'BOEING' then 'BOEING' else 'NOT BOEING' end
      423 |       }
    > 424 |     `).malloyResultMatches(expressionModel, [
          |        ^
      425 |       {other: 'BOEING', nully: 'BOEING', valuey: 'BOEING'},
      426 |       {other: 'OTHER', nully: null, valuey: 'NOT BOEING'},
      427 |     ]);

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:424:8)

  ● redshift › sql safe cast

    Expected events - Expected
    + Received

      Array [
        Object {
          "data": Object {
    -       "code": "dialect-cast-unsafe-only",
    +       "code": "invalid-sql-source",
    +       "data": null,
    +       "message": "Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED",
          },
          "id": "translation-error",
        },
      ]

      443 |       });
      444 |     } else {
    > 445 |       await expect(safeCast).toEmitDuringTranslation(runtime, {
          |                              ^
      446 |         id: 'translation-error',
      447 |         data: {code: 'dialect-cast-unsafe-only'},
      448 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:445:30)

  ● redshift › many_field.sum() has correct locality

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: 'year_built' is not defined
      |         dimension: a_year_built is a.year_built
      |                                    ^
    line 4: 'aircraft_model_code' is not defined
      |         join_many: a on a.aircraft_model_code = a.aircraft_model_code
      |                         ^
    line 4: 'aircraft_model_code' is not defined
      |         join_many: a on a.aircraft_model_code = a.aircraft_model_code
      |                                                 ^

      462 |         aggregate: avg_a_year_built2 is floor(a.avg(a_year_built))
      463 |       }
    > 464 |     `).malloyResultMatches(runtime, {
          |        ^
      465 |       avg_a_year_built1: 1969,
      466 |       avg_a_year_built2: 1969,
      467 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:464:8)

  ● redshift › sql expr functions › sql_string

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      477 |           group_by: string_1 is sql_string("UPPER(\${manufacturer})")
      478 |         }
    > 479 |       `).malloyResultMatches(expressionModel, {
          |          ^
      480 |         string_1: 'AHRENS AIRCRAFT CORP.',
      481 |       });
      482 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:479:10)

  ● redshift › sql expr functions › sql_number

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      491 |           group_by: number_1 is sql_number("\${seats} * 2")
      492 |         }
    > 493 |   `).malloyResultMatches(expressionModel, {
          |      ^
      494 |         seats: 29,
      495 |         number_1: 58,
      496 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:493:6)

  ● redshift › sql expr functions › sql_number can be sum()med

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      508 |           aggregate: s is number_1.sum()
      509 |         }
    > 510 |       `).malloyResultMatches(expressionModel, {
          |          ^
      511 |         s: 58,
      512 |       });
      513 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:510:10)

  ● redshift › sql expr functions › sql_boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      522 |           group_by: boolean_2 is sql_boolean("\${engines} = 2")
      523 |         }
    > 524 |   `).malloyResultMatches(expressionModel, {
          |      ^
      525 |         boolean_1: booleanResult(true, databaseName),
      526 |         boolean_2: booleanResult(false, databaseName),
      527 |       });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:524:6)

  ● redshift › sql expr functions › sql_date

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      536 |           group_by: date_1 is sql_date("\${last_action_date}")
      537 |         }
    > 538 |   `).malloyResultMatches(expressionModel, {
          |      ^
      539 |         date_1: new Date('2000-01-04T00:00:00.000Z'),
      540 |       });
      541 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:538:6)

  ● redshift › sql expr functions › sql_timestamp

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      549 |         group_by: timestamp_1 is sql_timestamp("\${last_action_date}")
      550 |         }
    > 551 |   `).malloyResultMatches(expressionModel, {
          |      ^
      552 |         timestamp_1: new Date('2000-01-04T00:00:00.000Z'),
      553 |       });
      554 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:551:6)

  ● redshift › sql expr functions › with ${TABLE}.field

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      562 |           group_by: string_1 is sql_string('UPPER(\${TABLE}.${q`manufacturer`})')
      563 |         }
    > 564 |       `).malloyResultMatches(expressionModel, {
          |          ^
      565 |         string_1: 'AHRENS AIRCRAFT CORP.',
      566 |       });
      567 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:564:10)

  ● redshift › sql expr functions › with ${field}

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      575 |           group_by: string_1 is sql_string("UPPER(\${manufacturer})")
      576 |         }
    > 577 |       `).malloyResultMatches(expressionModel, {
          |          ^
      578 |         string_1: 'AHRENS AIRCRAFT CORP.',
      579 |       });
      580 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:577:10)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.dimension_name} - one path

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found ${a.manufacturer}"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:596:43)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.dimension_name} - multiple paths

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found (${a.seats}, ${a.seats}, ${a.total_seats})"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:612:43)

  ● redshift › sql expr functions › [not yet supported] › ${view_name.SQL_TABLE_NAME}

    expect(received).rejects.toThrow(expected)

    Expected substring: "'.' paths are not yet supported in sql interpolations, found ${a.SQL_TABLE_NAME}"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:628:43)

  ● redshift › query with aliasname used twice

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      654 |             order_by: 2 desc, 1
      655 |         }
    > 656 |       `).malloyResultMatches(expressionModel, {first_three: 'SAB'});
          |          ^
      657 |     }
      658 |   );
      659 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:656:10)

  ● redshift › joined filtered sources

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      676 |           aircraft_count
      677 |       }
    > 678 |     `).malloyResultMatches(expressionModel, {
          |        ^
      679 |       model_count: 244,
      680 |       aircraft_count: 3599,
      681 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:678:8)

  ● redshift › joined filtered explores with NO dependencies

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         primary_key: state
      |         ^
    line 7: 'state' is not defined
      |       source: al is sf extend {where: state = 'AL'}
      |                                       ^
    line 11: 'state' is not defined
      |         join_one: al with state
      |                           ^
    line 11: join_one: Primary key 'undefined' not found in source
      |         join_one: al with state
      |                   ^
    line 10: 'state' is not defined
      |         where: state ~ 'A%'
      |                ^
    line 15: 'state' is not defined
      |         join_one: a with state
      |                          ^
    line 15: join_one: Primary key 'undefined' not found in source
      |         join_one: a with state
      |                   ^
    line 18: INTERNAL ERROR model/Segment.nextStructDef: state not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'allx',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 19, character: 10 },
              end: { line: 19, character: 29 }
            }
          },
          e: { node: 'field', path: [ 'state_count' ] },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'state_count'
        },
        {
          type: 'number',
          numberType: 'integer',
          name: 'a',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 20, character: 10 },
              end: { line: 20, character: 28 }
            }
          },
          e: { node: 'field', path: [ 'a', 'state_count' ] },
          compositeFieldUsage: {
            fields: [],
            joinedUsage: { a: { fields: [], joinedUsage: {} } }
          },
          expressionType: 'aggregate',
          code: 'a.state_count'
        },
        {
          type: 'number',
          numberType: 'integer',
          name: 'al',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 21, character: 10 },
              end: { line: 21, character: 32 }
            }
          },
          e: { node: 'field', path: [ 'a', 'al', 'state_count' ] },
          compositeFieldUsage: {
            fields: [],
            joinedUsage: {
              a: {
                fields: [],
                joinedUsage: { al: { fields: [], joinedUsage: {} } }
              }
            }
          },
          expressionType: 'aggregate',
          code: 'a.al.state_count'
        }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: {
          a: {
            fields: [],
            joinedUsage: { al: { fields: [], joinedUsage: {} } }
          }
        }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'allx', dir: 'desc' } ]
    }
      |       run: allx -> {
      |            ^

      741 |           al is a.al.state_count
      742 |       }
    > 743 |     `).malloyResultMatches(runtime, {allx: 51, a: 4, al: 1});
          |        ^
      744 |   });
      745 | });
      746 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:743:8)

  ● redshift › string literal quoting › quote single character

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string literal quoting › quote single quote

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string literal quoting › quote double quote

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") -> {
      |      ^

      811 |           select: double_quote is "${back}${dq}"
      812 |         }`
    > 813 |       ).malloyResultMatches(runtime, {double_quote: '"'});
          |         ^
      814 |     });
      815 |     test('quote backslash', async () => {
      816 |       expect(await sqlEq(`'${back}${back}'`, back)).isSqlEq();

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:813:9)

  ● redshift › string literal quoting › quote backslash

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT 1 as one""") extend {
      |                                          ^
    line 9: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › nullish ?? operator

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/ee967c00-89dc-54d5-9638-72ded1fcbf4c: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 5: 'null_value' is not defined
      |         where: null_value is null
      |                ^
    line 7: 'null_value' is not defined
      |           found_null is  null_value ?? 'correct',
      |                          ^
    line 8: 'string_value' is not defined
      |           else_pass is string_value ?? 'incorrect'
      |                        ^

      830 |           literal_null is null ?? 'correct'
      831 |       }`
    > 832 |     ).malloyResultMatches(runtime, {
          |       ^
      833 |       found_null: 'correct',
      834 |       else_pass: 'correct',
      835 |       literal_null: 'correct',

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:832:7)

  ● redshift › null safe booleans › select boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> {
      |                          ^
    line 12: 'tf' is not defined
      |           null_boolean is tf
      |                           ^

      854 |         select:
      855 |           null_boolean is tf
    > 856 |       }`).malloyResultMatches(runtime, {null_boolean: null});
          |           ^
      857 |     });
      858 |     it('not boolean', async () => {
      859 |       await expect(`run: ${nulls} -> {

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:856:11)

  ● redshift › null safe booleans › not boolean

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> {
      |                          ^
    line 12: 'tf' is not defined
      |           not_null_boolean is not tf
      |                                   ^

      860 |         select:
      861 |           not_null_boolean is not tf
    > 862 |       }`).malloyResultMatches(runtime, {not_null_boolean: is_true});
          |           ^
      863 |     });
      864 |     it('numeric != non-null to null', async () => {
      865 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:862:11)

  ● redshift › null safe booleans › numeric != non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is x != 9 }
      |                          ^
    line 10: 'x' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is x != 9 }
      |                                                              ^

      865 |       await expect(
      866 |         `run: ${nulls} -> { select: val_ne_null is x != 9 }`
    > 867 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      868 |     });
      869 |     it('string !~ non-null to null', async () => {
      870 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:867:9)

  ● redshift › null safe booleans › string !~ non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ 'z' }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ 'z' }
      |                                                              ^

      870 |       await expect(
      871 |         `run: ${nulls} -> { select: val_ne_null is a !~ 'z' }`
    > 872 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      873 |     });
      874 |     it('regex !~ non-null to null', async () => {
      875 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:872:9)

  ● redshift › null safe booleans › regex !~ non-null to null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ r'z' }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: val_ne_null is a !~ r'z' }
      |                                                              ^

      875 |       await expect(
      876 |         `run: ${nulls} -> { select: val_ne_null is a !~ r'z' }`
    > 877 |       ).malloyResultMatches(runtime, {val_ne_null: is_true});
          |         ^
      878 |     });
      879 |     it('numeric != null-to-null', async () => {
      880 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:877:9)

  ● redshift › null safe booleans › numeric != null-to-null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                          ^
    line 10: 'x' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                                                               ^
    line 10: 'y' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is x != y }
      |                                                                    ^

      880 |       await expect(
      881 |         `run: ${nulls} -> { select: null_ne_null is x != y }`
    > 882 |       ).malloyResultMatches(runtime, {null_ne_null: is_true});
          |         ^
      883 |     });
      884 |     it('string !~ null-to-null', async () => {
      885 |       await expect(

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:882:9)

  ● redshift › null safe booleans › string !~ null-to-null

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/fe94298a-8feb-5c1a-b8bb-bb32ae5185fc: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 10: 'n' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                          ^
    line 10: 'a' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                                                               ^
    line 10: 'b' is not defined
      |     """) extend { where: n > 0 } -> { select: null_ne_null is a !~ b }
      |                                                                    ^

      885 |       await expect(
      886 |         `run: ${nulls} -> { select: null_ne_null is a !~ b }`
    > 887 |       ).malloyResultMatches(runtime, {null_ne_null: is_true});
          |         ^
      888 |     });
      889 |   });
      890 |

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:887:9)

  ● redshift › dimension expressions expanded with parens properly

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      898 |           paren is    false and (fot)
      899 |       }`
    > 900 |     ).malloyResultMatches(runtime, {
          |       ^
      901 |       paren: booleanResult(false, databaseName),
      902 |       no_paren: booleanResult(false, databaseName),
      903 |     });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:900:7)

FAIL test/src/databases/all/compound-atomic.spec.ts (22.657 s)
  ● compound atomic datatypes redshift › simple arrays › array literal dialect function

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e4b1437e-5a14-5e66-b6e0-eb610689fab4: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("""
      |                             ^

       98 |       test('array literal dialect function', async () => {
       99 |         await expect(`
    > 100 |           run: ${evens}`).malloyResultMatches(runtime, {
          |                           ^
      101 |           evens: evensObj,
      102 |         });
      103 |       });

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:100:27)

  ● compound atomic datatypes redshift › simple arrays › select array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/e4b1437e-5a14-5e66-b6e0-eb610689fab4: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("""
      |                             ^
    line 5: 'evens' is not defined
      |     """)->{select: nn is evens}
      |                          ^

      106 |           # test.verbose
      107 |           run: ${evens}->{select: nn is evens}
    > 108 |           `).malloyResultMatches(runtime, {nn: evensObj});
          |              ^
      109 |       });
      110 |       test.when(canReadCompoundSchema)(
      111 |         'schema read allows array-un-nest on each',

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:108:14)

  ● compound atomic datatypes redshift › simple arrays › array can be passed to !function

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/e4b1437e-5a14-5e66-b6e0-eb610689fab4: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""
      |                   ^
    line 3: 'evens' is not defined
      |     """)->{ select: nby2 is JSONB_ARRAY_LENGTH!number(evens); } 
      |                                                       ^

      137 |         await expect(
      138 |           `run: ${evens}->{ select: nby2 is ${fn}!number(evens); } `
    > 139 |         ).malloyResultMatches(runtime, {nby2: evensObj.length});
          |           ^
      140 |       });
      141 |       test('array.each in source', async () => {
      142 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:139:11)

  ● compound atomic datatypes redshift › simple arrays › array.each in source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      144 |           extend { dimension: d4 is [1,2,3,4] }
      145 |           -> { select: die_roll is d4.each }
    > 146 |         `).malloyResultMatches(runtime, [
          |            ^
      147 |           {die_roll: 1},
      148 |           {die_roll: 2},
      149 |           {die_roll: 3},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:146:12)

  ● compound atomic datatypes redshift › simple arrays › array.each in extend block

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^

      157 |             select: die_roll is d4.each
      158 |           }
    > 159 |         `).malloyResultMatches(runtime, [
          |            ^
      160 |           {die_roll: 1},
      161 |           {die_roll: 2},
      162 |           {die_roll: 3},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:159:12)

  ● compound atomic datatypes redshift › simple arrays › array stored field with special chars in name

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |             run: redshift.sql("SELECT 0 as z")
      |                  ^
    line 5: '_'_' is not defined
      |             -> { select: num is `_\'_`.each }
      |                                 ^

      194 |             ->{ select: ${qname} is [1]}
      195 |             -> { select: num is ${qname}.each }`;
    > 196 |             await expect(malloySrc).malloyResultMatches(runtime, {});
          |                                     ^
      197 |             const result = await runtime.loadQuery(malloySrc).run();
      198 |             const ok =
      199 |               result.data.path(0, 'num').value === 1

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:196:37)

  ● compound atomic datatypes redshift › simple arrays › bare array of array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> { select: aoa is [[1,2]] }
      |                ^

      245 |         await expect(`
      246 |           run: ${empty} -> { select: aoa is [[1,2]] }
    > 247 |         `).malloyResultMatches(runtime, {aoa: [[1, 2]]});
          |            ^
      248 |       });
      249 |       test.when(supportsNestedArrays)('each.each array of array', async () => {
      250 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:247:12)

  ● compound atomic datatypes redshift › simple arrays › each.each array of array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: aoa is [[1,2]] } -> { select: aoa.each.each }
      |                ^

      250 |         await expect(`
      251 |           run: ${empty} extend { dimension: aoa is [[1,2]] } -> { select: aoa.each.each }
    > 252 |         `).malloyResultMatches(runtime, [{each: 1}, {each: 2}]);
          |            ^
      253 |       });
      254 |     });
      255 |     describe('record', () => {

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:252:12)

  ● compound atomic datatypes redshift › record › record literal object

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/bce2202a-417c-5497-85db-08444715a2d1: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("select 0 as o")
      |                ^

      267 |           run: ${conName}.sql("select 0 as o")
      268 |           -> { select: ${malloySizes}}
    > 269 |         `).malloyResultMatches(runtime, rec_eq());
          |            ^
      270 |       });
      271 |       // can't use special chars in column names in bq
      272 |       test.when(conName !== 'bigquery')(

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:269:12)

  ● compound atomic datatypes redshift › record › special character in record property name

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 0 as z") -> { select: `_\'_` is 'ok' }
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● compound atomic datatypes redshift › record › record stored in field with special chars in name

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |             run: redshift.sql("SELECT 0 as z")
      |                  ^
    line 4: '_'_' is not defined
      |             -> { select: num is `_\'_`.rnum }
      |                                 ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● compound atomic datatypes redshift › record › simple record.property access

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0effe34d-8cbf-5613-86f3-bc8952b7f843: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: small is sizes.s }
      |                ^
    line 2: 'sizes' is not defined
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: small is sizes.s }
      |                                                                                                                             ^

      317 |       test('simple record.property access', async () => {
      318 |         await expect(`
    > 319 |           run: ${sizes} -> { select: small is sizes.s }`).malloyResultMatches(
          |                                                           ^
      320 |           runtime,
      321 |           {small: 0}
      322 |         );

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:319:59)

  ● compound atomic datatypes redshift › record › nested data looks like a record

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0e4cd650-724c-5cc2-b93a-3251c931a63c: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 1 as "o"') -> {
      |                ^
    line 6: 'o' is not defined
      |                 s is sum(o) - 1,
      |                          ^
    line 7: 'o' is not defined
      |                 m is sum(o),
      |                          ^
    line 8: 'o' is not defined
      |                 x is sum(o) + 1,
      |                          ^
    line 9: 'o' is not defined
      |                 xl is sum(o) + 2
      |                           ^
    line 11: 'sizes' is not defined
      |           } -> { select: small is sizes.s }
      |                                   ^

      333 |                 xl is sum(o) + 2
      334 |             }
    > 335 |           } -> { select: small is sizes.s }`).malloyResultMatches(runtime, {
          |                                               ^
      336 |           small: 0,
      337 |         });
      338 |       });

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:335:47)

  ● compound atomic datatypes redshift › record › record can be selected

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0effe34d-8cbf-5613-86f3-bc8952b7f843: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: sizes }
      |                ^
    line 2: 'sizes' is not defined
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: sizes }
      |                                                                                                                    ^

      341 |           `
      342 |           run: ${sizes} -> { select: sizes }`
    > 343 |         ).malloyResultMatches(runtime, rec_eq());
          |           ^
      344 |       });
      345 |       test('record literal can be selected', async () => {
      346 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:343:11)

  ● compound atomic datatypes redshift › record › record literal can be selected

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/0effe34d-8cbf-5613-86f3-bc8952b7f843: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: record is sizes }
      |                ^
    line 2: 'sizes' is not defined
      |           run: redshift.sql('SELECT 0 AS O') -> { select: sizes is {s is 0, m is 1, l is 2, xl is 3}} -> { select: record is sizes }
      |                                                                                                                              ^

      346 |         await expect(`
      347 |           run: ${sizes} -> { select: record is sizes }
    > 348 |         `).malloyResultMatches(runtime, rec_eq('record'));
          |            ^
      349 |       });
      350 |       test('select record literal from a source', async () => {
      351 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:348:12)

  ● compound atomic datatypes redshift › record › select record literal from a source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^

      354 |             select: sizes
      355 |           }
    > 356 |         `).malloyResultMatches(runtime, rec_eq());
          |            ^
      357 |       });
      358 |       test('computed record.property from a source', async () => {
      359 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:356:12)

  ● compound atomic datatypes redshift › record › computed record.property from a source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      361 |             extend { dimension: record is {s is 0, m is 1, l is 2, xl is 3} }
      362 |             -> { select: small is record.s }
    > 363 |         `).malloyResultMatches(runtime, {small: 0});
          |            ^
      364 |       });
      365 |       test('record.property from an extend block', async () => {
      366 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:363:12)

  ● compound atomic datatypes redshift › record › record.property from an extend block

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^

      369 |             select: small is record.s
      370 |           }
    > 371 |         `).malloyResultMatches(runtime, {small: 0});
          |            ^
      372 |       });
      373 |       test('simple each on array property inside record', async () => {
      374 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:371:12)

  ● compound atomic datatypes redshift › record › simple each on array property inside record

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> { select: nums is { odds is [1,3], evens is [2,4]} }
      |                ^
    line 3: 'nums' is not defined
      |           -> { select: odd is nums.odds.value }
      |                               ^

      375 |           run: ${empty} -> { select: nums is { odds is [1,3], evens is [2,4]} }
      376 |           -> { select: odd is nums.odds.value }
    > 377 |         `).malloyResultMatches(runtime, [{odd: 1}, {odd: 3}]);
          |            ^
      378 |       });
      379 |       test('each on array property inside record from source', async () => {
      380 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:377:12)

  ● compound atomic datatypes redshift › record › each on array property inside record from source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: nums is { odds is [1,3], evens is [2,4]} }
      |                ^

      381 |           run: ${empty} extend { dimension: nums is { odds is [1,3], evens is [2,4]} }
      382 |           -> { select: odd is nums.odds.each }
    > 383 |         `).malloyResultMatches(runtime, [{odd: 1}, {odd: 3}]);
          |            ^
      384 |       });
      385 |       const abc = "rec is {a is 'a', bc is {b is 'b', c is 'c'}}";
      386 |       test('record with a record property', async () => {

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:383:12)

  ● compound atomic datatypes redshift › record › record with a record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> { select: rec is {a is 'a', bc is {b is 'b', c is 'c'}} }
      |                ^
    line 3: 'rec' is not defined
      |           -> { select: rec.a, rec.bc.b, rec.bc.c }
      |                        ^
    line 3: 'rec' is not defined
      |           -> { select: rec.a, rec.bc.b, rec.bc.c }
      |                               ^
    line 3: 'rec' is not defined
      |           -> { select: rec.a, rec.bc.b, rec.bc.c }
      |                                         ^

      388 |           run: ${empty} -> { select: ${abc} }
      389 |           -> { select: rec.a, rec.bc.b, rec.bc.c }
    > 390 |         `).malloyResultMatches(runtime, {a: 'a', b: 'b', c: 'c'});
          |            ^
      391 |       });
      392 |       test('record in source with a record property', async () => {
      393 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:390:12)

  ● compound atomic datatypes redshift › record › record in source with a record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: rec is {a is 'a', bc is {b is 'b', c is 'c'}} }
      |                ^

      394 |           run: ${empty} extend { dimension: ${abc} }
      395 |           -> { select: rec.a, rec.bc.b, rec.bc.c }
    > 396 |         `).malloyResultMatches(runtime, {a: 'a', b: 'b', c: 'c'});
          |            ^
      397 |       });
      398 |       test('record dref in source with a record property', async () => {
      399 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:396:12)

  ● compound atomic datatypes redshift › record › record dref in source with a record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: rec is {a is 'a', bc is {b is 'b', c is 'c'}} }
      |                ^

      400 |           run: ${empty} extend { dimension: ${abc} }
      401 |           -> { select: b is pick rec.bc.b when true else 'b' }
    > 402 |         `).malloyResultMatches(runtime, {b: 'b'});
          |            ^
      403 |       });
      404 |       test.todo('array or record where first entries are null');
      405 |     });

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:402:12)

  ● compound atomic datatypes redshift › repeated record › repeated record from nest

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/06f481d0-1a2d-576a-b3fb-021b8c408f63: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |             run: redshift.sql("""
      |                               ^
    line 7: 'a' is not defined
      |             """) -> { nest: ab is { select: a, b } }
      |                                             ^
    line 7: 'b' is not defined
      |             """) -> { nest: ab is { select: a, b } }
      |                                                ^
    line 8: 'ab' is not defined
      |                  -> { select: ab.a, ab.b ; order_by: a}
      |                               ^
    line 8: 'ab' is not defined
      |                  -> { select: ab.a, ab.b ; order_by: a}
      |                                     ^

      441 |             """) -> { nest: ab is { select: a, b } }
      442 |                  -> { select: ab.a, ab.b ; order_by: a}
    > 443 |         `).malloyResultMatches(runtime, ab_eq);
          |            ^
      444 |       });
      445 |       test('select repeated record from literal dialect functions', async () => {
      446 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:443:12)

  ● compound atomic datatypes redshift › repeated record › select repeated record from literal dialect functions

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/33fbccea-6a58-5fe1-8666-7d426af32f59: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql(""" SELECT JSONB_BUILD_ARRAY(JSONB_BUILD_OBJECT('a',10, 'b',11),JSONB_BUILD_OBJECT('a',20, 'b',21)) AS "ab" """)
      |                             ^

      446 |         await expect(`
      447 |           run: ${conName}.sql(""" ${selectAB('ab')} """)
    > 448 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      449 |       });
      450 |       test('repeat record from malloy literal', async () => {
      451 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:448:12)

  ● compound atomic datatypes redshift › repeated record › repeat record from malloy literal

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      452 |           run: ${empty}
      453 |           -> { select: ab is ${abMalloy} }
    > 454 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      455 |       });
      456 |       test('repeated record can be selected and renamed', async () => {
      457 |         const src = `

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:454:12)

  ● compound atomic datatypes redshift › repeated record › repeated record can be selected and renamed

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/32253540-9219-53f1-b16c-354a638aac18: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("""
      |                             ^
    line 4: 'sqlAB' is not defined
      |           """) -> { select: ab is sqlAB }
      |                                   ^

      460 |           """) -> { select: ab is sqlAB }
      461 |       `;
    > 462 |         await expect(src).malloyResultMatches(runtime, {ab: ab_eq});
          |                           ^
      463 |       });
      464 |       test('select repeated record passed down pipeline', async () => {
      465 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:462:27)

  ● compound atomic datatypes redshift › repeated record › select repeated record passed down pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^
    line 4: 'pipeAb' is not defined
      |           -> { select: ab is pipeAb }
      |                              ^

      467 |           -> { select: pipeAb is ${abMalloy} }
      468 |           -> { select: ab is pipeAb }
    > 469 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      470 |       });
      471 |       test('deref repeat record passed down pipeline', async () => {
      472 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:469:12)

  ● compound atomic datatypes redshift › repeated record › deref repeat record passed down pipeline

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^
    line 4: 'pipeAb' is not defined
      |           -> { select: pipeAb.a, pipeAb.b }
      |                        ^
    line 4: 'pipeAb' is not defined
      |           -> { select: pipeAb.a, pipeAb.b }
      |                                  ^

      474 |           -> { select: pipeAb is ${abMalloy} }
      475 |           -> { select: pipeAb.a, pipeAb.b }
    > 476 |         `).malloyResultMatches(runtime, ab_eq);
          |            ^
      477 |       });
      478 |       test('select array of records from source', async () => {
      479 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:476:12)

  ● compound atomic datatypes redshift › repeated record › select array of records from source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      481 |           extend { dimension: abSrc is ${abMalloy} }
      482 |           -> { select: ab is abSrc }
    > 483 |         `).malloyResultMatches(runtime, {ab: ab_eq});
          |            ^
      484 |       });
      485 |       test('deref array of records from source', async () => {
      486 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:483:12)

  ● compound atomic datatypes redshift › repeated record › deref array of records from source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z")
      |                ^

      488 |           extend { dimension: ab is ${abMalloy} }
      489 |           -> { select: ab.a, ab.b }
    > 490 |         `).malloyResultMatches(runtime, ab_eq);
          |            ^
      491 |       });
      492 |       test('repeated record in source wth record property', async () => {
      493 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:490:12)

  ● compound atomic datatypes redshift › repeated record › repeated record in source wth record property

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend { dimension: rec is [ {bc is  {b is 'b'}} ] }
      |                ^

      494 |           run: ${empty} extend { dimension: rec is [ {bc is  {b is 'b'}} ] }
      495 |           -> { select: rec.bc.b }
    > 496 |         `).malloyResultMatches(runtime, {b: 'b'});
          |            ^
      497 |       });
      498 |       test('piped repeated record containing an array', async () => {
      499 |         await expect(`

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:496:12)

  ● compound atomic datatypes redshift › repeated record › piped repeated record containing an array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") -> {
      |                ^
    line 8: 'rrec' is not defined
      |             select: val is rrec.val, name is rrec.names.each
      |                            ^
    line 8: 'rrec' is not defined
      |             select: val is rrec.val, name is rrec.names.each
      |                                              ^

      507 |             order_by: val desc, name asc
      508 |           }
    > 509 |         `).malloyResultMatches(runtime, [
          |            ^
      510 |           {val: 2, name: 'due'},
      511 |           {val: 2, name: 'two'},
      512 |           {val: 1, name: 'one'},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:509:12)

  ● compound atomic datatypes redshift › repeated record › source repeated record containing an array

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/e2b73d31-5a99-5d77-9526-93f7928abf72: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           run: redshift.sql("SELECT 0 as z") extend {
      |                ^

      525 |             order_by: val desc, name asc
      526 |           }
    > 527 |         `).malloyResultMatches(runtime, [
          |            ^
      528 |           {val: 2, name: 'due'},
      529 |           {val: 2, name: 'two'},
      530 |           {val: 1, name: 'one'},

      at Object.<anonymous> (test/src/databases/all/compound-atomic.spec.ts:527:12)

FAIL test/src/databases/all/functions.spec.ts (19.87 s)
  ● concat › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● round › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● floor › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ceil › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● length › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lower › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● upper › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● regexp_extract › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● replace › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● substr › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● raw function call › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works with struct - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works with implicit parameter - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● stddev › works with filter - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a dimension  - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a dimension in the other order  - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a measure - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works when the order by is a measure but there is no group by - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works inside nest - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works outside nest, but with a nest nearby - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works ordered by dimension - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works ordered by aggregate - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works using unary minus in calculate block - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › properly isolated nested calculations - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      506 |             order_by: id2 desc
      507 |           }
    > 508 |       `).malloyResultMatches(expressionModel, {
          |          ^
      509 |         id2: 2,
      510 |       });
      511 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:508:10)

  ● lag › works with one param - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with expression field - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with expression - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with field, ordering by expression field - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with offset - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with default value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lag › works with now as the default value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● output field in calculate › output field referenceable in calculate - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works in nest - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works outside nest - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works with an aggregate which is not in the query - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works with a localized aggregate - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● trunc › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● log › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ln › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● exp › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● cos › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● acos › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sin › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● asin › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● tan › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● atan › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● atan2 › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sqrt › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● pow › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● abs › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sign › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● is_inf › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● is_nan › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● greatest › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● least › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● div › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● strpos › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● starts_with › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ends_with › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● trim › trim works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ltrim › ltrim works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rtrim › rtrim works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rand › is usually not the same value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● pi › is pi - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● byte_length › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ifnull › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● coalesce › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● nullif › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● chr › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ascii › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● unicode › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● string_repeat › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● reverse › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lead › works with one param - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lead › works with offset - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● lead › works with default value - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● last_value › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● avg_moving › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● avg_moving › works forward - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● sum_moving › works - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1252 |         calculate: s is sum_moving(b, 2)
      1253 |         limit: 5
    > 1254 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1255 |         {b: 28810563, s: 28810563},
      1256 |         {b: 23694136, s: 23694136 + 28810563},
      1257 |         {b: 21467359, s: 21467359 + 23694136 + 28810563},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1254:11)

  ● sum_moving › works forward - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1268 |         calculate: s is sum_moving(b, 0, 2)
      1269 |         limit: 7
    > 1270 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1271 |         {b: 28810563, s: 28810563 + 23694136 + 21467359},
      1272 |         {b: 23694136, s: 23694136 + 21467359 + 16661910},
      1273 |         {b: 21467359, s: 21467359 + 16661910 + 15178876},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1270:11)

  ● min, max, sum / window, cumulative › works - redshift

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string_agg › works no order by - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1388 |         where: name = 'RUTHERFORD PAT R JR'
      1389 |         aggregate: f is string_agg(name)
    > 1390 |       }`).malloyResultMatches(expressionModel, {f: 'RUTHERFORD PAT R JR'});
           |           ^
      1391 |     });
      1392 |
      1393 |     it(`works with dotted shortcut - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1390:11)

  ● redshift › string_agg › works with dotted shortcut - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1395 |         where: name = 'RUTHERFORD PAT R JR'
      1396 |         aggregate: f is name.string_agg()
    > 1397 |       }`).malloyResultMatches(expressionModel, {f: 'RUTHERFORD PAT R JR'});
           |           ^
      1398 |     });
      1399 |
      1400 |     it(`works with order by field - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1397:11)

  ● redshift › string_agg › works with order by field - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1405 |           order_by: name
      1406 |         }
    > 1407 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1408 |         f: 'RUTHERFORD JAMES C,RUTHERFORD PAT R JR',
      1409 |       });
      1410 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1407:11)

  ● redshift › string_agg › works with multiple order_bys - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1429 |           order_by: city, name
      1430 |         }
    > 1431 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1432 |         f: 'RUTHERFORD PAT R JR,RUTHERFORD JAMES C',
      1433 |       });
      1434 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1431:11)

  ● redshift › string_agg › works with order by expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1445 |           order_by: length(name)
      1446 |         }
    > 1447 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1448 |         f: 'YANKEE FLYING CLUB INC,WESTCHESTER FLYING CLUB,WILSON FLYING SERVICE INC',
      1449 |       });
      1450 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1447:11)

  ● redshift › string_agg › works with order by join expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1455 |         where: name ~ r'.*ADVENTURE.*'
      1456 |         aggregate: f is string_agg(name, ',') { order_by: aircraft_models.model }
    > 1457 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1458 |         f: 'ADVENTURE INC,SEA PLANE ADVENTURE INC,A BALLOON ADVENTURES ALOFT,A AERONAUTICAL ADVENTURE INC',
      1459 |       });
      1460 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1457:11)

  ● redshift › string_agg › works with order asc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1469 |       } -> {
      1470 |         aggregate: f is string_agg(name, ',') { order_by: name asc }
    > 1471 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1472 |         f: 'WESTCHESTER FLYING CLUB,WILSON FLYING SERVICE INC,YANKEE FLYING CLUB INC',
      1473 |       });
      1474 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1471:11)

  ● redshift › string_agg › works with order desc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1483 |       } -> {
      1484 |         aggregate: f is string_agg(name, ',') { order_by: name desc }
    > 1485 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1486 |         f: 'YANKEE FLYING CLUB INC,WILSON FLYING SERVICE INC,WESTCHESTER FLYING CLUB',
      1487 |       });
      1488 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1485:11)

  ● redshift › string_agg › works with fanout and order_by - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1510 |           order_by: popular_name, state
      1511 |         }
    > 1512 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1513 |         s: 'IA,LA,MN,AL,AR,IN,ME,MT,NC,AZ,CA,CO,CT,FL,GA,HI,IL,KS,KY,MA,MO,NJ,NM,NV,NY,OH,OK,PA,RI,TN,TX,WV,WY,DC,MS,SC,ID,NE,UT,VA,AK,DE,MD,MI,ND,NH,OR,SD,VT,WA,WI',
      1514 |         c: 51,
      1515 |       });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1512:11)

  ● redshift › string_agg › works with fanout - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1531 |         aggregate: c is state_facts2.count()
      1532 |         aggregate: s is string_agg('o')
    > 1533 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1534 |         s: 'o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o,o',
      1535 |         c: 51,
      1536 |       });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1533:11)

  ● redshift › string_agg › works with fanout and separator - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1547 |         aggregate: c is state_facts2.count()
      1548 |         aggregate: s is string_agg('o', '')
    > 1549 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1550 |         s: 'ooooooooooooooooooooooooooooooooooooooooooooooooooo',
      1551 |         c: 51,
      1552 |       });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1549:11)

  ● redshift › string_agg › works with limit - redshift

    expect(received).rejects.toThrow(expected)

    Expected substring: "Function string_agg does not support limit"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1573:70)

  ● redshift › string_agg_distinct › actually distincts - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'tail_num' is not defined
      |           primary_key: tail_num
      |           ^
    line 7: 'aircraft_model_code' is not defined
      |           primary_key: aircraft_model_code
      |           ^
    line 8: 'aircraft_model_code' is not defined
      |           join_many: aircraft on aircraft_model_code = aircraft.aircraft_model_code
      |                                  ^
    line 8: 'aircraft_model_code' is not defined
      |           join_many: aircraft on aircraft_model_code = aircraft.aircraft_model_code
      |                                                        ^
    line 12: 'name' is not defined
      |           where: aircraft.name = 'RAYTHEON AIRCRAFT COMPANY' | 'FOWLER IRA R DBA'
      |                  ^
    line 13: Reference to undefined value aircraft.name
      |           aggregate: f_dist is aircraft.name.string_agg_distinct() { order_by: asc }
      |                                ^
    line 13: No matching overload for function string_agg_distinct()
      |           aggregate: f_dist is aircraft.name.string_agg_distinct() { order_by: asc }
      |                                ^
    line 14: Reference to undefined value aircraft.name
      |           aggregate: f_all is aircraft.name.string_agg() { order_by: aircraft.name }
      |                               ^
    line 14: No matching overload for function string_agg()
      |           aggregate: f_all is aircraft.name.string_agg() { order_by: aircraft.name }
      |                               ^

      1594 |           aggregate: f_dist is aircraft.name.string_agg_distinct() { order_by: asc }
      1595 |           aggregate: f_all is aircraft.name.string_agg() { order_by: aircraft.name }
    > 1596 |       }`).malloyResultMatches(runtime, {
           |           ^
      1597 |         f_dist: 'FOWLER IRA R DBA,RAYTHEON AIRCRAFT COMPANY',
      1598 |         f_all:
      1599 |           'FOWLER IRA R DBA,FOWLER IRA R DBA,RAYTHEON AIRCRAFT COMPANY,RAYTHEON AIRCRAFT COMPANY',

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1596:11)

  ● redshift › string_agg_distinct › works no order by - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1605 |         where: name = 'RUTHERFORD PAT R JR'
      1606 |         aggregate: f is string_agg_distinct(name)
    > 1607 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1608 |         f: 'RUTHERFORD PAT R JR',
      1609 |       });
      1610 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1607:11)

  ● redshift › string_agg_distinct › works with dotted shortcut - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1614 |         where: name = 'RUTHERFORD PAT R JR'
      1615 |         aggregate: f is name.string_agg_distinct()
    > 1616 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1617 |         f: 'RUTHERFORD PAT R JR',
      1618 |       });
      1619 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1616:11)

  ● redshift › string_agg_distinct › works with order by direction - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1626 |           order_by: asc
      1627 |         }
    > 1628 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1629 |         f: 'RUTHERFORD JAMES C,RUTHERFORD PAT R JR',
      1630 |       });
      1631 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1628:11)

  ● redshift › string_agg_distinct › works with order asc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1640 |       } -> {
      1641 |         aggregate: f is string_agg_distinct(name, ',') { order_by: asc }
    > 1642 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1643 |         f: 'WESTCHESTER FLYING CLUB,WILSON FLYING SERVICE INC,YANKEE FLYING CLUB INC',
      1644 |       });
      1645 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1642:11)

  ● redshift › string_agg_distinct › works with order desc - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1654 |       } -> {
      1655 |         aggregate: f is string_agg_distinct(name, ',') { order_by: desc }
    > 1656 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1657 |         f: 'YANKEE FLYING CLUB INC,WILSON FLYING SERVICE INC,WESTCHESTER FLYING CLUB',
      1658 |       });
      1659 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1656:11)

  ● redshift › string_agg_distinct › works with limit - redshift

    expect(received).rejects.toThrow(expected)

    Expected substring: "Function string_agg_distinct does not support limit"
    Received message:   "Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^"

          383 |           const errors = result.problems || [];
          384 |           const errText = translator.prettyErrors();
        > 385 |           throw new MalloyError(
              |                 ^
          386 |             `Error(s) compiling model:\n${errText}`,
          387 |             errors
          388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.toThrow (node_modules/@jest/expect/node_modules/expect/build/index.js:210:22)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1679:70)

  ● redshift › partition_by › works - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1702 |         order_by: yr, qtr
      1703 |         where: dep_time < @2002
    > 1704 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1705 |         {yr: 2000, qtr: 1, qtr_flights: 12148, last_yr_qtr_flights: null},
      1706 |         {yr: 2000, qtr: 2, qtr_flights: 11599, last_yr_qtr_flights: null},
      1707 |         {yr: 2000, qtr: 3, qtr_flights: 12075, last_yr_qtr_flights: null},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1704:11)

  ● redshift › partition_by › works with aggregate - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1726 |         order_by: l
      1727 |         limit: 5
    > 1728 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1729 |         {l: 'A', c: 4, prev: null},
      1730 |         {l: 'C', c: 3, prev: null},
      1731 |         {l: 'D', c: 2, prev: null},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1728:11)

  ● redshift › partition_by › works with multiple order_bys - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1752 |           }
      1753 |         order_by: name
    > 1754 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1755 |         {name: 'AMERICAN AIRLINES INC', r: 3},
      1756 |         {name: 'CESSNA AIRCRAFT COMPANY', r: 4},
      1757 |         {name: 'FEDERAL EXPRESS CORP', r: 2},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1754:11)

  ● redshift › partition_by › can be used in a select

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1774 |           limit: 3
      1775 |         }
    > 1776 |       `).malloyResultMatches(expressionModel, [
           |          ^
      1777 |         {
      1778 |           state: 'CA',
      1779 |           births: 28810563,

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1776:10)


  ● Test suite failed to run

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 7: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 8: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 8: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^

      1417 |           order_by: asc
      1418 |         }
    > 1419 |       }`).malloyResultMatches(expressionModel, {
           |           ^
      1420 |         f: 'RUTHERFORD JAMES C,RUTHERFORD PAT R JR',
      1421 |       });
      1422 |     });

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1419:11)

FAIL test/src/databases/all/time.spec.ts (18.906 s)
  ● redshift date and time › interval measurement › forwards is positive

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › reverse is negative

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › seconds

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › minutes

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › hours

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › days

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › interval measurement › timeDiff passed to a function preserves rhs

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7f42210-8f99-5cd8-926d-39bc04d35e97: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1")
      |              ^

      100 |         run: ${dbName}.sql("SELECT 1")
      101 |         -> { select: yd is floor(days(@2001 to @2002)) }
    > 102 |       `).malloyResultMatches(runtime, {yd: 365});
          |          ^
      103 |       }
      104 |     );
      105 |

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:102:10)

  ● redshift date and time › timestamp truncation › trunc second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc hour

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp truncation › trunc year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract hour

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract day_of_week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › first week day is one 

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract day_of_year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp extraction › extract year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date truncation › date trunc year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract day_of_week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract day_of_year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date extraction › date extract year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta negative second

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta hours

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › timestamp delta year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta week

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta quarter

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › delta computations › date delta year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › date › before for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › date › first for-range is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › date › last for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › timestamp › before for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › timestamp › first for-range is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › for range edge tests › timestamp › last for-range is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › date › before to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › date › first to is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › date › last to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › timestamp › before to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › timestamp › first to is inside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › to range edge tests › timestamp › last to is outside

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › date in sql_block no explore

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timestamp in sql_block no explore

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › valid timestamp without seconds

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › minute implied truncated range

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › day implied truncated range

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › year implied truncated range

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal minute

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal day

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › date in literal month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal month

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › granular time range checks › timestamp in literal year

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: basicTypes is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """) 
      |                                          ^
    line 4: Reference to undefined object 'basicTypes'
      |           run: basicTypes
      |                ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › dependant join dialect fragments

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/b7aae626-efd1-58b7-8d68-807e54ec18ff: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: timeData is redshift.sql("""SELECT DATE '2021-02-24' as "t_date", TIMESTAMP '2021-02-24 03:05:06' as "t_timestamp" """)
      |                                        ^
    line 3: Reference to undefined object 'timeData'
      |       run: timeData -> {
      |            ^

      482 |         group_by: t_month is joined.t_timestamp.month
      483 |       }
    > 484 |     `).malloyResultMatches(runtime, {t_month: new Date('2021-02-01')});
          |        ^
      485 |   });
      486 |
      487 |   describe('timezone set correctly', () => {

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:484:8)

  ● redshift date and time › timezone set correctly › timezone set in source used by query

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timezone set correctly › timezone set in view inside source

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timezone set correctly › timezone set in query using source

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift date and time › timezone set correctly › multiple timezones

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql('SELECT 1 as one') extend {
      |      ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: tz literals › redshift - default timezone is UTC

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: tz literals › literal with zone name

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: query tz › literal timestamps

    Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         run: redshift.sql("SELECT 1 as one") -> {
      |              ^

      383 |           const errors = result.problems || [];
      384 |           const errText = translator.prettyErrors();
    > 385 |           throw new MalloyError(
          |                 ^
      386 |             `Error(s) compiling model:\n${errText}`,
      387 |             errors
      388 |           );

      at _callee$ (packages/malloy/src/malloy.ts:385:17)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift: query tz › extract

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/41039b60-64d7-5e39-a4da-2d99662d5b41: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as one") -> {
      |      ^

      696 |           mex_day is day(utc_midnight)
      697 |       }`
    > 698 |     ).malloyResultMatches(runtime, {mex_midnight: 18, mex_day: 19});
          |       ^
      699 |   });
      700 |
      701 |   test.when(

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:698:7)

  ● redshift: query tz › truncate day

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/f92abcd0-8ea9-5e83-a5fa-491530db5d06: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as x") -> {
      |      ^

      711 |         select: mex_day is utc_midnight.day
      712 |       }`
    > 713 |     ).malloyResultMatches(runtime, {mex_day: mex_19.toJSDate()});
          |       ^
      714 |   });
      715 |
      716 |   test.when(

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:713:7)

  ● redshift: query tz › cast timestamp to date

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/f92abcd0-8ea9-5e83-a5fa-491530db5d06: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("SELECT 1 as x") -> {
      |      ^

      725 |         select: mex_day is day(utc_midnight::date)
      726 |       }`
    > 727 |     ).malloyResultMatches(runtime, {mex_day: 19});
          |       ^
      728 |   });
      729 |
      730 |   test.when(

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:727:7)

  ● redshift: query tz › cast date to timestamp

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/51afc285-f0fe-5798-a8da-f3e4a167b051: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql(""" SELECT DATE '2020-02-20'  AS "mex_20" """) -> {
      |                   ^
    line 3: 'mex_20' is not defined
      |         select: mex_ts is mex_20::timestamp
      |                           ^

      736 |         select: mex_ts is mex_20::timestamp
      737 |       }`
    > 738 |     ).malloyResultMatches(runtime, {mex_ts: zone_2020.toJSDate()});
          |       ^
      739 |   });
      740 | });
      741 |

      at Object.<anonymous> (test/src/databases/all/time.spec.ts:738:7)

FAIL test/src/databases/all/join.spec.ts (16.726 s)
  ● redshift › model source refine join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      73 |           aircraft_models.model_count
      74 |       }
    > 75 |     `).malloyResultMatches(joinModel, {model_count: 1416});
         |        ^
      76 |   });
      77 |
      78 |   it('model source refine in query join', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:75:8)

  ● redshift › model source refine in query join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      85 |           aircraft_models.model_count
      86 |       }
    > 87 |     `).malloyResultMatches(joinModel, {model_count: 1416});
         |        ^
      88 |   });
      89 |
      90 |   it('model: join fact table query', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:87:8)

  ● redshift › model: join fact table query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      103 |         limit: 1
      104 |       }
    > 105 |     `).malloyResultMatches(joinModel, {num_models: 1147});
          |        ^
      106 |   });
      107 |
      108 |   it('model: source based on query', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:105:8)

  ● redshift › model: source based on query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      119 |           limit: 1
      120 |         }
    > 121 |     `).malloyResultMatches(joinModel, {num_models: 1147});
          |        ^
      122 |   });
      123 |
      124 |   it('model: funnel - merge two queries', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:121:8)

  ● redshift › model: funnel - merge two queries

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      141 |           limit: 1
      142 |         }
    > 143 |     `).malloyResultMatches(joinModel, {
          |        ^
      144 |       num_models: 1147,
      145 |       total_seats: 252771,
      146 |     });

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:143:8)

  ● redshift › model: modeled funnel

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      159 |         limit: 1
      160 |       }
    > 161 |     `).malloyResultMatches(joinModel, {
          |        ^
      162 |       num_models: 1147,
      163 |       total_seats: 252771,
      164 |     });

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:161:8)

  ● redshift › model: modeled funnel2

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      175 |         limit: 1
      176 |       }
    > 177 |     `).malloyResultMatches(joinModel, {
          |        ^
      178 |       num_models: 1147,
      179 |       total_seats: 252771,
      180 |     });

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:177:8)

  ● redshift › model: double_pipe

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      191 |         select: f_sum2 is f_sum+1
      192 |       }
    > 193 |   `).malloyResultMatches(joinModel, {f_sum2: 60462});
          |      ^
      194 |   });
      195 |
      196 |   test.when(runtime.supportsNesting && runtime.dialect.supportsLeftJoinUnnest)(

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:193:6)

  ● redshift › model: unnest is left join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      219 |           limit: 5
      220 |         }
    > 221 |       `).malloyResultMatches(joinModel, [{}, {}, {}, {}, {}]);
          |          ^
      222 |     }
      223 |   );
      224 |

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:221:10)

  ● redshift › All joins at the same level

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      238 |         limit: 5
      239 |       }
    > 240 |     `).malloyResultMatches(joinModel, [{}, {}, {}, {}, {}]);
          |        ^
      241 |   });
      242 |
      243 |   it('join issue440', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:240:8)

  ● redshift › join issue440

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'tail_num' is not defined
      |         join_one: aircraft on aircraft.tail_num = tail_num
      |                               ^
    line 7: 'tail_num' is not defined
      |         join_one: aircraft on aircraft.tail_num = tail_num
      |                                                   ^
    line 8: 'aircraft_model_code' is not defined
      |         join_one: aircraft_models on aircraft_models.aircraft_model_code = aircraft.aircraft_model_code
      |                                      ^
    line 8: 'aircraft_model_code' is not defined
      |         join_one: aircraft_models on aircraft_models.aircraft_model_code = aircraft.aircraft_model_code
      |                                                                            ^
    line 12: 'model' is not defined
      |         group_by: testingtwo is aircraft_models.model
      |                                 ^
    line 11: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: flights-> {
      |            ^

      256 |         limit: 5
      257 |       }
    > 258 |     `).malloyResultMatches(runtime, [{}, {}, {}, {}, {}]);
          |        ^
      259 |   });
      260 |
      261 |   it('join issue1092', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:258:8)

  ● redshift › join issue1092

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'state' is not defined
      |         extend: {join_one: sf is redshift.table('malloytest.state_facts') on sf.state = state}
      |                                                                              ^
    line 3: 'state' is not defined
      |         extend: {join_one: sf is redshift.table('malloytest.state_facts') on sf.state = state}
      |                                                                                         ^
    line 4: Reference to undefined value sf.births
      |         aggregate: x is sf.births.sum() { where:  state = 'CA' }
      |                         ^
    line 4: Filtered expression requires an aggregate computation
      |         aggregate: x is sf.births.sum() { where:  state = 'CA' }
      |                         ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      extendSource: [
        {
          type: 'table',
          name: 'sf',
          dialect: 'redshift',
          tablePath: 'malloytest.state_facts',
          connection: 'redshift',
          fields: [
            {
              type: 'string',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'number',
              numberType: 'integer',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'number',
              numberType: 'integer',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'number',
              numberType: 'integer',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            },
            {
              type: 'string',
              name: undefined,
              location: {
                url: 'internal://internal.malloy',
                range: {
                  start: { line: 2, character: 33 },
                  end: { line: 2, character: 73 }
                }
              }
            }
          ],
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 27 },
              end: { line: 2, character: 93 }
            }
          },
          join: 'one',
          matrixOperation: 'left',
          onExpression: { node: 'error', message: 'cascading error' },
          onCompositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts') -> {
      |            ^

      265 |         aggregate: x is sf.births.sum() { where:  state = 'CA' }
      266 |       }
    > 267 |     `).malloyResultMatches(runtime, [{}]);
          |        ^
      268 |   });
      269 |
      270 |   it('always join in query', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:267:8)

  ● redshift › always join in query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      276 |         aggregate: c is count()
      277 |       }
    > 278 |     `).malloyResultMatches(joinModel, {c: 51 * 51});
          |        ^
      279 |   });
      280 |
      281 |   it('not always join in extend', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:278:8)

  ● redshift › not always join in extend

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      289 |         aggregate: c is count()
      290 |       }
    > 291 |     `).malloyResultMatches(joinModel, {c: 51});
          |        ^
      292 |   });
      293 |
      294 |   it('always inner join has side effects (in group_by)', async () => {

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:291:8)

  ● redshift › always inner join has side effects (in group_by)

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |     primary_key: aircraft_model_code
      |     ^
    line 6: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 10: 'manufacturer' is not defined
      |       group_by: manufacturer
      |                 ^
    line 11: Reference to undefined value seats
      |       aggregate: total_seats is seats.sum()
      |                                 ^
    line 16: 'tail_num' is not defined
      |     primary_key: tail_num
      |     ^
    line 22: 'manufacturer' is not defined
      |         with manufacturer
      |              ^
    line 21: join_one: Cannot use with unless source has a primary key
      |     join_one: seats is aircraft_models->manufacturer_seats
      |               ^

      301 |         aggregate: c is count()
      302 |       }
    > 303 |     `).malloyResultMatches(joinModel, {c: 0});
          |        ^
      304 |   });
      305 | });
      306 |

      at Object.<anonymous> (test/src/databases/all/join.spec.ts:303:8)

FAIL test/src/databases/all/db_index.spec.ts (15.323 s)
  ● basic index  - redshift

    TypeError: Cannot read properties of undefined (reading 'replace')

      109 |
      110 |   sqlMaybeQuoteIdentifier(identifier: string): string {
    > 111 |     return '"' + identifier.replace(/"/g, '""') + '"';
          |                             ^
      112 |   }
      113 | }
      114 |

      at RedshiftDialect.sqlMaybeQuoteIdentifier (packages/malloy/src/dialect/pg_impl.ts:111:29)
      at RedshiftDialect.sqlFieldReference (packages/malloy/src/dialect/redshift/redshift.ts:272:26)
      at QueryStruct.sqlChildReference (packages/malloy/src/model/malloy_query.ts:4499:25)
      at QueryFieldString.generateExpression (packages/malloy/src/model/malloy_query.ts:1417:24)
      at QueryQueryIndexStage.generateSQL (packages/malloy/src/model/malloy_query.ts:4003:33)
      at QueryQueryIndex.generateSQL (packages/malloy/src/model/malloy_query.ts:4197:31)
      at QueryQueryIndex.generateSQLFromPipeline (packages/malloy/src/model/malloy_query.ts:3884:30)
      at QueryModel.loadQuery (packages/malloy/src/model/malloy_query.ts:4978:19)
      at QueryModel.compileQuery (packages/malloy/src/model/malloy_query.ts:5035:19)
      at QueryModel._callee$ (packages/malloy/src/model/malloy_query.ts:5118:21)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at node_modules/@babel/runtime/helpers/asyncToGenerator.js:27:7
      at QueryModel.apply (node_modules/@babel/runtime/helpers/asyncToGenerator.js:19:12)
      at QueryModel.searchIndex (packages/malloy/src/model/malloy_query.ts:5161:4)
      at ModelMaterializer._callee19$ (packages/malloy/src/malloy.ts:2884:29)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● index value map  - redshift

    undefined not found

      4759 |     if (found === undefined) {
      4760 |       const pathErr = path.length > 1 ? ` in ${path.join('.')}` : '';
    > 4761 |       throw new Error(`${notFound} not found${pathErr}`);
           |             ^
      4762 |     }
      4763 |     return found;
      4764 |   }

      at QueryStruct.getFieldByName (packages/malloy/src/model/malloy_query.ts:4761:13)
      at QueryStruct.getQueryFieldByName (packages/malloy/src/model/malloy_query.ts:4768:24)
      at QueryQueryIndexStage.expandField (packages/malloy/src/model/malloy_query.ts:3944:31)
      at QueryQueryIndexStage.expandFields (packages/malloy/src/model/malloy_query.ts:3954:32)
      at QueryQueryIndexStage.prepare (packages/malloy/src/model/malloy_query.ts:2650:12)
      at QueryQueryIndex.generateSQL (packages/malloy/src/model/malloy_query.ts:4196:9)
      at QueryQueryIndex.generateSQLFromPipeline (packages/malloy/src/model/malloy_query.ts:3884:30)
      at QueryModel.loadQuery (packages/malloy/src/model/malloy_query.ts:4978:19)
      at QueryModel.compileQuery (packages/malloy/src/model/malloy_query.ts:5035:19)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1028:40)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● index no sample rows - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |       } -> {index:one, state }
      |                   ^

      94 |       } -> {index:one, state }
      95 |         -> {select: fieldName, weight, fieldValue; order_by: 2 desc; where: fieldName = 'one'}
    > 96 |     `).malloyResultMatches(runtime, {fieldName: 'one', weight: 51});
         |        ^
      97 |   });
      98 |
      99 |   // bigquery doesn't support row count based sampling.

      at Object.<anonymous> (test/src/databases/all/db_index.spec.ts:96:8)

  ● index rows count - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         } -> {index:one, state; sample: 10 }
      |                     ^

      108 |         } -> {index:one, state; sample: 10 }
      109 |             -> {select: fieldName, weight, fieldValue; order_by: 2 desc; where: fieldName = 'one'}
    > 110 |       `).malloyResultMatches(runtime, {fieldName: 'one', weight: 10});
          |          ^
      111 |   });
      112 |
      113 |   it.when(databaseName !== 'trino' && databaseName !== 'presto')(

      at Object.<anonymous> (test/src/databases/all/db_index.spec.ts:110:10)

  ● index rows count - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'tail_num' is not defined
      |       } -> {index:one, tail_num; sample: 50% }
      |                   ^

      119 |       } -> {index:one, tail_num; sample: 50% }
      120 |         -> {select: fieldName, weight, fieldValue; order_by: 2 desc; where: fieldName = 'one'}
    > 121 |     `).malloyResultMatches(runtime, {fieldName: 'one'});
          |        ^
      122 |       // Hard to get consistent results here so just check that we get a value back.
      123 |     }
      124 |   );

      at Object.<anonymous> (test/src/databases/all/db_index.spec.ts:121:8)

FAIL test/src/databases/all/lenses.spec.ts (13.728 s)
  ● named view plus named view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> d + m
      |            ^

      45 |       }
      46 |       run: x -> d + m
    > 47 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      48 |   });
      49 |   it(`named view plus measure - ${databaseName}`, async () => {
      50 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:47:8)

  ● named view plus measure - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> d + c
      |            ^

      54 |       }
      55 |       run: x -> d + c
    > 56 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      57 |   });
      58 |   it(`dimension plus named view - ${databaseName}`, async () => {
      59 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:56:8)

  ● dimension plus named view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> n + m
      |            ^

      62 |       }
      63 |       run: x -> n + m
    > 64 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      65 |   });
      66 |   it(`where headed - ${databaseName}`, async () => {
      67 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:64:8)

  ● where headed - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> { where: true } + m
      |            ^

      70 |       }
      71 |       run: x -> { where: true } + m
    > 72 |     `).malloyResultMatches(runtime, {c: 1});
         |        ^
      73 |   });
      74 |   it(`named view plus named view in source - ${databaseName}`, async () => {
      75 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:72:8)

  ● named view plus named view in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 7: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      80 |       }
      81 |       run: x -> y
    > 82 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      83 |   });
      84 |   it(`dimension plus named view in source - ${databaseName}`, async () => {
      85 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:82:8)

  ● dimension plus named view in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is n + m
      |                    ^
    line 4: Named refinements of multi-stage views are not supported
      |         view: y is n + m
      |               ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      89 |       }
      90 |       run: x -> y
    > 91 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
         |        ^
      92 |   });
      93 |   it(`named view plus dimension in source - ${databaseName}`, async () => {
      94 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:91:8)

  ● named view plus dimension in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is m + n
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

       98 |       }
       99 |       run: x -> y
    > 100 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      101 |   });
      102 |   it(`literal view plus named view - ${databaseName}`, async () => {
      103 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:100:8)

  ● literal view plus named view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> { group_by: n } + m
      |            ^

      106 |       }
      107 |       run: x -> { group_by: n } + m
    > 108 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      109 |   });
      110 |   it(`literal view plus measure - ${databaseName}`, async () => {
      111 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:108:8)

  ● literal view plus measure - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> { group_by: n } + c
      |            ^

      114 |       }
      115 |       run: x -> { group_by: n } + c
    > 116 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      117 |   });
      118 |   it(`measure plus literal view - ${databaseName}`, async () => {
      119 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:116:8)

  ● measure plus literal view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> c + { group_by: n }
      |            ^

      122 |       }
      123 |       run: x -> c + { group_by: n }
    > 124 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      125 |   });
      126 |   it(`literal view plus named view in source - ${databaseName}`, async () => {
      127 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:124:8)

  ● literal view plus named view in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is { group_by: n } + m
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      131 |       }
      132 |       run: x -> y
    > 133 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      134 |   });
      135 |   it(`literal view plus measure in source - ${databaseName}`, async () => {
      136 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:133:8)

  ● literal view plus measure in source - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: y is { group_by: n } + c
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y
      |            ^

      140 |       }
      141 |       run: x -> y
    > 142 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      143 |   });
      144 |   it(`named view plus literal view - ${databaseName}`, async () => {
      145 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:142:8)

  ● named view plus literal view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 5: Reference to undefined object 'x'
      |       run: x -> d + { aggregate: c is count() }
      |            ^

      148 |       }
      149 |       run: x -> d + { aggregate: c is count() }
    > 150 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      151 |   });
      152 |   it(`literal view plus literal view - ${databaseName}`, async () => {
      153 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:150:8)

  ● literal view plus literal view - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"')
      |                    ^
    line 3: Reference to undefined object 'x'
      |       run: x -> { group_by: n } + { aggregate: c is count() }
      |            ^

      154 |       source: x is ${databaseName}.sql('SELECT 1 as ${q`n`}')
      155 |       run: x -> { group_by: n } + { aggregate: c is count() }
    > 156 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      157 |   });
      158 |   it(`three named views - ${databaseName}`, async () => {
      159 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:156:8)

  ● three named views - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d1 is { group_by: n1 is n }
      |                                       ^
    line 4: 'n' is not defined
      |         view: d2 is { group_by: n2 is n }
      |                                       ^
    line 7: Reference to undefined object 'x'
      |       run: x -> d1 + d2 + m
      |            ^

      164 |       }
      165 |       run: x -> d1 + d2 + m
    > 166 |     `).malloyResultMatches(runtime, {n1: 1, n2: 1, c: 1});
          |        ^
      167 |   });
      168 |   it(`nested no name - ${databaseName}`, async () => {
      169 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:166:8)

  ● nested no name - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      175 |         nest: d + m
      176 |       }
    > 177 |     `).malloyResultMatches(runtime, {'d.n': 1, 'd.c': 1});
          |        ^
      178 |   });
      179 |   it(`nested with name - ${databaseName}`, async () => {
      180 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:177:8)

  ● nested with name - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: d is { group_by: n }
      |                                ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      186 |         nest: y is d + m
      187 |       }
    > 188 |     `).malloyResultMatches(runtime, {'y.n': 1, 'y.c': 1});
          |        ^
      189 |   });
      190 |   it(`nested no name with dimension head - ${databaseName}`, async () => {
      191 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:188:8)

  ● nested no name with dimension head - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      196 |         nest: n + m
      197 |       }
    > 198 |     `).malloyResultMatches(runtime, {'n.n': 1, 'n.c': 1});
          |        ^
      199 |   });
      200 |   it(`nest dimension only - ${databaseName}`, async () => {
      201 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:198:8)

  ● nest dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      206 |         nest: n
      207 |       }
    > 208 |     `).malloyResultMatches(runtime, {'n.n': 1});
          |        ^
      209 |   });
      210 |   it(`joined dimension in middle of refinements - ${databaseName}`, async () => {
      211 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:208:8)

  ● joined dimension in middle of refinements - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> m + y.n + { limit: 1 }
      |            ^

      215 |       }
      216 |       run: x -> m + y.n + { limit: 1 }
    > 217 |     `).malloyResultMatches(runtime, {'n': 2, 'c': 1});
          |        ^
      218 |   });
      219 |   it(`nest joined dimension refined - ${databaseName}`, async () => {
      220 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:217:8)

  ● nest joined dimension refined - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 1 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 1 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      226 |         nest: y.n + { limit: 1 }
      227 |       }
    > 228 |     `).malloyResultMatches(runtime, {'n.n': 1});
          |        ^
      229 |   });
      230 |   it(`joined dimension refined - ${databaseName}`, async () => {
      231 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:228:8)

  ● joined dimension refined - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y.n + { limit: 1 }
      |            ^

      235 |       }
      236 |       run: x -> y.n + { limit: 1 }
    > 237 |     `).malloyResultMatches(runtime, {'n': 2});
          |        ^
      238 |   });
      239 |   it(`nest joined dimension bare - ${databaseName}`, async () => {
      240 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:237:8)

  ● nest joined dimension bare - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> {
      |            ^

      246 |         nest: y.n
      247 |       }
    > 248 |     `).malloyResultMatches(runtime, {'n.n': 2});
          |        ^
      249 |   });
      250 |   it(`joined dimension bare - ${databaseName}`, async () => {
      251 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:248:8)

  ● joined dimension bare - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> y.n
      |            ^

      255 |       }
      256 |       run: x -> y.n
    > 257 |     `).malloyResultMatches(runtime, {'n': 2});
          |        ^
      258 |   });
      259 |   it(`joined dimension nest refinement - ${databaseName}`, async () => {
      260 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:257:8)

  ● joined dimension nest refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 6: Reference to undefined object 'x'
      |       run: x -> { nest: m + y.n }
      |            ^

      264 |       }
      265 |       run: x -> { nest: m + y.n }
    > 266 |     `).malloyResultMatches(runtime, {'m.c': 1, 'm.n': 2});
          |        ^
      267 |   });
      268 |   it.skip(`nest measure only in second stage - ${databaseName}`, async () => {
      269 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:266:8)

  ● nest dimension only in refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> m + {
      |            ^

      284 |         nest: n
      285 |       }
    > 286 |     `).malloyResultMatches(runtime, {'n.n': 1, 'c': 1});
          |        ^
      287 |   });
      288 |   it(`view dimension only - ${databaseName}`, async () => {
      289 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:286:8)

  ● view dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: 'n' is not defined
      |         view: m is n
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> m
      |            ^

      292 |       }
      293 |       run: x -> m
    > 294 |     `).malloyResultMatches(runtime, {n: 1});
          |        ^
      295 |   });
      296 |   it(`view join dimension only - ${databaseName}`, async () => {
      297 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:294:8)

  ● view join dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 3: Invalid SQL, Error fetching SELECTschema for sql://redshift/69822463-4def-55da-ab2b-fc3a04092110: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |         join_one: y is redshift.sql('SELECT 2 as "n"') on true
      |                        ^
    line 4: 'n' is not defined
      |         view: m is y.n
      |                    ^
    line 6: Reference to undefined object 'x'
      |       run: x -> m
      |            ^

      301 |       }
      302 |       run: x -> m
    > 303 |     `).malloyResultMatches(runtime, {n: 2});
          |        ^
      304 |   });
      305 |   it(`run dimension only - ${databaseName}`, async () => {
      306 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:303:8)

  ● run dimension only - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"')
      |                    ^
    line 3: Reference to undefined object 'x'
      |       run: x -> n
      |            ^

      307 |       source: x is ${databaseName}.sql('SELECT 1 as ${q`n`}')
      308 |       run: x -> n
    > 309 |     `).malloyResultMatches(runtime, {n: 1});
          |        ^
      310 |   });
      311 |   it.skip(`second stage refinement chain - ${databaseName}`, async () => {
      312 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:309:8)

  ● copy of view with lens - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 4: 'n' is not defined
      |         view: v is { group_by: n } + metrics
      |                                ^
    line 7: Reference to undefined object 'x'
      |       run: x -> v2
      |            ^

      330 |       }
      331 |       run: x -> v2
    > 332 |     `).malloyResultMatches(runtime, {n: 1, c: 1});
          |        ^
      333 |   });
      334 |   it(`aggregate copy bug with only old refinement - ${databaseName}`, async () => {
      335 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:332:8)

  ● aggregate copy bug with only old refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> c + {
      |            ^

      340 |         aggregate: e is c { where: false }
      341 |       }
    > 342 |     `).malloyResultMatches(runtime, {c: 1, e: 0});
          |        ^
      343 |   });
      344 |   it(`aggregate copy bug with only old old refinement - ${databaseName}`, async () => {
      345 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:342:8)

  ● aggregate copy bug with only old old refinement - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 6: Reference to undefined object 'x'
      |       run: x -> v + {
      |            ^

      351 |         aggregate: e is c { where: false }
      352 |       }
    > 353 |     `).malloyResultMatches(runtime, {c: 1, e: 0});
          |        ^
      354 |   });
      355 |   it(`but still need to be able to use as output field - ${databaseName}`, async () => {
      356 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:353:8)

  ● but still need to be able to use as output field - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 6: Reference to undefined object 'x'
      |       run: x -> v + {
      |            ^

      362 |         calculate: e is lag(c)
      363 |       }
    > 364 |     `).malloyResultMatches(runtime, {c: 1, e: null});
          |        ^
      365 |   });
      366 |   it(`aggregate copy bug - ${databaseName}`, async () => {
      367 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:364:8)

  ● aggregate copy bug - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 2: Invalid SQL, Error fetching SELECTschema for sql://redshift/1869b9f6-63d4-51c7-9c75-e431791ad39a: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |       source: x is redshift.sql('SELECT 1 as "n"') extend {
      |                    ^
    line 5: Reference to undefined object 'x'
      |       run: x -> n + c + {
      |            ^

      372 |         aggregate: e is c { where: false }
      373 |       }
    > 374 |     `).malloyResultMatches(runtime, {n: 1, c: 1, e: 0});
          |        ^
      375 |   });
      376 | });
      377 |

      at Object.<anonymous> (test/src/databases/all/lenses.spec.ts:374:8)

FAIL test/src/databases/all/sql_expressions.spec.ts (13.594 s)
  ● sql expression with turducken - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 4, character: 23 },
              end: { line: 4, character: 35 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |           redshift.table('malloytest.state_facts') -> {
      |           ^
    line 3: Invalid SQL, Error: Redefinition of undefined
      |         """SELECT * FROM (%{
      |         ^

      47 |         }) AS state_facts """
      48 |       ) -> { select: * }
    > 49 |     `).malloyResultMatches(runtime, {c: 51});
         |        ^
      50 |   });
      51 |   it(`sql expression in second of two queries in same block, dependent on first query - ${databaseName}`, async () => {
      52 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:49:8)

  ● sql expression in second of two queries in same block, dependent on first query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |         a is redshift.table('malloytest.state_facts') -> {
      |              ^
    line 7: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 3, character: 21 },
              end: { line: 3, character: 33 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |           """SELECT * FROM (%{ a -> { select: * } }) AS state_facts """
      |                                ^
    line 7: Invalid SQL, Error: Redefinition of undefined
      |           """SELECT * FROM (%{ a -> { select: * } }) AS state_facts """
      |           ^

      59 |         ) -> { select: * }
      60 |       run: b
    > 61 |     `).malloyResultMatches(runtime, {c: 51});
         |        ^
      62 |   });
      63 |   it(`sql expression in other sql expression - ${databaseName}`, async () => {
      64 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:61:8)

  ● sql expression in other sql expression - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: Invalid SQL, Error fetching SELECTschema for sql://redshift/48724aa7-019f-58ec-95f8-f2869d7db6a5: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      |           redshift.sql("""SELECT 1 as "one" """) -> { group_by: one }
      |                        ^
    line 4: 'one' is not defined
      |           redshift.sql("""SELECT 1 as "one" """) -> { group_by: one }
      |                                                                 ^
    line 2: Invalid SQL, Error: Unknown Dialect ~malformed~
      |       run: redshift.sql("""
      |                         ^
    line 6: 'one' is not defined
      |       """) -> { group_by: one }
      |                           ^

      68 |         }) as the_table
      69 |       """) -> { group_by: one }
    > 70 |     `).malloyResultMatches(runtime, {one: 1});
         |        ^
      71 |   });
      72 |   it(`run sql expression as query - ${databaseName}`, async () => {
      73 |     await expect(

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:70:8)

  ● run sql expression as query - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 1: Invalid SQL, Error fetching SELECTschema for sql://redshift/48724aa7-019f-58ec-95f8-f2869d7db6a5: Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
      | run: redshift.sql("""SELECT 1 as "one" """)
      |                   ^

      73 |     await expect(
      74 |       `run: ${databaseName}.sql("""SELECT 1 as ${q`one`} """)`
    > 75 |     ).malloyResultMatches(runtime, {one: 1});
         |       ^
      76 |   });
      77 | });
      78 |

      at Object.<anonymous> (test/src/databases/all/sql_expressions.spec.ts:75:7)

FAIL test/src/databases/all/composite_sources.spec.ts (12.751 s)
  ● redshift › basic composite usage

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:25:8)

  ● redshift › composite usage multistage

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:33:8)

  ● redshift › composite view multistage

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:43:8)

  ● redshift › composite source used in join

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 6: 'state' is not defined
      |         join_one: x on x.state = state
      |                        ^
    line 6: 'state' is not defined
      |         join_one: x on x.state = state
      |                                  ^

      52 |       }
      53 |       run: y -> { group_by: x.foo }
    > 54 |     `).malloyResultMatches(runtime, {foo: 1});
         |        ^
      55 |   });
      56 |   it('composite field from joined source used in join on', async () => {
      57 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:54:8)

  ● redshift › composite field from joined source used in join on

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |       source: x is compose(state_facts, state_facts extend { dimension: state_copy is state })
      |                                                                                       ^
    line 11: 'state' is not defined
      |       run: y -> { group_by: ca.state; where: state = 'IL' }
      |                                              ^
    line 11: 'state' is not defined
      |       run: y -> { group_by: ca.state; where: state = 'IL' }
      |                             ^
    line 11: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [
        {
          node: 'filterCondition',
          code: "state = 'IL'",
          e: { node: 'error', message: 'cascading error' },
          expressionType: 'scalar',
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: y -> { group_by: ca.state; where: state = 'IL' }
      |            ^

      66 |       }
      67 |       run: y -> { group_by: ca.state; where: state = 'IL' }
    > 68 |     `).malloyResultMatches(runtime, {state: 'CA'});
         |        ^
      69 |   });
      70 |   it('composite field from joining source used in join on', async () => {
      71 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:68:8)

  ● redshift › composite field from joining source used in join on

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 14: 'state' is not defined
      |         join_one: state_facts on state_one = state_facts.state
      |                                              ^
    line 16: 'state' is not defined
      |       run: x -> { group_by: state_facts.state }
      |                             ^
    line 16: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> { group_by: state_facts.state }
      |            ^

      85 |       }
      86 |       run: x -> { group_by: state_facts.state }
    > 87 |     `).malloyResultMatches(runtime, {state: 'CA'});
         |        ^
      88 |   });
      89 |   it('query against composite resolves nested composite source even when no composite fields', async () => {
      90 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:87:8)

  ● redshift › query against composite resolves nested composite source even when no composite fields

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:103:8)

  ● redshift › composite field used in view

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:114:8)

  ● redshift › composite field used in view refined with scalar

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |           where: state = 'CA'
      |                  ^
    line 6: 'state' is not defined
      |           group_by: state
      |                     ^

      126 |       }
      127 |       run: x -> v + foo
    > 128 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      129 |   });
      130 |   it('composite field used in view refined with literal view', async () => {
      131 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:128:8)

  ● redshift › composite field used in view refined with literal view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |           where: state = 'CA'
      |                  ^
    line 6: 'state' is not defined
      |           group_by: state
      |                     ^

      140 |       }
      141 |       run: x -> v + { group_by: foo }
    > 142 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      143 |   });
      144 |   it('composite field used in refined query', async () => {
      145 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:142:8)

  ● redshift › composite field used in refined query

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |           where: state = 'CA'
      |                  ^
    line 6: 'state' is not defined
      |           group_by: state
      |                     ^

      155 |       query: v is x -> v
      156 |       run: v + { group_by: foo }
    > 157 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      158 |   });
      159 |   it('composite of a composite', async () => {
      160 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:157:8)

  ● redshift › composite of a composite

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:174:8)

  ● redshift › definitions from composite extension carry through

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:187:8)

  ● redshift › filters from composite extension carry through

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 8: 'state' is not defined
      |         where: state = 'CA'
      |                ^
    line 10: 'state' is not defined
      |       run: x -> { group_by: foo, state }
      |                                  ^

      198 |       }
      199 |       run: x -> { group_by: foo, state }
    > 200 |     `).malloyResultMatches(runtime, {foo: 1, state: 'CA'});
          |        ^
      201 |   });
      202 |   it(`composite of a composite where greedy is bad- ${databaseName}`, async () => {
      203 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:200:8)

  ● redshift › composite of a composite where greedy is bad- redshift

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:217:8)

  ● redshift › composite with parameters

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:228:8)

  ● redshift › issue where measure defined on composite source has the wrong structPath

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: Reference to undefined value airport_count
      |         measure: total_airport_count is airport_count.sum()
      |                                         ^
    line 8: 'state' is not defined
      |         where: state = 'CA'
      |                ^
    line 7: Cannot use a scalar field in an aggregate operation, did you mean to use a group_by or select operation instead?
      |         aggregate: total_airport_count
      |                    ^

      238 |         where: state = 'CA'
      239 |       }
    > 240 |     `).malloyResultMatches(runtime, {total_airport_count: 984});
          |        ^
      241 |   });
      242 |   it('issue where query against composite source with no composite field usage does not resolve the source', async () => {
      243 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:240:8)

  ● redshift › issue where query against composite source with no composite field usage does not resolve the source

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: Reference to undefined value airport_count
      |         measure: total_airport_count is airport_count.sum()
      |                                         ^

      249 |         group_by: x is 1
      250 |       }
    > 251 |     `).malloyResultMatches(runtime, {x: 1});
          |        ^
      252 |   });
      253 |   it('reference composite field in nest', async () => {
      254 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:251:8)

  ● redshift › reference composite field in nest

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:262:8)

  ● redshift › composite with select *

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:272:8)

  ● redshift › composite with each

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:285:8)

  ● redshift › complex nesting composite without join

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:306:8)

  ● redshift › complex nesting composite with join -- literal view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 15: 'state' is not defined
      |         join_one: state_facts on the_state = state_facts.state
      |                                              ^
    line 17: 'state' is not defined
      |       run: x -> { group_by: state_facts.state }
      |                             ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> { group_by: state_facts.state }
      |            ^

      324 |       }
      325 |       run: x -> { group_by: state_facts.state }
    > 326 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      327 |   });
      328 |   it('complex nesting composite with join -- double extend to define view', async () => {
      329 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:326:8)

  ● redshift › complex nesting composite with join -- double extend to define view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 15: 'state' is not defined
      |         join_one: state_facts on the_state = state_facts.state
      |                                              ^
    line 17: 'state' is not defined
      |         view: y is { group_by: state_facts.state }
      |                                ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         view: y is { group_by: state_facts.state }
      |               ^
    line 19: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> y
      |                 ^

      346 |       }
      347 |       run: x -> y
    > 348 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      349 |   });
      350 |   it('complex nesting composite with join -- defined view', async () => {
      351 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:348:8)

  ● redshift › complex nesting composite with join -- defined view

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 15: 'state' is not defined
      |         join_one: state_facts on the_state = state_facts.state
      |                                              ^
    line 17: 'state' is not defined
      |         view: y is { group_by: state_facts.state }
      |                                ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |         view: y is { group_by: state_facts.state }
      |               ^
    line 19: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: x -> y
      |                 ^

      368 |       }
      369 |       run: x -> y
    > 370 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      371 |   });
      372 |   describe('index queries against composite sources', () => {
      373 |     it('index query selects second input', async () => {

      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:370:8)

  ● redshift › index queries against composite sources › index query selects second input

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:381:10)

  ● redshift › index queries against composite sources › index query selects first input

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:391:10)

  ● redshift › index queries against composite sources › index query resolves when two stages

    query.run failed: Redefinition of undefined
    Error: Redefinition of undefined

      4567 |   addFieldToNameMap(as: string, n: QueryField) {
      4568 |     if (this.nameMap.has(as)) {
    > 4569 |       throw new Error(`Redefinition of ${as}`);
           |             ^
      4570 |     }
      4571 |     this.nameMap.set(as, n);
      4572 |   }

      at QueryStruct.addFieldToNameMap (packages/malloy/src/model/malloy_query.ts:4569:13)
      at QueryStruct.addFieldsFromFieldList (packages/malloy/src/model/malloy_query.ts:4417:14)
      at new QueryStruct (packages/malloy/src/model/malloy_query.ts:4317:10)
      at QueryModel.loadModelFromDef (packages/malloy/src/model/malloy_query.ts:4900:14)
      at new QueryModel (packages/malloy/src/model/malloy_query.ts:4891:12)
      at PreparedQuery.getPreparedResult (packages/malloy/src/malloy.ts:1027:24)
      at _callee25$ (packages/malloy/src/malloy.ts:3079:41)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/composite_sources.spec.ts:401:10)

FAIL test/src/databases/all/parameters.spec.ts (26.4 s)
  ● number param used in dimension - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1+1 as "param_plus_one"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:26:8)

  ● number param used in sql function - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1 + 1 as "param_plus_one"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:35:8)

  ● can pass param into joined source correctly - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 6: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 12: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 19: 'state' is not defined
      |           s1 is state,
      |                 ^
    line 20: 'state' is not defined
      |           s2 is state_facts.state
      |                 ^

      76 |         aggregate: c is count()
      77 |       }
    > 78 |     `).malloyResultMatches(runtime, {s1: 'CA', s2: 'CA', c: 1});
         |        ^
      79 |   });
      80 |   it(`can pass param into extended source - ${databaseName}`, async () => {
      81 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:78:8)

  ● can pass param into extended source - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1 as "p"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:88:8)

  ● can shadow field that is excepted - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 5: Illegal `except:` of parameter
      |           except: state
      |                   ^

      149 |         }
      150 |       `
    > 151 |     ).malloyResultMatches(runtime, {hardcoded_state: 'NOT A STATE'});
          |       ^
      152 |   });
      153 |   it(`default value propagates - ${databaseName}`, async () => {
      154 |     await expect(

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:151:7)

  ● default value propagates - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         10 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:162:7)

  ● default value can be overridden - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         11 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:173:7)

  ● default value passed through extension propagates - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         11 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:185:7)

  ● use parameter in nested view - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        10 as "param_value_1__0",
        10 as "param_value_2__0",
        CASE WHEN group_set=1 THEN
          10
          END as "param_value_1__1",
        CASE WHEN group_set=1 THEN
          10
          END as "param_value_3__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3,4,5
    )
    , __stage1 AS (
      SELECT
        "param_value_1__0" as "param_value_1",
        "param_value_2__0" as "param_value_2",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT 
          "param_value_1__1"::DOUBLE PRECISION as "param_value_1", 
          "param_value_3__1"::DOUBLE PRECISION as "param_value_3"
          ) as __x)  ORDER BY  "param_value_1__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "n"
      FROM __stage0
      GROUP BY 1,2
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:204:7)

  ● can use param in join on - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 10: 'state' is not defined
      |         join_many: state_facts on state_facts.state = state_filter
      |                                   ^
    line 8: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 15: 'state' is not defined
      |           s1 is state,
      |                 ^
    line 16: 'state' is not defined
      |           s2 is state_facts.state
      |                 ^
    line 13: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'number',
          numberType: 'integer',
          name: 'c',
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 16, character: 19 },
              end: { line: 16, character: 31 }
            }
          },
          e: { node: 'aggregate', function: 'count', e: { node: '' } },
          compositeFieldUsage: { fields: [], joinedUsage: {} },
          expressionType: 'aggregate',
          code: 'count()'
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'c', dir: 'desc' } ]
    }
      |       run: state_facts2(state_filter is "CA") -> {
      |            ^

      269 |         aggregate: c is count()
      270 |       }
    > 271 |     `).malloyResultMatches(runtime, {s1: 'CA', s2: 'CA', c: 1});
          |        ^
      272 |   });
      273 |   it(`can use param in join with - ${databaseName}`, async () => {
      274 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:271:8)

  ● can use param in join with - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'state' is not defined
      |         primary_key: state
      |         ^
    line 12: join_one: Primary key 'undefined' not found in source
      |         join_one: state_facts with state_filter
      |                   ^
    line 10: 'state' is not defined
      |         where: state = state_filter
      |                ^
    line 17: 'state' is not defined
      |           s1 is state,
      |                 ^
    line 18: 'state' is not defined
      |           s2 is state_facts.state
      |                 ^

      292 |         aggregate: c is count()
      293 |       }
    > 294 |     `).malloyResultMatches(runtime, {s1: 'CA', s2: 'CA', c: 1});
          |        ^
      295 |   });
      296 |   it(`source arguments in query propagate when turned into source - ${databaseName}`, async () => {
      297 |     await expect(`

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:294:8)

  ● source arguments in query propagate when turned into source - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         1 as "param_value"
      FROM "malloytest"."state_facts" as base
    )
    , __stage1 AS (
      SELECT 
         base."param_value" as "param_value"
      FROM __stage0 as base
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:305:8)

  ● date parameters keep granularity when passing in - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         EXTRACT(day FROM DATE_TRUNC('month', DATE '2024-04-11')) as "date_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:314:8)

  ● can use parameter in null check - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 7: 'state' is not defined
      |         where: param is null and state = state_filter
      |                                  ^
    line 9: 'state' is not defined
      |       run: state_facts -> { group_by: state }
      |                                       ^

      324 |       }
      325 |       run: state_facts -> { group_by: state }
    > 326 |     `).malloyResultMatches(runtime, {state: 'CA'});
          |        ^
      327 |   });
      328 |   it(`default value not passed through extension propagates - ${databaseName}`, async () => {
      329 |     await expect(

      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:326:8)

  ● default value not passed through extension propagates - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         10 as "param_value"
      FROM "malloytest"."state_facts" as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage0 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/parameters.spec.ts:338:7)

FAIL test/src/databases/all/orderby.spec.ts (18.275 s)
  ● redshift › boolean type - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'seats' is not defined
      |         group_by: big is seats >=20
      |                          ^

      45 |         aggregate: model_count is count()
      46 |       }
    > 47 |     `).malloyResultMatches(orderByModel, {
         |        ^
      48 |       big: booleanResult(false, databaseName),
      49 |       model_count: 58451,
      50 |     });

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:47:8)

  ● redshift › boolean in pipeline - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'manufacturer' is not defined
      |           manufacturer,
      |           ^
    line 5: 'seats' is not defined
      |           big is seats >=21
      |                  ^

      62 |         aggregate: model_count is model_count.sum()
      63 |       }
    > 64 |     `).malloyResultMatches(orderByModel, {
         |        ^
      65 |       big: booleanResult(false, databaseName),
      66 |       model_count: 58500,
      67 |     });

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:64:8)

  ● redshift › filtered measures in model are aggregates #352 - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'manufacturer' is not defined
      |         aggregate: j_names is model_count {where: manufacturer ~ 'J%'}
      |                                                   ^

      75 |         group_by: j_names
      76 |       }
    > 77 |     `).malloyResultMatches(orderByModel, {j_names: 1358});
         |        ^
      78 |   });
      79 |
      80 |   it(`reserved words are quoted - ${databaseName}`, async () => {

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:77:8)

  ● redshift › reserved words are quoted - redshift

    query.run failed: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED
    SQL: WITH __stage0 AS (
      SELECT 
         COUNT(1) as "fetch"
      FROM "malloytest"."aircraft_models" as base
    )
    , __stage1 AS (
      SELECT 
         base."fetch" as "fetch"
      FROM __stage0 as base
      GROUP BY 1
      ORDER BY 1 asc NULLS LAST
    )
    SELECT row_to_json(finalStage) as row FROM __stage1 AS finalStage
    Error: Error executing batch query: Error: Batch query did not finish successfully. Status: FAILED

      378 |       console.log('Error executing Redshift batch query:', error);
      379 |       console.log('SQL that caused error:', sqlArray);
    > 380 |       throw new Error(`Error executing batch query: ${error}`);
          |             ^
      381 |     }
      382 |
      383 |     return {

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:380:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:87:8)

  ● redshift › reserved words are quoted in turtles - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'popular_name' is not defined
      |           group_by: select is upper(popular_name)
      |                                     ^
    line 2: INTERNAL ERROR model/Segment.nextStructDef: Redefinition of undefined
    QUERY: {
      type: 'reduce',
      queryFields: [
        {
          type: 'turtle',
          name: 'withx',
          pipeline: [
            {
              type: 'reduce',
              queryFields: [
                {
                  type: 'string',
                  name: 'select',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 3, character: 20 },
                      end: { line: 3, character: 49 }
                    }
                  },
                  e: {
                    node: 'function_call',
                    overload: {
                      returnType: {
                        type: 'string',
                        expressionType: 'scalar',
                        evalSpace: 'input'
                      },
                      params: [
                        {
                          name: 'value',
                          allowedTypes: [
                            {
                              type: 'string',
                              expressionType: undefined,
                              evalSpace: 'input'
                            }
                          ],
                          isVariadic: false
                        }
                      ],
                      dialect: {
                        postgres: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        standardsql: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        duckdb: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        snowflake: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        trino: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        presto: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        mysql: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        databricks: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        },
                        redshift: {
                          e: {
                            node: 'genericSQLExpr',
                            kids: {
                              args: [
                                {
                                  node: 'function_parameter',
                                  name: 'value'
                                }
                              ]
                            },
                            src: [ 'UPPER(', ')' ]
                          },
                          needsWindowOrderBy: undefined,
                          between: undefined,
                          defaultOrderByArgIndex: undefined
                        }
                      },
                      supportsOrderBy: undefined,
                      supportsLimit: undefined,
                      genericTypes: undefined,
                      isSymmetric: undefined
                    },
                    name: 'upper',
                    kids: {
                      args: [
                        {
                          node: 'error',
                          message: 'field-not-found'
                        }
                      ]
                    },
                    expressionType: 'scalar',
                    structPath: undefined
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'scalar',
                  code: 'upper(popular_name)'
                },
                {
                  type: 'number',
                  numberType: 'integer',
                  name: 'fetch',
                  location: {
                    url: 'internal://internal.malloy',
                    range: {
                      start: { line: 4, character: 21 },
                      end: { line: 4, character: 37 }
                    }
                  },
                  e: {
                    node: 'aggregate',
                    function: 'count',
                    e: { node: '' }
                  },
                  compositeFieldUsage: { fields: [], joinedUsage: {} },
                  expressionType: 'aggregate',
                  code: 'count()'
                }
              ],
              filterList: [],
              compositeFieldUsage: { fields: [], joinedUsage: {} },
              defaultOrderBy: true,
              orderBy: [ { field: 'fetch', dir: 'desc' } ]
            }
          ],
          annotation: { inherits: undefined },
          location: {
            url: 'internal://internal.malloy',
            range: {
              start: { line: 2, character: 14 },
              end: { line: 5, character: 9 }
            }
          },
          compositeFieldUsage: { fields: [], joinedUsage: {} }
        }
      ],
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} }
    }
      |       run: redshift.table('malloytest.state_facts')->{
      |            ^
    line 9: 'withx' is not defined
      |           withxz is lower(withx.select)
      |                           ^
    line 10: 'withx' is not defined
      |           fetch is withx.fetch
      |                    ^

      102 |           fetch is withx.fetch
      103 |       }
    > 104 |     `).malloyResultMatches(orderByModel, {});
          |        ^
      105 |     }
      106 |   );
      107 |

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:104:8)

  ● redshift › aggregate and scalar conditions - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'manufacturer' is not defined
      |         aggregate: model_count is count(){ where: manufacturer ? ~'A%' }
      |                                                   ^

      125 |         aggregate: model_count is count(){ where: manufacturer ? ~'A%' }
      126 |       }
    > 127 |     `).malloyResultMatches(orderByModel, {});
          |        ^
      128 |   });
      129 |
      130 |   // I'm not sure I have the syntax right here...

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:127:8)

  ● redshift › modeled having simple - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'manufacturer' is not defined
      |         group_by: manufacturer
      |                   ^
    line 9: 'manufacturer' is not defined
      |         select: manufacturer, model_count
      |                 ^

      140 |         select: manufacturer, model_count
      141 |       }
    > 142 |     `).malloyResultMatches(orderByModel, {model_count: 102});
          |        ^
      143 |   });
      144 |
      145 |   test.when(runtime.supportsNesting)(

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:142:8)

  ● redshift › modeled having complex - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 4: 'manufacturer' is not defined
      |           group_by: manufacturer
      |                     ^
    line 8: 'manufacturer' is not defined
      |             group_by: manufacturer
      |                       ^
    line 14: 'manufacturer' is not defined
      |           select: manufacturer, model_count
      |                   ^

      161 |           select: manufacturer, model_count
      162 |         }
    > 163 |       `).malloyResultMatches(orderByModel, {model_count: 102});
          |          ^
      164 |     }
      165 |   );
      166 |

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:163:10)

  ● redshift › turtle references joined element - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'tail_num' is not defined
      |         primary_key: tail_num
      |         ^
    line 8: 'id2' is not defined
      |         primary_key: id2
      |         ^
    line 9: 'tail_num' is not defined
      |         join_one: a with tail_num
      |                          ^
    line 9: join_one: Primary key 'undefined' not found in source
      |         join_one: a with tail_num
      |                   ^
    line 13: 'carrier' is not defined
      |           group_by: carrier
      |                     ^
    line 12: INTERNAL ERROR model/Segment.nextStructDef: tail_num not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        { type: 'fieldref', path: [ 'flight_count' ] },
        { type: 'fieldref', path: [ 'a', 'aircraft_count' ] }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: { a: { fields: [], joinedUsage: {} } }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'flight_count', dir: 'desc' } ]
    }
      |         view: foo is {
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: tail_num not found
    QUERY: {
      type: 'reduce',
      queryFields: [
        { type: 'fieldref', path: [ 'flight_count' ] },
        { type: 'fieldref', path: [ 'a', 'aircraft_count' ] }
      ],
      filterList: [],
      compositeFieldUsage: {
        fields: [],
        joinedUsage: { a: { fields: [], joinedUsage: {} } }
      },
      defaultOrderBy: true,
      orderBy: [ { field: 'flight_count', dir: 'desc' } ]
    }
      |       } -> foo
      |            ^

      183 |         }
      184 |       } -> foo
    > 185 |     `).malloyResultMatches(orderByModel, {});
          |        ^
      186 |   });
      187 | });
      188 |

      at Object.<anonymous> (test/src/databases/all/orderby.spec.ts:185:8)


Test Suites: 12 failed, 33 skipped, 29 passed, 41 of 74 total
Tests:       450 failed, 268 skipped, 2 todo, 1014 passed, 1734 total
Snapshots:   0 total
Time:        296.39 s
Ran all test suites.
