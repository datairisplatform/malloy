
> malloy@0.0.1 test
> jest --runInBand expr.spec

  console.log
    BRIAN fetching TABLE schema

      at RedshiftTestConnection._callee7$ (packages/malloy-db-redshift/src/redshift_connection.ts:266:13)

  console.log
    BRIAN schema rows: [
      {
        data_type: 'character varying(256)',
        col_name: 'aircraft_model_code'
      },
      { data_type: 'character varying(256)', col_name: 'manufacturer' },
      { data_type: 'character varying(256)', col_name: 'model' },
      { data_type: 'bigint', col_name: 'aircraft_type_id' },
      { data_type: 'bigint', col_name: 'aircraft_engine_type_id' },
      { data_type: 'bigint', col_name: 'aircraft_category_id' },
      { data_type: 'bigint', col_name: 'amateur' },
      { data_type: 'bigint', col_name: 'engines' },
      { data_type: 'bigint', col_name: 'seats' },
      { data_type: 'bigint', col_name: 'weight' },
      { data_type: 'bigint', col_name: 'speed' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:243:13)

  console.log
    BRIAN fetching TABLE schema

      at RedshiftTestConnection._callee7$ (packages/malloy-db-redshift/src/redshift_connection.ts:266:13)

  console.log
    BRIAN schema rows: [
      { data_type: 'bigint', col_name: 'id' },
      { data_type: 'character varying(256)', col_name: 'tail_num' },
      { data_type: 'character varying(256)', col_name: 'aircraft_serial' },
      {
        data_type: 'character varying(256)',
        col_name: 'aircraft_model_code'
      },
      {
        data_type: 'character varying(256)',
        col_name: 'aircraft_engine_code'
      },
      { data_type: 'bigint', col_name: 'year_built' },
      { data_type: 'bigint', col_name: 'aircraft_type_id' },
      { data_type: 'bigint', col_name: 'aircraft_engine_type_id' },
      { data_type: 'bigint', col_name: 'registrant_type_id' },
      { data_type: 'character varying(256)', col_name: 'name' },
      { data_type: 'character varying(256)', col_name: 'address1' },
      { data_type: 'character varying(256)', col_name: 'address2' },
      { data_type: 'character varying(256)', col_name: 'city' },
      { data_type: 'character varying(256)', col_name: 'state' },
      { data_type: 'character varying(256)', col_name: 'zip' },
      { data_type: 'character varying(256)', col_name: 'region' },
      { data_type: 'character varying(256)', col_name: 'county' },
      { data_type: 'character varying(256)', col_name: 'country' },
      { data_type: 'character varying(256)', col_name: 'certification' },
      { data_type: 'character varying(256)', col_name: 'status_code' },
      { data_type: 'character varying(256)', col_name: 'mode_s_code' },
      { data_type: 'character varying(256)', col_name: 'fract_owner' },
      { data_type: 'date', col_name: 'last_action_date' },
      { data_type: 'date', col_name: 'cert_issue_date' },
      { data_type: 'date', col_name: 'air_worth_date' }
    ]

      at RedshiftTestConnection._callee6$ (packages/malloy-db-redshift/src/redshift_connection.ts:243:13)

FAIL test/src/databases/all/expr.spec.ts (15.978 s)
  redshift
    ✕ join dependencies tracked from annotated references (3649 ms)
    ○ skipped basic calculations
    ○ skipped join dependencies tracked from annotated references
    ○ skipped Floor() -or any function bustage with aggregates
    ○ skipped computes mod correctly
    ○ skipped model: expression fixups.
    ○ skipped simple turtle
    ○ skipped double turtle
    ○ skipped double turtle - pipeline
    ○ skipped model: turtle
    ○ skipped model: filtered turtle
    ○ skipped model: simple having
    ○ skipped model: having in a nest
    ○ skipped model: turtle having on main
    ○ skipped model: having float group by partition
    ○ skipped model: aggregate functions distinct min max
    ○ skipped model: dates named
    ○ skipped named query metadata undefined
    ○ skipped named query metadata named
    ○ skipped named query metadata named head of pipeline
    ○ skipped filtered explores basic
    ○ skipped sql cast
    ○ skipped case expressions
    ○ skipped sql safe cast
    ○ skipped many_field.sum() has correct locality
    ○ skipped query with aliasname used twice
    ○ skipped joined filtered sources
    ○ skipped joined filtered explores with dependencies
    ○ skipped joined filtered explores with NO dependencies
    ○ skipped nullish ?? operator
    ○ skipped dimension expressions expanded with parens properly
    sql expr functions
      ○ skipped sql_string
      ○ skipped sql_number
      ○ skipped sql_number can be sum()med
      ○ skipped sql_boolean
      ○ skipped sql_date
      ○ skipped sql_timestamp
      ○ skipped with ${TABLE}.field
      ○ skipped with ${field}
      [not yet supported]
        ○ skipped ${view_name.dimension_name} - one path
        ○ skipped ${view_name.dimension_name} - multiple paths
        ○ skipped ${view_name.SQL_TABLE_NAME}
    alternations with not-eq
      ○ skipped x not-eq y or z : x eq y
      ○ skipped x not-eq y or z : x eq z
      ○ skipped x not-eq y or z : else
      ○ skipped x not-eq y and not-eq z : x eq y
      ○ skipped x not-eq y and not-eq z : x eq z
      ○ skipped x not-eq y and not-eq z : else
    string literal quoting
      ○ skipped quote single character
      ○ skipped quote single quote
      ○ skipped quote double quote
      ○ skipped quote backslash
    null safe booleans
      ○ skipped select boolean
      ○ skipped not boolean
      ○ skipped numeric != non-null to null
      ○ skipped string !~ non-null to null
      ○ skipped regex !~ non-null to null
      ○ skipped numeric != null-to-null
      ○ skipped string !~ null-to-null

  ● redshift › join dependencies tracked from annotated references

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 3: 'aircraft_model_code' is not defined
      |   primary_key: aircraft_model_code
      |   ^
    line 6: 'seats' is not defined
      |     total_seats is sum(seats),
      |                        ^
    line 7: 'seats' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                         ^
    line 7: 'manufacturer' is not defined
      |     boeing_seats is sum(seats) { where: manufacturer ? 'BOEING'},
      |                                         ^
    line 8: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing is boeing_seats / total_seats * 100,
      |     ^
    line 9: Cannot use a scalar field in a measure declaration, did you mean to use a dimension declaration instead?
      |     percent_boeing_floor is floor(boeing_seats / total_seats * 100),
      |     ^
    line 10: 'seats' is not defined
      |   dimension: seats_bucketed is floor(seats/20)*20.0
      |                                      ^
    line 14: 'tail_num' is not defined
      |   primary_key: tail_num
      |   ^
    line 15: 'aircraft_model_code' is not defined
      |   join_one: aircraft_models with aircraft_model_code
      |                                  ^
    line 15: join_one: Primary key 'undefined' not found in source
      |   join_one: aircraft_models with aircraft_model_code
      |             ^
    line 19: 'manufacturer' is not defined
      |     group_by: aircraft_models.manufacturer
      |               ^
    line 17: INTERNAL ERROR model/Segment.nextStructDef: unknown field definition 2
    QUERY: {
      type: 'reduce',
      queryFields: [ { type: 'fieldref', path: [ 'aircraft_count' ] } ],
      limit: 5,
      filterList: [],
      compositeFieldUsage: { fields: [], joinedUsage: {} },
      defaultOrderBy: true,
      orderBy: [ { field: 'aircraft_count', dir: 'desc' } ]
    }
      |   view: by_manufacturer is {
      |         ^

      102 |         select: seats
      103 |       }
    > 104 |     `).malloyResultMatches(expressionModel, {
          |        ^
      105 |       seats: 0,
      106 |     });
      107 |   });

      at Object.<anonymous> (test/src/databases/all/expr.spec.ts:104:8)

Test Suites: 1 failed, 1 skipped, 1 of 2 total
Tests:       1 failed, 77 skipped, 78 total
Snapshots:   0 total
Time:        16.346 s, estimated 17 s
Ran all test suites matching /expr.spec/i.
