
> malloy@0.0.1 test
> jest --runInBand functions

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        base."state" as "state__0",
        CASE WHEN group_set=1 THEN
          airports_0."county"
          END as "county__1",
        CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."state"  ORDER BY  CASE WHEN group_set=1 THEN
          airports_0."county"
          END asc NULLS LAST ) END as "row_num__1"
      FROM "malloytest"."state_facts" as base
       LEFT JOIN "malloytest"."airports" AS airports_0
        ON airports_0."state"=base."state"
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3
    )
    SELECT
      "state__0" as "state",
      COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
        "county__1" as "county",
        "row_num__1"::DOUBLE PRECISION as "row_num"
        ) as __x)  ORDER BY  "county__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "q"
    FROM __stage0
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        base."state" as "state__0",
        CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  base."state" asc NULLS LAST ) END as "row_num__0",
        CASE WHEN group_set=1 THEN
          base."state"
          END as "state__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,4
    )
    SELECT
      "state__0" as "state",
      (ARRAY_AGG("row_num__0") FILTER (WHERE group_set=0 AND "row_num__0" IS NOT NULL))[1] as "row_num",
      COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
        "state__1" as "state"
        ) as __x)  ORDER BY  "state__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "nested"
    FROM __stage0
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "first_letter",
       (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 as "states_with_first_letter_ish",
       RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST ) as "r"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1
    ORDER BY 2 desc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "first_letter",
       (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 as "states_with_first_letter_ish",
       RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST ) as "r",
       -(RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST )) as "neg_r"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1
    ORDER BY 2 desc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        base."faa_region" as "faa_region__0",
        CASE WHEN group_set=0 THEN
          COUNT(1)
          END as "airport_count__0",
        CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          base."fac_type"
          END as "fac_type__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "airport_count__1",
        CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."faa_region"  ORDER BY  CASE WHEN group_set=1 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id2__1",
        CASE WHEN group_set=2 THEN
          AVG(base."elevation")
          END as "avg_elevation__2"
      FROM "malloytest"."airports" as base
      CROSS JOIN GENERATE_SERIES(0,2,1) as group_set
      GROUP BY 1,2,5
    )
    , __stage1 AS (
      SELECT
        CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,
        "faa_region__0" as "faa_region__0",
        MAX("airport_count__0") as "airport_count__0",
        MAX("id__0") as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          "fac_type__1"
          END as "fac_type__1",
        MAX("airport_count__1") as "airport_count__1",
        MAX("id2__1") as "id2__1",
        TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT
          "avg_elevation__2"::DOUBLE PRECISION as "avg_elevation") as __x)) FILTER (WHERE group_set=2))[1]) as "elevation__1"
      FROM __stage0
      GROUP BY 1,2,5
    )
    , __stage2 AS (
      SELECT
        "faa_region__0" as "faa_region",
        (ARRAY_AGG("airport_count__0") FILTER (WHERE group_set=0 AND "airport_count__0" IS NOT NULL))[1] as "airport_count",
        (ARRAY_AGG("id__0") FILTER (WHERE group_set=0 AND "id__0" IS NOT NULL))[1] as "id",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
          "fac_type__1" as "fac_type",
          "airport_count__1"::DOUBLE PRECISION as "airport_count",
          "id2__1"::DOUBLE PRECISION as "id2",
          "elevation__1" as "elevation"
          ) as __x)  ORDER BY  "airport_count__1" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as "by_fac_type"
      FROM __stage1
      GROUP BY 1
    )
    SELECT
       JSONB_EXTRACT_PATH_TEXT(by_fac_type_0,'id2')::double precision as "id2"
    FROM __stage2 as base
    LEFT JOIN JSONB_ARRAY_ELEMENTS(base."by_fac_type") as by_fac_type_0 ON true
    GROUP BY 1
    ORDER BY 1 desc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
        group_set,
        base."state" as "state__0",
        CASE WHEN group_set=1 THEN
          base."county"
          END as "county__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "aircraft_count__1",
        CASE WHEN group_set=1 THEN FIRST_VALUE(CASE WHEN group_set=1 THEN
          COUNT(1)
          END) OVER(PARTITION BY group_set, base."state"  ORDER BY  CASE WHEN group_set=1 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "first_count__1"
      FROM "malloytest"."aircraft" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      WHERE base."state" IS NOT NULL
      GROUP BY 1,2,3
    )
    SELECT
      "state__0" as "state",
      COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
        "county__1" as "county",
        "aircraft_count__1"::DOUBLE PRECISION as "aircraft_count",
        "first_count__1"::DOUBLE PRECISION as "first_count"
        ) as __x)  ORDER BY  "aircraft_count__1" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as "by_county"
    FROM __stage0
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       base."state" as "state",
       base."births" as "births",
       FIRST_VALUE((base."births")) OVER(  ORDER BY  base."births" desc NULLS LAST ) as "most_births"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1,2
    ORDER BY 2 desc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       aircraft_models_0."seats" as "seats",
       LAG(COALESCE(CAST((
        (
          SUM(DISTINCT
            (CAST(ROUND(COALESCE(aircraft_models_0."seats",0)*(1*1.0), 9) AS DECIMAL) +
            ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)
          ))
          -
           SUM(DISTINCT ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))
        )/(1*1.0)) AS DOUBLE PRECISION),0)) OVER(  ORDER BY  aircraft_models_0."seats" asc NULLS LAST ) as "prev_sum_of_seats"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       COALESCE(STARTS_WITH('hello world', 'hello'), false) as "f0",
       COALESCE(STARTS_WITH('hello world', 'world'), false) as "f1",
       COALESCE(STARTS_WITH(NULL, 'world'), false) as "f2",
       COALESCE(STARTS_WITH('hello world', NULL), false) as "f3"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1,2,3,4
    ORDER BY 1 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."aircraft_count" as "aircraft_count",
         base."airport_count" as "airport_count",
         base."births" as "births",
         base."popular_name" as "popular_name",
         base."state" as "state"
      FROM "malloytest"."state_facts" as base
      LIMIT 10
    )
    SELECT
       base."state" as "state",
       LEAD((base."state"),1,'NONE') OVER(  ORDER BY  base."state" asc NULLS LAST ) as "next_state"
    FROM __stage0 as base
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."aircraft_count" as "aircraft_count",
         base."airport_count" as "airport_count",
         base."births" as "births",
         base."popular_name" as "popular_name",
         base."state" as "state"
      FROM "malloytest"."state_facts" as base
      LIMIT 5
    )
    SELECT
       base."state" as "state",
       base."births" as "births",
       MIN((base."births")) OVER(  ORDER BY  base."births" asc NULLS LAST ) as "min_c",
       MAX((base."births")) OVER(  ORDER BY  base."births" asc NULLS LAST ) as "max_c",
       SUM((base."births")) OVER(  ORDER BY  base."births" asc NULLS LAST ) as "sum_c",
       MIN((base."births")) OVER(  ) as "min_w",
       MAX((base."births")) OVER(  ) as "max_w",
       SUM((base."births")) OVER(  ) as "sum_w"
    FROM __stage0 as base
    GROUP BY 1,2
    ORDER BY 2 asc NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(base."name", ',' ORDER BY base."city", base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY LENGTH(base."name")) as "f"
    FROM __stage0 as base

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(base."name", ',' ORDER BY aircraft_models_0."model") as "f"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" ~ '.*ADVENTURE.*'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',' ORDER BY (a::json->>'f3'), (a::json->>'f4')) as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",base."state",base."popular_name",base."state"))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o'))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), '') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o',''))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(DISTINCT aircraft_0."name", ',' ORDER BY aircraft_0."name" ASC) as "f_dist",
       STRING_AGG(aircraft_0."name", ',' ORDER BY aircraft_0."name") as "f_all"
    FROM "malloytest"."aircraft_models" as base
     LEFT JOIN "malloytest"."aircraft" AS aircraft_0
      ON base."aircraft_model_code"=aircraft_0."aircraft_model_code"
    WHERE aircraft_0."name" IN ('RAYTHEON AIRCRAFT COMPANY','FOWLER IRA R DBA')

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       COUNT(1) as "c",
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "l",
       LAG((SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1))) OVER(PARTITION BY (COUNT(1))  ORDER BY  SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) ASC NULLS LAST ) as "prev"
    FROM "malloytest"."state_facts" as base
    GROUP BY 2
    ORDER BY 2 ASC NULLS LAST
    LIMIT 5

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

  console.log
    Error in SQL:
     SELECT
       base."name" as "name",
       RANK() OVER( ORDER BY COUNT(DISTINCT aircraft_models_0."aircraft_model_code") DESC, COALESCE(CAST((
        (
          SUM(DISTINCT
            (CAST(ROUND(COALESCE(aircraft_models_0."seats",0)*(1*1.0), 9) AS DECIMAL) +
            ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)
          ))
          -
           SUM(DISTINCT ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))
        )/(1*1.0)) AS DOUBLE PRECISION),0) DESC ) as "r"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" IN ('UNITED AIR LINES INC','FEDERAL EXPRESS CORP','AMERICAN AIRLINES INC','CESSNA AIRCRAFT COMPANY')
    GROUP BY 1
    ORDER BY 1 ASC NULLS LAST

      at RedshiftTestConnection.runSQL (test/src/runtimes.ts:148:15)

FAIL test/src/databases/all/functions.spec.ts (157.227 s)
  concat
    ✓ works - redshift (10540 ms)
  round
    ✓ works - redshift (1515 ms)
  floor
    ✓ works - redshift (3083 ms)
  ceil
    ✓ works - redshift (1518 ms)
  length
    ✓ works - redshift (1478 ms)
  lower
    ✓ works - redshift (1621 ms)
  upper
    ✓ works - redshift (1399 ms)
  regexp_extract
    ✓ works - redshift (1483 ms)
  replace
    ✓ works - redshift (1410 ms)
  substr
    ✓ works - redshift (1500 ms)
  raw function call
    ✓ works - redshift (1413 ms)
  row_number
    ✓ works when the order by is a dimension  - redshift (1420 ms)
    ✓ works when the order by is a dimension in the other order  - redshift (1518 ms)
    ✓ works when the order by is a measure - redshift (1446 ms)
    ✓ works when the order by is a measure but there is no group by - redshift (1521 ms)
    ✕ works inside nest - redshift (1437 ms)
    ✕ works outside nest, but with a nest nearby - redshift (1425 ms)
  rank
    ✓ works ordered by dimension - redshift (1517 ms)
    ✕ works ordered by aggregate - redshift (1327 ms)
    ✕ works using unary minus in calculate block - redshift (1385 ms)
    ✕ properly isolated nested calculations - redshift (1418 ms)
  lag
    ✓ works with one param - redshift (1530 ms)
    ✓ works with expression field - redshift (1605 ms)
    ✓ works with expression - redshift (1580 ms)
    ✓ works with field, ordering by expression field - redshift (1417 ms)
    ✓ works with offset - redshift (1573 ms)
    ○ skipped works with default value - redshift
    ○ skipped works with now as the default value - redshift
  output field in calculate
    ✓ output field referenceable in calculate - redshift (1495 ms)
  first_value
    ✕ works in nest - redshift (1385 ms)
    ✕ works outside nest - redshift (1383 ms)
    ✓ works with an aggregate which is not in the query - redshift (1399 ms)
    ✕ works with a localized aggregate - redshift (1541 ms)
  trunc
    ✓ works - redshift (1554 ms)
  log
    ✓ works - redshift (1429 ms)
  ln
    ✓ works - redshift (1443 ms)
  exp
    ✓ works - redshift (1432 ms)
  cos
    ✓ works - redshift (1509 ms)
  acos
    ✓ works - redshift (1423 ms)
  sin
    ✓ works - redshift (1429 ms)
  asin
    ✓ works - redshift (1408 ms)
  tan
    ✓ works - redshift (1457 ms)
  atan
    ✓ works - redshift (1456 ms)
  atan2
    ✓ works - redshift (1395 ms)
  sqrt
    ✓ works - redshift (1426 ms)
  pow
    ✓ works - redshift (1447 ms)
  abs
    ✓ works - redshift (1411 ms)
  sign
    ✓ works - redshift (1449 ms)
  is_inf
    ○ skipped works - redshift
  is_nan
    ○ skipped works - redshift
  greatest
    ○ skipped works - redshift
  least
    ○ skipped works - redshift
  div
    ✓ works - redshift (1381 ms)
  strpos
    ✓ works - redshift (1422 ms)
  starts_with
    ✕ works - redshift (1340 ms)
  ends_with
    ✕ works - redshift (1432 ms)
  trim
    ✓ trim works - redshift (1576 ms)
  ltrim
    ✓ ltrim works - redshift (1424 ms)
  rtrim
    ✓ rtrim works - redshift (1387 ms)
  rand
    ✕ is usually not the same value - redshift (1421 ms)
  pi
    ✕ is pi - redshift (1435 ms)
  byte_length
    ✓ works - redshift (1477 ms)
  ifnull
    ✓ works - redshift (1463 ms)
  coalesce
    ✓ works - redshift (1485 ms)
  nullif
    ✓ works - redshift (1447 ms)
  chr
    ✓ works - redshift (1431 ms)
  ascii
    ✓ works - redshift (1426 ms)
  unicode
    ✓ works - redshift (1389 ms)
  string_repeat
    ✓ works - redshift (1574 ms)
    ○ skipped works floor decimal - redshift
  reverse
    ✓ works - redshift (1465 ms)
  lead
    ✓ works with one param - redshift (1576 ms)
    ✓ works with offset - redshift (1604 ms)
    ✕ works with default value - redshift (1376 ms)
  count_approx
    ○ skipped works generally
    ○ skipped works with fanout
  last_value
    ✓ works - redshift (1521 ms)
  avg_moving
    ✓ works - redshift (1438 ms)
    ✓ works forward - redshift (1387 ms)
  sum_moving
    ✓ works - redshift (1571 ms)
    ✓ works forward - redshift (1485 ms)
  min, max, sum / window, cumulative
    ✕ works - redshift (1328 ms)
  hll_functions
    ○ skipped hyperloglog basic - redshift
    ○ skipped hyperloglog combine - redshift
    ○ skipped hyperloglog import/export - redshift
  snowflake_statistical_functions
    ○ skipped stddev works - redshift
    ○ skipped stddev_pop works - redshift
    ○ skipped variance works - redshift
    ○ skipped var_pop works - redshift
    ○ skipped var_samp works - redshift
    ○ skipped corr works - redshift
    ○ skipped covar_pop works - redshift
    ○ skipped covar_samp works - redshift
    ○ skipped percent_rank basic - redshift
    ○ skipped percent_rank with partition - redshift
  dialect functions
    duckdb
      ○ skipped to_timestamp
      ○ skipped list_extract
      ○ skipped date_part,to_seconds
    trino
      ○ skipped from_unixtime
  redshift
    string_agg
      ✕ works no order by - redshift (1412 ms)
      ✕ works with dotted shortcut - redshift (1358 ms)
      ✕ works with order by field - redshift (1390 ms)
      ✓ works with order by direction - redshift (21 ms)
      ✕ works with multiple order_bys - redshift (1357 ms)
      ✕ works with order by expression - redshift (1385 ms)
      ✕ works with order by join expression - redshift (1365 ms)
      ✕ works with order asc - redshift (1370 ms)
      ✕ works with order desc - redshift (1336 ms)
      ✕ works with fanout and order_by - redshift (1378 ms)
      ✕ works with fanout - redshift (1399 ms)
      ✕ works with fanout and separator - redshift (1325 ms)
      ✓ works with limit - redshift (17 ms)
    string_agg_distinct
      ✕ actually distincts - redshift (1378 ms)
      ✕ works no order by - redshift (1340 ms)
      ✕ works with dotted shortcut - redshift (1368 ms)
      ✕ works with order by direction - redshift (1342 ms)
      ✕ works with order asc - redshift (1369 ms)
      ✕ works with order desc - redshift (1457 ms)
      ✓ works with limit - redshift (22 ms)
    partition_by
      ✕ works - redshift (18 ms)
      ✕ works with aggregate - redshift (1539 ms)
      ✕ works with multiple order_bys - redshift (1435 ms)
      ✓ can be used in a select (1484 ms)

  ● row_number › works inside nest - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
        group_set,
        base."state" as "state__0",
        CASE WHEN group_set=1 THEN
          airports_0."county"
          END as "county__1",
        CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."state"  ORDER BY  CASE WHEN group_set=1 THEN
          airports_0."county"
          END asc NULLS LAST ) END as "row_num__1"
      FROM "malloytest"."state_facts" as base
       LEFT JOIN "malloytest"."airports" AS airports_0
        ON airports_0."state"=base."state"
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,3
    )
    SELECT
      "state__0" as "state",
      COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
        "county__1" as "county",
        "row_num__1"::DOUBLE PRECISION as "row_num"
        ) as __x)  ORDER BY  "county__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "q"
    FROM __stage0
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "064cacd3-f9c9-4e18-ab46-0f8c6bec20c5",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:31.165Z",
      "Database": "dev",
      "Duration": 46107802,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"as __x)  ORDER\", at line 22, column 16\n  Position: 748",
      "HasResultSet": false,
      "Id": "e6646251-ed47-4a69-b6dc-c5fc90aef83e",
      "RedshiftPid": 1073905810,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:31.253Z",
          "Duration": 46107802,
          "HasResultSet": false,
          "Id": "e6646251-ed47-4a69-b6dc-c5fc90aef83e:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:31.677Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:31.256Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"as __x)  ORDER\", at line 22, column 16\n  Position: 748",
          "HasResultSet": false,
          "Id": "e6646251-ed47-4a69-b6dc-c5fc90aef83e:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT\n    group_set,\n    base.\"state\" as \"state__0\",\n    CASE WHEN group_set=1 THEN\n      airports_0.\"county\"\n      END as \"county__1\",\n    CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base.\"state\"  ORDER BY  CASE WHEN group_set=1 THEN\n      airports_0.\"county\"\n      END asc NULLS LAST ) END as \"row_num__1\"\n  FROM \"malloytest\".\"state_facts\" as base\n   LEFT JOIN \"malloytest\".\"airports\" AS airports_0\n    ON airports_0.\"state\"=base.\"state\"\n  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n  GROUP BY 1,2,3\n)\nSELECT\n  \"state__0\" as \"state\",\n  COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n    \"county__1\" as \"county\", \n    \"row_num__1\"::DOUBLE PRECISION as \"row_num\"\n    ) as __x)  ORDER BY  \"county__1\" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as \"q\"\nFROM __stage0\nGROUP BY 1\nORDER BY 1 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:31.677Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:31.742Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● row_number › works outside nest, but with a nest nearby - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
        group_set,
        base."state" as "state__0",
        CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  base."state" asc NULLS LAST ) END as "row_num__0",
        CASE WHEN group_set=1 THEN
          base."state"
          END as "state__1"
      FROM "malloytest"."state_facts" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      GROUP BY 1,2,4
    )
    SELECT
      "state__0" as "state",
      (ARRAY_AGG("row_num__0") FILTER (WHERE group_set=0 AND "row_num__0" IS NOT NULL))[1] as "row_num",
      COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
        "state__1" as "state"
        ) as __x)  ORDER BY  "state__1" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as "nested"
    FROM __stage0
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "faf68e87-d34b-4a9f-a7c5-04be0339b5a7",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:32.587Z",
      "Database": "dev",
      "Duration": 54725138,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"FILTER\" in context \"ARRAY_AGG(\"row_num__0\") FILTER\", at line 15, column 28\n  Position: 453",
      "HasResultSet": false,
      "Id": "8d941b6f-0893-47ec-89cc-a724e1750b9c",
      "RedshiftPid": 1073987732,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:32.692Z",
          "Duration": 54725138,
          "HasResultSet": false,
          "Id": "8d941b6f-0893-47ec-89cc-a724e1750b9c:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:33.143Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:32.696Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"FILTER\" in context \"ARRAY_AGG(\"row_num__0\") FILTER\", at line 15, column 28\n  Position: 453",
          "HasResultSet": false,
          "Id": "8d941b6f-0893-47ec-89cc-a724e1750b9c:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT\n    group_set,\n    base.\"state\" as \"state__0\",\n    CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  base.\"state\" asc NULLS LAST ) END as \"row_num__0\",\n    CASE WHEN group_set=1 THEN\n      base.\"state\"\n      END as \"state__1\"\n  FROM \"malloytest\".\"state_facts\" as base\n  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n  GROUP BY 1,2,4\n)\nSELECT\n  \"state__0\" as \"state\",\n  (ARRAY_AGG(\"row_num__0\") FILTER (WHERE group_set=0 AND \"row_num__0\" IS NOT NULL))[1] as \"row_num\",\n  COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n    \"state__1\" as \"state\"\n    ) as __x)  ORDER BY  \"state__1\" asc NULLS LAST ) FILTER (WHERE group_set=1))),'[]'::JSONB) as \"nested\"\nFROM __stage0\nGROUP BY 1\nORDER BY 1 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:33.143Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:33.219Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works ordered by aggregate - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "first_letter",
       (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 as "states_with_first_letter_ish",
       RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST ) as "r"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1
    ORDER BY 2 desc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "6d2d7e3f-415c-4f9e-9b6b-73195d49a40a",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:35.469Z",
      "Database": "dev",
      "Duration": 43855755,
      "Error": "Query #2 failed with ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1226527[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073856644]\n  -----------------------------------------------\n",
      "HasResultSet": false,
      "Id": "f2078119-4b4a-46ec-a79d-1f518e429206",
      "RedshiftPid": 1073856644,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:35.550Z",
          "Duration": 43855755,
          "HasResultSet": false,
          "Id": "f2078119-4b4a-46ec-a79d-1f518e429206:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:35.981Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:35.554Z",
          "Duration": -1,
          "Error": "ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1226527[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073856644]\n  -----------------------------------------------\n",
          "HasResultSet": false,
          "Id": "f2078119-4b4a-46ec-a79d-1f518e429206:2",
          "QueryString": "SELECT \n   SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1) as \"first_letter\",\n   (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 as \"states_with_first_letter_ish\",\n   RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST ) as \"r\"\nFROM \"malloytest\".\"state_facts\" as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:35.981Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:36.046Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › works using unary minus in calculate block - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "first_letter",
       (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 as "states_with_first_letter_ish",
       RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST ) as "r",
       -(RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST )) as "neg_r"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1
    ORDER BY 2 desc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "1a020ce4-ec77-44c6-9695-d9a35eb65cad",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:36.837Z",
      "Database": "dev",
      "Duration": 43113066,
      "Error": "Query #2 failed with ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1226536[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073741963]\n  -----------------------------------------------\n",
      "HasResultSet": false,
      "Id": "d0eb0d10-e965-4dad-af34-279e7d9f679c",
      "RedshiftPid": 1073741963,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:36.931Z",
          "Duration": 43113066,
          "HasResultSet": false,
          "Id": "d0eb0d10-e965-4dad-af34-279e7d9f679c:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:37.374Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:36.934Z",
          "Duration": -1,
          "Error": "ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1226536[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073741963]\n  -----------------------------------------------\n",
          "HasResultSet": false,
          "Id": "d0eb0d10-e965-4dad-af34-279e7d9f679c:2",
          "QueryString": "SELECT \n   SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1) as \"first_letter\",\n   (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 as \"states_with_first_letter_ish\",\n   RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST ) as \"r\",\n   -(RANK() OVER(  ORDER BY  (ROUND((COUNT(1)*1.0/2)::FLOAT8))*2 desc NULLS LAST )) as \"neg_r\"\nFROM \"malloytest\".\"state_facts\" as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:37.374Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:37.449Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● rank › properly isolated nested calculations - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
        group_set,
        base."faa_region" as "faa_region__0",
        CASE WHEN group_set=0 THEN
          COUNT(1)
          END as "airport_count__0",
        CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          base."fac_type"
          END as "fac_type__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "airport_count__1",
        CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."faa_region"  ORDER BY  CASE WHEN group_set=1 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id2__1",
        CASE WHEN group_set=2 THEN
          AVG(base."elevation")
          END as "avg_elevation__2"
      FROM "malloytest"."airports" as base
      CROSS JOIN GENERATE_SERIES(0,2,1) as group_set
      GROUP BY 1,2,5
    )
    , __stage1 AS (
      SELECT
        CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,
        "faa_region__0" as "faa_region__0",
        MAX("airport_count__0") as "airport_count__0",
        MAX("id__0") as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          "fac_type__1"
          END as "fac_type__1",
        MAX("airport_count__1") as "airport_count__1",
        MAX("id2__1") as "id2__1",
        TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT
          "avg_elevation__2"::DOUBLE PRECISION as "avg_elevation") as __x)) FILTER (WHERE group_set=2))[1]) as "elevation__1"
      FROM __stage0
      GROUP BY 1,2,5
    )
    , __stage2 AS (
      SELECT
        "faa_region__0" as "faa_region",
        (ARRAY_AGG("airport_count__0") FILTER (WHERE group_set=0 AND "airport_count__0" IS NOT NULL))[1] as "airport_count",
        (ARRAY_AGG("id__0") FILTER (WHERE group_set=0 AND "id__0" IS NOT NULL))[1] as "id",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
          "fac_type__1" as "fac_type",
          "airport_count__1"::DOUBLE PRECISION as "airport_count",
          "id2__1"::DOUBLE PRECISION as "id2",
          "elevation__1" as "elevation"
          ) as __x)  ORDER BY  "airport_count__1" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as "by_fac_type"
      FROM __stage1
      GROUP BY 1
    )
    SELECT
       JSONB_EXTRACT_PATH_TEXT(by_fac_type_0,'id2')::double precision as "id2"
    FROM __stage2 as base
    LEFT JOIN JSONB_ARRAY_ELEMENTS(base."by_fac_type") as by_fac_type_0 ON true
    GROUP BY 1
    ORDER BY 1 desc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "e32dbcb6-4bcb-4643-a6a2-d45a22a84cce",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:38.241Z",
      "Database": "dev",
      "Duration": 44316996,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"FILTER\" in context \"__x)) FILTER\", at line 39, column 73\n  Position: 1390",
      "HasResultSet": false,
      "Id": "61bb8d63-2602-4984-80e3-3da849bdb67e",
      "RedshiftPid": 1073987722,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:38.340Z",
          "Duration": 44316996,
          "HasResultSet": false,
          "Id": "61bb8d63-2602-4984-80e3-3da849bdb67e:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:38.753Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:38.344Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"FILTER\" in context \"__x)) FILTER\", at line 39, column 73\n  Position: 1390",
          "HasResultSet": false,
          "Id": "61bb8d63-2602-4984-80e3-3da849bdb67e:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT\n    group_set,\n    base.\"faa_region\" as \"faa_region__0\",\n    CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END as \"airport_count__0\",\n    CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END desc NULLS LAST ) END as \"id__0\",\n    CASE WHEN group_set IN (1,2) THEN\n      base.\"fac_type\"\n      END as \"fac_type__1\",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as \"airport_count__1\",\n    CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base.\"faa_region\"  ORDER BY  CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END desc NULLS LAST ) END as \"id2__1\",\n    CASE WHEN group_set=2 THEN\n      AVG(base.\"elevation\")\n      END as \"avg_elevation__2\"\n  FROM \"malloytest\".\"airports\" as base\n  CROSS JOIN GENERATE_SERIES(0,2,1) as group_set\n  GROUP BY 1,2,5\n)\n, __stage1 AS (\n  SELECT \n    CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,\n    \"faa_region__0\" as \"faa_region__0\",\n    MAX(\"airport_count__0\") as \"airport_count__0\",\n    MAX(\"id__0\") as \"id__0\",\n    CASE WHEN group_set IN (1,2) THEN\n      \"fac_type__1\"\n      END as \"fac_type__1\",\n    MAX(\"airport_count__1\") as \"airport_count__1\",\n    MAX(\"id2__1\") as \"id2__1\",\n    TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT \n      \"avg_elevation__2\"::DOUBLE PRECISION as \"avg_elevation\") as __x)) FILTER (WHERE group_set=2))[1]) as \"elevation__1\"\n  FROM __stage0\n  GROUP BY 1,2,5\n)\n, __stage2 AS (\n  SELECT\n    \"faa_region__0\" as \"faa_region\",\n    (ARRAY_AGG(\"airport_count__0\") FILTER (WHERE group_set=0 AND \"airport_count__0\" IS NOT NULL))[1] as \"airport_count\",\n    (ARRAY_AGG(\"id__0\") FILTER (WHERE group_set=0 AND \"id__0\" IS NOT NULL))[1] as \"id\",\n    COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n      \"fac_type__1\" as \"fac_type\", \n      \"airport_count__1\"::DOUBLE PRECISION as \"airport_count\", \n      \"id2__1\"::DOUBLE PRECISION as \"id2\", \n      \"elevation__1\" as \"elevation\"\n      ) as __x)  ORDER BY  \"airport_count__1\" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as \"by_fac_type\"\n  FROM __stage1\n  GROUP BY 1\n)\nSELECT \n   JSONB_EXTRACT_PATH_TEXT(by_fac_type_0,'id2')::double precision as \"id2\"\nFROM __stage2 as base\nLEFT JOIN JSONB_ARRAY_ELEMENTS(base.\"by_fac_type\") as by_fac_type_0 ON true\nGROUP BY 1\nORDER BY 1 desc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:38.753Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:38.819Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: WITH __stage0 AS (
      SELECT
        group_set,
        base."faa_region" as "faa_region__0",
        CASE WHEN group_set=0 THEN
          COUNT(1)
          END as "airport_count__0",
        CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          base."fac_type"
          END as "fac_type__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "airport_count__1",
        CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."faa_region"  ORDER BY  CASE WHEN group_set=1 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id2__1",
        CASE WHEN group_set=2 THEN
          AVG(base."elevation")
          END as "avg_elevation__2"
      FROM "malloytest"."airports" as base
      CROSS JOIN GENERATE_SERIES(0,2,1) as group_set
      GROUP BY 1,2,5
    )
    , __stage1 AS (
      SELECT
        CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,
        "faa_region__0" as "faa_region__0",
        MAX("airport_count__0") as "airport_count__0",
        MAX("id__0") as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          "fac_type__1"
          END as "fac_type__1",
        MAX("airport_count__1") as "airport_count__1",
        MAX("id2__1") as "id2__1",
        TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT
          "avg_elevation__2"::DOUBLE PRECISION as "avg_elevation") as __x)) FILTER (WHERE group_set=2))[1]) as "elevation__1"
      FROM __stage0
      GROUP BY 1,2,5
    )
    , __stage2 AS (
      SELECT
        "faa_region__0" as "faa_region",
        (ARRAY_AGG("airport_count__0") FILTER (WHERE group_set=0 AND "airport_count__0" IS NOT NULL))[1] as "airport_count",
        (ARRAY_AGG("id__0") FILTER (WHERE group_set=0 AND "id__0" IS NOT NULL))[1] as "id",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
          "fac_type__1" as "fac_type",
          "airport_count__1"::DOUBLE PRECISION as "airport_count",
          "id2__1"::DOUBLE PRECISION as "id2",
          "elevation__1" as "elevation"
          ) as __x)  ORDER BY  "airport_count__1" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as "by_fac_type"
      FROM __stage1
      GROUP BY 1
    )
    SELECT
       JSONB_EXTRACT_PATH_TEXT(by_fac_type_0,'id2')::double precision as "id2"
    FROM __stage2 as base
    LEFT JOIN JSONB_ARRAY_ELEMENTS(base."by_fac_type") as by_fac_type_0 ON true
    GROUP BY 1
    ORDER BY 1 desc NULLS LAST

    Error: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
        group_set,
        base."faa_region" as "faa_region__0",
        CASE WHEN group_set=0 THEN
          COUNT(1)
          END as "airport_count__0",
        CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          base."fac_type"
          END as "fac_type__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "airport_count__1",
        CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."faa_region"  ORDER BY  CASE WHEN group_set=1 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "id2__1",
        CASE WHEN group_set=2 THEN
          AVG(base."elevation")
          END as "avg_elevation__2"
      FROM "malloytest"."airports" as base
      CROSS JOIN GENERATE_SERIES(0,2,1) as group_set
      GROUP BY 1,2,5
    )
    , __stage1 AS (
      SELECT
        CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,
        "faa_region__0" as "faa_region__0",
        MAX("airport_count__0") as "airport_count__0",
        MAX("id__0") as "id__0",
        CASE WHEN group_set IN (1,2) THEN
          "fac_type__1"
          END as "fac_type__1",
        MAX("airport_count__1") as "airport_count__1",
        MAX("id2__1") as "id2__1",
        TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT
          "avg_elevation__2"::DOUBLE PRECISION as "avg_elevation") as __x)) FILTER (WHERE group_set=2))[1]) as "elevation__1"
      FROM __stage0
      GROUP BY 1,2,5
    )
    , __stage2 AS (
      SELECT
        "faa_region__0" as "faa_region",
        (ARRAY_AGG("airport_count__0") FILTER (WHERE group_set=0 AND "airport_count__0" IS NOT NULL))[1] as "airport_count",
        (ARRAY_AGG("id__0") FILTER (WHERE group_set=0 AND "id__0" IS NOT NULL))[1] as "id",
        COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
          "fac_type__1" as "fac_type",
          "airport_count__1"::DOUBLE PRECISION as "airport_count",
          "id2__1"::DOUBLE PRECISION as "id2",
          "elevation__1" as "elevation"
          ) as __x)  ORDER BY  "airport_count__1" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as "by_fac_type"
      FROM __stage1
      GROUP BY 1
    )
    SELECT
       JSONB_EXTRACT_PATH_TEXT(by_fac_type_0,'id2')::double precision as "id2"
    FROM __stage2 as base
    LEFT JOIN JSONB_ARRAY_ELEMENTS(base."by_fac_type") as by_fac_type_0 ON true
    GROUP BY 1
    ORDER BY 1 desc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "e32dbcb6-4bcb-4643-a6a2-d45a22a84cce",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:38.241Z",
      "Database": "dev",
      "Duration": 44316996,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"FILTER\" in context \"__x)) FILTER\", at line 39, column 73\n  Position: 1390",
      "HasResultSet": false,
      "Id": "61bb8d63-2602-4984-80e3-3da849bdb67e",
      "RedshiftPid": 1073987722,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:38.340Z",
          "Duration": 44316996,
          "HasResultSet": false,
          "Id": "61bb8d63-2602-4984-80e3-3da849bdb67e:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:38.753Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:38.344Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"FILTER\" in context \"__x)) FILTER\", at line 39, column 73\n  Position: 1390",
          "HasResultSet": false,
          "Id": "61bb8d63-2602-4984-80e3-3da849bdb67e:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT\n    group_set,\n    base.\"faa_region\" as \"faa_region__0\",\n    CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END as \"airport_count__0\",\n    CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END desc NULLS LAST ) END as \"id__0\",\n    CASE WHEN group_set IN (1,2) THEN\n      base.\"fac_type\"\n      END as \"fac_type__1\",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as \"airport_count__1\",\n    CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base.\"faa_region\"  ORDER BY  CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END desc NULLS LAST ) END as \"id2__1\",\n    CASE WHEN group_set=2 THEN\n      AVG(base.\"elevation\")\n      END as \"avg_elevation__2\"\n  FROM \"malloytest\".\"airports\" as base\n  CROSS JOIN GENERATE_SERIES(0,2,1) as group_set\n  GROUP BY 1,2,5\n)\n, __stage1 AS (\n  SELECT \n    CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,\n    \"faa_region__0\" as \"faa_region__0\",\n    MAX(\"airport_count__0\") as \"airport_count__0\",\n    MAX(\"id__0\") as \"id__0\",\n    CASE WHEN group_set IN (1,2) THEN\n      \"fac_type__1\"\n      END as \"fac_type__1\",\n    MAX(\"airport_count__1\") as \"airport_count__1\",\n    MAX(\"id2__1\") as \"id2__1\",\n    TO_JSONB((ARRAY_AGG((SELECT __x FROM (SELECT \n      \"avg_elevation__2\"::DOUBLE PRECISION as \"avg_elevation\") as __x)) FILTER (WHERE group_set=2))[1]) as \"elevation__1\"\n  FROM __stage0\n  GROUP BY 1,2,5\n)\n, __stage2 AS (\n  SELECT\n    \"faa_region__0\" as \"faa_region\",\n    (ARRAY_AGG(\"airport_count__0\") FILTER (WHERE group_set=0 AND \"airport_count__0\" IS NOT NULL))[1] as \"airport_count\",\n    (ARRAY_AGG(\"id__0\") FILTER (WHERE group_set=0 AND \"id__0\" IS NOT NULL))[1] as \"id\",\n    COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n      \"fac_type__1\" as \"fac_type\", \n      \"airport_count__1\"::DOUBLE PRECISION as \"airport_count\", \n      \"id2__1\"::DOUBLE PRECISION as \"id2\", \n      \"elevation__1\" as \"elevation\"\n      ) as __x)  ORDER BY  \"airport_count__1\" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as \"by_fac_type\"\n  FROM __stage1\n  GROUP BY 1\n)\nSELECT \n   JSONB_EXTRACT_PATH_TEXT(by_fac_type_0,'id2')::double precision as \"id2\"\nFROM __stage2 as base\nLEFT JOIN JSONB_ARRAY_ELEMENTS(base.\"by_fac_type\") as by_fac_type_0 ON true\nGROUP BY 1\nORDER BY 1 desc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:38.753Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:38.819Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:515:10)

  ● first_value › works in nest - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
        group_set,
        base."state" as "state__0",
        CASE WHEN group_set=1 THEN
          base."county"
          END as "county__1",
        CASE WHEN group_set=1 THEN
          COUNT(1)
          END as "aircraft_count__1",
        CASE WHEN group_set=1 THEN FIRST_VALUE(CASE WHEN group_set=1 THEN
          COUNT(1)
          END) OVER(PARTITION BY group_set, base."state"  ORDER BY  CASE WHEN group_set=1 THEN
          COUNT(1)
          END desc NULLS LAST ) END as "first_count__1"
      FROM "malloytest"."aircraft" as base
      CROSS JOIN GENERATE_SERIES(0,1,1) as group_set
      WHERE base."state" IS NOT NULL
      GROUP BY 1,2,3
    )
    SELECT
      "state__0" as "state",
      COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT
        "county__1" as "county",
        "aircraft_count__1"::DOUBLE PRECISION as "aircraft_count",
        "first_count__1"::DOUBLE PRECISION as "first_count"
        ) as __x)  ORDER BY  "aircraft_count__1" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as "by_county"
    FROM __stage0
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "79e23f1e-e7f6-4261-b2ef-9279fe0c5902",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:48.847Z",
      "Database": "dev",
      "Duration": 52504753,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"as __x)  ORDER\", at line 27, column 16\n  Position: 880",
      "HasResultSet": false,
      "Id": "decf64d4-601f-40bd-b6da-58a34a4e5942",
      "RedshiftPid": 1073963137,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:48.944Z",
          "Duration": 52504753,
          "HasResultSet": false,
          "Id": "decf64d4-601f-40bd-b6da-58a34a4e5942:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:49.392Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:48.947Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"as __x)  ORDER\", at line 27, column 16\n  Position: 880",
          "HasResultSet": false,
          "Id": "decf64d4-601f-40bd-b6da-58a34a4e5942:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT\n    group_set,\n    base.\"state\" as \"state__0\",\n    CASE WHEN group_set=1 THEN\n      base.\"county\"\n      END as \"county__1\",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as \"aircraft_count__1\",\n    CASE WHEN group_set=1 THEN FIRST_VALUE(CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END) OVER(PARTITION BY group_set, base.\"state\"  ORDER BY  CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END desc NULLS LAST ) END as \"first_count__1\"\n  FROM \"malloytest\".\"aircraft\" as base\n  CROSS JOIN GENERATE_SERIES(0,1,1) as group_set\n  WHERE base.\"state\" IS NOT NULL\n  GROUP BY 1,2,3\n)\nSELECT\n  \"state__0\" as \"state\",\n  COALESCE(TO_JSONB((ARRAY_AGG((SELECT TO_JSONB(__x) FROM (SELECT \n    \"county__1\" as \"county\", \n    \"aircraft_count__1\"::DOUBLE PRECISION as \"aircraft_count\", \n    \"first_count__1\"::DOUBLE PRECISION as \"first_count\"\n    ) as __x)  ORDER BY  \"aircraft_count__1\" desc NULLS LAST ) FILTER (WHERE group_set=1))[1:2]),'[]'::JSONB) as \"by_county\"\nFROM __stage0\nGROUP BY 1\nORDER BY 1 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:49.392Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:49.457Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works outside nest - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       base."state" as "state",
       base."births" as "births",
       FIRST_VALUE((base."births")) OVER(  ORDER BY  base."births" desc NULLS LAST ) as "most_births"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1,2
    ORDER BY 2 desc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "6813db92-4250-4f09-99a7-3f34ad451c0a",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:50.211Z",
      "Database": "dev",
      "Duration": 44406005,
      "Error": "Query #2 failed with ERROR: Aggregate window functions with an ORDER BY clause require a frame clause",
      "HasResultSet": false,
      "Id": "83976a19-4875-4d45-91c2-c222380e31d7",
      "RedshiftPid": 1073897624,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:50.307Z",
          "Duration": 44406005,
          "HasResultSet": false,
          "Id": "83976a19-4875-4d45-91c2-c222380e31d7:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:50.753Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:50.310Z",
          "Duration": -1,
          "Error": "ERROR: Aggregate window functions with an ORDER BY clause require a frame clause",
          "HasResultSet": false,
          "Id": "83976a19-4875-4d45-91c2-c222380e31d7:2",
          "QueryString": "SELECT \n   base.\"state\" as \"state\",\n   base.\"births\" as \"births\",\n   FIRST_VALUE((base.\"births\")) OVER(  ORDER BY  base.\"births\" desc NULLS LAST ) as \"most_births\"\nFROM \"malloytest\".\"state_facts\" as base\nGROUP BY 1,2\nORDER BY 2 desc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:50.753Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:50.819Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● first_value › works with a localized aggregate - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       aircraft_models_0."seats" as "seats",
       LAG(COALESCE(CAST((
        (
          SUM(DISTINCT
            (CAST(ROUND(COALESCE(aircraft_models_0."seats",0)*(1*1.0), 9) AS DECIMAL) +
            ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)
          ))
          -
           SUM(DISTINCT ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))
        )/(1*1.0)) AS DOUBLE PRECISION),0)) OVER(  ORDER BY  aircraft_models_0."seats" asc NULLS LAST ) as "prev_sum_of_seats"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "2c7a1ff3-bff1-4b7b-a75c-3b732220c425",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:28:53.060Z",
      "Database": "dev",
      "Duration": 45011693,
      "Error": "Query #2 failed with ERROR: DECIMAL precision 65 must be between 1 and 38",
      "HasResultSet": false,
      "Id": "139e305d-de1f-4665-a3ad-900fd9d37802",
      "RedshiftPid": 1073782916,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:28:53.197Z",
          "Duration": 45011693,
          "HasResultSet": false,
          "Id": "139e305d-de1f-4665-a3ad-900fd9d37802:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:28:53.706Z"
        },
        {
          "CreatedAt": "2025-02-28T23:28:53.201Z",
          "Duration": -1,
          "Error": "ERROR: DECIMAL precision 65 must be between 1 and 38",
          "HasResultSet": false,
          "Id": "139e305d-de1f-4665-a3ad-900fd9d37802:2",
          "QueryString": "SELECT \n   aircraft_models_0.\"seats\" as \"seats\",\n   LAG(COALESCE(CAST((\n    (\n      SUM(DISTINCT\n        (CAST(ROUND(COALESCE(aircraft_models_0.\"seats\",0)*(1*1.0), 9) AS DECIMAL) +\n        ('x' || MD5(aircraft_models_0.\"aircraft_model_code\"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0.\"aircraft_model_code\"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)\n      ))\n      -\n       SUM(DISTINCT ('x' || MD5(aircraft_models_0.\"aircraft_model_code\"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0.\"aircraft_model_code\"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))\n    )/(1*1.0)) AS DOUBLE PRECISION),0)) OVER(  ORDER BY  aircraft_models_0.\"seats\" asc NULLS LAST ) as \"prev_sum_of_seats\"\nFROM \"malloytest\".\"aircraft\" as base\n LEFT JOIN \"malloytest\".\"aircraft_models\" AS aircraft_models_0\n  ON aircraft_models_0.\"aircraft_model_code\"=base.\"aircraft_model_code\"\nGROUP BY 1\nORDER BY 1 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:28:53.706Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:28:53.772Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● starts_with › works - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COALESCE(STARTS_WITH('hello world', 'hello'), false) as "f0",
       COALESCE(STARTS_WITH('hello world', 'world'), false) as "f1",
       COALESCE(STARTS_WITH(NULL, 'world'), false) as "f2",
       COALESCE(STARTS_WITH('hello world', NULL), false) as "f3"
    FROM "malloytest"."state_facts" as base
    GROUP BY 1,2,3,4
    ORDER BY 1 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "696aa90a-2c56-4566-b5d7-5aee676bc498",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:19.000Z",
      "Database": "dev",
      "Duration": 46116587,
      "Error": "Query #2 failed with ERROR: function starts_with(\"unknown\", \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "b0d25227-ce70-40fb-99ff-433cd373ec43",
      "RedshiftPid": 1073987731,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:19.092Z",
          "Duration": 46116587,
          "HasResultSet": false,
          "Id": "b0d25227-ce70-40fb-99ff-433cd373ec43:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:19.496Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:19.095Z",
          "Duration": -1,
          "Error": "ERROR: function starts_with(\"unknown\", \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "b0d25227-ce70-40fb-99ff-433cd373ec43:2",
          "QueryString": "SELECT \n   COALESCE(STARTS_WITH('hello world', 'hello'), false) as \"f0\",\n   COALESCE(STARTS_WITH('hello world', 'world'), false) as \"f1\",\n   COALESCE(STARTS_WITH(NULL, 'world'), false) as \"f2\",\n   COALESCE(STARTS_WITH('hello world', NULL), false) as \"f3\"\nFROM \"malloytest\".\"state_facts\" as base\nGROUP BY 1,2,3,4\nORDER BY 1 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:19.496Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:19.562Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● ends_with › works - redshift

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      119 |       // console.log(databaseName, result.sql);
      120 |       // console.log(result.data);
    > 121 |       expect(result.data.path(0, `f${i}`).value).toBe(testCase[1]);
          |                                                  ^
      122 |     });
      123 |   };
      124 |

      at test/src/databases/all/functions.spec.ts:121:50
          at Array.forEach (<anonymous>)
      at funcTestMultiple (test/src/databases/all/functions.spec.ts:118:15)
      at async Object.<anonymous> (test/src/databases/all/functions.spec.ts:963:7)

  ● rand › is usually not the same value - redshift

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: null

      87 |     if (expected.success !== undefined) {
      88 |       const result = await run();
    > 89 |       expect(result.data.path(0, 'f').value).toBe(expected.success);
         |                                              ^
      90 |     } else {
      91 |       expect(run).rejects.toThrowError(expected.error);
      92 |     }

      at funcTestGeneral (test/src/databases/all/functions.spec.ts:89:46)
      at async Object.<anonymous> (test/src/databases/all/functions.spec.ts:1018:7)

  ● pi › is pi - redshift

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: null

      87 |     if (expected.success !== undefined) {
      88 |       const result = await run();
    > 89 |       expect(result.data.path(0, 'f').value).toBe(expected.success);
         |                                              ^
      90 |     } else {
      91 |       expect(run).rejects.toThrowError(expected.error);
      92 |     }

      at funcTestGeneral (test/src/databases/all/functions.spec.ts:89:46)
      at async Object.<anonymous> (test/src/databases/all/functions.spec.ts:1023:7)

  ● lead › works with default value - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."aircraft_count" as "aircraft_count",
         base."airport_count" as "airport_count",
         base."births" as "births",
         base."popular_name" as "popular_name",
         base."state" as "state"
      FROM "malloytest"."state_facts" as base
      LIMIT 10
    )
    SELECT
       base."state" as "state",
       LEAD((base."state"),1,'NONE') OVER(  ORDER BY  base."state" asc NULLS LAST ) as "next_state"
    FROM __stage0 as base
    GROUP BY 1
    ORDER BY 1 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "0c0a2655-66ae-4190-8e4c-f816c1c82b34",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:45.400Z",
      "Database": "dev",
      "Duration": 55793242,
      "Error": "Query #2 failed with ERROR: Default parameter not be supported for window function lead",
      "HasResultSet": false,
      "Id": "8f71aca5-2c7c-4a86-8adf-cb3fd6a105f2",
      "RedshiftPid": 1073864858,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:45.489Z",
          "Duration": 55793242,
          "HasResultSet": false,
          "Id": "8f71aca5-2c7c-4a86-8adf-cb3fd6a105f2:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:45.926Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:45.492Z",
          "Duration": -1,
          "Error": "ERROR: Default parameter not be supported for window function lead",
          "HasResultSet": false,
          "Id": "8f71aca5-2c7c-4a86-8adf-cb3fd6a105f2:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"aircraft_count\" as \"aircraft_count\",\n     base.\"airport_count\" as \"airport_count\",\n     base.\"births\" as \"births\",\n     base.\"popular_name\" as \"popular_name\",\n     base.\"state\" as \"state\"\n  FROM \"malloytest\".\"state_facts\" as base\n  LIMIT 10\n)\nSELECT \n   base.\"state\" as \"state\",\n   LEAD((base.\"state\"),1,'NONE') OVER(  ORDER BY  base.\"state\" asc NULLS LAST ) as \"next_state\"\nFROM __stage0 as base\nGROUP BY 1\nORDER BY 1 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:45.926Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:45.992Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● min, max, sum / window, cumulative › works - redshift

    Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."aircraft_count" as "aircraft_count",
         base."airport_count" as "airport_count",
         base."births" as "births",
         base."popular_name" as "popular_name",
         base."state" as "state"
      FROM "malloytest"."state_facts" as base
      LIMIT 5
    )
    SELECT
       base."state" as "state",
       base."births" as "births",
       MIN((base."births")) OVER(  ORDER BY  base."births" asc NULLS LAST ) as "min_c",
       MAX((base."births")) OVER(  ORDER BY  base."births" asc NULLS LAST ) as "max_c",
       SUM((base."births")) OVER(  ORDER BY  base."births" asc NULLS LAST ) as "sum_c",
       MIN((base."births")) OVER(  ) as "min_w",
       MAX((base."births")) OVER(  ) as "max_w",
       SUM((base."births")) OVER(  ) as "sum_w"
    FROM __stage0 as base
    GROUP BY 1,2
    ORDER BY 2 asc NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c0499a9b-7599-43ac-8bae-dec16838b187",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:54.143Z",
      "Database": "dev",
      "Duration": 45962450,
      "Error": "Query #2 failed with ERROR: Aggregate window functions with an ORDER BY clause require a frame clause",
      "HasResultSet": false,
      "Id": "97562a63-d71d-4608-a4be-5eec079c8088",
      "RedshiftPid": 1073741957,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:54.227Z",
          "Duration": 45962450,
          "HasResultSet": false,
          "Id": "97562a63-d71d-4608-a4be-5eec079c8088:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:54.683Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:54.230Z",
          "Duration": -1,
          "Error": "ERROR: Aggregate window functions with an ORDER BY clause require a frame clause",
          "HasResultSet": false,
          "Id": "97562a63-d71d-4608-a4be-5eec079c8088:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"aircraft_count\" as \"aircraft_count\",\n     base.\"airport_count\" as \"airport_count\",\n     base.\"births\" as \"births\",\n     base.\"popular_name\" as \"popular_name\",\n     base.\"state\" as \"state\"\n  FROM \"malloytest\".\"state_facts\" as base\n  LIMIT 5\n)\nSELECT \n   base.\"state\" as \"state\",\n   base.\"births\" as \"births\",\n   MIN((base.\"births\")) OVER(  ORDER BY  base.\"births\" asc NULLS LAST ) as \"min_c\",\n   MAX((base.\"births\")) OVER(  ORDER BY  base.\"births\" asc NULLS LAST ) as \"max_c\",\n   SUM((base.\"births\")) OVER(  ORDER BY  base.\"births\" asc NULLS LAST ) as \"sum_c\",\n   MIN((base.\"births\")) OVER(  ) as \"min_w\",\n   MAX((base.\"births\")) OVER(  ) as \"max_w\",\n   SUM((base.\"births\")) OVER(  ) as \"sum_w\"\nFROM __stage0 as base\nGROUP BY 1,2\nORDER BY 2 asc NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:54.683Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:54.748Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)

  ● redshift › string_agg › works no order by - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "8699dc09-d032-4baa-a7ef-1ec35f00d9ff",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:55.515Z",
      "Database": "dev",
      "Duration": 44586485,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "d44977d4-93be-46b0-b723-ab2a538ecc90",
      "RedshiftPid": 1073913994,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:55.606Z",
          "Duration": 44586485,
          "HasResultSet": false,
          "Id": "d44977d4-93be-46b0-b723-ab2a538ecc90:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:56.033Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:55.609Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "d44977d4-93be-46b0-b723-ab2a538ecc90:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:56.033Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:56.098Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "8699dc09-d032-4baa-a7ef-1ec35f00d9ff",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:55.515Z",
      "Database": "dev",
      "Duration": 44586485,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "d44977d4-93be-46b0-b723-ab2a538ecc90",
      "RedshiftPid": 1073913994,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:55.606Z",
          "Duration": 44586485,
          "HasResultSet": false,
          "Id": "d44977d4-93be-46b0-b723-ab2a538ecc90:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:56.033Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:55.609Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "d44977d4-93be-46b0-b723-ab2a538ecc90:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:56.033Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:56.098Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1503:11)

  ● redshift › string_agg › works with dotted shortcut - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "451ad10f-7681-487c-a930-292579b8ffee",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:56.901Z",
      "Database": "dev",
      "Duration": 51623044,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "1b113218-7b03-4d84-972c-22bdc8b3600f",
      "RedshiftPid": 1073946762,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:56.988Z",
          "Duration": 51623044,
          "HasResultSet": false,
          "Id": "1b113218-7b03-4d84-972c-22bdc8b3600f:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:57.422Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:56.991Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "1b113218-7b03-4d84-972c-22bdc8b3600f:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:57.422Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:57.487Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "451ad10f-7681-487c-a930-292579b8ffee",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:56.901Z",
      "Database": "dev",
      "Duration": 51623044,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "1b113218-7b03-4d84-972c-22bdc8b3600f",
      "RedshiftPid": 1073946762,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:56.988Z",
          "Duration": 51623044,
          "HasResultSet": false,
          "Id": "1b113218-7b03-4d84-972c-22bdc8b3600f:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:57.422Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:56.991Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "1b113218-7b03-4d84-972c-22bdc8b3600f:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:57.422Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:57.487Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1510:11)

  ● redshift › string_agg › works with order by field - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c2162a58-fa4e-4085-9a5e-00a31ed8d14c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:58.278Z",
      "Database": "dev",
      "Duration": 51874029,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "be76d7bd-94fb-46dc-aefb-cb9f5bee4b29",
      "RedshiftPid": 1073979528,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:58.377Z",
          "Duration": 51874029,
          "HasResultSet": false,
          "Id": "be76d7bd-94fb-46dc-aefb-cb9f5bee4b29:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:58.841Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:58.381Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "be76d7bd-94fb-46dc-aefb-cb9f5bee4b29:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\") as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:58.841Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:58.905Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c2162a58-fa4e-4085-9a5e-00a31ed8d14c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:58.278Z",
      "Database": "dev",
      "Duration": 51874029,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "be76d7bd-94fb-46dc-aefb-cb9f5bee4b29",
      "RedshiftPid": 1073979528,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:58.377Z",
          "Duration": 51874029,
          "HasResultSet": false,
          "Id": "be76d7bd-94fb-46dc-aefb-cb9f5bee4b29:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:29:58.841Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:58.381Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "be76d7bd-94fb-46dc-aefb-cb9f5bee4b29:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\") as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:29:58.841Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:29:58.905Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1520:11)

  ● redshift › string_agg › works with multiple order_bys - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "dda2c7c6-9385-402f-9289-f80b4e033b33",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:59.655Z",
      "Database": "dev",
      "Duration": 44305000,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "d85b2fea-3c52-41ad-a119-cbc8afc08272",
      "RedshiftPid": 1073889408,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:59.749Z",
          "Duration": 44305000,
          "HasResultSet": false,
          "Id": "d85b2fea-3c52-41ad-a119-cbc8afc08272:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:00.166Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:59.752Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "d85b2fea-3c52-41ad-a119-cbc8afc08272:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:00.166Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:00.232Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "dda2c7c6-9385-402f-9289-f80b4e033b33",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:59.655Z",
      "Database": "dev",
      "Duration": 44305000,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "d85b2fea-3c52-41ad-a119-cbc8afc08272",
      "RedshiftPid": 1073889408,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:59.749Z",
          "Duration": 44305000,
          "HasResultSet": false,
          "Id": "d85b2fea-3c52-41ad-a119-cbc8afc08272:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:00.166Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:59.752Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "d85b2fea-3c52-41ad-a119-cbc8afc08272:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:00.166Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:00.232Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1532:11)

  ● redshift › string_agg › works with multiple order_bys - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."city", base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "ba54e349-f7ae-4526-88d7-56c8931823b1",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:59.669Z",
      "Database": "dev",
      "Duration": 42967522,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "824d81c3-5311-4de7-af48-eaef9b224b26",
      "RedshiftPid": 1073922372,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:59.762Z",
          "Duration": 42967522,
          "HasResultSet": false,
          "Id": "824d81c3-5311-4de7-af48-eaef9b224b26:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:00.192Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:59.766Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "824d81c3-5311-4de7-af48-eaef9b224b26:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"city\", base.\"name\") as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:00.192Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:00.256Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(base."name", ',' ORDER BY base."city", base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."city", base."name") as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "ba54e349-f7ae-4526-88d7-56c8931823b1",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:29:59.669Z",
      "Database": "dev",
      "Duration": 42967522,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "824d81c3-5311-4de7-af48-eaef9b224b26",
      "RedshiftPid": 1073922372,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:29:59.762Z",
          "Duration": 42967522,
          "HasResultSet": false,
          "Id": "824d81c3-5311-4de7-af48-eaef9b224b26:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:00.192Z"
        },
        {
          "CreatedAt": "2025-02-28T23:29:59.766Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "824d81c3-5311-4de7-af48-eaef9b224b26:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"city\", base.\"name\") as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:00.192Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:00.256Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1544:11)

  ● redshift › string_agg › works with order by expression - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY LENGTH(base."name")) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "15648ff2-e8ec-40b2-900d-e21c4d9e4242",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:01.049Z",
      "Database": "dev",
      "Duration": 43977093,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
      "HasResultSet": false,
      "Id": "c9f19426-37d9-4efd-9db9-3c234a8361cd",
      "RedshiftPid": 1073791130,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:01.145Z",
          "Duration": 43977093,
          "HasResultSet": false,
          "Id": "c9f19426-37d9-4efd-9db9-3c234a8361cd:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:01.582Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:01.148Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
          "HasResultSet": false,
          "Id": "c9f19426-37d9-4efd-9db9-3c234a8361cd:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY LENGTH(base.\"name\")) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:01.582Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:01.647Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY LENGTH(base."name")) as "f"
    FROM __stage0 as base

    Error: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY LENGTH(base."name")) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "15648ff2-e8ec-40b2-900d-e21c4d9e4242",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:01.049Z",
      "Database": "dev",
      "Duration": 43977093,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
      "HasResultSet": false,
      "Id": "c9f19426-37d9-4efd-9db9-3c234a8361cd",
      "RedshiftPid": 1073791130,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:01.145Z",
          "Duration": 43977093,
          "HasResultSet": false,
          "Id": "c9f19426-37d9-4efd-9db9-3c234a8361cd:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:01.582Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:01.148Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
          "HasResultSet": false,
          "Id": "c9f19426-37d9-4efd-9db9-3c234a8361cd:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY LENGTH(base.\"name\")) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:01.582Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:01.647Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1560:11)

  ● redshift › string_agg › works with order by join expression - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY aircraft_models_0."model") as "f"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" ~ '.*ADVENTURE.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "ce72d40d-a84f-461f-925d-72979f4ba04c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:02.402Z",
      "Database": "dev",
      "Duration": 44776817,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "ae2ba999-a35b-45ef-b96b-84854a4ecf68",
      "RedshiftPid": 1073758358,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:02.512Z",
          "Duration": 44776817,
          "HasResultSet": false,
          "Id": "ae2ba999-a35b-45ef-b96b-84854a4ecf68:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:02.940Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:02.515Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "ae2ba999-a35b-45ef-b96b-84854a4ecf68:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY aircraft_models_0.\"model\") as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\n LEFT JOIN \"malloytest\".\"aircraft_models\" AS aircraft_models_0\n  ON aircraft_models_0.\"aircraft_model_code\"=base.\"aircraft_model_code\"\nWHERE base.\"name\" ~ '.*ADVENTURE.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:02.940Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:03.006Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(base."name", ',' ORDER BY aircraft_models_0."model") as "f"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" ~ '.*ADVENTURE.*'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(base."name", ',' ORDER BY aircraft_models_0."model") as "f"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" ~ '.*ADVENTURE.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "ce72d40d-a84f-461f-925d-72979f4ba04c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:02.402Z",
      "Database": "dev",
      "Duration": 44776817,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
      "HasResultSet": false,
      "Id": "ae2ba999-a35b-45ef-b96b-84854a4ecf68",
      "RedshiftPid": 1073758358,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:02.512Z",
          "Duration": 44776817,
          "HasResultSet": false,
          "Id": "ae2ba999-a35b-45ef-b96b-84854a4ecf68:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:02.940Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:02.515Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 32\n  Position: 40",
          "HasResultSet": false,
          "Id": "ae2ba999-a35b-45ef-b96b-84854a4ecf68:2",
          "QueryString": "SELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY aircraft_models_0.\"model\") as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\n LEFT JOIN \"malloytest\".\"aircraft_models\" AS aircraft_models_0\n  ON aircraft_models_0.\"aircraft_model_code\"=base.\"aircraft_model_code\"\nWHERE base.\"name\" ~ '.*ADVENTURE.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:02.940Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:03.006Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1570:11)

  ● redshift › string_agg › works with order asc - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "100361c1-9062-4042-810d-a3bceeb5a444",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:03.775Z",
      "Database": "dev",
      "Duration": 42686254,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
      "HasResultSet": false,
      "Id": "4c94ec1d-cca5-403a-8b93-78a972b50a93",
      "RedshiftPid": 1073848477,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:03.877Z",
          "Duration": 42686254,
          "HasResultSet": false,
          "Id": "4c94ec1d-cca5-403a-8b93-78a972b50a93:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:04.337Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:03.880Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
          "HasResultSet": false,
          "Id": "4c94ec1d-cca5-403a-8b93-78a972b50a93:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:04.337Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:04.402Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

    Error: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "100361c1-9062-4042-810d-a3bceeb5a444",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:03.775Z",
      "Database": "dev",
      "Duration": 42686254,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
      "HasResultSet": false,
      "Id": "4c94ec1d-cca5-403a-8b93-78a972b50a93",
      "RedshiftPid": 1073848477,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:03.877Z",
          "Duration": 42686254,
          "HasResultSet": false,
          "Id": "4c94ec1d-cca5-403a-8b93-78a972b50a93:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:04.337Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:03.880Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
          "HasResultSet": false,
          "Id": "4c94ec1d-cca5-403a-8b93-78a972b50a93:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:04.337Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:04.402Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1584:11)

  ● redshift › string_agg › works with order desc - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c23648e1-0a0e-4ea0-bca0-deeab50b484b",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:05.137Z",
      "Database": "dev",
      "Duration": 47138026,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
      "HasResultSet": false,
      "Id": "d3c511fa-2f01-4f84-98e1-fac06b28e6ac",
      "RedshiftPid": 1073832072,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:05.222Z",
          "Duration": 47138026,
          "HasResultSet": false,
          "Id": "d3c511fa-2f01-4f84-98e1-fac06b28e6ac:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:05.636Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:05.226Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
          "HasResultSet": false,
          "Id": "d3c511fa-2f01-4f84-98e1-fac06b28e6ac:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\" DESC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:05.636Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:05.692Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

    Error: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c23648e1-0a0e-4ea0-bca0-deeab50b484b",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:05.137Z",
      "Database": "dev",
      "Duration": 47138026,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
      "HasResultSet": false,
      "Id": "d3c511fa-2f01-4f84-98e1-fac06b28e6ac",
      "RedshiftPid": 1073832072,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:05.222Z",
          "Duration": 47138026,
          "HasResultSet": false,
          "Id": "d3c511fa-2f01-4f84-98e1-fac06b28e6ac:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:05.636Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:05.226Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 32\n  Position: 221",
          "HasResultSet": false,
          "Id": "d3c511fa-2f01-4f84-98e1-fac06b28e6ac:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(base.\"name\", ',' ORDER BY base.\"name\" DESC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:05.636Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:05.692Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1598:11)

  ● redshift › string_agg › works with fanout and order_by - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',' ORDER BY (a::json->>'f3'), (a::json->>'f4')) as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",base."state",base."popular_name",base."state"))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "3b032d23-83bc-4930-b225-f3967ddffe85",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:06.505Z",
      "Database": "dev",
      "Duration": 44215790,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"->>'f2'), ',' ORDER\", at line 4, column 49\n  Position: 121",
      "HasResultSet": false,
      "Id": "24a81b2d-9b1d-48ec-90c2-6a013febf277",
      "RedshiftPid": 1073897622,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:06.600Z",
          "Duration": 44215790,
          "HasResultSet": false,
          "Id": "24a81b2d-9b1d-48ec-90c2-6a013febf277:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:07.007Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:06.604Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"->>'f2'), ',' ORDER\", at line 4, column 49\n  Position: 121",
          "HasResultSet": false,
          "Id": "24a81b2d-9b1d-48ec-90c2-6a013febf277:2",
          "QueryString": "SELECT \n   COUNT(DISTINCT state_facts2_0.\"__distinct_key\") as \"c\",\n   (\n        SELECT STRING_AGG((a::json->>'f2'), ',' ORDER BY (a::json->>'f3'), (a::json->>'f4')) as value\n        FROM (\n          SELECT UNNEST(array_agg(distinct row_to_json(row(base.\"__distinct_key\",base.\"state\",base.\"popular_name\",base.\"state\"))::text)) a\n        ) a\n      ) as \"s\"\nFROM (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) AS state_facts2_0\n  ON state_facts2_0.\"state\"=base.\"state\"\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:07.007Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:07.072Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',' ORDER BY (a::json->>'f3'), (a::json->>'f4')) as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",base."state",base."popular_name",base."state"))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',' ORDER BY (a::json->>'f3'), (a::json->>'f4')) as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",base."state",base."popular_name",base."state"))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "3b032d23-83bc-4930-b225-f3967ddffe85",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:06.505Z",
      "Database": "dev",
      "Duration": 44215790,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"->>'f2'), ',' ORDER\", at line 4, column 49\n  Position: 121",
      "HasResultSet": false,
      "Id": "24a81b2d-9b1d-48ec-90c2-6a013febf277",
      "RedshiftPid": 1073897622,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:06.600Z",
          "Duration": 44215790,
          "HasResultSet": false,
          "Id": "24a81b2d-9b1d-48ec-90c2-6a013febf277:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:07.007Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:06.604Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"->>'f2'), ',' ORDER\", at line 4, column 49\n  Position: 121",
          "HasResultSet": false,
          "Id": "24a81b2d-9b1d-48ec-90c2-6a013febf277:2",
          "QueryString": "SELECT \n   COUNT(DISTINCT state_facts2_0.\"__distinct_key\") as \"c\",\n   (\n        SELECT STRING_AGG((a::json->>'f2'), ',' ORDER BY (a::json->>'f3'), (a::json->>'f4')) as value\n        FROM (\n          SELECT UNNEST(array_agg(distinct row_to_json(row(base.\"__distinct_key\",base.\"state\",base.\"popular_name\",base.\"state\"))::text)) a\n        ) a\n      ) as \"s\"\nFROM (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) AS state_facts2_0\n  ON state_facts2_0.\"state\"=base.\"state\"\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:07.007Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:07.072Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1625:11)

  ● redshift › string_agg › works with fanout - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o'))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "3561aee8-ff55-4949-8240-d9f5a631e09c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:07.893Z",
      "Database": "dev",
      "Duration": 44911659,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 163",
      "HasResultSet": false,
      "Id": "6c21a7f7-8bcb-4382-ad3c-e6c9c1ff3d27",
      "RedshiftPid": 1073815711,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:07.982Z",
          "Duration": 44911659,
          "HasResultSet": false,
          "Id": "6c21a7f7-8bcb-4382-ad3c-e6c9c1ff3d27:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:08.400Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:07.986Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 163",
          "HasResultSet": false,
          "Id": "6c21a7f7-8bcb-4382-ad3c-e6c9c1ff3d27:2",
          "QueryString": "SELECT \n   COUNT(DISTINCT state_facts2_0.\"__distinct_key\") as \"c\",\n   (\n        SELECT STRING_AGG((a::json->>'f2'), ',') as value\n        FROM (\n          SELECT UNNEST(array_agg(distinct row_to_json(row(base.\"__distinct_key\",'o'))::text)) a\n        ) a\n      ) as \"s\"\nFROM (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) AS state_facts2_0\n  ON state_facts2_0.\"state\"=base.\"state\"\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:08.400Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:08.456Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o'))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), ',') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o'))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "3561aee8-ff55-4949-8240-d9f5a631e09c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:07.893Z",
      "Database": "dev",
      "Duration": 44911659,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 163",
      "HasResultSet": false,
      "Id": "6c21a7f7-8bcb-4382-ad3c-e6c9c1ff3d27",
      "RedshiftPid": 1073815711,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:07.982Z",
          "Duration": 44911659,
          "HasResultSet": false,
          "Id": "6c21a7f7-8bcb-4382-ad3c-e6c9c1ff3d27:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:08.400Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:07.986Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 163",
          "HasResultSet": false,
          "Id": "6c21a7f7-8bcb-4382-ad3c-e6c9c1ff3d27:2",
          "QueryString": "SELECT \n   COUNT(DISTINCT state_facts2_0.\"__distinct_key\") as \"c\",\n   (\n        SELECT STRING_AGG((a::json->>'f2'), ',') as value\n        FROM (\n          SELECT UNNEST(array_agg(distinct row_to_json(row(base.\"__distinct_key\",'o'))::text)) a\n        ) a\n      ) as \"s\"\nFROM (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) AS state_facts2_0\n  ON state_facts2_0.\"state\"=base.\"state\"\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:08.400Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:08.456Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1646:11)

  ● redshift › string_agg › works with fanout and separator - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), '') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o',''))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c559d695-f82f-4705-9ae3-cff9d637923c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:09.250Z",
      "Database": "dev",
      "Duration": 44942032,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 162",
      "HasResultSet": false,
      "Id": "3ada8962-8d45-44f6-8d0e-ed7aedc735cf",
      "RedshiftPid": 1073741971,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:09.332Z",
          "Duration": 44942032,
          "HasResultSet": false,
          "Id": "3ada8962-8d45-44f6-8d0e-ed7aedc735cf:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:09.757Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:09.335Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 162",
          "HasResultSet": false,
          "Id": "3ada8962-8d45-44f6-8d0e-ed7aedc735cf:2",
          "QueryString": "SELECT \n   COUNT(DISTINCT state_facts2_0.\"__distinct_key\") as \"c\",\n   (\n        SELECT STRING_AGG((a::json->>'f2'), '') as value\n        FROM (\n          SELECT UNNEST(array_agg(distinct row_to_json(row(base.\"__distinct_key\",'o',''))::text)) a\n        ) a\n      ) as \"s\"\nFROM (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) AS state_facts2_0\n  ON state_facts2_0.\"state\"=base.\"state\"\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:09.757Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:09.822Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), '') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o',''))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(DISTINCT state_facts2_0."__distinct_key") as "c",
       (
            SELECT STRING_AGG((a::json->>'f2'), '') as value
            FROM (
              SELECT UNNEST(array_agg(distinct row_to_json(row(base."__distinct_key",'o',''))::text)) a
            ) a
          ) as "s"
    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) as base
     LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM "malloytest"."state_facts" as x) AS state_facts2_0
      ON state_facts2_0."state"=base."state"

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "c559d695-f82f-4705-9ae3-cff9d637923c",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:09.250Z",
      "Database": "dev",
      "Duration": 44942032,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 162",
      "HasResultSet": false,
      "Id": "3ada8962-8d45-44f6-8d0e-ed7aedc735cf",
      "RedshiftPid": 1073741971,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:09.332Z",
          "Duration": 44942032,
          "HasResultSet": false,
          "Id": "3ada8962-8d45-44f6-8d0e-ed7aedc735cf:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:09.757Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:09.335Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"UNNEST\" in context \"FROM (\n          SELECT UNNEST\", at line 6, column 18\n  Position: 162",
          "HasResultSet": false,
          "Id": "3ada8962-8d45-44f6-8d0e-ed7aedc735cf:2",
          "QueryString": "SELECT \n   COUNT(DISTINCT state_facts2_0.\"__distinct_key\") as \"c\",\n   (\n        SELECT STRING_AGG((a::json->>'f2'), '') as value\n        FROM (\n          SELECT UNNEST(array_agg(distinct row_to_json(row(base.\"__distinct_key\",'o',''))::text)) a\n        ) a\n      ) as \"s\"\nFROM (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as \"__distinct_key\", x.*  FROM \"malloytest\".\"state_facts\" as x) AS state_facts2_0\n  ON state_facts2_0.\"state\"=base.\"state\"\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:09.757Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:09.822Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1662:11)

  ● redshift › string_agg_distinct › actually distincts - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT aircraft_0."name", ',' ORDER BY aircraft_0."name" ASC) as "f_dist",
       STRING_AGG(aircraft_0."name", ',' ORDER BY aircraft_0."name") as "f_all"
    FROM "malloytest"."aircraft_models" as base
     LEFT JOIN "malloytest"."aircraft" AS aircraft_0
      ON base."aircraft_model_code"=aircraft_0."aircraft_model_code"
    WHERE aircraft_0."name" IN ('RAYTHEON AIRCRAFT COMPANY','FOWLER IRA R DBA')

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "e069bb8e-2f72-468c-aebb-af481f031a11",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:10.601Z",
      "Database": "dev",
      "Duration": 46464554,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"aircraft_0.\"name\", ',' ORDER\", at line 2, column 47\n  Position: 55",
      "HasResultSet": false,
      "Id": "cf694a2d-f9c0-43bb-87be-bbea95f77e5f",
      "RedshiftPid": 1073954972,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:10.698Z",
          "Duration": 46464554,
          "HasResultSet": false,
          "Id": "cf694a2d-f9c0-43bb-87be-bbea95f77e5f:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:11.102Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:10.702Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"aircraft_0.\"name\", ',' ORDER\", at line 2, column 47\n  Position: 55",
          "HasResultSet": false,
          "Id": "cf694a2d-f9c0-43bb-87be-bbea95f77e5f:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT aircraft_0.\"name\", ',' ORDER BY aircraft_0.\"name\" ASC) as \"f_dist\",\n   STRING_AGG(aircraft_0.\"name\", ',' ORDER BY aircraft_0.\"name\") as \"f_all\"\nFROM \"malloytest\".\"aircraft_models\" as base\n LEFT JOIN \"malloytest\".\"aircraft\" AS aircraft_0\n  ON base.\"aircraft_model_code\"=aircraft_0.\"aircraft_model_code\"\nWHERE aircraft_0.\"name\" IN ('RAYTHEON AIRCRAFT COMPANY','FOWLER IRA R DBA')\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:11.102Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:11.158Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(DISTINCT aircraft_0."name", ',' ORDER BY aircraft_0."name" ASC) as "f_dist",
       STRING_AGG(aircraft_0."name", ',' ORDER BY aircraft_0."name") as "f_all"
    FROM "malloytest"."aircraft_models" as base
     LEFT JOIN "malloytest"."aircraft" AS aircraft_0
      ON base."aircraft_model_code"=aircraft_0."aircraft_model_code"
    WHERE aircraft_0."name" IN ('RAYTHEON AIRCRAFT COMPANY','FOWLER IRA R DBA')

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT aircraft_0."name", ',' ORDER BY aircraft_0."name" ASC) as "f_dist",
       STRING_AGG(aircraft_0."name", ',' ORDER BY aircraft_0."name") as "f_all"
    FROM "malloytest"."aircraft_models" as base
     LEFT JOIN "malloytest"."aircraft" AS aircraft_0
      ON base."aircraft_model_code"=aircraft_0."aircraft_model_code"
    WHERE aircraft_0."name" IN ('RAYTHEON AIRCRAFT COMPANY','FOWLER IRA R DBA')

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "e069bb8e-2f72-468c-aebb-af481f031a11",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:10.601Z",
      "Database": "dev",
      "Duration": 46464554,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"aircraft_0.\"name\", ',' ORDER\", at line 2, column 47\n  Position: 55",
      "HasResultSet": false,
      "Id": "cf694a2d-f9c0-43bb-87be-bbea95f77e5f",
      "RedshiftPid": 1073954972,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:10.698Z",
          "Duration": 46464554,
          "HasResultSet": false,
          "Id": "cf694a2d-f9c0-43bb-87be-bbea95f77e5f:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:11.102Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:10.702Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"aircraft_0.\"name\", ',' ORDER\", at line 2, column 47\n  Position: 55",
          "HasResultSet": false,
          "Id": "cf694a2d-f9c0-43bb-87be-bbea95f77e5f:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT aircraft_0.\"name\", ',' ORDER BY aircraft_0.\"name\" ASC) as \"f_dist\",\n   STRING_AGG(aircraft_0.\"name\", ',' ORDER BY aircraft_0.\"name\") as \"f_all\"\nFROM \"malloytest\".\"aircraft_models\" as base\n LEFT JOIN \"malloytest\".\"aircraft\" AS aircraft_0\n  ON base.\"aircraft_model_code\"=aircraft_0.\"aircraft_model_code\"\nWHERE aircraft_0.\"name\" IN ('RAYTHEON AIRCRAFT COMPANY','FOWLER IRA R DBA')\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:11.102Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:11.158Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1709:11)

  ● redshift › string_agg_distinct › works no order by - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "fc87d0c7-c757-4120-8ea5-b077eb4dcf31",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:11.974Z",
      "Database": "dev",
      "Duration": 50018352,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "18dd98cc-50b3-4e8d-8020-15eb03d23d27",
      "RedshiftPid": 1073840286,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:12.055Z",
          "Duration": 50018352,
          "HasResultSet": false,
          "Id": "18dd98cc-50b3-4e8d-8020-15eb03d23d27:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:12.510Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:12.058Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "18dd98cc-50b3-4e8d-8020-15eb03d23d27:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:12.510Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:12.574Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "fc87d0c7-c757-4120-8ea5-b077eb4dcf31",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:11.974Z",
      "Database": "dev",
      "Duration": 50018352,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "18dd98cc-50b3-4e8d-8020-15eb03d23d27",
      "RedshiftPid": 1073840286,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:12.055Z",
          "Duration": 50018352,
          "HasResultSet": false,
          "Id": "18dd98cc-50b3-4e8d-8020-15eb03d23d27:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:12.510Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:12.058Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "18dd98cc-50b3-4e8d-8020-15eb03d23d27:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:12.510Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:12.574Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1720:11)

  ● redshift › string_agg_distinct › works with dotted shortcut - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "34190712-d33a-4612-8947-307ceb12ee60",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:13.315Z",
      "Database": "dev",
      "Duration": 51146726,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "2dcc8676-0981-4c1d-9609-cfad1938928b",
      "RedshiftPid": 1073905808,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:13.418Z",
          "Duration": 51146726,
          "HasResultSet": false,
          "Id": "2dcc8676-0981-4c1d-9609-cfad1938928b:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:13.861Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:13.421Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "2dcc8676-0981-4c1d-9609-cfad1938928b:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:13.861Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:13.925Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT base."name", ',') as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name"='RUTHERFORD PAT R JR'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "34190712-d33a-4612-8947-307ceb12ee60",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:13.315Z",
      "Database": "dev",
      "Duration": 51146726,
      "Error": "Query #2 failed with ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
      "HasResultSet": false,
      "Id": "2dcc8676-0981-4c1d-9609-cfad1938928b",
      "RedshiftPid": 1073905808,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:13.418Z",
          "Duration": 51146726,
          "HasResultSet": false,
          "Id": "2dcc8676-0981-4c1d-9609-cfad1938928b:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:13.861Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:13.421Z",
          "Duration": -1,
          "Error": "ERROR: function string_agg(character varying, \"unknown\") does not exist\n  Hint: No function matches the given name and argument types. You may need to add explicit type casts.",
          "HasResultSet": false,
          "Id": "2dcc8676-0981-4c1d-9609-cfad1938928b:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT base.\"name\", ',') as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\"='RUTHERFORD PAT R JR'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:13.861Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:13.925Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1729:11)

  ● redshift › string_agg_distinct › works with order by direction - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "7eb30f12-5bce-483b-8792-cda981a867aa",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:14.678Z",
      "Database": "dev",
      "Duration": 44403908,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 41\n  Position: 49",
      "HasResultSet": false,
      "Id": "5274b718-2e0c-4ff4-9da3-953457d1bfb9",
      "RedshiftPid": 1073897623,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:14.770Z",
          "Duration": 44403908,
          "HasResultSet": false,
          "Id": "5274b718-2e0c-4ff4-9da3-953457d1bfb9:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:15.199Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:14.773Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 41\n  Position: 49",
          "HasResultSet": false,
          "Id": "5274b718-2e0c-4ff4-9da3-953457d1bfb9:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:15.199Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:15.265Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM "malloytest"."aircraft" as base
    WHERE base."name" ~ '.*RUTHERFORD.*'

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "7eb30f12-5bce-483b-8792-cda981a867aa",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:14.678Z",
      "Database": "dev",
      "Duration": 44403908,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 41\n  Position: 49",
      "HasResultSet": false,
      "Id": "5274b718-2e0c-4ff4-9da3-953457d1bfb9",
      "RedshiftPid": 1073897623,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:14.770Z",
          "Duration": 44403908,
          "HasResultSet": false,
          "Id": "5274b718-2e0c-4ff4-9da3-953457d1bfb9:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:15.199Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:14.773Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 2, column 41\n  Position: 49",
          "HasResultSet": false,
          "Id": "5274b718-2e0c-4ff4-9da3-953457d1bfb9:2",
          "QueryString": "SELECT \n   STRING_AGG(DISTINCT base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM \"malloytest\".\"aircraft\" as base\nWHERE base.\"name\" ~ '.*RUTHERFORD.*'\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:15.199Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:15.265Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1741:11)

  ● redshift › string_agg_distinct › works with order asc - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "e617b229-ee60-4ae9-9f7d-73d88b32def0",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:16.031Z",
      "Database": "dev",
      "Duration": 52569114,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
      "HasResultSet": false,
      "Id": "cb252dfc-6959-4635-8765-c6a4967f9f23",
      "RedshiftPid": 1073938570,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:16.129Z",
          "Duration": 52569114,
          "HasResultSet": false,
          "Id": "cb252dfc-6959-4635-8765-c6a4967f9f23:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:16.570Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:16.132Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
          "HasResultSet": false,
          "Id": "cb252dfc-6959-4635-8765-c6a4967f9f23:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(DISTINCT base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:16.570Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:16.621Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

    Error: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" ASC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "e617b229-ee60-4ae9-9f7d-73d88b32def0",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:16.031Z",
      "Database": "dev",
      "Duration": 52569114,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
      "HasResultSet": false,
      "Id": "cb252dfc-6959-4635-8765-c6a4967f9f23",
      "RedshiftPid": 1073938570,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:16.129Z",
          "Duration": 52569114,
          "HasResultSet": false,
          "Id": "cb252dfc-6959-4635-8765-c6a4967f9f23:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:16.570Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:16.132Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
          "HasResultSet": false,
          "Id": "cb252dfc-6959-4635-8765-c6a4967f9f23:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(DISTINCT base.\"name\", ',' ORDER BY base.\"name\" ASC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:16.570Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:16.621Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1755:11)

  ● redshift › string_agg_distinct › works with order desc - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "77ff8ff0-b3ed-407e-98ef-cb27d912c4dd",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:17.455Z",
      "Database": "dev",
      "Duration": 45716475,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
      "HasResultSet": false,
      "Id": "96198ea0-c045-4ba4-97c9-9883b578352c",
      "RedshiftPid": 1073873033,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:17.569Z",
          "Duration": 45716475,
          "HasResultSet": false,
          "Id": "96198ea0-c045-4ba4-97c9-9883b578352c:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:18.026Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:17.573Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
          "HasResultSet": false,
          "Id": "96198ea0-c045-4ba4-97c9-9883b578352c:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(DISTINCT base.\"name\", ',' ORDER BY base.\"name\" DESC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:18.026Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:18.092Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

    Error: Batch error:
     sql: SET search_path TO malloytest;
    WITH __stage0 AS (
      SELECT
         base."name" as "name"
      FROM "malloytest"."aircraft" as base
      WHERE base."name" ~ '.*FLY.*'
      GROUP BY 1
      ORDER BY 1 desc NULLS LAST
      LIMIT 3
    )
    SELECT
       STRING_AGG(DISTINCT base."name", ',' ORDER BY base."name" DESC) as "f"
    FROM __stage0 as base

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "77ff8ff0-b3ed-407e-98ef-cb27d912c4dd",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:17.455Z",
      "Database": "dev",
      "Duration": 45716475,
      "Error": "Query #2 failed with ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
      "HasResultSet": false,
      "Id": "96198ea0-c045-4ba4-97c9-9883b578352c",
      "RedshiftPid": 1073873033,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:17.569Z",
          "Duration": 45716475,
          "HasResultSet": false,
          "Id": "96198ea0-c045-4ba4-97c9-9883b578352c:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:18.026Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:17.573Z",
          "Duration": -1,
          "Error": "ERROR: syntax error at or near \"ORDER\" in context \"base.\"name\", ',' ORDER\", at line 11, column 41\n  Position: 230",
          "HasResultSet": false,
          "Id": "96198ea0-c045-4ba4-97c9-9883b578352c:2",
          "QueryString": "WITH __stage0 AS (\n  SELECT \n     base.\"name\" as \"name\"\n  FROM \"malloytest\".\"aircraft\" as base\n  WHERE base.\"name\" ~ '.*FLY.*'\n  GROUP BY 1\n  ORDER BY 1 desc NULLS LAST\n  LIMIT 3\n)\nSELECT \n   STRING_AGG(DISTINCT base.\"name\", ',' ORDER BY base.\"name\" DESC) as \"f\"\nFROM __stage0 as base\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:18.026Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:18.092Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1769:11)

  ● redshift › partition_by › works - redshift

    Could not prepare query to run: Error(s) compiling model:
    FILE: internal://internal.malloy
    line 16: Unsupported SQL native type 'timestamp without time zone' not allowed in expression
      |         where: dep_time < @2002
      |                ^
    line 4: year() requires time type, not 'sql native'
      |           yr is year(dep_time)
      |                 ^
    line 5: quarter() requires time type, not 'sql native'
      |           qtr is quarter(dep_time)
      |                  ^

      1815 |         order_by: yr, qtr
      1816 |         where: dep_time < @2002
    > 1817 |       }`).malloyResultMatches(expressionModel, [
           |           ^
      1818 |         {yr: 2000, qtr: 1, qtr_flights: 12148, last_yr_qtr_flights: null},
      1819 |         {yr: 2000, qtr: 2, qtr_flights: 11599, last_yr_qtr_flights: null},
      1820 |         {yr: 2000, qtr: 3, qtr_flights: 12075, last_yr_qtr_flights: null},

      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1817:11)

  ● redshift › partition_by › works with aggregate - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(1) as "c",
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "l",
       LAG((SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1))) OVER(PARTITION BY (COUNT(1))  ORDER BY  SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) ASC NULLS LAST ) as "prev"
    FROM "malloytest"."state_facts" as base
    GROUP BY 2
    ORDER BY 2 ASC NULLS LAST
    LIMIT 5

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "59972d37-36ec-476c-bd24-9ce666de1027",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:18.975Z",
      "Database": "dev",
      "Duration": 44733355,
      "Error": "Query #2 failed with ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1227118[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073922177]\n  -----------------------------------------------\n",
      "HasResultSet": false,
      "Id": "8a3fc28f-9afb-4b0f-a632-377075277626",
      "RedshiftPid": 1073922177,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:19.083Z",
          "Duration": 44733355,
          "HasResultSet": false,
          "Id": "8a3fc28f-9afb-4b0f-a632-377075277626:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:19.556Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:19.094Z",
          "Duration": -1,
          "Error": "ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1227118[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073922177]\n  -----------------------------------------------\n",
          "HasResultSet": false,
          "Id": "8a3fc28f-9afb-4b0f-a632-377075277626:2",
          "QueryString": "SELECT \n   COUNT(1) as \"c\",\n   SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1) as \"l\",\n   LAG((SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1))) OVER(PARTITION BY (COUNT(1))  ORDER BY  SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1) ASC NULLS LAST ) as \"prev\"\nFROM \"malloytest\".\"state_facts\" as base\nGROUP BY 2\nORDER BY 2 ASC NULLS LAST\nLIMIT 5\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:19.556Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:19.622Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       COUNT(1) as "c",
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "l",
       LAG((SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1))) OVER(PARTITION BY (COUNT(1))  ORDER BY  SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) ASC NULLS LAST ) as "prev"
    FROM "malloytest"."state_facts" as base
    GROUP BY 2
    ORDER BY 2 ASC NULLS LAST
    LIMIT 5

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       COUNT(1) as "c",
       SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) as "l",
       LAG((SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1))) OVER(PARTITION BY (COUNT(1))  ORDER BY  SUBSTR(base."state", CASE WHEN 1 < 0 THEN LENGTH(base."state") + 1 + 1 ELSE 1 END, 1) ASC NULLS LAST ) as "prev"
    FROM "malloytest"."state_facts" as base
    GROUP BY 2
    ORDER BY 2 ASC NULLS LAST
    LIMIT 5

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "59972d37-36ec-476c-bd24-9ce666de1027",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:18.975Z",
      "Database": "dev",
      "Duration": 44733355,
      "Error": "Query #2 failed with ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1227118[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073922177]\n  -----------------------------------------------\n",
      "HasResultSet": false,
      "Id": "8a3fc28f-9afb-4b0f-a632-377075277626",
      "RedshiftPid": 1073922177,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:19.083Z",
          "Duration": 44733355,
          "HasResultSet": false,
          "Id": "8a3fc28f-9afb-4b0f-a632-377075277626:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:19.556Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:19.094Z",
          "Duration": -1,
          "Error": "ERROR: SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  Detail: \n  -----------------------------------------------\n  error:  SUBSTR() function is not supported (Hint: use SUBSTRING instead)\n  code:      8001\n  context:   \n  query:     1227118[child_sequence:1]\n  location:  cg_expr_fn_builder.cpp:9022\n  process:   padbmaster [pid=1073922177]\n  -----------------------------------------------\n",
          "HasResultSet": false,
          "Id": "8a3fc28f-9afb-4b0f-a632-377075277626:2",
          "QueryString": "SELECT \n   COUNT(1) as \"c\",\n   SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1) as \"l\",\n   LAG((SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1))) OVER(PARTITION BY (COUNT(1))  ORDER BY  SUBSTR(base.\"state\", CASE WHEN 1 < 0 THEN LENGTH(base.\"state\") + 1 + 1 ELSE 1 END, 1) ASC NULLS LAST ) as \"prev\"\nFROM \"malloytest\".\"state_facts\" as base\nGROUP BY 2\nORDER BY 2 ASC NULLS LAST\nLIMIT 5\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:19.556Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:19.622Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1841:11)

  ● redshift › partition_by › works with multiple order_bys - redshift

    query.run failed: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       base."name" as "name",
       RANK() OVER( ORDER BY COUNT(DISTINCT aircraft_models_0."aircraft_model_code") DESC, COALESCE(CAST((
        (
          SUM(DISTINCT
            (CAST(ROUND(COALESCE(aircraft_models_0."seats",0)*(1*1.0), 9) AS DECIMAL) +
            ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)
          ))
          -
           SUM(DISTINCT ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))
        )/(1*1.0)) AS DOUBLE PRECISION),0) DESC ) as "r"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" IN ('UNITED AIR LINES INC','FEDERAL EXPRESS CORP','AMERICAN AIRLINES INC','CESSNA AIRCRAFT COMPANY')
    GROUP BY 1
    ORDER BY 1 ASC NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "bca5a51a-9995-416f-b067-5e3abfd2bfd8",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:20.485Z",
      "Database": "dev",
      "Duration": 53254208,
      "Error": "Query #2 failed with ERROR: DECIMAL precision 65 must be between 1 and 38",
      "HasResultSet": false,
      "Id": "45ce30cd-4384-49fe-b631-17b01bf6b511",
      "RedshiftPid": 1073963142,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:20.588Z",
          "Duration": 53254208,
          "HasResultSet": false,
          "Id": "45ce30cd-4384-49fe-b631-17b01bf6b511:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:21.061Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:20.591Z",
          "Duration": -1,
          "Error": "ERROR: DECIMAL precision 65 must be between 1 and 38",
          "HasResultSet": false,
          "Id": "45ce30cd-4384-49fe-b631-17b01bf6b511:2",
          "QueryString": "SELECT \n   base.\"name\" as \"name\",\n   RANK() OVER( ORDER BY COUNT(DISTINCT aircraft_models_0.\"aircraft_model_code\") DESC, COALESCE(CAST((\n    (\n      SUM(DISTINCT\n        (CAST(ROUND(COALESCE(aircraft_models_0.\"seats\",0)*(1*1.0), 9) AS DECIMAL) +\n        ('x' || MD5(aircraft_models_0.\"aircraft_model_code\"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0.\"aircraft_model_code\"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)\n      ))\n      -\n       SUM(DISTINCT ('x' || MD5(aircraft_models_0.\"aircraft_model_code\"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0.\"aircraft_model_code\"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))\n    )/(1*1.0)) AS DOUBLE PRECISION),0) DESC ) as \"r\"\nFROM \"malloytest\".\"aircraft\" as base\n LEFT JOIN \"malloytest\".\"aircraft_models\" AS aircraft_models_0\n  ON aircraft_models_0.\"aircraft_model_code\"=base.\"aircraft_model_code\"\nWHERE base.\"name\" IN ('UNITED AIR LINES INC','FEDERAL EXPRESS CORP','AMERICAN AIRLINES INC','CESSNA AIRCRAFT COMPANY')\nGROUP BY 1\nORDER BY 1 ASC NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:21.061Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:21.126Z",
      "WorkgroupName": "default-workgroup"
    }
    SQL: SELECT
       base."name" as "name",
       RANK() OVER( ORDER BY COUNT(DISTINCT aircraft_models_0."aircraft_model_code") DESC, COALESCE(CAST((
        (
          SUM(DISTINCT
            (CAST(ROUND(COALESCE(aircraft_models_0."seats",0)*(1*1.0), 9) AS DECIMAL) +
            ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)
          ))
          -
           SUM(DISTINCT ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))
        )/(1*1.0)) AS DOUBLE PRECISION),0) DESC ) as "r"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" IN ('UNITED AIR LINES INC','FEDERAL EXPRESS CORP','AMERICAN AIRLINES INC','CESSNA AIRCRAFT COMPANY')
    GROUP BY 1
    ORDER BY 1 ASC NULLS LAST

    Error: Batch error:
     sql: SET search_path TO malloytest;
    SELECT
       base."name" as "name",
       RANK() OVER( ORDER BY COUNT(DISTINCT aircraft_models_0."aircraft_model_code") DESC, COALESCE(CAST((
        (
          SUM(DISTINCT
            (CAST(ROUND(COALESCE(aircraft_models_0."seats",0)*(1*1.0), 9) AS DECIMAL) +
            ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)
          ))
          -
           SUM(DISTINCT ('x' || MD5(aircraft_models_0."aircraft_model_code"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0."aircraft_model_code"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))
        )/(1*1.0)) AS DOUBLE PRECISION),0) DESC ) as "r"
    FROM "malloytest"."aircraft" as base
     LEFT JOIN "malloytest"."aircraft_models" AS aircraft_models_0
      ON aircraft_models_0."aircraft_model_code"=base."aircraft_model_code"
    WHERE base."name" IN ('UNITED AIR LINES INC','FEDERAL EXPRESS CORP','AMERICAN AIRLINES INC','CESSNA AIRCRAFT COMPANY')
    GROUP BY 1
    ORDER BY 1 ASC NULLS LAST

     {
      "$metadata": {
        "httpStatusCode": 200,
        "requestId": "bca5a51a-9995-416f-b067-5e3abfd2bfd8",
        "attempts": 1,
        "totalRetryDelay": 0
      },
      "CreatedAt": "2025-02-28T23:30:20.485Z",
      "Database": "dev",
      "Duration": 53254208,
      "Error": "Query #2 failed with ERROR: DECIMAL precision 65 must be between 1 and 38",
      "HasResultSet": false,
      "Id": "45ce30cd-4384-49fe-b631-17b01bf6b511",
      "RedshiftPid": 1073963142,
      "RedshiftQueryId": 0,
      "ResultFormat": "json",
      "ResultRows": -1,
      "ResultSize": -1,
      "SecretArn": "arn:aws:secretsmanager:us-west-1:977099028464:secret:redshift-access-secret-4MyGTg",
      "Status": "FAILED",
      "SubStatements": [
        {
          "CreatedAt": "2025-02-28T23:30:20.588Z",
          "Duration": 53254208,
          "HasResultSet": false,
          "Id": "45ce30cd-4384-49fe-b631-17b01bf6b511:1",
          "QueryString": "SET search_path TO malloytest;",
          "RedshiftQueryId": 0,
          "ResultRows": 0,
          "ResultSize": 0,
          "Status": "FINISHED",
          "UpdatedAt": "2025-02-28T23:30:21.061Z"
        },
        {
          "CreatedAt": "2025-02-28T23:30:20.591Z",
          "Duration": -1,
          "Error": "ERROR: DECIMAL precision 65 must be between 1 and 38",
          "HasResultSet": false,
          "Id": "45ce30cd-4384-49fe-b631-17b01bf6b511:2",
          "QueryString": "SELECT \n   base.\"name\" as \"name\",\n   RANK() OVER( ORDER BY COUNT(DISTINCT aircraft_models_0.\"aircraft_model_code\") DESC, COALESCE(CAST((\n    (\n      SUM(DISTINCT\n        (CAST(ROUND(COALESCE(aircraft_models_0.\"seats\",0)*(1*1.0), 9) AS DECIMAL) +\n        ('x' || MD5(aircraft_models_0.\"aircraft_model_code\"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0.\"aircraft_model_code\"::varchar),17))::bit(64)::bigint::DECIMAL(65,0)\n      ))\n      -\n       SUM(DISTINCT ('x' || MD5(aircraft_models_0.\"aircraft_model_code\"::varchar))::bit(64)::bigint::DECIMAL(65,0)  *18446744073709551616 + ('x' || SUBSTR(MD5(aircraft_models_0.\"aircraft_model_code\"::varchar),17))::bit(64)::bigint::DECIMAL(65,0))\n    )/(1*1.0)) AS DOUBLE PRECISION),0) DESC ) as \"r\"\nFROM \"malloytest\".\"aircraft\" as base\n LEFT JOIN \"malloytest\".\"aircraft_models\" AS aircraft_models_0\n  ON aircraft_models_0.\"aircraft_model_code\"=base.\"aircraft_model_code\"\nWHERE base.\"name\" IN ('UNITED AIR LINES INC','FEDERAL EXPRESS CORP','AMERICAN AIRLINES INC','CESSNA AIRCRAFT COMPANY')\nGROUP BY 1\nORDER BY 1 ASC NULLS LAST\n",
          "RedshiftQueryId": 0,
          "ResultRows": -1,
          "ResultSize": -1,
          "Status": "FAILED",
          "UpdatedAt": "2025-02-28T23:30:21.061Z"
        }
      ],
      "UpdatedAt": "2025-02-28T23:30:21.126Z",
      "WorkgroupName": "default-workgroup"
    }

      362 |       }
      363 |     } else {
    > 364 |       throw new Error(
          |             ^
      365 |         `Batch error: \n sql: ${sqlArray.join('\n')} \n ${JSON.stringify(
      366 |           statusResponse,
      367 |           null,

      at _callee10$ (packages/malloy-db-redshift/src/redshift_connection.ts:364:13)
      at tryCatch (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:45:16)
      at Generator.<anonymous> (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:133:17)
      at Generator.next (node_modules/@babel/runtime/helpers/regeneratorRuntime.js:74:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:24)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:22:9)
      at Object.<anonymous> (test/src/databases/all/functions.spec.ts:1867:11)

Test Suites: 1 failed, 1 total
Tests:       34 failed, 26 skipped, 63 passed, 123 total
Snapshots:   0 total
Time:        157.29 s
Ran all test suites matching /functions/i.
